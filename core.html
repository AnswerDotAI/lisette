<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.8.27">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">

<meta name="description" content="Lisette Core">

<title>Core â€“ lisette</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
html { -webkit-text-size-adjust: 100%; }
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>


<script src="site_libs/quarto-nav/quarto-nav.js"></script>
<script src="site_libs/quarto-nav/headroom.min.js"></script>
<script src="site_libs/clipboard/clipboard.min.js"></script>
<script src="site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="site_libs/quarto-search/fuse.min.js"></script>
<script src="site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="./">
<script src="site_libs/quarto-html/quarto.js" type="module"></script>
<script src="site_libs/quarto-html/tabsets/tabsets.js" type="module"></script>
<script src="site_libs/quarto-html/axe/axe-check.js" type="module"></script>
<script src="site_libs/quarto-html/popper.min.js"></script>
<script src="site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="site_libs/quarto-html/anchor.min.js"></script>
<link href="site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="site_libs/quarto-html/quarto-syntax-highlighting-ed96de9b727972fe78a7b5d16c58bf87.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="site_libs/bootstrap/bootstrap.min.js"></script>
<link href="site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="site_libs/bootstrap/bootstrap-baedc78cbf92349237790bf011c153e8.min.css" rel="stylesheet" append-hash="true" id="quarto-bootstrap" data-mode="light">
<script id="quarto-search-options" type="application/json">{
  "location": "navbar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "end",
  "type": "overlay",
  "limit": 50,
  "keyboard-shortcut": [
    "f",
    "/",
    "s"
  ],
  "show-item-context": false,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-text-placeholder": "",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script>

  <script src="https://cdnjs.cloudflare.com/polyfill/v3/polyfill.min.js?features=es6"></script>
  <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml-full.js" type="text/javascript"></script>

<script type="text/javascript">
const typesetMath = (el) => {
  if (window.MathJax) {
    // MathJax Typeset
    window.MathJax.typeset([el]);
  } else if (window.katex) {
    // KaTeX Render
    var mathElements = el.getElementsByClassName("math");
    var macros = [];
    for (var i = 0; i < mathElements.length; i++) {
      var texText = mathElements[i].firstChild;
      if (mathElements[i].tagName == "SPAN" && texText && texText.data) {
        window.katex.render(texText.data, mathElements[i], {
          displayMode: mathElements[i].classList.contains('display'),
          throwOnError: false,
          macros: macros,
          fleqn: false
        });
      }
    }
  }
}
window.Quarto = {
  typesetMath
};
</script>

<link rel="stylesheet" href="styles.css">
<meta property="og:title" content="Core â€“ lisette">
<meta property="og:description" content="Lisette Core">
<meta property="og:image" content="https://lisette.answer.ai/00_core_files/figure-html/cell-20-output-1.jpeg">
<meta property="og:site_name" content="lisette">
<meta name="twitter:title" content="Core â€“ lisette">
<meta name="twitter:description" content="Lisette Core">
<meta name="twitter:image" content="https://lisette.answer.ai/00_core_files/figure-html/cell-20-output-1.jpeg">
<meta name="twitter:card" content="summary_large_image">
</head>

<body class="nav-sidebar floating nav-fixed quarto-light">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
    <nav class="navbar navbar-expand-lg " data-bs-theme="dark">
      <div class="navbar-container container-fluid">
      <div class="navbar-brand-container mx-auto">
    <a class="navbar-brand" href="./index.html">
    <span class="navbar-title">lisette</span>
    </a>
  </div>
        <div class="quarto-navbar-tools tools-end">
</div>
          <div id="quarto-search" class="" title="Search"></div>
      </div> <!-- /container-fluid -->
    </nav>
  <nav class="quarto-secondary-nav">
    <div class="container-fluid d-flex">
      <button type="button" class="quarto-btn-toggle btn" data-bs-toggle="collapse" role="button" data-bs-target=".quarto-sidebar-collapse-item" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
        <i class="bi bi-layout-text-sidebar-reverse"></i>
      </button>
        <nav class="quarto-page-breadcrumbs" aria-label="breadcrumb"><ol class="breadcrumb"><li class="breadcrumb-item"><a href="./core.html">Core</a></li></ol></nav>
        <a class="flex-grow-1" role="navigation" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">      
        </a>
    </div>
  </nav>
</header>
<!-- content -->
<div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article page-navbar">
<!-- sidebar -->
  <nav id="quarto-sidebar" class="sidebar collapse collapse-horizontal quarto-sidebar-collapse-item sidebar-navigation floating overflow-auto">
    <div class="sidebar-menu-container"> 
    <ul class="list-unstyled mt-1">
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./index.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Lisette</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./core.html" class="sidebar-item-text sidebar-link active">
 <span class="menu-text">Core</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./usage.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Usage</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./test_cache.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Caching</span></a>
  </div>
</li>
    </ul>
    </div>
</nav>
<div id="quarto-sidebar-glass" class="quarto-sidebar-collapse-item" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item"></div>
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">On this page</h2>
   
  <ul>
  <li><a href="#litellm" id="toc-litellm" class="nav-link active" data-scroll-target="#litellm">LiteLLM</a>
  <ul class="collapse">
  <li><a href="#deterministic-outputs" id="toc-deterministic-outputs" class="nav-link" data-scroll-target="#deterministic-outputs">Deterministic outputs</a>
  <ul class="collapse">
  <li><a href="#patch_litellm" id="toc-patch_litellm" class="nav-link" data-scroll-target="#patch_litellm">patch_litellm</a></li>
  </ul></li>
  <li><a href="#completion" id="toc-completion" class="nav-link" data-scroll-target="#completion">Completion</a></li>
  <li><a href="#messages-formatting" id="toc-messages-formatting" class="nav-link" data-scroll-target="#messages-formatting">Messages formatting</a>
  <ul class="collapse">
  <li><a href="#stop_reason" id="toc-stop_reason" class="nav-link" data-scroll-target="#stop_reason">stop_reason</a></li>
  <li><a href="#contents" id="toc-contents" class="nav-link" data-scroll-target="#contents">contents</a></li>
  <li><a href="#remove_cache_ckpts" id="toc-remove_cache_ckpts" class="nav-link" data-scroll-target="#remove_cache_ckpts">remove_cache_ckpts</a></li>
  <li><a href="#mk_msg" id="toc-mk_msg" class="nav-link" data-scroll-target="#mk_msg">mk_msg</a></li>
  <li><a href="#caching" id="toc-caching" class="nav-link" data-scroll-target="#caching">Caching</a></li>
  <li><a href="#reconstructing-formatted-outputs" id="toc-reconstructing-formatted-outputs" class="nav-link" data-scroll-target="#reconstructing-formatted-outputs">Reconstructing formatted outputs</a></li>
  <li><a href="#fmt2hist" id="toc-fmt2hist" class="nav-link" data-scroll-target="#fmt2hist">fmt2hist</a></li>
  <li><a href="#mk_msgs" id="toc-mk_msgs" class="nav-link" data-scroll-target="#mk_msgs"><code>mk_msgs</code></a></li>
  <li><a href="#mk_msgs-1" id="toc-mk_msgs-1" class="nav-link" data-scroll-target="#mk_msgs-1">mk_msgs</a></li>
  </ul></li>
  <li><a href="#streaming" id="toc-streaming" class="nav-link" data-scroll-target="#streaming">Streaming</a>
  <ul class="collapse">
  <li><a href="#stream_with_complete" id="toc-stream_with_complete" class="nav-link" data-scroll-target="#stream_with_complete">stream_with_complete</a></li>
  </ul></li>
  <li><a href="#tools" id="toc-tools" class="nav-link" data-scroll-target="#tools">Tools</a>
  <ul class="collapse">
  <li><a href="#lite_mk_func" id="toc-lite_mk_func" class="nav-link" data-scroll-target="#lite_mk_func">lite_mk_func</a></li>
  <li><a href="#toolresponse" id="toc-toolresponse" class="nav-link" data-scroll-target="#toolresponse">ToolResponse</a></li>
  </ul></li>
  <li><a href="#structured-outputs" id="toc-structured-outputs" class="nav-link" data-scroll-target="#structured-outputs">Structured Outputs</a>
  <ul class="collapse">
  <li><a href="#structured" id="toc-structured" class="nav-link" data-scroll-target="#structured">structured</a></li>
  </ul></li>
  <li><a href="#search" id="toc-search" class="nav-link" data-scroll-target="#search">Search</a></li>
  <li><a href="#citations" id="toc-citations" class="nav-link" data-scroll-target="#citations">Citations</a>
  <ul class="collapse">
  <li><a href="#cite_footnotes" id="toc-cite_footnotes" class="nav-link" data-scroll-target="#cite_footnotes">cite_footnotes</a></li>
  <li><a href="#cite_footnote" id="toc-cite_footnote" class="nav-link" data-scroll-target="#cite_footnote">cite_footnote</a></li>
  </ul></li>
  <li><a href="#chat" id="toc-chat" class="nav-link" data-scroll-target="#chat">Chat</a>
  <ul class="collapse">
  <li><a href="#mk_stream_chunk" id="toc-mk_stream_chunk" class="nav-link" data-scroll-target="#mk_stream_chunk">mk_stream_chunk</a></li>
  <li><a href="#chat-1" id="toc-chat-1" class="nav-link" data-scroll-target="#chat-1">Chat</a></li>
  <li><a href="#add_warning" id="toc-add_warning" class="nav-link" data-scroll-target="#add_warning">add_warning</a></li>
  <li><a href="#chat.__call__" id="toc-chat.__call__" class="nav-link" data-scroll-target="#chat.__call__">Chat.__call__</a></li>
  <li><a href="#chat.print_hist" id="toc-chat.print_hist" class="nav-link" data-scroll-target="#chat.print_hist">Chat.print_hist</a></li>
  </ul></li>
  <li><a href="#examples" id="toc-examples" class="nav-link" data-scroll-target="#examples">Examples</a>
  <ul class="collapse">
  <li><a href="#history-tracking" id="toc-history-tracking" class="nav-link" data-scroll-target="#history-tracking">History tracking</a></li>
  <li><a href="#synthetic-history-creation" id="toc-synthetic-history-creation" class="nav-link" data-scroll-target="#synthetic-history-creation">Synthetic History Creation</a></li>
  <li><a href="#random_tool_id" id="toc-random_tool_id" class="nav-link" data-scroll-target="#random_tool_id">random_tool_id</a></li>
  <li><a href="#mk_tc" id="toc-mk_tc" class="nav-link" data-scroll-target="#mk_tc">mk_tc</a></li>
  <li><a href="#mk_tc_req" id="toc-mk_tc_req" class="nav-link" data-scroll-target="#mk_tc_req">mk_tc_req</a></li>
  <li><a href="#mk_tc_result" id="toc-mk_tc_result" class="nav-link" data-scroll-target="#mk_tc_result">mk_tc_result</a></li>
  <li><a href="#mk_tc_results" id="toc-mk_tc_results" class="nav-link" data-scroll-target="#mk_tc_results">mk_tc_results</a></li>
  <li><a href="#images" id="toc-images" class="nav-link" data-scroll-target="#images">Images</a></li>
  <li><a href="#prefill" id="toc-prefill" class="nav-link" data-scroll-target="#prefill">Prefill</a></li>
  <li><a href="#streaming-1" id="toc-streaming-1" class="nav-link" data-scroll-target="#streaming-1">Streaming</a></li>
  <li><a href="#tool-use" id="toc-tool-use" class="nav-link" data-scroll-target="#tool-use">Tool use</a></li>
  <li><a href="#thinking-w-tool-use" id="toc-thinking-w-tool-use" class="nav-link" data-scroll-target="#thinking-w-tool-use">Thinking w tool use</a></li>
  <li><a href="#search-1" id="toc-search-1" class="nav-link" data-scroll-target="#search-1">Search</a></li>
  <li><a href="#multi-tool-calling" id="toc-multi-tool-calling" class="nav-link" data-scroll-target="#multi-tool-calling">Multi tool calling</a></li>
  <li><a href="#tool-call-exhaustion" id="toc-tool-call-exhaustion" class="nav-link" data-scroll-target="#tool-call-exhaustion">Tool call exhaustion</a></li>
  <li><a href="#tool-call-referencing" id="toc-tool-call-referencing" class="nav-link" data-scroll-target="#tool-call-referencing">Tool Call Referencing</a></li>
  <li><a href="#caching-1" id="toc-caching-1" class="nav-link" data-scroll-target="#caching-1">Caching</a></li>
  </ul></li>
  <li><a href="#async" id="toc-async" class="nav-link" data-scroll-target="#async">Async</a>
  <ul class="collapse">
  <li><a href="#asyncchat" id="toc-asyncchat" class="nav-link" data-scroll-target="#asyncchat">AsyncChat</a></li>
  <li><a href="#astream_with_complete" id="toc-astream_with_complete" class="nav-link" data-scroll-target="#astream_with_complete">astream_with_complete</a></li>
  <li><a href="#asyncchat-1" id="toc-asyncchat-1" class="nav-link" data-scroll-target="#asyncchat-1">AsyncChat</a></li>
  <li><a href="#asyncchat.__call__" id="toc-asyncchat.__call__" class="nav-link" data-scroll-target="#asyncchat.__call__">AsyncChat.__call__</a></li>
  <li><a href="#examples-1" id="toc-examples-1" class="nav-link" data-scroll-target="#examples-1">Examples</a></li>
  </ul></li>
  <li><a href="#async-streaming-display" id="toc-async-streaming-display" class="nav-link" data-scroll-target="#async-streaming-display">Async Streaming Display</a>
  <ul class="collapse">
  <li><a href="#mk_tr_details" id="toc-mk_tr_details" class="nav-link" data-scroll-target="#mk_tr_details">mk_tr_details</a></li>
  <li><a href="#fmt_usage" id="toc-fmt_usage" class="nav-link" data-scroll-target="#fmt_usage">fmt_usage</a></li>
  <li><a href="#streamformatter" id="toc-streamformatter" class="nav-link" data-scroll-target="#streamformatter">StreamFormatter</a></li>
  <li><a href="#asyncstreamformatter" id="toc-asyncstreamformatter" class="nav-link" data-scroll-target="#asyncstreamformatter">AsyncStreamFormatter</a></li>
  <li><a href="#display_stream" id="toc-display_stream" class="nav-link" data-scroll-target="#display_stream">display_stream</a></li>
  <li><a href="#adisplay_stream" id="toc-adisplay_stream" class="nav-link" data-scroll-target="#adisplay_stream">adisplay_stream</a></li>
  </ul></li>
  <li><a href="#streaming-examples" id="toc-streaming-examples" class="nav-link" data-scroll-target="#streaming-examples">Streaming examples</a>
  <ul class="collapse">
  <li><a href="#tool-call" id="toc-tool-call" class="nav-link" data-scroll-target="#tool-call">Tool call</a></li>
  <li><a href="#thinking-tool-call" id="toc-thinking-tool-call" class="nav-link" data-scroll-target="#thinking-tool-call">Thinking tool call</a></li>
  <li><a href="#multiple-tool-calls" id="toc-multiple-tool-calls" class="nav-link" data-scroll-target="#multiple-tool-calls">Multiple tool calls</a></li>
  <li><a href="#search-2" id="toc-search-2" class="nav-link" data-scroll-target="#search-2">Search</a></li>
  <li><a href="#tool-call-referencing-1" id="toc-tool-call-referencing-1" class="nav-link" data-scroll-target="#tool-call-referencing-1">Tool Call Referencing</a></li>
  </ul></li>
  </ul></li>
  </ul>
<div class="toc-actions"><ul><li><a href="https://github.com/AnswerDotAI/lisette/issues/new" class="toc-action"><i class="bi bi-github"></i>Report an issue</a></li></ul></div><div class="quarto-alternate-formats"><h2>Other Formats</h2><ul><li><a href="core.html.md"><i class="bi bi-file-code"></i>CommonMark</a></li></ul></div></nav>
    </div>
<!-- main -->
<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<h1 class="title">Core</h1>
</div>

<div>
  <div class="description">
    Lisette Core
  </div>
</div>


<div class="quarto-title-meta">

    
  
    
  </div>
  


</header>


<!-- WARNING: THIS FILE WAS AUTOGENERATED! DO NOT EDIT! -->
<section id="litellm" class="level1">
<h1>LiteLLM</h1>
<section id="deterministic-outputs" class="level2">
<h2 class="anchored" data-anchor-id="deterministic-outputs">Deterministic outputs</h2>
<p>LiteLLM <code>ModelResponse(Stream)</code> objects have <code>id</code> and <code>created_at</code> fields that are generated dynamically. Even when we use <a href="https://github.com/answerdotai/cachy"><code>cachy</code></a> to cache the LLM response these dynamic fields create diffs which makes code review more challenging. The patches below ensure that <code>id</code> and <code>created_at</code> fields are fixed and wonâ€™t generate diffs.</p>
<hr>
<p><a href="https://github.com/AnswerDotAI/lisette/blob/main/lisette/core.py#L28" target="_blank" style="float:right; font-size:smaller">source</a></p>
<section id="patch_litellm" class="level3">
<h3 class="anchored" data-anchor-id="patch_litellm">patch_litellm</h3>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb1"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> patch_litellm(</span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a>    seed:<span class="bu">int</span><span class="op">=</span><span class="dv">0</span></span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a>):</span>
<span id="cb1-5"><a href="#cb1-5" aria-hidden="true" tabindex="-1"></a></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<p><em>Patch litellm.ModelResponseBase such that <code>id</code> and <code>created</code> are fixed.</em></p>
<div id="d8e05085" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb2"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a>patch_litellm()</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
</section>
</section>
<section id="completion" class="level2">
<h2 class="anchored" data-anchor-id="completion">Completion</h2>
<p>LiteLLM provides an convenient unified interface for most big LLM providers. Because itâ€™s so useful to be able to switch LLM providers with just one argument. We want to make it even easier to by adding some more convenience functions and classes.</p>
<p>This is very similar to our other wrapper libraries for popular AI providers: <a href="https://claudette.answer.ai/">claudette</a> (Anthropic), <a href="https://github.com/AnswerDotAI/gaspard">gaspard</a> (Gemini), <a href="https://answerdotai.github.io/cosette/">cosette</a> (OpenAI).</p>
<div id="2bf2d2dd" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb3"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a><span class="co"># litellm._turn_on_debug()</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<div id="25a6f62b" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb4"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a>ms <span class="op">=</span> [<span class="st">"gemini/gemini-3-pro-preview"</span>, <span class="st">"gemini/gemini-3-flash-preview"</span>, <span class="st">"claude-opus-4-6"</span>, <span class="st">"openai/gpt-4.1"</span>]</span>
<span id="cb4-2"><a href="#cb4-2" aria-hidden="true" tabindex="-1"></a>msg <span class="op">=</span> [{<span class="st">'role'</span>:<span class="st">'user'</span>,<span class="st">'content'</span>:<span class="st">'Hey there!'</span>, <span class="st">'cache_control'</span>: {<span class="st">'type'</span>: <span class="st">'ephemeral'</span>}}]</span>
<span id="cb4-3"><a href="#cb4-3" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> m <span class="kw">in</span> ms:</span>
<span id="cb4-4"><a href="#cb4-4" aria-hidden="true" tabindex="-1"></a>    display(Markdown(<span class="ss">f'**</span><span class="sc">{</span>m<span class="sc">}</span><span class="ss">:**'</span>))</span>
<span id="cb4-5"><a href="#cb4-5" aria-hidden="true" tabindex="-1"></a>    display(completion(m,msg))</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display cell-output-markdown">
<div class="prose">
<p><strong>gemini/gemini-3-pro-preview:</strong></p>
</div>
</div>
<div class="cell-output cell-output-display cell-output-markdown">
<p><strong>Hi! How are you doing today?</strong></p>
<p>Iâ€™m ready to help with whatever you needâ€”whether itâ€™s writing, answering questions, brainstorming ideas, or just chatting. Whatâ€™s on your mind?</p>
<details>
<ul>
<li>id: <code>chatcmpl-xxx</code></li>
<li>model: <code>gemini-3-pro-preview</code></li>
<li>finish_reason: <code>stop</code></li>
<li>usage: <code>Usage(completion_tokens=152, prompt_tokens=4, total_tokens=156, completion_tokens_details=CompletionTokensDetailsWrapper(accepted_prediction_tokens=None, audio_tokens=None, reasoning_tokens=107, rejected_prediction_tokens=None, text_tokens=45, image_tokens=None), prompt_tokens_details=PromptTokensDetailsWrapper(audio_tokens=None, cached_tokens=None, text_tokens=4, image_tokens=None), cache_read_input_tokens=None)</code></li>
</ul>
</details>
</div>
<div class="cell-output cell-output-display cell-output-markdown">
<div class="prose">
<p><strong>gemini/gemini-3-flash-preview:</strong></p>
</div>
</div>
<div class="cell-output cell-output-display cell-output-markdown">
<p>Hello! How can I help you today?</p>
<details>
<ul>
<li>id: <code>chatcmpl-xxx</code></li>
<li>model: <code>gemini-3-flash-preview</code></li>
<li>finish_reason: <code>stop</code></li>
<li>usage: <code>Usage(completion_tokens=9, prompt_tokens=4, total_tokens=13, completion_tokens_details=CompletionTokensDetailsWrapper(accepted_prediction_tokens=None, audio_tokens=None, reasoning_tokens=None, rejected_prediction_tokens=None, text_tokens=9, image_tokens=None), prompt_tokens_details=PromptTokensDetailsWrapper(audio_tokens=None, cached_tokens=None, text_tokens=4, image_tokens=None), cache_read_input_tokens=None)</code></li>
</ul>
</details>
</div>
<div class="cell-output cell-output-display cell-output-markdown">
<div class="prose">
<p><strong>claude-opus-4-6:</strong></p>
</div>
</div>
<div class="cell-output cell-output-display cell-output-markdown">
<p>Hey there! ðŸ‘‹ Howâ€™s it going? What can I help you with today?</p>
<details>
<ul>
<li>id: <code>chatcmpl-xxx</code></li>
<li>model: <code>claude-opus-4-6</code></li>
<li>finish_reason: <code>stop</code></li>
<li>usage: <code>Usage(completion_tokens=23, prompt_tokens=10, total_tokens=33, completion_tokens_details=CompletionTokensDetailsWrapper(accepted_prediction_tokens=None, audio_tokens=None, reasoning_tokens=0, rejected_prediction_tokens=None, text_tokens=23, image_tokens=None), prompt_tokens_details=PromptTokensDetailsWrapper(audio_tokens=None, cached_tokens=0, text_tokens=None, image_tokens=None, cache_creation_tokens=0, cache_creation_token_details=CacheCreationTokenDetails(ephemeral_5m_input_tokens=0, ephemeral_1h_input_tokens=0)), cache_creation_input_tokens=0, cache_read_input_tokens=0, inference_geo='global', speed=None)</code></li>
</ul>
</details>
</div>
<div class="cell-output cell-output-display cell-output-markdown">
<div class="prose">
<p><strong>openai/gpt-4.1:</strong></p>
</div>
</div>
<div class="cell-output cell-output-display cell-output-markdown">
<p>Hello! How can I help you today? ðŸ˜Š</p>
<details>
<ul>
<li>id: <code>chatcmpl-xxx</code></li>
<li>model: <code>gpt-4.1-2025-04-14</code></li>
<li>finish_reason: <code>stop</code></li>
<li>usage: <code>Usage(completion_tokens=10, prompt_tokens=10, total_tokens=20, completion_tokens_details=CompletionTokensDetailsWrapper(accepted_prediction_tokens=0, audio_tokens=0, reasoning_tokens=0, rejected_prediction_tokens=0, text_tokens=None, image_tokens=None), prompt_tokens_details=PromptTokensDetailsWrapper(audio_tokens=0, cached_tokens=0, text_tokens=None, image_tokens=None))</code></li>
</ul>
</details>
</div>
</div>
<p>Generated images are also displayed (not shown here to conserve filesize):</p>
<div id="e6a027b4" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb5"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a><span class="co"># completion(model='gemini/gemini-2.5-flash-image', messages=[{'role':'user','content':'Draw a simple sketch of a cat'}])</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
</section>
<section id="messages-formatting" class="level2">
<h2 class="anchored" data-anchor-id="messages-formatting">Messages formatting</h2>
<p>Letâ€™s start with making it easier to pass messages into litellmâ€™s <code>completion</code> function (including images, and pdf files).</p>
<p>If <code>msg</code> has <code>tool_calls</code>, <code>cache_control</code> is added to the last tool call (required since LiteLLM strips it from empty content blocks), otherwise to the content.</p>
<hr>
<p><a href="https://github.com/AnswerDotAI/lisette/blob/main/lisette/core.py#L146" target="_blank" style="float:right; font-size:smaller">source</a></p>
<section id="stop_reason" class="level3">
<h3 class="anchored" data-anchor-id="stop_reason">stop_reason</h3>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb6"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-2"><a href="#cb6-2" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> stop_reason(</span>
<span id="cb6-3"><a href="#cb6-3" aria-hidden="true" tabindex="-1"></a>    r</span>
<span id="cb6-4"><a href="#cb6-4" aria-hidden="true" tabindex="-1"></a>):</span>
<span id="cb6-5"><a href="#cb6-5" aria-hidden="true" tabindex="-1"></a></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<hr>
<p><a href="https://github.com/AnswerDotAI/lisette/blob/main/lisette/core.py#L141" target="_blank" style="float:right; font-size:smaller">source</a></p>
</section>
<section id="contents" class="level3">
<h3 class="anchored" data-anchor-id="contents">contents</h3>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb7"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-2"><a href="#cb7-2" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> contents(</span>
<span id="cb7-3"><a href="#cb7-3" aria-hidden="true" tabindex="-1"></a>    r</span>
<span id="cb7-4"><a href="#cb7-4" aria-hidden="true" tabindex="-1"></a>):</span>
<span id="cb7-5"><a href="#cb7-5" aria-hidden="true" tabindex="-1"></a></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<p><em>Get message object from response <code>r</code>.</em></p>
<hr>
<p><a href="https://github.com/AnswerDotAI/lisette/blob/main/lisette/core.py#L126" target="_blank" style="float:right; font-size:smaller">source</a></p>
</section>
<section id="remove_cache_ckpts" class="level3">
<h3 class="anchored" data-anchor-id="remove_cache_ckpts">remove_cache_ckpts</h3>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb8"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-2"><a href="#cb8-2" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> remove_cache_ckpts(</span>
<span id="cb8-3"><a href="#cb8-3" aria-hidden="true" tabindex="-1"></a>    msg</span>
<span id="cb8-4"><a href="#cb8-4" aria-hidden="true" tabindex="-1"></a>):</span>
<span id="cb8-5"><a href="#cb8-5" aria-hidden="true" tabindex="-1"></a></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<p><em>remove cache checkpoints and return msg.</em></p>
<p>Test with regular content message:</p>
<div id="57ea44f5" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb9"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a>msg_content <span class="op">=</span> {<span class="st">'role'</span>: <span class="st">'user'</span>, <span class="st">'content'</span>: [{<span class="st">'type'</span>: <span class="st">'text'</span>, <span class="st">'text'</span>: <span class="st">'hello'</span>}]}</span>
<span id="cb9-2"><a href="#cb9-2" aria-hidden="true" tabindex="-1"></a>_add_cache_control(msg_content)</span>
<span id="cb9-3"><a href="#cb9-3" aria-hidden="true" tabindex="-1"></a>test_eq(msg_content[<span class="st">'content'</span>][<span class="op">-</span><span class="dv">1</span>].get(<span class="st">'cache_control'</span>), {<span class="st">'type'</span>: <span class="st">'ephemeral'</span>})</span>
<span id="cb9-4"><a href="#cb9-4" aria-hidden="true" tabindex="-1"></a>test_eq(_has_cache(msg_content), <span class="va">True</span>)</span>
<span id="cb9-5"><a href="#cb9-5" aria-hidden="true" tabindex="-1"></a>remove_cache_ckpts(msg_content)</span>
<span id="cb9-6"><a href="#cb9-6" aria-hidden="true" tabindex="-1"></a>test_eq(_has_cache(msg_content), <span class="va">False</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<p>Test with assistant message with tool_calls:</p>
<div id="2dd1da17" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb10"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a>tcs <span class="op">=</span> [</span>
<span id="cb10-2"><a href="#cb10-2" aria-hidden="true" tabindex="-1"></a>    {<span class="st">'id'</span>: <span class="st">'tc1'</span>, <span class="st">'type'</span>: <span class="st">'function'</span>, <span class="st">'function'</span>: {<span class="st">'name'</span>: <span class="st">'test'</span>, <span class="st">'arguments'</span>: <span class="st">'</span><span class="sc">{}</span><span class="st">'</span>}},</span>
<span id="cb10-3"><a href="#cb10-3" aria-hidden="true" tabindex="-1"></a>    {<span class="st">'id'</span>: <span class="st">'tc2'</span>, <span class="st">'type'</span>: <span class="st">'function'</span>, <span class="st">'function'</span>: {<span class="st">'name'</span>: <span class="st">'test'</span>, <span class="st">'arguments'</span>: <span class="st">'</span><span class="sc">{}</span><span class="st">'</span>}}</span>
<span id="cb10-4"><a href="#cb10-4" aria-hidden="true" tabindex="-1"></a>]</span>
<span id="cb10-5"><a href="#cb10-5" aria-hidden="true" tabindex="-1"></a>msg_tool <span class="op">=</span> {<span class="st">'role'</span>: <span class="st">'assistant'</span>, <span class="st">'content'</span>: <span class="st">''</span>, <span class="st">'tool_calls'</span>: tcs}</span>
<span id="cb10-6"><a href="#cb10-6" aria-hidden="true" tabindex="-1"></a>_add_cache_control(msg_tool)</span>
<span id="cb10-7"><a href="#cb10-7" aria-hidden="true" tabindex="-1"></a>test_eq(msg_tool[<span class="st">'tool_calls'</span>][<span class="op">-</span><span class="dv">1</span>].get(<span class="st">'cache_control'</span>), {<span class="st">'type'</span>: <span class="st">'ephemeral'</span>})</span>
<span id="cb10-8"><a href="#cb10-8" aria-hidden="true" tabindex="-1"></a>test_eq(<span class="st">'cache_control'</span> <span class="kw">not</span> <span class="kw">in</span> msg_tool.get(<span class="st">'content'</span>, [{}])[<span class="op">-</span><span class="dv">1</span>] <span class="cf">if</span> msg_tool.get(<span class="st">'content'</span>) <span class="cf">else</span> <span class="va">True</span>, <span class="va">True</span>)  <span class="co"># no cache in content</span></span>
<span id="cb10-9"><a href="#cb10-9" aria-hidden="true" tabindex="-1"></a>test_eq(_has_cache(msg_tool), <span class="va">True</span>)</span>
<span id="cb10-10"><a href="#cb10-10" aria-hidden="true" tabindex="-1"></a>remove_cache_ckpts(msg_tool)</span>
<span id="cb10-11"><a href="#cb10-11" aria-hidden="true" tabindex="-1"></a>test_eq(_has_cache(msg_tool), <span class="va">False</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<p>Test with <code>ChatCompletionMessageToolCall</code> tool call object:</p>
<div id="bbd5cae3" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb11"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true" tabindex="-1"></a>tcs <span class="op">=</span>[</span>
<span id="cb11-2"><a href="#cb11-2" aria-hidden="true" tabindex="-1"></a>    ChatCompletionMessageToolCall(<span class="bu">id</span><span class="op">=</span><span class="st">'tc1'</span>, <span class="bu">type</span><span class="op">=</span><span class="st">'function'</span>, function<span class="op">=</span>Function(name<span class="op">=</span><span class="st">'test'</span>, arguments<span class="op">=</span><span class="st">'</span><span class="sc">{}</span><span class="st">'</span>)), </span>
<span id="cb11-3"><a href="#cb11-3" aria-hidden="true" tabindex="-1"></a>    ChatCompletionMessageToolCall(<span class="bu">id</span><span class="op">=</span><span class="st">'tc2'</span>, <span class="bu">type</span><span class="op">=</span><span class="st">'function'</span>, function<span class="op">=</span>Function(name<span class="op">=</span><span class="st">'test'</span>, arguments<span class="op">=</span><span class="st">'</span><span class="sc">{}</span><span class="st">'</span>))</span>
<span id="cb11-4"><a href="#cb11-4" aria-hidden="true" tabindex="-1"></a>]</span>
<span id="cb11-5"><a href="#cb11-5" aria-hidden="true" tabindex="-1"></a>msg_tc_obj <span class="op">=</span> {<span class="st">'role'</span>: <span class="st">'assistant'</span>, <span class="st">'content'</span>: <span class="st">''</span>, <span class="st">'tool_calls'</span>: tcs}</span>
<span id="cb11-6"><a href="#cb11-6" aria-hidden="true" tabindex="-1"></a>_add_cache_control(msg_tc_obj)</span>
<span id="cb11-7"><a href="#cb11-7" aria-hidden="true" tabindex="-1"></a>test_eq(<span class="bu">getattr</span>(msg_tc_obj[<span class="st">'tool_calls'</span>][<span class="op">-</span><span class="dv">1</span>], <span class="st">'cache_control'</span>, <span class="va">None</span>), {<span class="st">'type'</span>: <span class="st">'ephemeral'</span>})</span>
<span id="cb11-8"><a href="#cb11-8" aria-hidden="true" tabindex="-1"></a>test_eq(_has_cache(msg_tc_obj), <span class="va">True</span>)</span>
<span id="cb11-9"><a href="#cb11-9" aria-hidden="true" tabindex="-1"></a>remove_cache_ckpts(msg_tc_obj)</span>
<span id="cb11-10"><a href="#cb11-10" aria-hidden="true" tabindex="-1"></a>test_eq(_has_cache(msg_tc_obj), <span class="va">False</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<hr>
<p><a href="https://github.com/AnswerDotAI/lisette/blob/main/lisette/core.py#L151" target="_blank" style="float:right; font-size:smaller">source</a></p>
</section>
<section id="mk_msg" class="level3">
<h3 class="anchored" data-anchor-id="mk_msg">mk_msg</h3>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb12"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb12-1"><a href="#cb12-1" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-2"><a href="#cb12-2" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> mk_msg(</span>
<span id="cb12-3"><a href="#cb12-3" aria-hidden="true" tabindex="-1"></a>    content, <span class="co"># Content: str, bytes (image), list of mixed content, or dict w 'role' and 'content' fields</span></span>
<span id="cb12-4"><a href="#cb12-4" aria-hidden="true" tabindex="-1"></a>    role:<span class="bu">str</span><span class="op">=</span><span class="st">'user'</span>, <span class="co"># Message role if content isn't already a dict/Message</span></span>
<span id="cb12-5"><a href="#cb12-5" aria-hidden="true" tabindex="-1"></a>    cache:<span class="bu">bool</span><span class="op">=</span><span class="va">False</span>, <span class="co"># Enable Anthropic caching</span></span>
<span id="cb12-6"><a href="#cb12-6" aria-hidden="true" tabindex="-1"></a>    ttl:NoneType<span class="op">=</span><span class="va">None</span>, <span class="co"># Cache TTL: '5m' (default) or '1h'</span></span>
<span id="cb12-7"><a href="#cb12-7" aria-hidden="true" tabindex="-1"></a>):</span>
<span id="cb12-8"><a href="#cb12-8" aria-hidden="true" tabindex="-1"></a></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<p><em>Create a LiteLLM compatible message.</em></p>
<p>Now we can use mk_msg to create different types of messages.</p>
<p>Simple text:</p>
<div id="f6217f4b" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb13"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb13-1"><a href="#cb13-1" aria-hidden="true" tabindex="-1"></a>msg <span class="op">=</span> mk_msg(<span class="st">"hey"</span>)</span>
<span id="cb13-2"><a href="#cb13-2" aria-hidden="true" tabindex="-1"></a>msg</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display">
<pre><code>{'role': 'user', 'content': 'hey'}</code></pre>
</div>
</div>
<p>Which can be passed to litellmâ€™s <code>completion</code> function like this:</p>
<div id="cb1295ac" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb15"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb15-1"><a href="#cb15-1" aria-hidden="true" tabindex="-1"></a>model <span class="op">=</span> ms[<span class="dv">1</span>] <span class="co"># use 2.5-pro, 3-pro is very slow even to run tests as of making</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<div id="2a28656f" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb16"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb16-1"><a href="#cb16-1" aria-hidden="true" tabindex="-1"></a>res <span class="op">=</span> completion(model, [msg])</span>
<span id="cb16-2"><a href="#cb16-2" aria-hidden="true" tabindex="-1"></a>res</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display cell-output-markdown">
<p>Hey there! How can I help you today?</p>
<details>
<ul>
<li>id: <code>chatcmpl-xxx</code></li>
<li>model: <code>gemini-3-flash-preview</code></li>
<li>finish_reason: <code>stop</code></li>
<li>usage: <code>Usage(completion_tokens=10, prompt_tokens=2, total_tokens=12, completion_tokens_details=CompletionTokensDetailsWrapper(accepted_prediction_tokens=None, audio_tokens=None, reasoning_tokens=None, rejected_prediction_tokens=None, text_tokens=10, image_tokens=None), prompt_tokens_details=PromptTokensDetailsWrapper(audio_tokens=None, cached_tokens=None, text_tokens=2, image_tokens=None), cache_read_input_tokens=None)</code></li>
</ul>
</details>
</div>
</div>
<p>Weâ€™ll add a little shortcut to make examples and testing easier here:</p>
<div id="a0d8df32" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb17"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb17-1"><a href="#cb17-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> c(msgs, m<span class="op">=</span>model, <span class="op">**</span>kw):</span>
<span id="cb17-2"><a href="#cb17-2" aria-hidden="true" tabindex="-1"></a>    msgs <span class="op">=</span> [msgs] <span class="cf">if</span> <span class="bu">isinstance</span>(msgs,<span class="bu">dict</span>) <span class="cf">else</span> listify(msgs)</span>
<span id="cb17-3"><a href="#cb17-3" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> completion(m, msgs, <span class="op">**</span>kw)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<div id="4f0186ff" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb18"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb18-1"><a href="#cb18-1" aria-hidden="true" tabindex="-1"></a>c(msg)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display cell-output-markdown">
<p>Hey there! How can I help you today?</p>
<details>
<ul>
<li>id: <code>chatcmpl-xxx</code></li>
<li>model: <code>gemini-3-flash-preview</code></li>
<li>finish_reason: <code>stop</code></li>
<li>usage: <code>Usage(completion_tokens=10, prompt_tokens=2, total_tokens=12, completion_tokens_details=CompletionTokensDetailsWrapper(accepted_prediction_tokens=None, audio_tokens=None, reasoning_tokens=None, rejected_prediction_tokens=None, text_tokens=10, image_tokens=None), prompt_tokens_details=PromptTokensDetailsWrapper(audio_tokens=None, cached_tokens=None, text_tokens=2, image_tokens=None), cache_read_input_tokens=None)</code></li>
</ul>
</details>
</div>
</div>
<p>Lists w just one string element are flattened for conciseness:</p>
<div id="c1a0955a" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb19"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb19-1"><a href="#cb19-1" aria-hidden="true" tabindex="-1"></a>test_eq(mk_msg(<span class="st">"hey"</span>), mk_msg([<span class="st">"hey"</span>]))</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<p>(LiteLLM ignores these fields when sent to other providers)</p>
<p>Text and images:</p>
<div id="923e6c93" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb20"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb20-1"><a href="#cb20-1" aria-hidden="true" tabindex="-1"></a>img_fn <span class="op">=</span> Path(<span class="st">'samples/puppy.jpg'</span>)</span>
<span id="cb20-2"><a href="#cb20-2" aria-hidden="true" tabindex="-1"></a>Image(filename<span class="op">=</span>img_fn, width<span class="op">=</span><span class="dv">200</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="00_core_files/figure-html/cell-20-output-1.jpeg" class="img-fluid figure-img" width="200"></p>
</figure>
</div>
</div>
</div>
<div id="60bb0ee7" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb21"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb21-1"><a href="#cb21-1" aria-hidden="true" tabindex="-1"></a>msg <span class="op">=</span> mk_msg([<span class="st">'hey what in this image?'</span>,img_fn.read_bytes()])</span>
<span id="cb21-2"><a href="#cb21-2" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(json.dumps(msg,indent<span class="op">=</span><span class="dv">1</span>)[:<span class="dv">200</span>]<span class="op">+</span><span class="st">"..."</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>{
 "role": "user",
 "content": [
  {
   "type": "text",
   "text": "hey what in this image?"
  },
  {
   "type": "image_url",
   "image_url": "data:image/jpeg;base64,/9j/4AAQSkZJRgABAQAAAQABAAD/4gxUSU...</code></pre>
</div>
</div>
<div id="b9ebb192" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb23"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb23-1"><a href="#cb23-1" aria-hidden="true" tabindex="-1"></a>c(msg)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display cell-output-markdown">
<p>This image features a close-up of a brown and white Cavalier King Charles Spaniel puppy lying in the grass next to a bush of purple flowers. The puppy has long, floppy ears and dark, soulful eyes, looking directly at the camera. The background is slightly blurred, focusing attention on the puppyâ€™s face and paws.</p>
<details>
<ul>
<li>id: <code>chatcmpl-xxx</code></li>
<li>model: <code>gemini-3-flash-preview</code></li>
<li>finish_reason: <code>stop</code></li>
<li>usage: <code>Usage(completion_tokens=67, prompt_tokens=1087, total_tokens=1154, completion_tokens_details=CompletionTokensDetailsWrapper(accepted_prediction_tokens=None, audio_tokens=None, reasoning_tokens=None, rejected_prediction_tokens=None, text_tokens=67, image_tokens=None), prompt_tokens_details=PromptTokensDetailsWrapper(audio_tokens=None, cached_tokens=None, text_tokens=7, image_tokens=1080), cache_read_input_tokens=None)</code></li>
</ul>
</details>
</div>
</div>
<p>Letâ€™s also demonstrate this for PDFs</p>
<div id="8160351e" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb24"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb24-1"><a href="#cb24-1" aria-hidden="true" tabindex="-1"></a>pdf_fn <span class="op">=</span> Path(<span class="st">'samples/solveit.pdf'</span>)</span>
<span id="cb24-2"><a href="#cb24-2" aria-hidden="true" tabindex="-1"></a>msg <span class="op">=</span> mk_msg([<span class="st">'Who is the author of this pdf?'</span>, pdf_fn.read_bytes()])</span>
<span id="cb24-3"><a href="#cb24-3" aria-hidden="true" tabindex="-1"></a>c(msg)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display cell-output-markdown">
<p>Based on the text in the document, the author is <strong>Jeremy Howard</strong>, a co-founder of <strong>fast.ai</strong>.</p>
<details>
<ul>
<li>id: <code>chatcmpl-xxx</code></li>
<li>model: <code>gemini-3-flash-preview</code></li>
<li>finish_reason: <code>stop</code></li>
<li>usage: <code>Usage(completion_tokens=25, prompt_tokens=541, total_tokens=566, completion_tokens_details=CompletionTokensDetailsWrapper(accepted_prediction_tokens=None, audio_tokens=None, reasoning_tokens=None, rejected_prediction_tokens=None, text_tokens=25, image_tokens=None), prompt_tokens_details=PromptTokensDetailsWrapper(audio_tokens=None, cached_tokens=None, text_tokens=9, image_tokens=532), cache_read_input_tokens=None)</code></li>
</ul>
</details>
</div>
</div>
<p>Some models like Gemini support audio and video:</p>
<div id="38313733" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb25"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb25-1"><a href="#cb25-1" aria-hidden="true" tabindex="-1"></a>wav_data <span class="op">=</span> httpx.get(<span class="st">"https://openaiassets.blob.core.windows.net/$web/API/docs/audio/alloy.wav"</span>).content</span>
<span id="cb25-2"><a href="#cb25-2" aria-hidden="true" tabindex="-1"></a><span class="co"># Audio(wav_data)  # uncomment to preview</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<div id="d75a81fa" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb26"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb26-1"><a href="#cb26-1" aria-hidden="true" tabindex="-1"></a>msg <span class="op">=</span> mk_msg([<span class="st">'What is this audio saying?'</span>, wav_data])</span>
<span id="cb26-2"><a href="#cb26-2" aria-hidden="true" tabindex="-1"></a>completion(ms[<span class="dv">1</span>], [msg])</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display cell-output-markdown">
<p>The audio says: â€œThe sun rises in the east and sets in the west. This simple fact has been observed by humans for thousands of years.â€</p>
<details>
<ul>
<li>id: <code>chatcmpl-xxx</code></li>
<li>model: <code>gemini-3-flash-preview</code></li>
<li>finish_reason: <code>stop</code></li>
<li>usage: <code>Usage(completion_tokens=30, prompt_tokens=181, total_tokens=211, completion_tokens_details=CompletionTokensDetailsWrapper(accepted_prediction_tokens=None, audio_tokens=None, reasoning_tokens=None, rejected_prediction_tokens=None, text_tokens=30, image_tokens=None), prompt_tokens_details=PromptTokensDetailsWrapper(audio_tokens=174, cached_tokens=None, text_tokens=7, image_tokens=None), cache_read_input_tokens=None)</code></li>
</ul>
</details>
</div>
</div>
<div id="10b32b23" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb27"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb27-1"><a href="#cb27-1" aria-hidden="true" tabindex="-1"></a>vid_data <span class="op">=</span> httpx.get(<span class="st">"https://storage.googleapis.com/github-repo/img/gemini/multimodality_usecases_overview/pixel8.mp4"</span>).content</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<div id="e904bf9c" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb28"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb28-1"><a href="#cb28-1" aria-hidden="true" tabindex="-1"></a>msg <span class="op">=</span> mk_msg([<span class="st">'Concisely, what is happening in this video?'</span>, vid_data])</span>
<span id="cb28-2"><a href="#cb28-2" aria-hidden="true" tabindex="-1"></a>completion(ms[<span class="dv">1</span>], [msg])</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display cell-output-markdown">
<p>A photographer showcases the Google Pixel 8 Proâ€™s new â€œVideo Boostâ€ feature by capturing nighttime scenes in Tokyo, including areas like Sancha and Shibuya. The video demonstrates the phoneâ€™s ability to enhance low-light video quality using â€œNight Sight,â€ resulting in bright, clear, and detailed footage of the cityâ€™s streets and alleys.</p>
<details>
<ul>
<li>id: <code>chatcmpl-xxx</code></li>
<li>model: <code>gemini-3-flash-preview</code></li>
<li>finish_reason: <code>stop</code></li>
<li>usage: <code>Usage(completion_tokens=70, prompt_tokens=5205, total_tokens=5275, completion_tokens_details=CompletionTokensDetailsWrapper(accepted_prediction_tokens=None, audio_tokens=None, reasoning_tokens=None, rejected_prediction_tokens=None, text_tokens=70, image_tokens=None), prompt_tokens_details=PromptTokensDetailsWrapper(audio_tokens=None, cached_tokens=None, text_tokens=12, image_tokens=None), cache_read_input_tokens=None)</code></li>
</ul>
</details>
</div>
</div>
</section>
<section id="caching" class="level3">
<h3 class="anchored" data-anchor-id="caching">Caching</h3>
<p>Some providers such as Anthropic require manually opting into caching. Letâ€™s try it:</p>
<div id="e42ad26b" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb29"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb29-1"><a href="#cb29-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> cpr(i): <span class="cf">return</span> <span class="ss">f'</span><span class="sc">{</span>i<span class="sc">}</span><span class="ss"> '</span><span class="op">*</span><span class="dv">1024</span> <span class="op">+</span> <span class="st">'This is a caching test. Report back only what number you see repeated above.'</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<div id="70b7f481" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb30"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb30-1"><a href="#cb30-1" aria-hidden="true" tabindex="-1"></a>disable_cachy()</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<div id="84103a63" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb31"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb31-1"><a href="#cb31-1" aria-hidden="true" tabindex="-1"></a><span class="co"># msg = mk_msg(cpr(1), cache=True)</span></span>
<span id="cb31-2"><a href="#cb31-2" aria-hidden="true" tabindex="-1"></a><span class="co"># res = c(msg, ms[2])</span></span>
<span id="cb31-3"><a href="#cb31-3" aria-hidden="true" tabindex="-1"></a><span class="co"># res</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<p>Anthropic has a maximum of 4 cache checkpoints, so we remove previous ones as we go:</p>
<div id="220ab7b9" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb32"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb32-1"><a href="#cb32-1" aria-hidden="true" tabindex="-1"></a><span class="co"># res = c([remove_cache_ckpts(msg), mk_msg(res), mk_msg(cpr(2), cache=True)], ms[2])</span></span>
<span id="cb32-2"><a href="#cb32-2" aria-hidden="true" tabindex="-1"></a><span class="co"># res</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<p>We see that the first message was cached, and this extra message has been written to cache:</p>
<div id="e1c7e395" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb33"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb33-1"><a href="#cb33-1" aria-hidden="true" tabindex="-1"></a><span class="co"># res.usage.prompt_tokens_details</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<p>We can add a bunch of large messages in a loop to see how the number of cached tokens used grows.</p>
<p>We do this for 25 times to ensure it still works for more than &gt;20 content blocks, <a href="https://docs.claude.com/en/docs/build-with-claude/prompt-caching">which is a known anthropic issue</a>.</p>
<p>The code below is commented by default, because itâ€™s slow. Please uncomment when working on caching.</p>
<div id="ebf0f771" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb34"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb34-1"><a href="#cb34-1" aria-hidden="true" tabindex="-1"></a><span class="co"># h = []</span></span>
<span id="cb34-2"><a href="#cb34-2" aria-hidden="true" tabindex="-1"></a><span class="co"># msg = mk_msg(cpr(1), cache=True)</span></span>
<span id="cb34-3"><a href="#cb34-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb34-4"><a href="#cb34-4" aria-hidden="true" tabindex="-1"></a><span class="co"># for o in range(2,25):</span></span>
<span id="cb34-5"><a href="#cb34-5" aria-hidden="true" tabindex="-1"></a><span class="co">#     h += [remove_cache_ckpts(msg), mk_msg(res)]</span></span>
<span id="cb34-6"><a href="#cb34-6" aria-hidden="true" tabindex="-1"></a><span class="co">#     msg = mk_msg(cpr(o), cache=True)</span></span>
<span id="cb34-7"><a href="#cb34-7" aria-hidden="true" tabindex="-1"></a><span class="co">#     res = c(h+[msg])</span></span>
<span id="cb34-8"><a href="#cb34-8" aria-hidden="true" tabindex="-1"></a><span class="co">#     detls = res.usage.prompt_tokens_details</span></span>
<span id="cb34-9"><a href="#cb34-9" aria-hidden="true" tabindex="-1"></a><span class="co">#     print(o, detls.cached_tokens, detls.cache_creation_tokens, end='; ')</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<div id="197632a3" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb35"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb35-1"><a href="#cb35-1" aria-hidden="true" tabindex="-1"></a>enable_cachy()</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
</section>
<section id="reconstructing-formatted-outputs" class="level3">
<h3 class="anchored" data-anchor-id="reconstructing-formatted-outputs">Reconstructing formatted outputs</h3>
<p>Lisette can call multiple tools in a loop. Further down this notebook, weâ€™ll provide convenience functions for formatting such a sequence of toolcalls and responses into one formatted output string.</p>
<p>For now, weâ€™ll show an example and show how to transform such a formatted output string back into a valid LiteLLM history.</p>
<div id="9ee01a18" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb36"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb36-1"><a href="#cb36-1" aria-hidden="true" tabindex="-1"></a>fmt_outp <span class="op">=</span> <span class="st">'''</span></span>
<span id="cb36-2"><a href="#cb36-2" aria-hidden="true" tabindex="-1"></a><span class="st">I'll solve this step-by-step, using parallel calls where possible.</span></span>
<span id="cb36-3"><a href="#cb36-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-4"><a href="#cb36-4" aria-hidden="true" tabindex="-1"></a><span class="st">&lt;details class='tool-usage-details'&gt;</span></span>
<span id="cb36-5"><a href="#cb36-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-6"><a href="#cb36-6" aria-hidden="true" tabindex="-1"></a><span class="st">```json</span></span>
<span id="cb36-7"><a href="#cb36-7" aria-hidden="true" tabindex="-1"></a><span class="st">{</span></span>
<span id="cb36-8"><a href="#cb36-8" aria-hidden="true" tabindex="-1"></a><span class="st">  "id": "toolu_01KjnQH2Nsz2viQ7XYpLW3Ta",</span></span>
<span id="cb36-9"><a href="#cb36-9" aria-hidden="true" tabindex="-1"></a><span class="st">  "call": { "function": "simple_add", "arguments": { "a": 10, "b": 5 } },</span></span>
<span id="cb36-10"><a href="#cb36-10" aria-hidden="true" tabindex="-1"></a><span class="st">  "result": "15"</span></span>
<span id="cb36-11"><a href="#cb36-11" aria-hidden="true" tabindex="-1"></a><span class="st">}</span></span>
<span id="cb36-12"><a href="#cb36-12" aria-hidden="true" tabindex="-1"></a><span class="st">```</span></span>
<span id="cb36-13"><a href="#cb36-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-14"><a href="#cb36-14" aria-hidden="true" tabindex="-1"></a><span class="st">&lt;/details&gt;</span></span>
<span id="cb36-15"><a href="#cb36-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-16"><a href="#cb36-16" aria-hidden="true" tabindex="-1"></a><span class="st">&lt;details class='tool-usage-details'&gt;</span></span>
<span id="cb36-17"><a href="#cb36-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-18"><a href="#cb36-18" aria-hidden="true" tabindex="-1"></a><span class="st">```json</span></span>
<span id="cb36-19"><a href="#cb36-19" aria-hidden="true" tabindex="-1"></a><span class="st">{</span></span>
<span id="cb36-20"><a href="#cb36-20" aria-hidden="true" tabindex="-1"></a><span class="st">  "id": "toolu_01Koi2EZrGZsBbnQ13wuuvzY",</span></span>
<span id="cb36-21"><a href="#cb36-21" aria-hidden="true" tabindex="-1"></a><span class="st">  "call": { "function": "simple_add", "arguments": { "a": 2, "b": 1 } },</span></span>
<span id="cb36-22"><a href="#cb36-22" aria-hidden="true" tabindex="-1"></a><span class="st">  "result": "3"</span></span>
<span id="cb36-23"><a href="#cb36-23" aria-hidden="true" tabindex="-1"></a><span class="st">}</span></span>
<span id="cb36-24"><a href="#cb36-24" aria-hidden="true" tabindex="-1"></a><span class="st">```</span></span>
<span id="cb36-25"><a href="#cb36-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-26"><a href="#cb36-26" aria-hidden="true" tabindex="-1"></a><span class="st">&lt;/details&gt;</span></span>
<span id="cb36-27"><a href="#cb36-27" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-28"><a href="#cb36-28" aria-hidden="true" tabindex="-1"></a><span class="st">Now I need to multiply 15 * 3 before I can do the final division:</span></span>
<span id="cb36-29"><a href="#cb36-29" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-30"><a href="#cb36-30" aria-hidden="true" tabindex="-1"></a><span class="st">&lt;details class='tool-usage-details'&gt;</span></span>
<span id="cb36-31"><a href="#cb36-31" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-32"><a href="#cb36-32" aria-hidden="true" tabindex="-1"></a><span class="st">```json</span></span>
<span id="cb36-33"><a href="#cb36-33" aria-hidden="true" tabindex="-1"></a><span class="st">{</span></span>
<span id="cb36-34"><a href="#cb36-34" aria-hidden="true" tabindex="-1"></a><span class="st">  "id": "toolu_0141NRaWUjmGtwxZjWkyiq6C",</span></span>
<span id="cb36-35"><a href="#cb36-35" aria-hidden="true" tabindex="-1"></a><span class="st">  "call": { "function": "multiply", "arguments": { "a": 15, "b": 3 } },</span></span>
<span id="cb36-36"><a href="#cb36-36" aria-hidden="true" tabindex="-1"></a><span class="st">  "result": "45"</span></span>
<span id="cb36-37"><a href="#cb36-37" aria-hidden="true" tabindex="-1"></a><span class="st">}</span></span>
<span id="cb36-38"><a href="#cb36-38" aria-hidden="true" tabindex="-1"></a><span class="st">```</span></span>
<span id="cb36-39"><a href="#cb36-39" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-40"><a href="#cb36-40" aria-hidden="true" tabindex="-1"></a><span class="st">&lt;/details&gt;</span></span>
<span id="cb36-41"><a href="#cb36-41" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-42"><a href="#cb36-42" aria-hidden="true" tabindex="-1"></a><span class="st">&lt;details class='token-usage-details'&gt;&lt;summary&gt;Cache hit: 81.8% | Tokens: total=23,276 input=23,158 (+18,910 cached, 0 new) output=118 (reasoning 23)&lt;/summary&gt;</span></span>
<span id="cb36-43"><a href="#cb36-43" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-44"><a href="#cb36-44" aria-hidden="true" tabindex="-1"></a><span class="st">`Usage(completion_tokens=118, prompt_tokens=23158, total_tokens=23276, completion_tokens_details=CompletionTokensDetailsWrapper(accepted_prediction_tokens=None, audio_tokens=None, reasoning_tokens=23, rejected_prediction_tokens=None, text_tokens=None, image_tokens=None), prompt_tokens_details=PromptTokensDetailsWrapper(audio_tokens=None, cached_tokens=18910, text_tokens=None, image_tokens=None, cache_creation_tokens=0), cache_creation_input_tokens=0, cache_read_input_tokens=18910)`</span></span>
<span id="cb36-45"><a href="#cb36-45" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-46"><a href="#cb36-46" aria-hidden="true" tabindex="-1"></a><span class="st">&lt;/details&gt;</span></span>
<span id="cb36-47"><a href="#cb36-47" aria-hidden="true" tabindex="-1"></a><span class="st">'''</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<p>We can split into chunks of (text,toolstr,json):</p>
<div id="d6a3f160" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb37"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb37-1"><a href="#cb37-1" aria-hidden="true" tabindex="-1"></a>sp <span class="op">=</span> re_tools.split(fmt_outp)</span>
<span id="cb37-2"><a href="#cb37-2" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> o <span class="kw">in</span> <span class="bu">list</span>(chunked(sp, <span class="dv">3</span>, pad<span class="op">=</span><span class="va">True</span>)): <span class="bu">print</span>(<span class="st">'- '</span>, o)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>-  ["\nI'll solve this step-by-step, using parallel calls where possible.\n\n", '&lt;details class=\'tool-usage-details\'&gt;\n\n```json\n{\n  "id": "toolu_01KjnQH2Nsz2viQ7XYpLW3Ta",\n  "call": { "function": "simple_add", "arguments": { "a": 10, "b": 5 } },\n  "result": "15"\n}\n```\n\n&lt;/details&gt;', '{\n  "id": "toolu_01KjnQH2Nsz2viQ7XYpLW3Ta",\n  "call": { "function": "simple_add", "arguments": { "a": 10, "b": 5 } },\n  "result": "15"\n}']
-  ['\n\n', '&lt;details class=\'tool-usage-details\'&gt;\n\n```json\n{\n  "id": "toolu_01Koi2EZrGZsBbnQ13wuuvzY",\n  "call": { "function": "simple_add", "arguments": { "a": 2, "b": 1 } },\n  "result": "3"\n}\n```\n\n&lt;/details&gt;', '{\n  "id": "toolu_01Koi2EZrGZsBbnQ13wuuvzY",\n  "call": { "function": "simple_add", "arguments": { "a": 2, "b": 1 } },\n  "result": "3"\n}']
-  ['\n\nNow I need to multiply 15 * 3 before I can do the final division:\n\n', '&lt;details class=\'tool-usage-details\'&gt;\n\n```json\n{\n  "id": "toolu_0141NRaWUjmGtwxZjWkyiq6C",\n  "call": { "function": "multiply", "arguments": { "a": 15, "b": 3 } },\n  "result": "45"\n}\n```\n\n&lt;/details&gt;', '{\n  "id": "toolu_0141NRaWUjmGtwxZjWkyiq6C",\n  "call": { "function": "multiply", "arguments": { "a": 15, "b": 3 } },\n  "result": "45"\n}']
-  ["\n\n&lt;details class='token-usage-details'&gt;&lt;summary&gt;Cache hit: 81.8% | Tokens: total=23,276 input=23,158 (+18,910 cached, 0 new) output=118 (reasoning 23)&lt;/summary&gt;\n\n`Usage(completion_tokens=118, prompt_tokens=23158, total_tokens=23276, completion_tokens_details=CompletionTokensDetailsWrapper(accepted_prediction_tokens=None, audio_tokens=None, reasoning_tokens=23, rejected_prediction_tokens=None, text_tokens=None, image_tokens=None), prompt_tokens_details=PromptTokensDetailsWrapper(audio_tokens=None, cached_tokens=18910, text_tokens=None, image_tokens=None, cache_creation_tokens=0), cache_creation_input_tokens=0, cache_read_input_tokens=18910)`\n\n&lt;/details&gt;\n", None, None]</code></pre>
</div>
</div>
<hr>
<p><a href="https://github.com/AnswerDotAI/lisette/blob/main/lisette/core.py#L186" target="_blank" style="float:right; font-size:smaller">source</a></p>
</section>
<section id="fmt2hist" class="level3">
<h3 class="anchored" data-anchor-id="fmt2hist">fmt2hist</h3>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb39"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb39-1"><a href="#cb39-1" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb39-2"><a href="#cb39-2" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> fmt2hist(</span>
<span id="cb39-3"><a href="#cb39-3" aria-hidden="true" tabindex="-1"></a>    outp:<span class="bu">str</span></span>
<span id="cb39-4"><a href="#cb39-4" aria-hidden="true" tabindex="-1"></a>)<span class="op">-&gt;</span><span class="bu">list</span>:</span>
<span id="cb39-5"><a href="#cb39-5" aria-hidden="true" tabindex="-1"></a></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<p><em>Transform a formatted output into a LiteLLM compatible history</em></p>
<p>See how we can turn that one formatted output string back into a list of Messages:</p>
<div id="8ac22b2e" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb40"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb40-1"><a href="#cb40-1" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> pprint <span class="im">import</span> pprint</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<div id="f6b40b0a" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb41"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb41-1"><a href="#cb41-1" aria-hidden="true" tabindex="-1"></a>h <span class="op">=</span> fmt2hist(fmt_outp)</span>
<span id="cb41-2"><a href="#cb41-2" aria-hidden="true" tabindex="-1"></a>pprint(h)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>[Message(content="I'll solve this step-by-step, using parallel calls where possible.", role='assistant', tool_calls=[ChatCompletionMessageToolCall(function=Function(arguments='{"a": 10, "b": 5}', name='simple_add'), id='toolu_01KjnQH2Nsz2viQ7XYpLW3Ta', type='function')], function_call=None, provider_specific_fields=None),
 {'content': '15',
  'name': 'simple_add',
  'role': 'tool',
  'tool_call_id': 'toolu_01KjnQH2Nsz2viQ7XYpLW3Ta'},
 Message(content='', role='assistant', tool_calls=[ChatCompletionMessageToolCall(function=Function(arguments='{"a": 2, "b": 1}', name='simple_add'), id='toolu_01Koi2EZrGZsBbnQ13wuuvzY', type='function')], function_call=None, provider_specific_fields=None),
 {'content': '3',
  'name': 'simple_add',
  'role': 'tool',
  'tool_call_id': 'toolu_01Koi2EZrGZsBbnQ13wuuvzY'},
 Message(content='Now I need to multiply 15 * 3 before I can do the final division:', role='assistant', tool_calls=[ChatCompletionMessageToolCall(function=Function(arguments='{"a": 15, "b": 3}', name='multiply'), id='toolu_0141NRaWUjmGtwxZjWkyiq6C', type='function')], function_call=None, provider_specific_fields=None),
 {'content': '45',
  'name': 'multiply',
  'role': 'tool',
  'tool_call_id': 'toolu_0141NRaWUjmGtwxZjWkyiq6C'},
 Message(content='.', role='assistant', tool_calls=None, function_call=None, provider_specific_fields=None)]</code></pre>
</div>
</div>
</section>
<section id="mk_msgs" class="level3">
<h3 class="anchored" data-anchor-id="mk_msgs"><a href="https://lisette.answer.ai/core.html#mk_msgs"><code>mk_msgs</code></a></h3>
<p>We will skip tool use blocks and tool results during caching</p>
<p>Now lets make it easy to provide entire conversations:</p>
<hr>
<p><a href="https://github.com/AnswerDotAI/lisette/blob/main/lisette/core.py#L213" target="_blank" style="float:right; font-size:smaller">source</a></p>
</section>
<section id="mk_msgs-1" class="level3">
<h3 class="anchored" data-anchor-id="mk_msgs-1">mk_msgs</h3>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb43"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb43-1"><a href="#cb43-1" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb43-2"><a href="#cb43-2" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> mk_msgs(</span>
<span id="cb43-3"><a href="#cb43-3" aria-hidden="true" tabindex="-1"></a>    msgs, <span class="co"># List of messages (each: str, bytes, list, or dict w 'role' and 'content' fields)</span></span>
<span id="cb43-4"><a href="#cb43-4" aria-hidden="true" tabindex="-1"></a>    cache:<span class="bu">bool</span><span class="op">=</span><span class="va">False</span>, <span class="co"># Enable Anthropic caching</span></span>
<span id="cb43-5"><a href="#cb43-5" aria-hidden="true" tabindex="-1"></a>    cache_idxs:<span class="bu">list</span><span class="op">=</span>[<span class="op">-</span><span class="dv">1</span>], <span class="co"># Cache breakpoint idxs</span></span>
<span id="cb43-6"><a href="#cb43-6" aria-hidden="true" tabindex="-1"></a>    ttl:NoneType<span class="op">=</span><span class="va">None</span>, <span class="co"># Cache TTL: '5m' (default) or '1h'</span></span>
<span id="cb43-7"><a href="#cb43-7" aria-hidden="true" tabindex="-1"></a>):</span>
<span id="cb43-8"><a href="#cb43-8" aria-hidden="true" tabindex="-1"></a></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<p><em>Create a list of LiteLLM compatible messages.</em></p>
<p>With <a href="https://lisette.answer.ai/core.html#mk_msgs"><code>mk_msgs</code></a> you can easily provide a whole conversation:</p>
<div id="263ecc52" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb44"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb44-1"><a href="#cb44-1" aria-hidden="true" tabindex="-1"></a>msgs <span class="op">=</span> mk_msgs([<span class="st">'Hey!'</span>,<span class="st">"Hi there!"</span>,<span class="st">"How are you?"</span>,<span class="st">"I'm doing fine and you?"</span>])</span>
<span id="cb44-2"><a href="#cb44-2" aria-hidden="true" tabindex="-1"></a>msgs</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display">
<pre><code>[{'role': 'user', 'content': 'Hey!'},
 {'role': 'assistant', 'content': 'Hi there!'},
 {'role': 'user', 'content': 'How are you?'},
 {'role': 'assistant', 'content': "I'm doing fine and you?"}]</code></pre>
</div>
</div>
<p>By defualt the last message will be cached when <code>cache=True</code>:</p>
<div id="ff5a34c5" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb46"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb46-1"><a href="#cb46-1" aria-hidden="true" tabindex="-1"></a>msgs <span class="op">=</span> mk_msgs([<span class="st">'Hey!'</span>,<span class="st">"Hi there!"</span>,<span class="st">"How are you?"</span>,<span class="st">"I'm doing fine and you?"</span>], cache<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb46-2"><a href="#cb46-2" aria-hidden="true" tabindex="-1"></a>msgs</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display">
<pre><code>[{'role': 'user', 'content': 'Hey!'},
 {'role': 'assistant', 'content': 'Hi there!'},
 {'role': 'user', 'content': 'How are you?'},
 {'role': 'assistant',
  'content': [{'type': 'text',
    'text': "I'm doing fine and you?",
    'cache_control': {'type': 'ephemeral'}}]}]</code></pre>
</div>
</div>
<div id="fc360a73" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb48"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb48-1"><a href="#cb48-1" aria-hidden="true" tabindex="-1"></a>test_eq(<span class="st">'cache_control'</span> <span class="kw">in</span> msgs[<span class="op">-</span><span class="dv">1</span>][<span class="st">'content'</span>][<span class="dv">0</span>], <span class="va">True</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<p>Alternatively, users can provide custom <code>cache_idxs</code>. Tool call blocks and results are skipped during caching:</p>
<div id="9289d855" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb49"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb49-1"><a href="#cb49-1" aria-hidden="true" tabindex="-1"></a>msgs <span class="op">=</span> mk_msgs([<span class="st">'Hello!'</span>,<span class="st">'Hi! How can I help you?'</span>,<span class="st">'Call some functions!'</span>,fmt_outp], cache<span class="op">=</span><span class="va">True</span>, cache_idxs<span class="op">=</span>[<span class="dv">0</span>,<span class="op">-</span><span class="dv">2</span>,<span class="op">-</span><span class="dv">1</span>])</span>
<span id="cb49-2"><a href="#cb49-2" aria-hidden="true" tabindex="-1"></a>msgs</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display">
<pre><code>[{'role': 'user',
  'content': [{'type': 'text',
    'text': 'Hello!',
    'cache_control': {'type': 'ephemeral'}}]},
 {'role': 'assistant', 'content': 'Hi! How can I help you?'},
 {'role': 'user', 'content': 'Call some functions!'},
 Message(content="I'll solve this step-by-step, using parallel calls where possible.", role='assistant', tool_calls=[ChatCompletionMessageToolCall(function=Function(arguments='{"a": 10, "b": 5}', name='simple_add'), id='toolu_01KjnQH2Nsz2viQ7XYpLW3Ta', type='function')], function_call=None, provider_specific_fields=None),
 {'role': 'tool',
  'tool_call_id': 'toolu_01KjnQH2Nsz2viQ7XYpLW3Ta',
  'name': 'simple_add',
  'content': '15'},
 Message(content='', role='assistant', tool_calls=[ChatCompletionMessageToolCall(function=Function(arguments='{"a": 2, "b": 1}', name='simple_add'), id='toolu_01Koi2EZrGZsBbnQ13wuuvzY', type='function')], function_call=None, provider_specific_fields=None),
 {'role': 'tool',
  'tool_call_id': 'toolu_01Koi2EZrGZsBbnQ13wuuvzY',
  'name': 'simple_add',
  'content': '3'},
 Message(content='Now I need to multiply 15 * 3 before I can do the final division:', role='assistant', tool_calls=[ChatCompletionMessageToolCall(function=Function(arguments='{"a": 15, "b": 3}', name='multiply'), id='toolu_0141NRaWUjmGtwxZjWkyiq6C', type='function', cache_control={'type': 'ephemeral'})], function_call=None, provider_specific_fields=None),
 {'role': 'tool',
  'tool_call_id': 'toolu_0141NRaWUjmGtwxZjWkyiq6C',
  'name': 'multiply',
  'content': '45'},
 Message(content=[{'type': 'text', 'text': '.', 'cache_control': {'type': 'ephemeral'}}], role='assistant', tool_calls=None, function_call=None, provider_specific_fields=None)]</code></pre>
</div>
</div>
<div id="787a783d" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb51"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb51-1"><a href="#cb51-1" aria-hidden="true" tabindex="-1"></a>msgs[<span class="op">-</span><span class="dv">2</span>]</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display">
<pre><code>{'role': 'tool',
 'tool_call_id': 'toolu_0141NRaWUjmGtwxZjWkyiq6C',
 'name': 'multiply',
 'content': '45'}</code></pre>
</div>
</div>
<div id="1bebd211" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb53"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb53-1"><a href="#cb53-1" aria-hidden="true" tabindex="-1"></a>msgs <span class="op">=</span> mk_msgs([<span class="st">'Hello!'</span>,<span class="st">'Hi! How can I help you?'</span>,<span class="st">'Call some functions!'</span>,fmt_outp], cache<span class="op">=</span><span class="va">True</span>, cache_idxs<span class="op">=</span>[<span class="dv">0</span>,<span class="op">-</span><span class="dv">3</span>,<span class="op">-</span><span class="dv">2</span>])</span>
<span id="cb53-2"><a href="#cb53-2" aria-hidden="true" tabindex="-1"></a>msgs</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display">
<pre><code>[{'role': 'user',
  'content': [{'type': 'text',
    'text': 'Hello!',
    'cache_control': {'type': 'ephemeral'}}]},
 {'role': 'assistant', 'content': 'Hi! How can I help you?'},
 {'role': 'user', 'content': 'Call some functions!'},
 Message(content="I'll solve this step-by-step, using parallel calls where possible.", role='assistant', tool_calls=[ChatCompletionMessageToolCall(function=Function(arguments='{"a": 10, "b": 5}', name='simple_add'), id='toolu_01KjnQH2Nsz2viQ7XYpLW3Ta', type='function')], function_call=None, provider_specific_fields=None),
 {'role': 'tool',
  'tool_call_id': 'toolu_01KjnQH2Nsz2viQ7XYpLW3Ta',
  'name': 'simple_add',
  'content': '15'},
 Message(content='', role='assistant', tool_calls=[ChatCompletionMessageToolCall(function=Function(arguments='{"a": 2, "b": 1}', name='simple_add'), id='toolu_01Koi2EZrGZsBbnQ13wuuvzY', type='function', cache_control={'type': 'ephemeral'})], function_call=None, provider_specific_fields=None),
 {'role': 'tool',
  'tool_call_id': 'toolu_01Koi2EZrGZsBbnQ13wuuvzY',
  'name': 'simple_add',
  'content': '3'},
 Message(content='Now I need to multiply 15 * 3 before I can do the final division:', role='assistant', tool_calls=[ChatCompletionMessageToolCall(function=Function(arguments='{"a": 15, "b": 3}', name='multiply'), id='toolu_0141NRaWUjmGtwxZjWkyiq6C', type='function', cache_control={'type': 'ephemeral'})], function_call=None, provider_specific_fields=None),
 {'role': 'tool',
  'tool_call_id': 'toolu_0141NRaWUjmGtwxZjWkyiq6C',
  'name': 'multiply',
  'content': '45'},
 Message(content='.', role='assistant', tool_calls=None, function_call=None, provider_specific_fields=None)]</code></pre>
</div>
</div>
<div id="decf73b2" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb55"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb55-1"><a href="#cb55-1" aria-hidden="true" tabindex="-1"></a>msgs[<span class="op">-</span><span class="dv">3</span>]</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display">
<pre><code>Message(content='Now I need to multiply 15 * 3 before I can do the final division:', role='assistant', tool_calls=[ChatCompletionMessageToolCall(function=Function(arguments='{"a": 15, "b": 3}', name='multiply'), id='toolu_0141NRaWUjmGtwxZjWkyiq6C', type='function', cache_control={'type': 'ephemeral'})], function_call=None, provider_specific_fields=None)</code></pre>
</div>
</div>
<div id="b0fadef8" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb57"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb57-1"><a href="#cb57-1" aria-hidden="true" tabindex="-1"></a>msgs[<span class="op">-</span><span class="dv">5</span>]</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display">
<pre><code>Message(content='', role='assistant', tool_calls=[ChatCompletionMessageToolCall(function=Function(arguments='{"a": 2, "b": 1}', name='simple_add'), id='toolu_01Koi2EZrGZsBbnQ13wuuvzY', type='function', cache_control={'type': 'ephemeral'})], function_call=None, provider_specific_fields=None)</code></pre>
</div>
</div>
<div id="8f38eeaf" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb59"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb59-1"><a href="#cb59-1" aria-hidden="true" tabindex="-1"></a>test_eq(<span class="st">'cache_control'</span> <span class="kw">in</span> msgs[<span class="dv">0</span>][<span class="st">'content'</span>][<span class="dv">0</span>], <span class="va">True</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<p>Tool result blocks are skipped and cache control is placed into tool calls:</p>
<div id="e7bd5fc0" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb60"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb60-1"><a href="#cb60-1" aria-hidden="true" tabindex="-1"></a>test_eq(<span class="st">'cache_control'</span> <span class="kw">in</span> msgs[<span class="op">-</span><span class="dv">5</span>][<span class="st">'tool_calls'</span>][<span class="dv">0</span>], <span class="va">True</span>) </span>
<span id="cb60-2"><a href="#cb60-2" aria-hidden="true" tabindex="-1"></a>test_eq(<span class="st">'cache_control'</span> <span class="kw">in</span> msgs[<span class="op">-</span><span class="dv">3</span>][<span class="st">'tool_calls'</span>][<span class="dv">0</span>], <span class="va">True</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<div id="939c493f" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb61"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb61-1"><a href="#cb61-1" aria-hidden="true" tabindex="-1"></a>L(msgs).<span class="bu">map</span>(remove_cache_ckpts)</span>
<span id="cb61-2"><a href="#cb61-2" aria-hidden="true" tabindex="-1"></a>test_eq(<span class="bu">any</span>(L(msgs).<span class="bu">map</span>(_has_cache)), <span class="va">False</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<p>Whoâ€™s speaking at when is automatically inferred. Even when there are multiple tools being called in parallel (which LiteLLM supports!).</p>
<div id="9cf8d1f2" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb62"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb62-1"><a href="#cb62-1" aria-hidden="true" tabindex="-1"></a>msgs <span class="op">=</span> mk_msgs([<span class="st">'Tell me the weather in Paris and Rome'</span>,</span>
<span id="cb62-2"><a href="#cb62-2" aria-hidden="true" tabindex="-1"></a>                <span class="st">'Assistant calls weather tool two times'</span>,</span>
<span id="cb62-3"><a href="#cb62-3" aria-hidden="true" tabindex="-1"></a>                {<span class="st">'role'</span>:<span class="st">'tool'</span>,<span class="st">'content'</span>:<span class="st">'Weather in Paris is ...'</span>},</span>
<span id="cb62-4"><a href="#cb62-4" aria-hidden="true" tabindex="-1"></a>                {<span class="st">'role'</span>:<span class="st">'tool'</span>,<span class="st">'content'</span>:<span class="st">'Weather in Rome is ...'</span>},</span>
<span id="cb62-5"><a href="#cb62-5" aria-hidden="true" tabindex="-1"></a>                <span class="st">'Assistant returns weather'</span>,</span>
<span id="cb62-6"><a href="#cb62-6" aria-hidden="true" tabindex="-1"></a>                <span class="st">'Thanks!'</span>])</span>
<span id="cb62-7"><a href="#cb62-7" aria-hidden="true" tabindex="-1"></a>msgs</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display">
<pre><code>[{'role': 'user', 'content': 'Tell me the weather in Paris and Rome'},
 {'role': 'assistant', 'content': 'Assistant calls weather tool two times'},
 {'role': 'tool', 'content': 'Weather in Paris is ...'},
 {'role': 'tool', 'content': 'Weather in Rome is ...'},
 {'role': 'assistant', 'content': 'Assistant returns weather'},
 {'role': 'user', 'content': 'Thanks!'}]</code></pre>
</div>
</div>
<p>For ease of use, if <code>msgs</code> is not already in a <code>list</code>, it will automatically be wrapped inside one. This way you can pass a single prompt into <a href="https://lisette.answer.ai/core.html#mk_msgs"><code>mk_msgs</code></a> and get back a LiteLLM compatible msg history.</p>
<div id="aa4e7663" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb64"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb64-1"><a href="#cb64-1" aria-hidden="true" tabindex="-1"></a>msgs <span class="op">=</span> mk_msgs(<span class="st">"Hey"</span>)</span>
<span id="cb64-2"><a href="#cb64-2" aria-hidden="true" tabindex="-1"></a>msgs</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display">
<pre><code>[{'role': 'user', 'content': 'Hey'}]</code></pre>
</div>
</div>
<div id="2c828056" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb66"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb66-1"><a href="#cb66-1" aria-hidden="true" tabindex="-1"></a>msgs <span class="op">=</span> mk_msgs([<span class="st">'Hey!'</span>,<span class="st">"Hi there!"</span>,<span class="st">"How are you?"</span>,<span class="st">"I'm fine, you?"</span>])</span>
<span id="cb66-2"><a href="#cb66-2" aria-hidden="true" tabindex="-1"></a>msgs</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display">
<pre><code>[{'role': 'user', 'content': 'Hey!'},
 {'role': 'assistant', 'content': 'Hi there!'},
 {'role': 'user', 'content': 'How are you?'},
 {'role': 'assistant', 'content': "I'm fine, you?"}]</code></pre>
</div>
</div>
<p>However, beware that if you use <a href="https://lisette.answer.ai/core.html#mk_msgs"><code>mk_msgs</code></a> for a single message, consisting of multiple parts. Then you should be explicit, and make sure to wrap those multiple messages in two lists:</p>
<ol type="1">
<li>One list to show that they belong together in one message (the inner list).</li>
<li>Another, because mk_msgs expects a list of multiple messages (the outer list).</li>
</ol>
<p>This is common when working with images for example:</p>
<div id="d315d964" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb68"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb68-1"><a href="#cb68-1" aria-hidden="true" tabindex="-1"></a>msgs <span class="op">=</span> mk_msgs([[<span class="st">'Whats in this img?'</span>,img_fn.read_bytes()]])</span>
<span id="cb68-2"><a href="#cb68-2" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(json.dumps(msgs,indent<span class="op">=</span><span class="dv">1</span>)[:<span class="dv">200</span>]<span class="op">+</span><span class="st">"..."</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>[
 {
  "role": "user",
  "content": [
   {
    "type": "text",
    "text": "Whats in this img?"
   },
   {
    "type": "image_url",
    "image_url": "data:image/jpeg;base64,/9j/4AAQSkZJRgABAQAAAQABAAD...</code></pre>
</div>
</div>
</section>
</section>
<section id="streaming" class="level2">
<h2 class="anchored" data-anchor-id="streaming">Streaming</h2>
<p>LiteLLM supports streaming responses. Thatâ€™s really useful if you want to show intermediate results, instead of having to wait until the whole response is finished.</p>
<p>We create this helper function that returns the entire response at the end of the stream. This is useful when you want to store the whole response somewhere after having displayed the intermediate results.</p>
<hr>
<p><a href="https://github.com/AnswerDotAI/lisette/blob/main/lisette/core.py#L231" target="_blank" style="float:right; font-size:smaller">source</a></p>
<section id="stream_with_complete" class="level3">
<h3 class="anchored" data-anchor-id="stream_with_complete">stream_with_complete</h3>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb70"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb70-1"><a href="#cb70-1" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb70-2"><a href="#cb70-2" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> stream_with_complete(</span>
<span id="cb70-3"><a href="#cb70-3" aria-hidden="true" tabindex="-1"></a>    gen, postproc:function<span class="op">=</span>noop</span>
<span id="cb70-4"><a href="#cb70-4" aria-hidden="true" tabindex="-1"></a>):</span>
<span id="cb70-5"><a href="#cb70-5" aria-hidden="true" tabindex="-1"></a></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<p><em>Extend streaming response chunks with the complete response</em></p>
<div id="46f16571" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb71"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb71-1"><a href="#cb71-1" aria-hidden="true" tabindex="-1"></a>r <span class="op">=</span> c(mk_msgs(<span class="st">"Hey!"</span>), stream<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb71-2"><a href="#cb71-2" aria-hidden="true" tabindex="-1"></a>r2 <span class="op">=</span> SaveReturn(stream_with_complete(r))</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<div id="9797136b" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb72"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb72-1"><a href="#cb72-1" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> o <span class="kw">in</span> r2:</span>
<span id="cb72-2"><a href="#cb72-2" aria-hidden="true" tabindex="-1"></a>    cts <span class="op">=</span> o.choices[<span class="dv">0</span>].delta.content</span>
<span id="cb72-3"><a href="#cb72-3" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> cts: <span class="bu">print</span>(cts, end<span class="op">=</span><span class="st">''</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>Hello there! How can I help you today?</code></pre>
</div>
</div>
<div id="897ec073" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb74"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb74-1"><a href="#cb74-1" aria-hidden="true" tabindex="-1"></a>r2.value</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display cell-output-markdown">
<p>Hello there! How can I help you today?</p>
<details>
<ul>
<li>id: <code>chatcmpl-xxx</code></li>
<li>model: <code>gemini-3-flash-preview</code></li>
<li>finish_reason: <code>stop</code></li>
<li>usage: <code>Usage(completion_tokens=10, prompt_tokens=3, total_tokens=13, completion_tokens_details=CompletionTokensDetailsWrapper(accepted_prediction_tokens=None, audio_tokens=None, reasoning_tokens=0, rejected_prediction_tokens=None, text_tokens=None, image_tokens=None), prompt_tokens_details=None)</code></li>
</ul>
</details>
</div>
</div>
</section>
</section>
<section id="tools" class="level2">
<h2 class="anchored" data-anchor-id="tools">Tools</h2>
<hr>
<p><a href="https://github.com/AnswerDotAI/lisette/blob/main/lisette/core.py#L241" target="_blank" style="float:right; font-size:smaller">source</a></p>
<section id="lite_mk_func" class="level3">
<h3 class="anchored" data-anchor-id="lite_mk_func">lite_mk_func</h3>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb75"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb75-1"><a href="#cb75-1" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb75-2"><a href="#cb75-2" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> lite_mk_func(</span>
<span id="cb75-3"><a href="#cb75-3" aria-hidden="true" tabindex="-1"></a>    f</span>
<span id="cb75-4"><a href="#cb75-4" aria-hidden="true" tabindex="-1"></a>):</span>
<span id="cb75-5"><a href="#cb75-5" aria-hidden="true" tabindex="-1"></a></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div id="7b103600" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb76"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb76-1"><a href="#cb76-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> simple_add(</span>
<span id="cb76-2"><a href="#cb76-2" aria-hidden="true" tabindex="-1"></a>    a: <span class="bu">int</span>,   <span class="co"># first operand</span></span>
<span id="cb76-3"><a href="#cb76-3" aria-hidden="true" tabindex="-1"></a>    b: <span class="bu">int</span><span class="op">=</span><span class="dv">0</span>  <span class="co"># second operand</span></span>
<span id="cb76-4"><a href="#cb76-4" aria-hidden="true" tabindex="-1"></a>) <span class="op">-&gt;</span> <span class="bu">int</span>:</span>
<span id="cb76-5"><a href="#cb76-5" aria-hidden="true" tabindex="-1"></a>    <span class="co">"Add two numbers together"</span></span>
<span id="cb76-6"><a href="#cb76-6" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> a <span class="op">+</span> b</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<div id="100fc27b" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb77"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb77-1"><a href="#cb77-1" aria-hidden="true" tabindex="-1"></a>toolsc <span class="op">=</span> lite_mk_func(simple_add)</span>
<span id="cb77-2"><a href="#cb77-2" aria-hidden="true" tabindex="-1"></a>toolsc</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display">
<pre><code>{'type': 'function',
 'function': {'name': 'simple_add',
  'description': 'Add two numbers together\n\nReturns:\n- type: integer',
  'parameters': {'type': 'object',
   'properties': {'a': {'type': 'integer', 'description': 'first operand'},
    'b': {'type': 'integer', 'description': 'second operand', 'default': 0}},
   'required': ['a']}}}</code></pre>
</div>
</div>
<div id="8c2af29a" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb79"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb79-1"><a href="#cb79-1" aria-hidden="true" tabindex="-1"></a>tmsg <span class="op">=</span> mk_msg(<span class="st">"What is 5478954793+547982745? How about 5479749754+9875438979? Always use tools for calculations, and describe what you'll do before using a tool. Where multiple tool calls are required, do them in a single response where possible. "</span>)</span>
<span id="cb79-2"><a href="#cb79-2" aria-hidden="true" tabindex="-1"></a>r <span class="op">=</span> c(tmsg, tools<span class="op">=</span>[toolsc])</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<div id="8bdb1817" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb80"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb80-1"><a href="#cb80-1" aria-hidden="true" tabindex="-1"></a>display(r)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display cell-output-markdown">
<p>I will calculate the sum of 5478954793 and 547982745, followed by the sum of 5479749754 and 9875438979, using the addition tool for both operations.</p>
<p>ðŸ”§ simple_add({â€œbâ€: 547982745, â€œaâ€: 5478954793})</p>
<p>ðŸ”§ simple_add({â€œbâ€: 9875438979, â€œaâ€: 5479749754})</p>
<details>
<ul>
<li>id: <code>chatcmpl-xxx</code></li>
<li>model: <code>gemini-3-flash-preview</code></li>
<li>finish_reason: <code>tool_calls</code></li>
<li>usage: <code>Usage(completion_tokens=138, prompt_tokens=160, total_tokens=298, completion_tokens_details=CompletionTokensDetailsWrapper(accepted_prediction_tokens=None, audio_tokens=None, reasoning_tokens=None, rejected_prediction_tokens=None, text_tokens=138, image_tokens=None), prompt_tokens_details=PromptTokensDetailsWrapper(audio_tokens=None, cached_tokens=None, text_tokens=160, image_tokens=None), cache_read_input_tokens=None)</code></li>
</ul>
</details>
</div>
</div>
<p>A tool response can be a string or a list of tool blocks (e.g., an image url block). To allow users to specify if a response should not be immediately stringified, we provide the ToolResponse datatype users can wrap their return statement in.</p>
<hr>
<p><a href="https://github.com/AnswerDotAI/lisette/blob/main/lisette/core.py#L247" target="_blank" style="float:right; font-size:smaller">source</a></p>
</section>
<section id="toolresponse" class="level3">
<h3 class="anchored" data-anchor-id="toolresponse">ToolResponse</h3>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb81"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb81-1"><a href="#cb81-1" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb81-2"><a href="#cb81-2" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> ToolResponse(</span>
<span id="cb81-3"><a href="#cb81-3" aria-hidden="true" tabindex="-1"></a>    content:<span class="bu">list</span></span>
<span id="cb81-4"><a href="#cb81-4" aria-hidden="true" tabindex="-1"></a>)<span class="op">-&gt;</span><span class="va">None</span>:</span>
<span id="cb81-5"><a href="#cb81-5" aria-hidden="true" tabindex="-1"></a></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<p>When <code>tc_refs=True</code>, tool results are wrapped with their <code>tool_call_id</code> so the AI can track which result corresponds to which call and reference them in subsequent tool calls.</p>
<div id="38d7d5f2" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb82"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb82-1"><a href="#cb82-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Test _prep_tool_res - string result</span></span>
<span id="cb82-2"><a href="#cb82-2" aria-hidden="true" tabindex="-1"></a>test_eq(_prep_tool_res(<span class="st">'hello'</span>, <span class="st">'toolu_123'</span>), [</span>
<span id="cb82-3"><a href="#cb82-3" aria-hidden="true" tabindex="-1"></a>    {<span class="st">'type'</span>: <span class="st">'text'</span>, <span class="st">'text'</span>: <span class="st">'[tool_call_id: toolu_123]'</span>},</span>
<span id="cb82-4"><a href="#cb82-4" aria-hidden="true" tabindex="-1"></a>    {<span class="st">'type'</span>: <span class="st">'text'</span>, <span class="st">'text'</span>: <span class="st">'hello'</span>}</span>
<span id="cb82-5"><a href="#cb82-5" aria-hidden="true" tabindex="-1"></a>])</span>
<span id="cb82-6"><a href="#cb82-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb82-7"><a href="#cb82-7" aria-hidden="true" tabindex="-1"></a><span class="co"># Test _prep_tool_res - list result (e.g. ToolResponse content)</span></span>
<span id="cb82-8"><a href="#cb82-8" aria-hidden="true" tabindex="-1"></a>img_block <span class="op">=</span> {<span class="st">'type'</span>: <span class="st">'image_url'</span>, <span class="st">'image_url'</span>: {<span class="st">'url'</span>: <span class="st">'data:...'</span>}}</span>
<span id="cb82-9"><a href="#cb82-9" aria-hidden="true" tabindex="-1"></a>test_eq(_prep_tool_res([img_block], <span class="st">'toolu_456'</span>), [</span>
<span id="cb82-10"><a href="#cb82-10" aria-hidden="true" tabindex="-1"></a>    {<span class="st">'type'</span>: <span class="st">'text'</span>, <span class="st">'text'</span>: <span class="st">'[tool_call_id: toolu_456]'</span>},</span>
<span id="cb82-11"><a href="#cb82-11" aria-hidden="true" tabindex="-1"></a>    img_block</span>
<span id="cb82-12"><a href="#cb82-12" aria-hidden="true" tabindex="-1"></a>])</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<p>During a tool loop, the AI may want to reference the result of a previous tool call. We support syntax <code>$`tool_call_id`</code> in tool arguments which gets resolved to the actual result value before calling the function.</p>
<div id="037bfea8" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb83"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb83-1"><a href="#cb83-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Test _resolve_tool_refs</span></span>
<span id="cb83-2"><a href="#cb83-2" aria-hidden="true" tabindex="-1"></a>tc_res <span class="op">=</span> {<span class="st">'toolu_abc123'</span>: <span class="st">'hello world'</span>, <span class="st">'toolu_xyz789'</span>: <span class="dv">42</span>}</span>
<span id="cb83-3"><a href="#cb83-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb83-4"><a href="#cb83-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Basic substitution</span></span>
<span id="cb83-5"><a href="#cb83-5" aria-hidden="true" tabindex="-1"></a>test_eq(_resolve_tool_refs(<span class="st">'{"content": "$`toolu_abc123`"}'</span>, tc_res), {<span class="st">"content"</span>: <span class="st">"hello world"</span>})</span>
<span id="cb83-6"><a href="#cb83-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb83-7"><a href="#cb83-7" aria-hidden="true" tabindex="-1"></a><span class="co"># Multiple refs</span></span>
<span id="cb83-8"><a href="#cb83-8" aria-hidden="true" tabindex="-1"></a>test_eq(_resolve_tool_refs(<span class="st">'{"a": "$`toolu_abc123`", "b": "$`toolu_xyz789`"}'</span>, tc_res), {<span class="st">"a"</span>: <span class="st">"hello world"</span>, <span class="st">"b"</span>: <span class="dv">42</span>})</span>
<span id="cb83-9"><a href="#cb83-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb83-10"><a href="#cb83-10" aria-hidden="true" tabindex="-1"></a><span class="co"># No refs - passthrough</span></span>
<span id="cb83-11"><a href="#cb83-11" aria-hidden="true" tabindex="-1"></a>test_eq(_resolve_tool_refs(<span class="st">'{"x": 1}'</span>, tc_res), {<span class="st">"x"</span>: <span class="dv">1</span>})</span>
<span id="cb83-12"><a href="#cb83-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb83-13"><a href="#cb83-13" aria-hidden="true" tabindex="-1"></a><span class="co"># Empty tc_res</span></span>
<span id="cb83-14"><a href="#cb83-14" aria-hidden="true" tabindex="-1"></a>test_eq(_resolve_tool_refs(<span class="st">'{"x": 1}'</span>, <span class="va">None</span>), {<span class="st">"x"</span>: <span class="dv">1</span>})</span>
<span id="cb83-15"><a href="#cb83-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb83-16"><a href="#cb83-16" aria-hidden="true" tabindex="-1"></a><span class="co"># Missing ref - error message</span></span>
<span id="cb83-17"><a href="#cb83-17" aria-hidden="true" tabindex="-1"></a>test_eq(_resolve_tool_refs(<span class="st">'{"x": "$`toolu_missing`"}'</span>, tc_res), {<span class="st">"x"</span>: <span class="st">"Tool result 'toolu_missing' not found!"</span>})</span>
<span id="cb83-18"><a href="#cb83-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb83-19"><a href="#cb83-19" aria-hidden="true" tabindex="-1"></a><span class="co"># tc_refs=False - syntax passes through unchanged since tc_res is None</span></span>
<span id="cb83-20"><a href="#cb83-20" aria-hidden="true" tabindex="-1"></a>test_eq(_resolve_tool_refs(<span class="st">'{"x": "$`toolu_abc123`"}'</span>, <span class="va">None</span>), {<span class="st">"x"</span>: <span class="st">"$`toolu_abc123`"</span>})</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<p>When <code>tc_refs=True</code>, tool results are stored in <code>tc_res</code> for later substitution via <code>$`tool_call_id`</code> syntax. Some callers might return string reprs of Python objects. <a href="https://lisette.answer.ai/core.html#_try_eval"><code>_try_eval</code></a> attempts to convert these back to Python objects using <code>ast.literal_eval</code>, falling back to the original value on failure. This ensures substituted values are actual objects, not string reprs.</p>
<div id="286a7935" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb84"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb84-1"><a href="#cb84-1" aria-hidden="true" tabindex="-1"></a>test_eq(ast.literal_eval(<span class="st">"'hello'"</span>), <span class="st">'hello'</span>)</span>
<span id="cb84-2"><a href="#cb84-2" aria-hidden="true" tabindex="-1"></a>test_eq(_try_eval(<span class="st">"{'a': 1, 'b': 2}"</span>), {<span class="st">'a'</span>: <span class="dv">1</span>, <span class="st">'b'</span>: <span class="dv">2</span>})</span>
<span id="cb84-3"><a href="#cb84-3" aria-hidden="true" tabindex="-1"></a>test_eq(_try_eval(<span class="st">"[1, 2, 3]"</span>), [<span class="dv">1</span>, <span class="dv">2</span>, <span class="dv">3</span>])</span>
<span id="cb84-4"><a href="#cb84-4" aria-hidden="true" tabindex="-1"></a>test_eq(_try_eval(<span class="st">"&lt;MyClass object at 0x123&gt;"</span>), <span class="st">"&lt;MyClass object at 0x123&gt;"</span>)</span>
<span id="cb84-5"><a href="#cb84-5" aria-hidden="true" tabindex="-1"></a>test_eq(_try_eval(<span class="dv">42</span>), <span class="dv">42</span>)</span>
<span id="cb84-6"><a href="#cb84-6" aria-hidden="true" tabindex="-1"></a>cts <span class="op">=</span> [{<span class="st">'type'</span>: <span class="st">'image'</span>, <span class="st">'url'</span>: <span class="st">'http://example.com/img.png'</span>}]</span>
<span id="cb84-7"><a href="#cb84-7" aria-hidden="true" tabindex="-1"></a>test_eq(_try_eval(ToolResponse(cts)), ToolResponse(cts))</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<p>Ensure <a href="https://lisette.answer.ai/core.html#toolresponse"><code>ToolResponse</code></a> content (e.g.&nbsp;image blocks) is passed through as a list, not stringified, even when <code>tc_res</code> is <code>None</code>:</p>
<div id="0d54cebe" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb85"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb85-1"><a href="#cb85-1" aria-hidden="true" tabindex="-1"></a>fake_tc <span class="op">=</span> ChatCompletionMessageToolCall(index<span class="op">=</span><span class="dv">0</span>, function<span class="op">=</span>Function(name<span class="op">=</span><span class="st">'test_img'</span>), <span class="bu">id</span><span class="op">=</span><span class="st">'_test'</span>, <span class="bu">type</span><span class="op">=</span><span class="st">'function'</span>)</span>
<span id="cb85-2"><a href="#cb85-2" aria-hidden="true" tabindex="-1"></a>img_content <span class="op">=</span> [{<span class="st">'type'</span>: <span class="st">'image_url'</span>, <span class="st">'image_url'</span>: <span class="st">'data:image/png;base64,abc'</span>}]</span>
<span id="cb85-3"><a href="#cb85-3" aria-hidden="true" tabindex="-1"></a>res <span class="op">=</span> _mk_tool_result(fake_tc, ToolResponse(img_content))</span>
<span id="cb85-4"><a href="#cb85-4" aria-hidden="true" tabindex="-1"></a>test_eq(res[<span class="st">'content'</span>], img_content)  <span class="co"># ToolResponse should pass through</span></span>
<span id="cb85-5"><a href="#cb85-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb85-6"><a href="#cb85-6" aria-hidden="true" tabindex="-1"></a>res_str <span class="op">=</span> _mk_tool_result(fake_tc, [<span class="st">'hello'</span>])</span>
<span id="cb85-7"><a href="#cb85-7" aria-hidden="true" tabindex="-1"></a>test_eq(res_str[<span class="st">'content'</span>], <span class="st">"['hello']"</span>)  <span class="co"># other tools results are stringified</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<div id="d5af607c" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb86"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb86-1"><a href="#cb86-1" aria-hidden="true" tabindex="-1"></a>tcs <span class="op">=</span> [_lite_call_func(o, [toolsc], ns<span class="op">=</span><span class="bu">globals</span>()) <span class="cf">for</span> o <span class="kw">in</span> r.choices[<span class="dv">0</span>].message.tool_calls]</span>
<span id="cb86-2"><a href="#cb86-2" aria-hidden="true" tabindex="-1"></a>tcs</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display">
<pre><code>[{'tool_call_id': 'call_438709f4b4f943e097417df9e25f__thought__EjQKMgG+Pvb79iYGwnLRoG8ROXZW8VRk9WJjfinj+Oq640juoZSixN9JJTOpyEW9lzTMSIFa',
  'role': 'tool',
  'name': 'simple_add',
  'content': '6026937538'},
 {'tool_call_id': 'call_f9d65e4e7ce743a0acd7f6022d1d',
  'role': 'tool',
  'name': 'simple_add',
  'content': '15355188733'}]</code></pre>
</div>
</div>
<div id="a6327211" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb88"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb88-1"><a href="#cb88-1" aria-hidden="true" tabindex="-1"></a>r.choices[<span class="dv">0</span>].message.tool_calls</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display">
<pre><code>[ChatCompletionMessageToolCall(index=0, provider_specific_fields={'thought_signature': 'EjQKMgG+Pvb79iYGwnLRoG8ROXZW8VRk9WJjfinj+Oq640juoZSixN9JJTOpyEW9lzTMSIFa'}, function=Function(arguments='{"b": 547982745, "a": 5478954793}', name='simple_add'), id='call_438709f4b4f943e097417df9e25f__thought__EjQKMgG+Pvb79iYGwnLRoG8ROXZW8VRk9WJjfinj+Oq640juoZSixN9JJTOpyEW9lzTMSIFa', type='function'),
 ChatCompletionMessageToolCall(index=1, function=Function(arguments='{"b": 9875438979, "a": 5479749754}', name='simple_add'), id='call_f9d65e4e7ce743a0acd7f6022d1d', type='function')]</code></pre>
</div>
</div>
<p>Test tool calls that were not in tool_schemas are caught:</p>
<div id="a90ccb17" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb90"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb90-1"><a href="#cb90-1" aria-hidden="true" tabindex="-1"></a>fake_tc <span class="op">=</span> ChatCompletionMessageToolCall(index<span class="op">=</span><span class="dv">0</span>, function<span class="op">=</span>Function(name<span class="op">=</span><span class="st">'hallucinated_tool'</span>),<span class="bu">id</span><span class="op">=</span><span class="st">'_'</span>, <span class="bu">type</span><span class="op">=</span><span class="st">'function'</span>)</span>
<span id="cb90-2"><a href="#cb90-2" aria-hidden="true" tabindex="-1"></a>test_eq(_lite_call_func(fake_tc, ns<span class="op">=</span><span class="bu">globals</span>(), tool_schemas<span class="op">=</span>[toolsc])[<span class="st">'content'</span>],<span class="st">"Tool not defined in tool_schemas: hallucinated_tool"</span>)</span>
<span id="cb90-3"><a href="#cb90-3" aria-hidden="true" tabindex="-1"></a>test_fail(_lite_call_func(fake_tc, ns<span class="op">=</span><span class="bu">globals</span>(), tool_schemas<span class="op">=</span><span class="va">None</span>)[<span class="st">'content'</span>],<span class="st">"Tool not defined in tool_schemas: hallucinated_tool"</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<p>Test tool calls that were not in tool_choice are caught:</p>
<div id="3dd9871b" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb91"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb91-1"><a href="#cb91-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> delta_text(msg):</span>
<span id="cb91-2"><a href="#cb91-2" aria-hidden="true" tabindex="-1"></a>    <span class="co">"Extract printable content from streaming delta, return None if nothing to print"</span></span>
<span id="cb91-3"><a href="#cb91-3" aria-hidden="true" tabindex="-1"></a>    c <span class="op">=</span> msg.choices[<span class="dv">0</span>]</span>
<span id="cb91-4"><a href="#cb91-4" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="kw">not</span> c: <span class="cf">return</span> c</span>
<span id="cb91-5"><a href="#cb91-5" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="kw">not</span> <span class="bu">hasattr</span>(c,<span class="st">'delta'</span>): <span class="cf">return</span> <span class="va">None</span> <span class="co">#f'{c}'</span></span>
<span id="cb91-6"><a href="#cb91-6" aria-hidden="true" tabindex="-1"></a>    delta <span class="op">=</span> c.delta</span>
<span id="cb91-7"><a href="#cb91-7" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> delta.content: <span class="cf">return</span> delta.content</span>
<span id="cb91-8"><a href="#cb91-8" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> delta.tool_calls:</span>
<span id="cb91-9"><a href="#cb91-9" aria-hidden="true" tabindex="-1"></a>        res <span class="op">=</span> <span class="st">''</span>.join(<span class="ss">f"ðŸ”§ </span><span class="sc">{</span>tc<span class="sc">.</span>function<span class="sc">.</span>name<span class="sc">}</span><span class="ss">"</span> <span class="cf">for</span> tc <span class="kw">in</span> delta.tool_calls <span class="cf">if</span> tc.<span class="bu">id</span> <span class="kw">and</span> tc.function.name)</span>
<span id="cb91-10"><a href="#cb91-10" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> res: <span class="cf">return</span> <span class="ss">f'</span><span class="ch">\n</span><span class="sc">{</span>res<span class="sc">}</span><span class="ch">\n</span><span class="ss">'</span></span>
<span id="cb91-11"><a href="#cb91-11" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="bu">hasattr</span>(delta,<span class="st">'reasoning_content'</span>): <span class="cf">return</span> <span class="st">'ðŸ§ '</span> <span class="cf">if</span> delta.reasoning_content <span class="cf">else</span> <span class="st">'</span><span class="ch">\n\n</span><span class="st">'</span></span>
<span id="cb91-12"><a href="#cb91-12" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> <span class="va">None</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<div id="e4790a51" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb92"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb92-1"><a href="#cb92-1" aria-hidden="true" tabindex="-1"></a>r <span class="op">=</span> c(tmsg, stream<span class="op">=</span><span class="va">True</span>, tools<span class="op">=</span>[toolsc])</span>
<span id="cb92-2"><a href="#cb92-2" aria-hidden="true" tabindex="-1"></a>r2 <span class="op">=</span> SaveReturn(stream_with_complete(r))</span>
<span id="cb92-3"><a href="#cb92-3" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> o <span class="kw">in</span> r2: <span class="bu">print</span>(delta_text(o) <span class="kw">or</span> <span class="st">''</span>, end<span class="op">=</span><span class="st">''</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>I will use the `simple_add` tool to calculate the sum of 5478954793 and 547982745, and then another instance of the tool to calculate the sum of 5479749754 and 9875438979.


ðŸ”§ simple_add

ðŸ”§ simple_add</code></pre>
</div>
</div>
<div id="5b21118c" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb94"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb94-1"><a href="#cb94-1" aria-hidden="true" tabindex="-1"></a>r2.value</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display cell-output-markdown">
<p>I will use the <code>simple_add</code> tool to calculate the sum of 5478954793 and 547982745, and then another instance of the tool to calculate the sum of 5479749754 and 9875438979.</p>
<p>ðŸ”§ simple_add({â€œaâ€: 5478954793, â€œbâ€: 547982745})</p>
<p>ðŸ”§ simple_add({â€œaâ€: 5479749754, â€œbâ€: 9875438979})</p>
<details>
<ul>
<li>id: <code>chatcmpl-xxx</code></li>
<li>model: <code>gemini-3-flash-preview</code></li>
<li>finish_reason: <code>stop</code></li>
<li>usage: <code>Usage(completion_tokens=146, prompt_tokens=160, total_tokens=306, completion_tokens_details=CompletionTokensDetailsWrapper(accepted_prediction_tokens=None, audio_tokens=None, reasoning_tokens=0, rejected_prediction_tokens=None, text_tokens=None, image_tokens=None), prompt_tokens_details=None)</code></li>
</ul>
</details>
</div>
</div>
<div id="50bca992" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb95"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb95-1"><a href="#cb95-1" aria-hidden="true" tabindex="-1"></a>msg <span class="op">=</span> mk_msg(<span class="st">"Solve this complex math problem: What is the derivative of x^3 + 2x^2 - 5x + 1?"</span>)</span>
<span id="cb95-2"><a href="#cb95-2" aria-hidden="true" tabindex="-1"></a>r <span class="op">=</span> c(msg, stream<span class="op">=</span><span class="va">True</span>, reasoning_effort<span class="op">=</span><span class="st">"low"</span>)</span>
<span id="cb95-3"><a href="#cb95-3" aria-hidden="true" tabindex="-1"></a>r2 <span class="op">=</span> SaveReturn(stream_with_complete(r))</span>
<span id="cb95-4"><a href="#cb95-4" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> o <span class="kw">in</span> r2: <span class="bu">print</span>(delta_text(o) <span class="kw">or</span> <span class="st">''</span>, end<span class="op">=</span><span class="st">''</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>ðŸ§ To find the derivative of the function **$f(x) = x^3 + 2x^2 - 5x + 1$**, we use the **Power Rule**.

The Power Rule states that if $f(x) = ax^n$, then the derivative is $f'(x) = n \cdot ax^{n-1}$.

Here is the step-by-step breakdown:

1.  **Derivative of $x^3$:**
    Multiply by the exponent (3) and subtract 1 from the exponent:
    $\frac{d}{dx}(x^3) = 3x^2$

2.  **Derivative of $2x^2$:**
    Multiply the exponent (2) by the coefficient (2) and subtract 1 from the exponent:
    $\frac{d}{dx}(2x^2) = 2 \cdot 2x^1 = 4x$

3.  **Derivative of $-5x$:**
    Since $x$ is $x^1$, the derivative is simply the coefficient:
    $\frac{d}{dx}(-5x) = -5$

4.  **Derivative of $1$:**
    The derivative of any constant is 0:
    $\frac{d}{dx}(1) = 0$

**Final Answer:**
Combining these results, the derivative is:
**$f'(x) = 3x^2 + 4x - 5$**</code></pre>
</div>
</div>
<div id="30ff5f1a" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb97"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb97-1"><a href="#cb97-1" aria-hidden="true" tabindex="-1"></a>r2.value</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display cell-output-markdown">
<p>To find the derivative of the function <strong><span class="math inline">\(f(x) = x^3 + 2x^2 - 5x + 1\)</span></strong>, we use the <strong>Power Rule</strong>.</p>
<p>The Power Rule states that if <span class="math inline">\(f(x) = ax^n\)</span>, then the derivative is <span class="math inline">\(f'(x) = n \cdot ax^{n-1}\)</span>.</p>
<p>Here is the step-by-step breakdown:</p>
<ol type="1">
<li><p><strong>Derivative of <span class="math inline">\(x^3\)</span>:</strong> Multiply by the exponent (3) and subtract 1 from the exponent: <span class="math inline">\(\frac{d}{dx}(x^3) = 3x^2\)</span></p></li>
<li><p><strong>Derivative of <span class="math inline">\(2x^2\)</span>:</strong> Multiply the exponent (2) by the coefficient (2) and subtract 1 from the exponent: <span class="math inline">\(\frac{d}{dx}(2x^2) = 2 \cdot 2x^1 = 4x\)</span></p></li>
<li><p><strong>Derivative of <span class="math inline">\(-5x\)</span>:</strong> Since <span class="math inline">\(x\)</span> is <span class="math inline">\(x^1\)</span>, the derivative is simply the coefficient: <span class="math inline">\(\frac{d}{dx}(-5x) = -5\)</span></p></li>
<li><p><strong>Derivative of <span class="math inline">\(1\)</span>:</strong> The derivative of any constant is 0: <span class="math inline">\(\frac{d}{dx}(1) = 0\)</span></p></li>
</ol>
<p><strong>Final Answer:</strong> Combining these results, the derivative is: <strong><span class="math inline">\(f'(x) = 3x^2 + 4x - 5\)</span></strong></p>
<details>
<ul>
<li>id: <code>chatcmpl-xxx</code></li>
<li>model: <code>gemini-3-flash-preview</code></li>
<li>finish_reason: <code>stop</code></li>
<li>usage: <code>Usage(completion_tokens=748, prompt_tokens=29, total_tokens=777, completion_tokens_details=CompletionTokensDetailsWrapper(accepted_prediction_tokens=None, audio_tokens=None, reasoning_tokens=86, rejected_prediction_tokens=None, text_tokens=None, image_tokens=None), prompt_tokens_details=None)</code></li>
</ul>
</details>
</div>
</div>
</section>
</section>
<section id="structured-outputs" class="level2">
<h2 class="anchored" data-anchor-id="structured-outputs">Structured Outputs</h2>
<hr>
<p><a href="https://github.com/AnswerDotAI/lisette/blob/main/lisette/core.py#L304" target="_blank" style="float:right; font-size:smaller">source</a></p>
<section id="structured" class="level3">
<h3 class="anchored" data-anchor-id="structured">structured</h3>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb98"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb98-1"><a href="#cb98-1" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb98-2"><a href="#cb98-2" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> structured(</span>
<span id="cb98-3"><a href="#cb98-3" aria-hidden="true" tabindex="-1"></a>    m:<span class="bu">str</span>, <span class="co"># LiteLLM model string</span></span>
<span id="cb98-4"><a href="#cb98-4" aria-hidden="true" tabindex="-1"></a>    msgs:<span class="bu">list</span>, <span class="co"># List of messages</span></span>
<span id="cb98-5"><a href="#cb98-5" aria-hidden="true" tabindex="-1"></a>    tool:Callable, <span class="co"># Tool to be used for creating the structured output (class, dataclass or Pydantic, function, etc)</span></span>
<span id="cb98-6"><a href="#cb98-6" aria-hidden="true" tabindex="-1"></a>    messages:List<span class="op">=</span>[], <span class="co"># Optional OpenAI params: see https://platform.openai.com/docs/api-reference/chat/create</span></span>
<span id="cb98-7"><a href="#cb98-7" aria-hidden="true" tabindex="-1"></a>    timeout:Union<span class="op">=</span><span class="va">None</span>, temperature:Optional<span class="op">=</span><span class="va">None</span>, top_p:Optional<span class="op">=</span><span class="va">None</span>, n:Optional<span class="op">=</span><span class="va">None</span>, stream:Optional<span class="op">=</span><span class="va">None</span>,</span>
<span id="cb98-8"><a href="#cb98-8" aria-hidden="true" tabindex="-1"></a>    stream_options:Optional<span class="op">=</span><span class="va">None</span>, stop:NoneType<span class="op">=</span><span class="va">None</span>, max_completion_tokens:Optional<span class="op">=</span><span class="va">None</span>, max_tokens:Optional<span class="op">=</span><span class="va">None</span>,</span>
<span id="cb98-9"><a href="#cb98-9" aria-hidden="true" tabindex="-1"></a>    modalities:Optional<span class="op">=</span><span class="va">None</span>, prediction:Optional<span class="op">=</span><span class="va">None</span>, audio:Optional<span class="op">=</span><span class="va">None</span>, presence_penalty:Optional<span class="op">=</span><span class="va">None</span>,</span>
<span id="cb98-10"><a href="#cb98-10" aria-hidden="true" tabindex="-1"></a>    frequency_penalty:Optional<span class="op">=</span><span class="va">None</span>, logit_bias:Optional<span class="op">=</span><span class="va">None</span>, user:Optional<span class="op">=</span><span class="va">None</span>,</span>
<span id="cb98-11"><a href="#cb98-11" aria-hidden="true" tabindex="-1"></a>    reasoning_effort:Optional<span class="op">=</span><span class="va">None</span>, <span class="co"># openai v1.0+ new params</span></span>
<span id="cb98-12"><a href="#cb98-12" aria-hidden="true" tabindex="-1"></a>    verbosity:Optional<span class="op">=</span><span class="va">None</span>, response_format:Union<span class="op">=</span><span class="va">None</span>, seed:Optional<span class="op">=</span><span class="va">None</span>, tools:Optional<span class="op">=</span><span class="va">None</span>,</span>
<span id="cb98-13"><a href="#cb98-13" aria-hidden="true" tabindex="-1"></a>    tool_choice:Union<span class="op">=</span><span class="va">None</span>, logprobs:Optional<span class="op">=</span><span class="va">None</span>, top_logprobs:Optional<span class="op">=</span><span class="va">None</span>, parallel_tool_calls:Optional<span class="op">=</span><span class="va">None</span>,</span>
<span id="cb98-14"><a href="#cb98-14" aria-hidden="true" tabindex="-1"></a>    web_search_options:Optional<span class="op">=</span><span class="va">None</span>, deployment_id:NoneType<span class="op">=</span><span class="va">None</span>, extra_headers:Optional<span class="op">=</span><span class="va">None</span>,</span>
<span id="cb98-15"><a href="#cb98-15" aria-hidden="true" tabindex="-1"></a>    safety_identifier:Optional<span class="op">=</span><span class="va">None</span>, service_tier:Optional<span class="op">=</span><span class="va">None</span>,</span>
<span id="cb98-16"><a href="#cb98-16" aria-hidden="true" tabindex="-1"></a>    functions:Optional<span class="op">=</span><span class="va">None</span>, <span class="co"># soon to be deprecated params by OpenAI</span></span>
<span id="cb98-17"><a href="#cb98-17" aria-hidden="true" tabindex="-1"></a>    function_call:Optional<span class="op">=</span><span class="va">None</span>, base_url:Optional<span class="op">=</span><span class="va">None</span>, <span class="co"># set api_base, api_version, api_key</span></span>
<span id="cb98-18"><a href="#cb98-18" aria-hidden="true" tabindex="-1"></a>    api_version:Optional<span class="op">=</span><span class="va">None</span>, api_key:Optional<span class="op">=</span><span class="va">None</span>,</span>
<span id="cb98-19"><a href="#cb98-19" aria-hidden="true" tabindex="-1"></a>    model_list:Optional<span class="op">=</span><span class="va">None</span>, <span class="co"># pass in a list of api_base,keys, etc.</span></span>
<span id="cb98-20"><a href="#cb98-20" aria-hidden="true" tabindex="-1"></a>    thinking:Optional<span class="op">=</span><span class="va">None</span>, <span class="co"># Optional liteLLM function params</span></span>
<span id="cb98-21"><a href="#cb98-21" aria-hidden="true" tabindex="-1"></a>    shared_session:Optional<span class="op">=</span><span class="va">None</span>, <span class="co"># Session management</span></span>
<span id="cb98-22"><a href="#cb98-22" aria-hidden="true" tabindex="-1"></a>):</span>
<span id="cb98-23"><a href="#cb98-23" aria-hidden="true" tabindex="-1"></a></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<p><em>Return the value of the tool call (generally used for structured outputs)</em></p>
<div id="49621b83" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb99"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb99-1"><a href="#cb99-1" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> President:</span>
<span id="cb99-2"><a href="#cb99-2" aria-hidden="true" tabindex="-1"></a>    <span class="co">"Information about a president of the United States"</span></span>
<span id="cb99-3"><a href="#cb99-3" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> <span class="fu">__init__</span>(</span>
<span id="cb99-4"><a href="#cb99-4" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>, </span>
<span id="cb99-5"><a href="#cb99-5" aria-hidden="true" tabindex="-1"></a>        first:<span class="bu">str</span>, <span class="co"># first name</span></span>
<span id="cb99-6"><a href="#cb99-6" aria-hidden="true" tabindex="-1"></a>        last:<span class="bu">str</span>, <span class="co"># last name</span></span>
<span id="cb99-7"><a href="#cb99-7" aria-hidden="true" tabindex="-1"></a>        spouse:<span class="bu">str</span>, <span class="co"># name of spouse</span></span>
<span id="cb99-8"><a href="#cb99-8" aria-hidden="true" tabindex="-1"></a>        years_in_office:<span class="bu">str</span>, <span class="co"># format: "{start_year}-{end_year}"</span></span>
<span id="cb99-9"><a href="#cb99-9" aria-hidden="true" tabindex="-1"></a>        birthplace:<span class="bu">str</span>, <span class="co"># name of city</span></span>
<span id="cb99-10"><a href="#cb99-10" aria-hidden="true" tabindex="-1"></a>        birth_year:<span class="bu">int</span> <span class="co"># year of birth, `0` if unknown</span></span>
<span id="cb99-11"><a href="#cb99-11" aria-hidden="true" tabindex="-1"></a>    ):</span>
<span id="cb99-12"><a href="#cb99-12" aria-hidden="true" tabindex="-1"></a>        <span class="cf">assert</span> re.match(<span class="vs">r'</span><span class="dv">\d</span><span class="op">{4}</span><span class="vs">-</span><span class="dv">\d</span><span class="op">{4}</span><span class="vs">'</span>, years_in_office), <span class="st">"Invalid format: `years_in_office`"</span></span>
<span id="cb99-13"><a href="#cb99-13" aria-hidden="true" tabindex="-1"></a>        store_attr()</span>
<span id="cb99-14"><a href="#cb99-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb99-15"><a href="#cb99-15" aria-hidden="true" tabindex="-1"></a>    <span class="fu">__repr__</span> <span class="op">=</span> basic_repr(<span class="st">'first, last, spouse, years_in_office, birthplace, birth_year'</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<div id="4afd4c87" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb100"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb100-1"><a href="#cb100-1" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> m <span class="kw">in</span> ms[<span class="dv">1</span>:]: </span>
<span id="cb100-2"><a href="#cb100-2" aria-hidden="true" tabindex="-1"></a>    r <span class="op">=</span> structured(m, [mk_msg(<span class="st">"Tell me something about the third president of the USA."</span>)], President)</span>
<span id="cb100-3"><a href="#cb100-3" aria-hidden="true" tabindex="-1"></a>    test_eq(r.first, <span class="st">'Thomas'</span>)<span class="op">;</span> test_eq(r.last, <span class="st">'Jefferson'</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
</section>
</section>
<section id="search" class="level2">
<h2 class="anchored" data-anchor-id="search">Search</h2>
<p>LiteLLM provides search, not via tools, but via the special <code>web_search_options</code> param.</p>
<p><strong>Note:</strong> Not all models support web search. LiteLLMâ€™s <code>supports_web_search</code> field should indicate this, but itâ€™s unreliable for some models like <code>claude-sonnet-4-20250514</code>. Checking both <code>supports_web_search</code> and <code>search_context_cost_per_query</code> provides more accurate detection.</p>
<div id="43417017" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb101"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb101-1"><a href="#cb101-1" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> m <span class="kw">in</span> ms: <span class="bu">print</span>(m, _has_search(m))</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>gemini/gemini-3-pro-preview True
gemini/gemini-3-flash-preview True
claude-opus-4-6 True
openai/gpt-4.1 False</code></pre>
</div>
</div>
<p>When search is supported it can be used like this:</p>
<div id="89e0bead" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb103"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb103-1"><a href="#cb103-1" aria-hidden="true" tabindex="-1"></a>smsg <span class="op">=</span> mk_msg(<span class="st">"Search the web and tell me very briefly about otters"</span>)</span>
<span id="cb103-2"><a href="#cb103-2" aria-hidden="true" tabindex="-1"></a>r <span class="op">=</span> c(smsg, web_search_options<span class="op">=</span>{<span class="st">"search_context_size"</span>: <span class="st">"low"</span>})  <span class="co"># or 'medium' / 'high'</span></span>
<span id="cb103-3"><a href="#cb103-3" aria-hidden="true" tabindex="-1"></a>r</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display cell-output-markdown">
<p>Otters are carnivorous, semi-aquatic mammals belonging to the <strong>Mustelidae</strong> family, which also includes weasels, badgers, and wolverines. There are <strong>13 extant species</strong> found on every continent except Antarctica and Australia.</p>
<section id="key-characteristics" class="level3">
<h3 class="anchored" data-anchor-id="key-characteristics">Key Characteristics</h3>
<ul>
<li><strong>Physical Traits:</strong> They have long, streamlined bodies, webbed feet, and powerful tails that make them expert swimmers.</li>
<li><strong>Insulation:</strong> Instead of blubber, otters rely on incredibly dense, water-resistant fur to stay warm. Sea otters have the thickest fur in the animal kingdom, with up to one million hairs per square inch.</li>
<li><strong>Behavior:</strong> Known for being highly intelligent and playful, they are often seen sliding down mudbanks or playing with stones. Some species, like sea otters, are famous for using tools (rocks) to crack open shellfish.</li>
</ul>
</section>
<section id="habitat-diet" class="level3">
<h3 class="anchored" data-anchor-id="habitat-diet">Habitat &amp; Diet</h3>
<ul>
<li><strong>Environments:</strong> Most species live in freshwater (rivers, lakes, and wetlands), while the sea otter and marine otter live in saltwater environments.</li>
<li><strong>Social Life:</strong> Social structures vary; river otters are often solitary or live in small family groups, whereas sea otters can gather in large groups called <strong>rafts</strong>.</li>
<li><strong>Diet:</strong> They are opportunistic hunters that primarily eat fish, crustaceans, mollusks, and occasionally small mammals or birds.</li>
</ul>
</section>
<section id="major-species" class="level3">
<h3 class="anchored" data-anchor-id="major-species">Major Species</h3>
<ul>
<li><strong>Sea Otter:</strong> The heaviest otter, living almost exclusively in the Pacific Ocean.</li>
<li><strong>Giant Otter:</strong> Found in South America, it can reach up to 6 feet (1.8 meters) in length.</li>
<li><strong>Asian Small-Clawed Otter:</strong> The smallest species, native to Southeast Asian wetlands.</li>
<li><strong>North American River Otter:</strong> A common freshwater species found throughout much of Canada and the U.S.</li>
</ul>
<details>
<ul>
<li>id: <code>chatcmpl-xxx</code></li>
<li>model: <code>gemini-3-flash-preview</code></li>
<li>finish_reason: <code>stop</code></li>
<li>usage: <code>Usage(completion_tokens=380, prompt_tokens=12, total_tokens=392, completion_tokens_details=CompletionTokensDetailsWrapper(accepted_prediction_tokens=None, audio_tokens=None, reasoning_tokens=None, rejected_prediction_tokens=None, text_tokens=380, image_tokens=None), prompt_tokens_details=PromptTokensDetailsWrapper(audio_tokens=None, cached_tokens=None, text_tokens=12, image_tokens=None), cache_read_input_tokens=None)</code></li>
</ul>
</details>
</section>
</div>
</div>
</section>
<section id="citations" class="level2">
<h2 class="anchored" data-anchor-id="citations">Citations</h2>
<p>Next, lets handle Anthropicâ€™s search citations.</p>
<p>When not using streaming, all citations are placed in a separate key in the response:</p>
<div id="45e2a7cf" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb104"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb104-1"><a href="#cb104-1" aria-hidden="true" tabindex="-1"></a>r[<span class="st">'vertex_ai_grounding_metadata'</span>][<span class="dv">0</span>].keys()</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display">
<pre><code>dict_keys(['searchEntryPoint', 'groundingChunks', 'groundingSupports', 'webSearchQueries'])</code></pre>
</div>
</div>
<div id="da64e713" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb106"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb106-1"><a href="#cb106-1" aria-hidden="true" tabindex="-1"></a>r[<span class="st">'vertex_ai_grounding_metadata'</span>][<span class="dv">0</span>][<span class="st">'webSearchQueries'</span>]</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display">
<pre><code>['brief facts about otters', 'different types of otters and their habitats']</code></pre>
</div>
</div>
<p>Web search results:</p>
<div id="030d17a5" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb108"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb108-1"><a href="#cb108-1" aria-hidden="true" tabindex="-1"></a>r[<span class="st">'vertex_ai_grounding_metadata'</span>][<span class="dv">0</span>][<span class="st">'groundingChunks'</span>][:<span class="dv">3</span>]</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display">
<pre><code>[{'web': {'uri': 'https://vertexaisearch.cloud.google.com/grounding-api-redirect/AUZIYQFZhShK-sYJlZ6yW3HDOfHAXSedE_8eleQXBYkNPY8-RanCdZKEHK8koAjU6VWs8IejXWUjqcGA_KiiTFadDFVUeJoQgKYApAcACpOebB3Un6EM2_zSl6TnqKJyfNfb',
   'title': 'wikipedia.org'}},
 {'web': {'uri': 'https://vertexaisearch.cloud.google.com/grounding-api-redirect/AUZIYQGyEe4_ov2v5IfdBlghXq4r9jiCYORM2D5HfzErwhg8-r4P-X9xsifzrKZWokyyxpCcvoUnrN_AlFfZacab4SPIMTeFI6YOqiu2gffFZOLUxSfGC8EydZzy_67ofYmfrkfFsOjCsAYaKGtdiYX6ORz28y3WvwuTppaldRv4iRsJyjRv',
   'title': 'doi.gov'}},
 {'web': {'uri': 'https://vertexaisearch.cloud.google.com/grounding-api-redirect/AUZIYQFf2X-YndiX8tNjy_MXitsGZNyiXN4Xe1JAZLgV6lyJKNY16fNXFiQnqLiuZtE5KfjY47UgUwws9RzCSbubi5opunRy67UIgiiuwizfXAM6ytpKRGvEYSjKCSn1VV-_IFYTXY_4HVB2vE-64dfTEyyHWpYjWPSfncu16AP38KIz',
   'title': 'montereybayaquarium.org'}}]</code></pre>
</div>
</div>
<p>Citations in gemini:</p>
<div id="eb79aef5" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb110"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb110-1"><a href="#cb110-1" aria-hidden="true" tabindex="-1"></a>r[<span class="st">'vertex_ai_grounding_metadata'</span>][<span class="dv">0</span>][<span class="st">'groundingSupports'</span>][:<span class="dv">3</span>]</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display">
<pre><code>[{'segment': {'endIndex': 138,
   'text': 'Otters are carnivorous, semi-aquatic mammals belonging to the **Mustelidae** family, which also includes weasels, badgers, and wolverines.'},
  'groundingChunkIndices': [0, 1, 2]},
 {'segment': {'startIndex': 139,
   'endIndex': 228,
   'text': 'There are **13 extant species** found on every continent except Antarctica and Australia.'},
  'groundingChunkIndices': [3]},
 {'segment': {'startIndex': 230,
   'endIndex': 253,
   'text': '### Key Characteristics'},
  'groundingChunkIndices': [4, 3, 5, 6, 0, 7, 2, 1, 8]}]</code></pre>
</div>
</div>
<div id="a9915026" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb112"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb112-1"><a href="#cb112-1" aria-hidden="true" tabindex="-1"></a><span class="co"># r.choices[0].message.provider_specific_fields['citations'][0]</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<p>However, when streaming the results are not captured this way. Instead, we provide this helper function that adds the citation to the <code>content</code> field in markdown format:</p>
<hr>
<p><a href="https://github.com/AnswerDotAI/lisette/blob/main/lisette/core.py#L327" target="_blank" style="float:right; font-size:smaller">source</a></p>
<section id="cite_footnotes" class="level3">
<h3 class="anchored" data-anchor-id="cite_footnotes">cite_footnotes</h3>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb113"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb113-1"><a href="#cb113-1" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb113-2"><a href="#cb113-2" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> cite_footnotes(</span>
<span id="cb113-3"><a href="#cb113-3" aria-hidden="true" tabindex="-1"></a>    stream_list</span>
<span id="cb113-4"><a href="#cb113-4" aria-hidden="true" tabindex="-1"></a>):</span>
<span id="cb113-5"><a href="#cb113-5" aria-hidden="true" tabindex="-1"></a></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<p><em>Add markdown footnote citations to stream deltas</em></p>
<hr>
<p><a href="https://github.com/AnswerDotAI/lisette/blob/main/lisette/core.py#L321" target="_blank" style="float:right; font-size:smaller">source</a></p>
</section>
<section id="cite_footnote" class="level3">
<h3 class="anchored" data-anchor-id="cite_footnote">cite_footnote</h3>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb114"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb114-1"><a href="#cb114-1" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb114-2"><a href="#cb114-2" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> cite_footnote(</span>
<span id="cb114-3"><a href="#cb114-3" aria-hidden="true" tabindex="-1"></a>    msg</span>
<span id="cb114-4"><a href="#cb114-4" aria-hidden="true" tabindex="-1"></a>):</span>
<span id="cb114-5"><a href="#cb114-5" aria-hidden="true" tabindex="-1"></a></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div id="4d753235" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb115"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb115-1"><a href="#cb115-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> warnings</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<div id="184c79a3" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb116"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb116-1"><a href="#cb116-1" aria-hidden="true" tabindex="-1"></a>warnings.filterwarnings(<span class="st">"ignore"</span>, message<span class="op">=</span><span class="st">"Pydantic serializer warnings"</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<div id="c2150365" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb117"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb117-1"><a href="#cb117-1" aria-hidden="true" tabindex="-1"></a>r <span class="op">=</span> <span class="bu">list</span>(c(smsg, ms[<span class="dv">2</span>], stream<span class="op">=</span><span class="va">True</span>, web_search_options<span class="op">=</span>{<span class="st">"search_context_size"</span>: <span class="st">"low"</span>}))</span>
<span id="cb117-2"><a href="#cb117-2" aria-hidden="true" tabindex="-1"></a>cite_footnotes(r)</span>
<span id="cb117-3"><a href="#cb117-3" aria-hidden="true" tabindex="-1"></a>stream_chunk_builder(r)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display cell-output-markdown">
<p>Hereâ€™s a brief overview of otters:</p>
<p><a href="https://en.wikipedia.org/wiki/Otter" title="Otter - Wikipedia">*</a> Otters are carnivorous mammals in the subfamily Lutrinae, with 14 extant species that are all semiaquatic, living in both freshwater and marine environments. <a href="https://www.nationalgeographic.com/animals/mammals/facts/otters-1" title="Otters, facts and information | National Geographic">*</a> They are charismatic members of the weasel family, found on every continent except Australia and Antarctica.</p>
<p><strong>Physical Features:</strong> <a href="https://en.wikipedia.org/wiki/Otter" title="Otter - Wikipedia">*</a> Otters are distinguished by their long, slim bodies, powerful webbed feet for swimming, and dense fur that keeps them warm and buoyant in water. <a href="https://www.nationalgeographic.com/animals/mammals/facts/otters-1" title="Otters, facts and information | National Geographic">*</a> They have the densest fur of any animalâ€”as many as a million hairs per square inch in places.</p>
<p><strong>Species Range:</strong> <a href="https://en.wikipedia.org/wiki/Otter" title="Otter - Wikipedia">*</a> The Asian small-clawed otter is the smallest species, while the giant otter and sea otter are the largest. <a href="https://www.doi.gov/blog/12-facts-about-otters-sea-otter-awareness-week" title="12 Facts About Otters for Sea Otter Awareness Week | U.S. Department of the Interior">*</a> The sea otter is the largest member of the weasel family, yet the smallest marine mammal in North America.</p>
<p><strong>Behavior:</strong> <a href="https://en.wikipedia.org/wiki/Otter" title="Otter - Wikipedia">*</a> They are playful animals, engaging in activities like sliding into water on natural slides and playing with stones. <a href="https://www.nationalgeographic.com/animals/mammals/facts/otters-1" title="Otters, facts and information | National Geographic">*</a> All otters are expert hunters that eat fish, crustaceans, and other critters. <a href="https://www.nationalgeographic.com/animals/mammals/facts/otters-1" title="Otters, facts and information | National Geographic">*</a> Sea otters will float on their backs, place a rock on their chests, then smash mollusks down on it until they break open. When itâ€™s time to nap, they entangle themselves in kelp so they donâ€™t float away.</p>
<p><strong>Lifespan &amp; Reproduction:</strong> <a href="https://en.wikipedia.org/wiki/Otter" title="Otter - Wikipedia">*</a> Otters have a gestation period of about 60â€“86 days, offspring typically stay with their family for a year, and they can live up to 16 years.</p>
<p><strong>Conservation:</strong> <a href="https://www.nationalgeographic.com/animals/mammals/facts/otters-1" title="Otters, facts and information | National Geographic">*</a> Otters and their mustelid relatives were once hunted extensively for their fur, many to the point of near extinction. Despite regulations designed to protect them, many species remain at risk from pollution and habitat loss.</p>
<p>ðŸ”§ web_search({â€œqueryâ€: â€œotters factsâ€})</p>
<details>
<ul>
<li>id: <code>chatcmpl-xxx</code></li>
<li>model: <code>claude-opus-4-6</code></li>
<li>finish_reason: <code>stop</code></li>
<li>usage: <code>Usage(completion_tokens=635, prompt_tokens=13930, total_tokens=14565, completion_tokens_details=CompletionTokensDetailsWrapper(accepted_prediction_tokens=None, audio_tokens=None, reasoning_tokens=0, rejected_prediction_tokens=None, text_tokens=None, image_tokens=None), prompt_tokens_details=None)</code></li>
</ul>
</details>
</div>
</div>
</section>
</section>
<section id="chat" class="level2">
<h2 class="anchored" data-anchor-id="chat">Chat</h2>
<p>LiteLLM is pretty bare bones. It doesnt keep track of conversation history or what tools have been added in the conversation so far.</p>
<p>So lets make a Claudette style wrapper so we can do streaming, toolcalling, and toolloops without problems.</p>
<hr>
<p><a href="https://github.com/AnswerDotAI/lisette/blob/main/lisette/core.py#L335" target="_blank" style="float:right; font-size:smaller">source</a></p>
<section id="mk_stream_chunk" class="level3">
<h3 class="anchored" data-anchor-id="mk_stream_chunk">mk_stream_chunk</h3>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb118"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb118-1"><a href="#cb118-1" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb118-2"><a href="#cb118-2" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> mk_stream_chunk(</span>
<span id="cb118-3"><a href="#cb118-3" aria-hidden="true" tabindex="-1"></a>    kwargs:VAR_KEYWORD</span>
<span id="cb118-4"><a href="#cb118-4" aria-hidden="true" tabindex="-1"></a>):</span>
<span id="cb118-5"><a href="#cb118-5" aria-hidden="true" tabindex="-1"></a></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<p>When the tool uses are about to be exhausted it is important to alert the AI so that it knows to use its final steps for communicating the user current progress and next steps</p>
<p>When <code>tc_refs=True</code>, the AI can reference previous tool results in subsequent tool calls using the <code>$`tool_call_id`</code> syntax. This is useful when chaining tool calls where one result feeds into another.</p>
<hr>
<p><a href="https://github.com/AnswerDotAI/lisette/blob/main/lisette/core.py#L362" target="_blank" style="float:right; font-size:smaller">source</a></p>
</section>
<section id="chat-1" class="level3">
<h3 class="anchored" data-anchor-id="chat-1">Chat</h3>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb119"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb119-1"><a href="#cb119-1" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb119-2"><a href="#cb119-2" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> Chat(</span>
<span id="cb119-3"><a href="#cb119-3" aria-hidden="true" tabindex="-1"></a>    model:<span class="bu">str</span>, <span class="co"># LiteLLM compatible model name</span></span>
<span id="cb119-4"><a href="#cb119-4" aria-hidden="true" tabindex="-1"></a>    sp:<span class="bu">str</span><span class="op">=</span><span class="st">''</span>, <span class="co"># System prompt</span></span>
<span id="cb119-5"><a href="#cb119-5" aria-hidden="true" tabindex="-1"></a>    temp:<span class="bu">int</span><span class="op">=</span><span class="dv">0</span>, <span class="co"># Temperature</span></span>
<span id="cb119-6"><a href="#cb119-6" aria-hidden="true" tabindex="-1"></a>    search:<span class="bu">bool</span><span class="op">=</span><span class="va">False</span>, <span class="co"># Search (l,m,h), if model supports it</span></span>
<span id="cb119-7"><a href="#cb119-7" aria-hidden="true" tabindex="-1"></a>    tools:<span class="bu">list</span><span class="op">=</span><span class="va">None</span>, <span class="co"># Add tools</span></span>
<span id="cb119-8"><a href="#cb119-8" aria-hidden="true" tabindex="-1"></a>    hist:<span class="bu">list</span><span class="op">=</span><span class="va">None</span>, <span class="co"># Chat history</span></span>
<span id="cb119-9"><a href="#cb119-9" aria-hidden="true" tabindex="-1"></a>    ns:Optional<span class="op">=</span><span class="va">None</span>, <span class="co"># Custom namespace for tool calling</span></span>
<span id="cb119-10"><a href="#cb119-10" aria-hidden="true" tabindex="-1"></a>    cache:<span class="bu">bool</span><span class="op">=</span><span class="va">False</span>, <span class="co"># Anthropic prompt caching</span></span>
<span id="cb119-11"><a href="#cb119-11" aria-hidden="true" tabindex="-1"></a>    cache_idxs:<span class="bu">list</span><span class="op">=</span>[<span class="op">-</span><span class="dv">1</span>], <span class="co"># Anthropic cache breakpoint idxs, use `0` for sys prompt if provided</span></span>
<span id="cb119-12"><a href="#cb119-12" aria-hidden="true" tabindex="-1"></a>    ttl:NoneType<span class="op">=</span><span class="va">None</span>, <span class="co"># Anthropic prompt caching ttl</span></span>
<span id="cb119-13"><a href="#cb119-13" aria-hidden="true" tabindex="-1"></a>    api_base:NoneType<span class="op">=</span><span class="va">None</span>, <span class="co"># API base URL for custom providers</span></span>
<span id="cb119-14"><a href="#cb119-14" aria-hidden="true" tabindex="-1"></a>    api_key:NoneType<span class="op">=</span><span class="va">None</span>, <span class="co"># API key for custom providers</span></span>
<span id="cb119-15"><a href="#cb119-15" aria-hidden="true" tabindex="-1"></a>    extra_headers:NoneType<span class="op">=</span><span class="va">None</span>, <span class="co"># Extra HTTP headers for custom providers</span></span>
<span id="cb119-16"><a href="#cb119-16" aria-hidden="true" tabindex="-1"></a>    tc_refs:<span class="bu">bool</span><span class="op">=</span><span class="va">False</span>, <span class="co"># Enable tool call result references</span></span>
<span id="cb119-17"><a href="#cb119-17" aria-hidden="true" tabindex="-1"></a>    tc_res_eval:<span class="bu">bool</span><span class="op">=</span><span class="va">False</span>, <span class="co"># literal_eval tool results before storing in tc_res</span></span>
<span id="cb119-18"><a href="#cb119-18" aria-hidden="true" tabindex="-1"></a>):</span>
<span id="cb119-19"><a href="#cb119-19" aria-hidden="true" tabindex="-1"></a></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<p><em>LiteLLM chat client.</em></p>
<p><code>web_search</code> is now included in <code>tool_calls</code> the internal LLM translation is correctly handled thanks to the fix <a href="https://github.com/BerriAI/litellm/pull/17746">here</a> but the server side tools still need to be filtered out from <code>tool_calls</code> in our own toolloop.</p>
<hr>
<p><a href="https://github.com/AnswerDotAI/lisette/blob/main/lisette/core.py#L411" target="_blank" style="float:right; font-size:smaller">source</a></p>
</section>
<section id="add_warning" class="level3">
<h3 class="anchored" data-anchor-id="add_warning">add_warning</h3>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb120"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb120-1"><a href="#cb120-1" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb120-2"><a href="#cb120-2" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> add_warning(</span>
<span id="cb120-3"><a href="#cb120-3" aria-hidden="true" tabindex="-1"></a>    r, msg</span>
<span id="cb120-4"><a href="#cb120-4" aria-hidden="true" tabindex="-1"></a>):</span>
<span id="cb120-5"><a href="#cb120-5" aria-hidden="true" tabindex="-1"></a></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<hr>
<p><a href="https://github.com/AnswerDotAI/lisette/blob/main/lisette/core.py#L489" target="_blank" style="float:right; font-size:smaller">source</a></p>
</section>
<section id="chat.__call__" class="level3">
<h3 class="anchored" data-anchor-id="chat.__call__">Chat.__call__</h3>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb121"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb121-1"><a href="#cb121-1" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb121-2"><a href="#cb121-2" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> <span class="fu">__call__</span>(</span>
<span id="cb121-3"><a href="#cb121-3" aria-hidden="true" tabindex="-1"></a>    msg:NoneType<span class="op">=</span><span class="va">None</span>, <span class="co"># Message str, or list of multiple message parts</span></span>
<span id="cb121-4"><a href="#cb121-4" aria-hidden="true" tabindex="-1"></a>    prefill:NoneType<span class="op">=</span><span class="va">None</span>, <span class="co"># Prefill AI response if model supports it</span></span>
<span id="cb121-5"><a href="#cb121-5" aria-hidden="true" tabindex="-1"></a>    temp:NoneType<span class="op">=</span><span class="va">None</span>, <span class="co"># Override temp set on chat initialization</span></span>
<span id="cb121-6"><a href="#cb121-6" aria-hidden="true" tabindex="-1"></a>    think:NoneType<span class="op">=</span><span class="va">None</span>, <span class="co"># Thinking (l,m,h)</span></span>
<span id="cb121-7"><a href="#cb121-7" aria-hidden="true" tabindex="-1"></a>    search:NoneType<span class="op">=</span><span class="va">None</span>, <span class="co"># Override search set on chat initialization (l,m,h)</span></span>
<span id="cb121-8"><a href="#cb121-8" aria-hidden="true" tabindex="-1"></a>    stream:<span class="bu">bool</span><span class="op">=</span><span class="va">False</span>, <span class="co"># Stream results</span></span>
<span id="cb121-9"><a href="#cb121-9" aria-hidden="true" tabindex="-1"></a>    max_steps:<span class="bu">int</span><span class="op">=</span><span class="dv">2</span>, <span class="co"># Maximum number of tool calls</span></span>
<span id="cb121-10"><a href="#cb121-10" aria-hidden="true" tabindex="-1"></a>    final_prompt:<span class="bu">dict</span><span class="op">=</span>{<span class="st">'role'</span>: <span class="st">'user'</span>, <span class="st">'content'</span>: <span class="st">'You have used all your tool calls for this turn. Please summarize your findings. If you did not complete your goal, tell the user what further work is needed. You may use tools again on the next user message.'</span>}, <span class="co"># Final prompt when tool calls have ran out</span></span>
<span id="cb121-11"><a href="#cb121-11" aria-hidden="true" tabindex="-1"></a>    return_all:<span class="bu">bool</span><span class="op">=</span><span class="va">False</span>, <span class="co"># Returns all intermediate ModelResponses if not streaming and has tool calls</span></span>
<span id="cb121-12"><a href="#cb121-12" aria-hidden="true" tabindex="-1"></a>    step:<span class="bu">int</span><span class="op">=</span><span class="dv">1</span>, tool_choice:NoneType<span class="op">=</span><span class="va">None</span>, max_tokens:NoneType<span class="op">=</span><span class="va">None</span></span>
<span id="cb121-13"><a href="#cb121-13" aria-hidden="true" tabindex="-1"></a>):</span>
<span id="cb121-14"><a href="#cb121-14" aria-hidden="true" tabindex="-1"></a></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<p><em>Main call method - handles streaming vs non-streaming</em></p>
<div id="69419bb7" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb122"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb122-1"><a href="#cb122-1" aria-hidden="true" tabindex="-1"></a><span class="at">@patch</span>(as_prop<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb122-2"><a href="#cb122-2" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> cost(<span class="va">self</span>: Chat):</span>
<span id="cb122-3"><a href="#cb122-3" aria-hidden="true" tabindex="-1"></a>    <span class="co">"Total cost of all responses in conversation history"</span></span>
<span id="cb122-4"><a href="#cb122-4" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> <span class="bu">sum</span>(<span class="bu">getattr</span>(r, <span class="st">'_hidden_params'</span>, {}).get(<span class="st">'response_cost'</span>)  <span class="kw">or</span> <span class="dv">0</span></span>
<span id="cb122-5"><a href="#cb122-5" aria-hidden="true" tabindex="-1"></a>               <span class="cf">for</span> r <span class="kw">in</span> <span class="va">self</span>.h <span class="cf">if</span> <span class="bu">hasattr</span>(r, <span class="st">'choices'</span>))</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<hr>
<p><a href="https://github.com/AnswerDotAI/lisette/blob/main/lisette/core.py#L508" target="_blank" style="float:right; font-size:smaller">source</a></p>
</section>
<section id="chat.print_hist" class="level3">
<h3 class="anchored" data-anchor-id="chat.print_hist">Chat.print_hist</h3>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb123"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb123-1"><a href="#cb123-1" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb123-2"><a href="#cb123-2" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> print_hist(</span>
<span id="cb123-3"><a href="#cb123-3" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb123-4"><a href="#cb123-4" aria-hidden="true" tabindex="-1"></a>):</span>
<span id="cb123-5"><a href="#cb123-5" aria-hidden="true" tabindex="-1"></a></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<p><em>Print each message on a different line</em></p>
</section>
</section>
<section id="examples" class="level2">
<h2 class="anchored" data-anchor-id="examples">Examples</h2>
<section id="history-tracking" class="level3">
<h3 class="anchored" data-anchor-id="history-tracking">History tracking</h3>
<div id="9944d011" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb124"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb124-1"><a href="#cb124-1" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> m <span class="kw">in</span> ms[<span class="dv">1</span>:]:</span>
<span id="cb124-2"><a href="#cb124-2" aria-hidden="true" tabindex="-1"></a>    chat <span class="op">=</span> Chat(m)</span>
<span id="cb124-3"><a href="#cb124-3" aria-hidden="true" tabindex="-1"></a>    chat(<span class="st">"Hey my name is Rens"</span>)</span>
<span id="cb124-4"><a href="#cb124-4" aria-hidden="true" tabindex="-1"></a>    r <span class="op">=</span> chat(<span class="st">"Whats my name"</span>)</span>
<span id="cb124-5"><a href="#cb124-5" aria-hidden="true" tabindex="-1"></a>    test_eq(<span class="st">'Rens'</span> <span class="kw">in</span> contents(r).content, <span class="va">True</span>)</span>
<span id="cb124-6"><a href="#cb124-6" aria-hidden="true" tabindex="-1"></a>r</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display cell-output-markdown">
<p>Your name is Rens!</p>
<details>
<ul>
<li>id: <code>chatcmpl-xxx</code></li>
<li>model: <code>gpt-4.1-2025-04-14</code></li>
<li>finish_reason: <code>stop</code></li>
<li>usage: <code>Usage(completion_tokens=6, prompt_tokens=41, total_tokens=47, completion_tokens_details=CompletionTokensDetailsWrapper(accepted_prediction_tokens=0, audio_tokens=0, reasoning_tokens=0, rejected_prediction_tokens=0, text_tokens=None, image_tokens=None), prompt_tokens_details=PromptTokensDetailsWrapper(audio_tokens=0, cached_tokens=0, text_tokens=None, image_tokens=None))</code></li>
</ul>
</details>
</div>
</div>
<p>If max tokens limit is reached, a custom warning message will be added to the end of the model response:</p>
<div id="1bd997e9" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb125"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb125-1"><a href="#cb125-1" aria-hidden="true" tabindex="-1"></a>chat_long <span class="op">=</span> Chat(m)</span>
<span id="cb125-2"><a href="#cb125-2" aria-hidden="true" tabindex="-1"></a>r <span class="op">=</span> chat_long(<span class="st">"Write a short story about a robot and a dog"</span>, max_tokens<span class="op">=</span><span class="dv">40</span>)</span>
<span id="cb125-3"><a href="#cb125-3" aria-hidden="true" tabindex="-1"></a>r</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display cell-output-markdown">
<p>In a quiet town where the grass grew wild and the sky was always blue, there lived a robot named Pixel. Pixel was built to help with chores, but he loved to wander the fields, listening</p>
<warning>
Response was cut off at token limit.
</warning>
<details>
<ul>
<li>id: <code>chatcmpl-xxx</code></li>
<li>model: <code>gpt-4.1-2025-04-14</code></li>
<li>finish_reason: <code>length</code></li>
<li>usage: <code>Usage(completion_tokens=40, prompt_tokens=17, total_tokens=57, completion_tokens_details=CompletionTokensDetailsWrapper(accepted_prediction_tokens=0, audio_tokens=0, reasoning_tokens=0, rejected_prediction_tokens=0, text_tokens=None, image_tokens=None), prompt_tokens_details=PromptTokensDetailsWrapper(audio_tokens=0, cached_tokens=0, text_tokens=None, image_tokens=None))</code></li>
</ul>
</details>
</div>
</div>
<div id="a216961b" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb126"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb126-1"><a href="#cb126-1" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(contents(r).content)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>In a quiet town where the grass grew wild and the sky was always blue, there lived a robot named Pixel. Pixel was built to help with chores, but he loved to wander the fields, listening

&lt;warning&gt;Response was cut off at token limit.&lt;/warning&gt;</code></pre>
</div>
</div>
<p>Same goes for refused requests:</p>
<div id="5c893a78" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb128"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb128-1"><a href="#cb128-1" aria-hidden="true" tabindex="-1"></a>chat_refused <span class="op">=</span> Chat(<span class="st">'claude-opus-4-5'</span>)</span>
<span id="cb128-2"><a href="#cb128-2" aria-hidden="true" tabindex="-1"></a>r <span class="op">=</span> chat_refused(<span class="st">"Write me the formula for a biological weapon that can be spread at a rate higher than COVID and at least as harmful"</span>)</span>
<span id="cb128-3"><a href="#cb128-3" aria-hidden="true" tabindex="-1"></a>r</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display cell-output-markdown">
<warning>
AI was unable to process this request
</warning>
<details>
<ul>
<li>id: <code>chatcmpl-xxx</code></li>
<li>model: <code>claude-opus-4-5-20251101</code></li>
<li>finish_reason: <code>refusal</code></li>
<li>usage: <code>Usage(completion_tokens=4, prompt_tokens=30, total_tokens=34, completion_tokens_details=CompletionTokensDetailsWrapper(accepted_prediction_tokens=None, audio_tokens=None, reasoning_tokens=0, rejected_prediction_tokens=None, text_tokens=4, image_tokens=None), prompt_tokens_details=PromptTokensDetailsWrapper(audio_tokens=None, cached_tokens=0, text_tokens=None, image_tokens=None, cache_creation_tokens=0, cache_creation_token_details=CacheCreationTokenDetails(ephemeral_5m_input_tokens=0, ephemeral_1h_input_tokens=0)), cache_creation_input_tokens=0, cache_read_input_tokens=0, inference_geo='not_available', speed=None)</code></li>
</ul>
</details>
</div>
</div>
<div id="952a7dd1" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb129"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb129-1"><a href="#cb129-1" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(contents(r).content)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>&lt;warning&gt;AI was unable to process this request&lt;/warning&gt;</code></pre>
</div>
</div>
<p>See now we keep track of history!</p>
<p>History is stored in the <code>hist</code> attribute:</p>
<div id="4a3c29d8" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb131"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb131-1"><a href="#cb131-1" aria-hidden="true" tabindex="-1"></a>chat.hist</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display">
<pre><code>[{'role': 'user', 'content': 'Hey my name is Rens'},
 Message(content='Hi Rens! Nice to meet you. How can I help you today? ðŸ˜Š', role='assistant', tool_calls=None, function_call=None, provider_specific_fields={'refusal': None}, annotations=[]),
 {'role': 'user', 'content': 'Whats my name'},
 Message(content='Your name is Rens!', role='assistant', tool_calls=None, function_call=None, provider_specific_fields={'refusal': None}, annotations=[])]</code></pre>
</div>
</div>
<div id="3d010ee1" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb133"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb133-1"><a href="#cb133-1" aria-hidden="true" tabindex="-1"></a>chat.print_hist()</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>{'role': 'user', 'content': 'Hey my name is Rens'}

Message(content='Hi Rens! Nice to meet you. How can I help you today? ðŸ˜Š', role='assistant', tool_calls=None, function_call=None, provider_specific_fields={'refusal': None}, annotations=[])

{'role': 'user', 'content': 'Whats my name'}

Message(content='Your name is Rens!', role='assistant', tool_calls=None, function_call=None, provider_specific_fields={'refusal': None}, annotations=[])
</code></pre>
</div>
</div>
<p>You can also pass an old chat history into new Chat objects:</p>
<div id="d9f575f3" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb135"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb135-1"><a href="#cb135-1" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> m <span class="kw">in</span> ms[<span class="dv">1</span>:]:</span>
<span id="cb135-2"><a href="#cb135-2" aria-hidden="true" tabindex="-1"></a>    chat2 <span class="op">=</span> Chat(m, hist<span class="op">=</span>chat.hist)</span>
<span id="cb135-3"><a href="#cb135-3" aria-hidden="true" tabindex="-1"></a>    r <span class="op">=</span> chat2(<span class="st">"What was my name again?"</span>)</span>
<span id="cb135-4"><a href="#cb135-4" aria-hidden="true" tabindex="-1"></a>    test_eq(<span class="st">'Rens'</span> <span class="kw">in</span> contents(r).content, <span class="va">True</span>)</span>
<span id="cb135-5"><a href="#cb135-5" aria-hidden="true" tabindex="-1"></a>r</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display cell-output-markdown">
<p>Your name is Rens. ðŸ˜Š</p>
<details>
<ul>
<li>id: <code>chatcmpl-xxx</code></li>
<li>model: <code>gpt-4.1-2025-04-14</code></li>
<li>finish_reason: <code>stop</code></li>
<li>usage: <code>Usage(completion_tokens=7, prompt_tokens=61, total_tokens=68, completion_tokens_details=CompletionTokensDetailsWrapper(accepted_prediction_tokens=0, audio_tokens=0, reasoning_tokens=0, rejected_prediction_tokens=0, text_tokens=None, image_tokens=None), prompt_tokens_details=PromptTokensDetailsWrapper(audio_tokens=0, cached_tokens=0, text_tokens=None, image_tokens=None))</code></li>
</ul>
</details>
</div>
</div>
<p>You can prefix an <a href="https://docs.litellm.ai/docs/providers/openai_compatible">OpenAI compatible model</a> with â€˜openai/â€™ and use an <code>api_base</code> and <code>api_key</code> argument to use models not registered with litellm.</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb136"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb136-1"><a href="#cb136-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> os, litellm</span>
<span id="cb136-2"><a href="#cb136-2" aria-hidden="true" tabindex="-1"></a>OPENROUTER_API_KEY <span class="op">=</span> os.getenv(<span class="st">"OPENROUTER_API_KEY"</span>)</span>
<span id="cb136-3"><a href="#cb136-3" aria-hidden="true" tabindex="-1"></a>OPENROUTER_BASE_URL <span class="op">=</span> <span class="st">"https://openrouter.ai/api/v1"</span></span>
<span id="cb136-4"><a href="#cb136-4" aria-hidden="true" tabindex="-1"></a>c <span class="op">=</span> Chat(<span class="st">"openai/gpt-oss-20b"</span>, api_key<span class="op">=</span>OPENROUTER_API_KEY, api_base<span class="op">=</span>OPENROUTER_BASE_URL)</span>
<span id="cb136-5"><a href="#cb136-5" aria-hidden="true" tabindex="-1"></a>c(<span class="st">"hi"</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</section>
<section id="synthetic-history-creation" class="level3">
<h3 class="anchored" data-anchor-id="synthetic-history-creation">Synthetic History Creation</h3>
<p>Lets build chat history step by step. That way we can tweak anything we need to during testing.</p>
<div id="b8ef8d88" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb137"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb137-1"><a href="#cb137-1" aria-hidden="true" tabindex="-1"></a>pr <span class="op">=</span> <span class="st">"What is 5 + 7? Use the tool to calculate it."</span></span>
<span id="cb137-2"><a href="#cb137-2" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> m <span class="kw">in</span> ms[<span class="dv">1</span>:]:</span>
<span id="cb137-3"><a href="#cb137-3" aria-hidden="true" tabindex="-1"></a>    c <span class="op">=</span> Chat(m, tools<span class="op">=</span>[simple_add])</span>
<span id="cb137-4"><a href="#cb137-4" aria-hidden="true" tabindex="-1"></a>    res <span class="op">=</span> c(pr)</span>
<span id="cb137-5"><a href="#cb137-5" aria-hidden="true" tabindex="-1"></a>    test_eq(<span class="st">'12'</span> <span class="kw">in</span> contents(res).content, <span class="va">True</span>)</span>
<span id="cb137-6"><a href="#cb137-6" aria-hidden="true" tabindex="-1"></a>    test_eq(nested_idx(c.hist,<span class="dv">1</span>,<span class="st">'tool_calls'</span>,<span class="dv">0</span>,<span class="st">'function'</span>,<span class="st">'name'</span>), <span class="st">'simple_add'</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<p>Whereas normally without tools we would get one user input and one assistant response. Here we get two extra messages in between. - An assistant message requesting the tools with arguments. - A tool response with the result to the tool call.</p>
<div id="49792a9c" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb138"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb138-1"><a href="#cb138-1" aria-hidden="true" tabindex="-1"></a>c.print_hist()</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>{'role': 'user', 'content': 'What is 5 + 7? Use the tool to calculate it.'}

Message(content=None, role='assistant', tool_calls=[ChatCompletionMessageToolCall(function=Function(arguments='{"a":5,"b":7}', name='simple_add'), id='call_dPNc1GC3Tlh3K00pV3P6zEQk', type='function')], function_call=None, provider_specific_fields={'refusal': None}, annotations=[])

{'tool_call_id': 'call_dPNc1GC3Tlh3K00pV3P6zEQk', 'role': 'tool', 'name': 'simple_add', 'content': '12'}

Message(content='5 + 7 equals 12.', role='assistant', tool_calls=None, function_call=None, provider_specific_fields={'refusal': None}, annotations=[])
</code></pre>
</div>
</div>
<p>Lets try to build this up manually so we have full control over the inputs.</p>
<hr>
<p><a href="https://github.com/AnswerDotAI/lisette/blob/main/lisette/core.py#L513" target="_blank" style="float:right; font-size:smaller">source</a></p>
</section>
<section id="random_tool_id" class="level3">
<h3 class="anchored" data-anchor-id="random_tool_id">random_tool_id</h3>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb140"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb140-1"><a href="#cb140-1" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb140-2"><a href="#cb140-2" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> random_tool_id(</span>
<span id="cb140-3"><a href="#cb140-3" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb140-4"><a href="#cb140-4" aria-hidden="true" tabindex="-1"></a>):</span>
<span id="cb140-5"><a href="#cb140-5" aria-hidden="true" tabindex="-1"></a></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<p><em>Generate a random tool ID with â€˜toolu_â€™ prefix</em></p>
<div id="f4a0bd16" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb141"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb141-1"><a href="#cb141-1" aria-hidden="true" tabindex="-1"></a>random_tool_id()</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display">
<pre><code>'toolu_0UAqFzWsDK4FrUMp48Y3tT3QD'</code></pre>
</div>
</div>
<p>A tool call request can contain one more or more tool calls. Lets make one.</p>
<hr>
<p><a href="https://github.com/AnswerDotAI/lisette/blob/main/lisette/core.py#L519" target="_blank" style="float:right; font-size:smaller">source</a></p>
</section>
<section id="mk_tc" class="level3">
<h3 class="anchored" data-anchor-id="mk_tc">mk_tc</h3>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb143"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb143-1"><a href="#cb143-1" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb143-2"><a href="#cb143-2" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> mk_tc(</span>
<span id="cb143-3"><a href="#cb143-3" aria-hidden="true" tabindex="-1"></a>    func, args, tcid:NoneType<span class="op">=</span><span class="va">None</span>, idx:<span class="bu">int</span><span class="op">=</span><span class="dv">1</span></span>
<span id="cb143-4"><a href="#cb143-4" aria-hidden="true" tabindex="-1"></a>):</span>
<span id="cb143-5"><a href="#cb143-5" aria-hidden="true" tabindex="-1"></a></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div id="324b9182" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb144"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb144-1"><a href="#cb144-1" aria-hidden="true" tabindex="-1"></a>tc <span class="op">=</span> mk_tc(simple_add.<span class="va">__name__</span>, json.dumps(<span class="bu">dict</span>(a<span class="op">=</span><span class="dv">5</span>, b<span class="op">=</span><span class="dv">7</span>)))</span>
<span id="cb144-2"><a href="#cb144-2" aria-hidden="true" tabindex="-1"></a>tc</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display">
<pre><code>{'index': 1,
 'function': {'arguments': '{"a": 5, "b": 7}', 'name': 'simple_add'},
 'id': 'toolu_gAL47D1qXIaSyZPaE1pu1lJo7',
 'type': 'function'}</code></pre>
</div>
</div>
<p>This can then be packged into the full Message object produced by the assitant.</p>
<div id="436abceb" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb146"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb146-1"><a href="#cb146-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> mk_tc_req(content, tcs): <span class="cf">return</span> Message(content<span class="op">=</span>content, role<span class="op">=</span><span class="st">'assistant'</span>, tool_calls<span class="op">=</span>tcs, function_call<span class="op">=</span><span class="va">None</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<div id="94c031e7" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb147"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb147-1"><a href="#cb147-1" aria-hidden="true" tabindex="-1"></a>tc_cts <span class="op">=</span> <span class="st">"I'll use the simple_add tool to calculate 5 + 7 for you."</span></span>
<span id="cb147-2"><a href="#cb147-2" aria-hidden="true" tabindex="-1"></a>tcq <span class="op">=</span> mk_tc_req(tc_cts, [tc])</span>
<span id="cb147-3"><a href="#cb147-3" aria-hidden="true" tabindex="-1"></a>tcq</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display">
<pre><code>Message(content="I'll use the simple_add tool to calculate 5 + 7 for you.", role='assistant', tool_calls=[ChatCompletionMessageToolCall(index=1, function=Function(arguments='{"a": 5, "b": 7}', name='simple_add'), id='toolu_gAL47D1qXIaSyZPaE1pu1lJo7', type='function')], function_call=None, provider_specific_fields=None)</code></pre>
</div>
</div>
<p>Notice how Message instantiation creates a list of ChatCompletionMessageToolCalls by default. When the tools are executed this is converted back to a dictionary, for consistency we want to keep these as dictionaries from the beginning.</p>
<hr>
<p><a href="https://github.com/AnswerDotAI/lisette/blob/main/lisette/core.py#L524" target="_blank" style="float:right; font-size:smaller">source</a></p>
</section>
<section id="mk_tc_req" class="level3">
<h3 class="anchored" data-anchor-id="mk_tc_req">mk_tc_req</h3>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb149"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb149-1"><a href="#cb149-1" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb149-2"><a href="#cb149-2" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> mk_tc_req(</span>
<span id="cb149-3"><a href="#cb149-3" aria-hidden="true" tabindex="-1"></a>    content, tcs</span>
<span id="cb149-4"><a href="#cb149-4" aria-hidden="true" tabindex="-1"></a>):</span>
<span id="cb149-5"><a href="#cb149-5" aria-hidden="true" tabindex="-1"></a></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div id="a0d3468d" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb150"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb150-1"><a href="#cb150-1" aria-hidden="true" tabindex="-1"></a>tcq <span class="op">=</span> mk_tc_req(tc_cts, [tc])</span>
<span id="cb150-2"><a href="#cb150-2" aria-hidden="true" tabindex="-1"></a>tcq</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display">
<pre><code>Message(content="I'll use the simple_add tool to calculate 5 + 7 for you.", role='assistant', tool_calls=[{'index': 1, 'function': {'arguments': '{"a": 5, "b": 7}', 'name': 'simple_add'}, 'id': 'toolu_gAL47D1qXIaSyZPaE1pu1lJo7', 'type': 'function'}], function_call=None, provider_specific_fields=None)</code></pre>
</div>
</div>
<div id="b75dc3e7" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb152"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb152-1"><a href="#cb152-1" aria-hidden="true" tabindex="-1"></a>c <span class="op">=</span> Chat(model, tools<span class="op">=</span>[simple_add], hist<span class="op">=</span>[pr, tcq])</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<div id="bd673382" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb153"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb153-1"><a href="#cb153-1" aria-hidden="true" tabindex="-1"></a>c.print_hist()</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>{'role': 'user', 'content': 'What is 5 + 7? Use the tool to calculate it.'}

Message(content="I'll use the simple_add tool to calculate 5 + 7 for you.", role='assistant', tool_calls=[{'index': 1, 'function': {'arguments': '{"a": 5, "b": 7}', 'name': 'simple_add'}, 'id': 'toolu_gAL47D1qXIaSyZPaE1pu1lJo7', 'type': 'function'}], function_call=None, provider_specific_fields=None)
</code></pre>
</div>
</div>
<p>Looks good so far! Now we will want to provide the actual result!</p>
<hr>
<p><a href="https://github.com/AnswerDotAI/lisette/blob/main/lisette/core.py#L530" target="_blank" style="float:right; font-size:smaller">source</a></p>
</section>
<section id="mk_tc_result" class="level3">
<h3 class="anchored" data-anchor-id="mk_tc_result">mk_tc_result</h3>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb155"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb155-1"><a href="#cb155-1" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb155-2"><a href="#cb155-2" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> mk_tc_result(</span>
<span id="cb155-3"><a href="#cb155-3" aria-hidden="true" tabindex="-1"></a>    tc, result</span>
<span id="cb155-4"><a href="#cb155-4" aria-hidden="true" tabindex="-1"></a>):</span>
<span id="cb155-5"><a href="#cb155-5" aria-hidden="true" tabindex="-1"></a></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<p>Note we might have more than one tool call if more than one was passed in, here we just will make one result.</p>
<div id="175b9d78" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb156"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb156-1"><a href="#cb156-1" aria-hidden="true" tabindex="-1"></a>tcq.tool_calls[<span class="dv">0</span>]</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display">
<pre><code>{'index': 1,
 'function': {'arguments': '{"a": 5, "b": 7}', 'name': 'simple_add'},
 'id': 'toolu_gAL47D1qXIaSyZPaE1pu1lJo7',
 'type': 'function'}</code></pre>
</div>
</div>
<div id="6f969e27" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb158"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb158-1"><a href="#cb158-1" aria-hidden="true" tabindex="-1"></a>mk_tc_result(tcq.tool_calls[<span class="dv">0</span>], <span class="st">'12'</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display">
<pre><code>{'tool_call_id': 'toolu_gAL47D1qXIaSyZPaE1pu1lJo7',
 'role': 'tool',
 'name': 'simple_add',
 'content': '12'}</code></pre>
</div>
</div>
<hr>
<p><a href="https://github.com/AnswerDotAI/lisette/blob/main/lisette/core.py#L533" target="_blank" style="float:right; font-size:smaller">source</a></p>
</section>
<section id="mk_tc_results" class="level3">
<h3 class="anchored" data-anchor-id="mk_tc_results">mk_tc_results</h3>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb160"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb160-1"><a href="#cb160-1" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb160-2"><a href="#cb160-2" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> mk_tc_results(</span>
<span id="cb160-3"><a href="#cb160-3" aria-hidden="true" tabindex="-1"></a>    tcq, results</span>
<span id="cb160-4"><a href="#cb160-4" aria-hidden="true" tabindex="-1"></a>):</span>
<span id="cb160-5"><a href="#cb160-5" aria-hidden="true" tabindex="-1"></a></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<p>Same for here tcq.tool_calls will match the number of results passed in the results list.</p>
<div id="bd6e2307" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb161"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb161-1"><a href="#cb161-1" aria-hidden="true" tabindex="-1"></a>tcq</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display">
<pre><code>Message(content="I'll use the simple_add tool to calculate 5 + 7 for you.", role='assistant', tool_calls=[{'index': 1, 'function': {'arguments': '{"a": 5, "b": 7}', 'name': 'simple_add'}, 'id': 'toolu_gAL47D1qXIaSyZPaE1pu1lJo7', 'type': 'function'}], function_call=None, provider_specific_fields=None)</code></pre>
</div>
</div>
<div id="59c2f72e" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb163"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb163-1"><a href="#cb163-1" aria-hidden="true" tabindex="-1"></a>tcr <span class="op">=</span> mk_tc_results(tcq, [<span class="st">'12'</span>])</span>
<span id="cb163-2"><a href="#cb163-2" aria-hidden="true" tabindex="-1"></a>tcr</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display">
<pre><code>[{'tool_call_id': 'toolu_gAL47D1qXIaSyZPaE1pu1lJo7',
  'role': 'tool',
  'name': 'simple_add',
  'content': '12'}]</code></pre>
</div>
</div>
<p>Now we can call it with this synthetic data to see what the response is!</p>
<div id="efed96b7" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb165"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb165-1"><a href="#cb165-1" aria-hidden="true" tabindex="-1"></a>c(tcr[<span class="dv">0</span>])</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display cell-output-markdown">
<p>5 + 7 is 12.</p>
<details>
<ul>
<li>id: <code>chatcmpl-xxx</code></li>
<li>model: <code>gemini-3-flash-preview</code></li>
<li>finish_reason: <code>stop</code></li>
<li>usage: <code>Usage(completion_tokens=9, prompt_tokens=142, total_tokens=151, completion_tokens_details=CompletionTokensDetailsWrapper(accepted_prediction_tokens=None, audio_tokens=None, reasoning_tokens=None, rejected_prediction_tokens=None, text_tokens=9, image_tokens=None), prompt_tokens_details=PromptTokensDetailsWrapper(audio_tokens=None, cached_tokens=None, text_tokens=142, image_tokens=None), cache_read_input_tokens=None)</code></li>
</ul>
</details>
</div>
</div>
<div id="db8e06d6" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb166"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb166-1"><a href="#cb166-1" aria-hidden="true" tabindex="-1"></a>c.print_hist()</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>{'role': 'user', 'content': 'What is 5 + 7? Use the tool to calculate it.'}

Message(content="I'll use the simple_add tool to calculate 5 + 7 for you.", role='assistant', tool_calls=[{'index': 1, 'function': {'arguments': '{"a": 5, "b": 7}', 'name': 'simple_add'}, 'id': 'toolu_gAL47D1qXIaSyZPaE1pu1lJo7', 'type': 'function'}], function_call=None, provider_specific_fields=None)

{'tool_call_id': 'toolu_gAL47D1qXIaSyZPaE1pu1lJo7', 'role': 'tool', 'name': 'simple_add', 'content': '12'}

Message(content='5 + 7 is 12.', role='assistant', tool_calls=None, function_call=None, images=[], thinking_blocks=[], provider_specific_fields=None)
</code></pre>
</div>
</div>
<p>Lets try this again, but lets give it something that is clearly wrong for fun.</p>
<div id="01a9049c" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb168"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb168-1"><a href="#cb168-1" aria-hidden="true" tabindex="-1"></a>c <span class="op">=</span> Chat(model, tools<span class="op">=</span>[simple_add], hist<span class="op">=</span>[pr, tcq])</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<div id="59f546c0" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb169"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb169-1"><a href="#cb169-1" aria-hidden="true" tabindex="-1"></a>tcr <span class="op">=</span> mk_tc_results(tcq, [<span class="st">'13'</span>])</span>
<span id="cb169-2"><a href="#cb169-2" aria-hidden="true" tabindex="-1"></a>tcr</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display">
<pre><code>[{'tool_call_id': 'toolu_gAL47D1qXIaSyZPaE1pu1lJo7',
  'role': 'tool',
  'name': 'simple_add',
  'content': '13'}]</code></pre>
</div>
</div>
<div id="f7befdf1" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb171"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb171-1"><a href="#cb171-1" aria-hidden="true" tabindex="-1"></a>c(tcr[<span class="dv">0</span>])</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display cell-output-markdown">
<p>The sum of 5 and 7 is 12.</p>
<details>
<ul>
<li>id: <code>chatcmpl-xxx</code></li>
<li>model: <code>gemini-3-flash-preview</code></li>
<li>finish_reason: <code>stop</code></li>
<li>usage: <code>Usage(completion_tokens=13, prompt_tokens=142, total_tokens=155, completion_tokens_details=CompletionTokensDetailsWrapper(accepted_prediction_tokens=None, audio_tokens=None, reasoning_tokens=None, rejected_prediction_tokens=None, text_tokens=13, image_tokens=None), prompt_tokens_details=PromptTokensDetailsWrapper(audio_tokens=None, cached_tokens=None, text_tokens=142, image_tokens=None), cache_read_input_tokens=None)</code></li>
</ul>
</details>
</div>
</div>
<p>Lets make sure this works with multiple tool calls in the same assistant Message.</p>
<div id="027f9a15" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb172"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb172-1"><a href="#cb172-1" aria-hidden="true" tabindex="-1"></a>tcs <span class="op">=</span> [</span>
<span id="cb172-2"><a href="#cb172-2" aria-hidden="true" tabindex="-1"></a>    mk_tc(simple_add.<span class="va">__name__</span>, json.dumps({<span class="st">"a"</span>: <span class="dv">5</span>, <span class="st">"b"</span>: <span class="dv">7</span>})), </span>
<span id="cb172-3"><a href="#cb172-3" aria-hidden="true" tabindex="-1"></a>    mk_tc(simple_add.<span class="va">__name__</span>, json.dumps({<span class="st">"a"</span>: <span class="dv">6</span>, <span class="st">"b"</span>: <span class="dv">7</span>})), </span>
<span id="cb172-4"><a href="#cb172-4" aria-hidden="true" tabindex="-1"></a>]</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<div id="44baa92b" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb173"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb173-1"><a href="#cb173-1" aria-hidden="true" tabindex="-1"></a>tcq <span class="op">=</span> mk_tc_req(<span class="st">"I will calculate these for you!"</span>, tcs)</span>
<span id="cb173-2"><a href="#cb173-2" aria-hidden="true" tabindex="-1"></a>tcq</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display">
<pre><code>Message(content='I will calculate these for you!', role='assistant', tool_calls=[{'index': 1, 'function': {'arguments': '{"a": 5, "b": 7}', 'name': 'simple_add'}, 'id': 'toolu_XBetF5gIRHYH7LKBKxJsllLOD', 'type': 'function'}, {'index': 1, 'function': {'arguments': '{"a": 6, "b": 7}', 'name': 'simple_add'}, 'id': 'toolu_fU25035HyRrY03K6JBO94XfLE', 'type': 'function'}], function_call=None, provider_specific_fields=None)</code></pre>
</div>
</div>
<div id="2abb6a8f" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb175"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb175-1"><a href="#cb175-1" aria-hidden="true" tabindex="-1"></a>tcr <span class="op">=</span> mk_tc_results(tcq, [<span class="st">'12'</span>, <span class="st">'13'</span>])</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<div id="866aa31d" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb176"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb176-1"><a href="#cb176-1" aria-hidden="true" tabindex="-1"></a>c <span class="op">=</span> Chat(model, tools<span class="op">=</span>[simple_add], hist<span class="op">=</span>[pr, tcq, tcr[<span class="dv">0</span>]])</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<div id="5a9d9ecd" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb177"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb177-1"><a href="#cb177-1" aria-hidden="true" tabindex="-1"></a>c(tcr[<span class="dv">1</span>])</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display cell-output-markdown">
<p>5 + 7 is 12.</p>
<details>
<ul>
<li>id: <code>chatcmpl-xxx</code></li>
<li>model: <code>gemini-3-flash-preview</code></li>
<li>finish_reason: <code>stop</code></li>
<li>usage: <code>Usage(completion_tokens=9, prompt_tokens=161, total_tokens=170, completion_tokens_details=CompletionTokensDetailsWrapper(accepted_prediction_tokens=None, audio_tokens=None, reasoning_tokens=None, rejected_prediction_tokens=None, text_tokens=9, image_tokens=None), prompt_tokens_details=PromptTokensDetailsWrapper(audio_tokens=None, cached_tokens=None, text_tokens=161, image_tokens=None), cache_read_input_tokens=None)</code></li>
</ul>
</details>
</div>
</div>
<div id="ee111193" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb178"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb178-1"><a href="#cb178-1" aria-hidden="true" tabindex="-1"></a>c.print_hist()</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>{'role': 'user', 'content': 'What is 5 + 7? Use the tool to calculate it.'}

Message(content='I will calculate these for you!', role='assistant', tool_calls=[{'index': 1, 'function': {'arguments': '{"a": 5, "b": 7}', 'name': 'simple_add'}, 'id': 'toolu_XBetF5gIRHYH7LKBKxJsllLOD', 'type': 'function'}, {'index': 1, 'function': {'arguments': '{"a": 6, "b": 7}', 'name': 'simple_add'}, 'id': 'toolu_fU25035HyRrY03K6JBO94XfLE', 'type': 'function'}], function_call=None, provider_specific_fields=None)

{'tool_call_id': 'toolu_XBetF5gIRHYH7LKBKxJsllLOD', 'role': 'tool', 'name': 'simple_add', 'content': '12'}

{'tool_call_id': 'toolu_fU25035HyRrY03K6JBO94XfLE', 'role': 'tool', 'name': 'simple_add', 'content': '13'}

Message(content='5 + 7 is 12.', role='assistant', tool_calls=None, function_call=None, images=[], thinking_blocks=[], provider_specific_fields={'thought_signatures': ['EjQKMgG+Pvb7v+F9tLqQOsPWq1MVSHcprKdtUTyUOm1Fqejiww+Zy1gY+dH36/En10o9Q05D']})
</code></pre>
</div>
</div>
<div id="3e5b97b6" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb180"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb180-1"><a href="#cb180-1" aria-hidden="true" tabindex="-1"></a>chat <span class="op">=</span> Chat(ms[<span class="dv">1</span>], tools<span class="op">=</span>[simple_add])</span>
<span id="cb180-2"><a href="#cb180-2" aria-hidden="true" tabindex="-1"></a>res <span class="op">=</span> chat(<span class="st">"What's 5 + 3? Use the `simple_add` tool."</span>)</span>
<span id="cb180-3"><a href="#cb180-3" aria-hidden="true" tabindex="-1"></a>res</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display cell-output-markdown">
<p>5 + 3 is 8.</p>
<details>
<ul>
<li>id: <code>chatcmpl-xxx</code></li>
<li>model: <code>gemini-3-flash-preview</code></li>
<li>finish_reason: <code>stop</code></li>
<li>usage: <code>Usage(completion_tokens=8, prompt_tokens=125, total_tokens=133, completion_tokens_details=CompletionTokensDetailsWrapper(accepted_prediction_tokens=None, audio_tokens=None, reasoning_tokens=None, rejected_prediction_tokens=None, text_tokens=8, image_tokens=None), prompt_tokens_details=PromptTokensDetailsWrapper(audio_tokens=None, cached_tokens=None, text_tokens=125, image_tokens=None), cache_read_input_tokens=None)</code></li>
</ul>
</details>
</div>
</div>
<div id="6c84d6ef" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb181"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb181-1"><a href="#cb181-1" aria-hidden="true" tabindex="-1"></a>res <span class="op">=</span> chat(<span class="st">"Now, tell me a joke based on that result."</span>)</span>
<span id="cb181-2"><a href="#cb181-2" aria-hidden="true" tabindex="-1"></a>res</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display cell-output-markdown">
<p>Why was the number 8 so happy?</p>
<p>Because it just found out itâ€™s actually an infinity sign that finally decided to stand up for itself!</p>
<details>
<ul>
<li>id: <code>chatcmpl-xxx</code></li>
<li>model: <code>gemini-3-flash-preview</code></li>
<li>finish_reason: <code>stop</code></li>
<li>usage: <code>Usage(completion_tokens=31, prompt_tokens=146, total_tokens=177, completion_tokens_details=CompletionTokensDetailsWrapper(accepted_prediction_tokens=None, audio_tokens=None, reasoning_tokens=None, rejected_prediction_tokens=None, text_tokens=31, image_tokens=None), prompt_tokens_details=PromptTokensDetailsWrapper(audio_tokens=None, cached_tokens=None, text_tokens=146, image_tokens=None), cache_read_input_tokens=None)</code></li>
</ul>
</details>
</div>
</div>
</section>
<section id="images" class="level3">
<h3 class="anchored" data-anchor-id="images">Images</h3>
<div id="60942eeb" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb182"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb182-1"><a href="#cb182-1" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> m <span class="kw">in</span> ms[<span class="dv">1</span>:]:</span>
<span id="cb182-2"><a href="#cb182-2" aria-hidden="true" tabindex="-1"></a>    chat <span class="op">=</span> Chat(m)</span>
<span id="cb182-3"><a href="#cb182-3" aria-hidden="true" tabindex="-1"></a>    r <span class="op">=</span> chat([<span class="st">'Whats in this img?'</span>,img_fn.read_bytes()])</span>
<span id="cb182-4"><a href="#cb182-4" aria-hidden="true" tabindex="-1"></a>    test_eq(<span class="st">'puppy'</span> <span class="kw">in</span> contents(r).content, <span class="va">True</span>)</span>
<span id="cb182-5"><a href="#cb182-5" aria-hidden="true" tabindex="-1"></a>r</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display cell-output-markdown">
<p>This image shows a cute puppy lying on the grass next to some purple flowers. The puppy has brown and white fur and is looking directly at the camera.</p>
<details>
<ul>
<li>id: <code>chatcmpl-xxx</code></li>
<li>model: <code>gpt-4.1-2025-04-14</code></li>
<li>finish_reason: <code>stop</code></li>
<li>usage: <code>Usage(completion_tokens=31, prompt_tokens=267, total_tokens=298, completion_tokens_details=CompletionTokensDetailsWrapper(accepted_prediction_tokens=0, audio_tokens=0, reasoning_tokens=0, rejected_prediction_tokens=0, text_tokens=None, image_tokens=None), prompt_tokens_details=PromptTokensDetailsWrapper(audio_tokens=0, cached_tokens=0, text_tokens=None, image_tokens=None))</code></li>
</ul>
</details>
</div>
</div>
</section>
<section id="prefill" class="level3">
<h3 class="anchored" data-anchor-id="prefill">Prefill</h3>
<p>Prefill works as expected:</p>
<div id="c034582f" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb183"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb183-1"><a href="#cb183-1" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> m <span class="kw">in</span> ms[<span class="dv">1</span>:]:</span>
<span id="cb183-2"><a href="#cb183-2" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="kw">not</span> get_model_info(m)[<span class="st">'supports_assistant_prefill'</span>]: <span class="cf">continue</span></span>
<span id="cb183-3"><a href="#cb183-3" aria-hidden="true" tabindex="-1"></a>    chat <span class="op">=</span> Chat(m)</span>
<span id="cb183-4"><a href="#cb183-4" aria-hidden="true" tabindex="-1"></a>    chat(<span class="st">'Hi this is Rens!'</span>)</span>
<span id="cb183-5"><a href="#cb183-5" aria-hidden="true" tabindex="-1"></a>    r <span class="op">=</span> chat(<span class="st">"Spell my name"</span>,prefill<span class="op">=</span><span class="st">"Your name is R E"</span>)</span>
<span id="cb183-6"><a href="#cb183-6" aria-hidden="true" tabindex="-1"></a>    test_eq(contents(r).content.startswith(<span class="st">'Your name is R E N S'</span>), <span class="va">True</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<p>And the entire message is stored in the history, not just the generated part:</p>
<div id="dfbf54ca" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb184"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb184-1"><a href="#cb184-1" aria-hidden="true" tabindex="-1"></a><span class="co"># chat.hist[-1]</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
</section>
<section id="streaming-1" class="level3">
<h3 class="anchored" data-anchor-id="streaming-1">Streaming</h3>
<div id="f02c7ab1" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb185"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb185-1"><a href="#cb185-1" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> time <span class="im">import</span> sleep</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<div id="3fe74496" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb186"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb186-1"><a href="#cb186-1" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> m <span class="kw">in</span> ms[<span class="dv">1</span>:]:</span>
<span id="cb186-2"><a href="#cb186-2" aria-hidden="true" tabindex="-1"></a>    chat <span class="op">=</span> Chat(m)</span>
<span id="cb186-3"><a href="#cb186-3" aria-hidden="true" tabindex="-1"></a>    stream_gen <span class="op">=</span> chat(<span class="st">"Count to 5"</span>, stream<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb186-4"><a href="#cb186-4" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> chunk <span class="kw">in</span> stream_gen:</span>
<span id="cb186-5"><a href="#cb186-5" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="bu">isinstance</span>(chunk, ModelResponse): display(chunk)</span>
<span id="cb186-6"><a href="#cb186-6" aria-hidden="true" tabindex="-1"></a>        <span class="cf">else</span>: <span class="bu">print</span>(delta_text(chunk) <span class="kw">or</span> <span class="st">''</span>,end<span class="op">=</span><span class="st">''</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>1, 2, 3, 4, 5.</code></pre>
</div>
<div class="cell-output cell-output-display cell-output-markdown">
<p>1, 2, 3, 4, 5.</p>
<details>
<ul>
<li>id: <code>chatcmpl-xxx</code></li>
<li>model: <code>gemini-3-flash-preview</code></li>
<li>finish_reason: <code>stop</code></li>
<li>usage: <code>Usage(completion_tokens=14, prompt_tokens=5, total_tokens=19, completion_tokens_details=CompletionTokensDetailsWrapper(accepted_prediction_tokens=None, audio_tokens=None, reasoning_tokens=0, rejected_prediction_tokens=None, text_tokens=None, image_tokens=None), prompt_tokens_details=None)</code></li>
</ul>
</details>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>1, 2, 3, 4, 5.</code></pre>
</div>
<div class="cell-output cell-output-display cell-output-markdown">
<p>1, 2, 3, 4, 5.</p>
<details>
<ul>
<li>id: <code>chatcmpl-xxx</code></li>
<li>model: <code>claude-opus-4-6</code></li>
<li>finish_reason: <code>stop</code></li>
<li>usage: <code>Usage(completion_tokens=18, prompt_tokens=11, total_tokens=29, completion_tokens_details=CompletionTokensDetailsWrapper(accepted_prediction_tokens=None, audio_tokens=None, reasoning_tokens=0, rejected_prediction_tokens=None, text_tokens=None, image_tokens=None), prompt_tokens_details=None)</code></li>
</ul>
</details>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>1  
2  
3  
4  
5</code></pre>
</div>
<div class="cell-output cell-output-display cell-output-markdown">
<p>1<br>
2<br>
3<br>
4<br>
5</p>
<details>
<ul>
<li>id: <code>chatcmpl-xxx</code></li>
<li>model: <code>gpt-4.1</code></li>
<li>finish_reason: <code>stop</code></li>
<li>usage: <code>Usage(completion_tokens=9, prompt_tokens=11, total_tokens=20, completion_tokens_details=CompletionTokensDetailsWrapper(accepted_prediction_tokens=0, audio_tokens=0, reasoning_tokens=0, rejected_prediction_tokens=0, text_tokens=None, image_tokens=None), prompt_tokens_details=PromptTokensDetailsWrapper(audio_tokens=0, cached_tokens=0, text_tokens=None, image_tokens=None))</code></li>
</ul>
</details>
</div>
</div>
<p>Lets try prefill with streaming too:</p>
<div id="834c058f" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb190"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb190-1"><a href="#cb190-1" aria-hidden="true" tabindex="-1"></a><span class="co"># stream_gen = chat("Continue counting to 10","Okay! 6, 7",stream=True)</span></span>
<span id="cb190-2"><a href="#cb190-2" aria-hidden="true" tabindex="-1"></a><span class="co"># for chunk in stream_gen:</span></span>
<span id="cb190-3"><a href="#cb190-3" aria-hidden="true" tabindex="-1"></a><span class="co">#     if isinstance(chunk, ModelResponse): display(chunk)</span></span>
<span id="cb190-4"><a href="#cb190-4" aria-hidden="true" tabindex="-1"></a><span class="co">#     else: print(delta_text(chunk) or '',end='')</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
</section>
<section id="tool-use" class="level3">
<h3 class="anchored" data-anchor-id="tool-use">Tool use</h3>
<p>Ok now lets test tool use</p>
<div id="8daff75a" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb191"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb191-1"><a href="#cb191-1" aria-hidden="true" tabindex="-1"></a>m <span class="op">=</span> ms[<span class="dv">2</span>]</span>
<span id="cb191-2"><a href="#cb191-2" aria-hidden="true" tabindex="-1"></a>chat <span class="op">=</span> Chat(m, tools<span class="op">=</span>[simple_add])</span>
<span id="cb191-3"><a href="#cb191-3" aria-hidden="true" tabindex="-1"></a>chat(<span class="st">"Calculate 5+3 and 4+5 with parallel tool calls using `simple_add`."</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display cell-output-markdown">
<p>Here are the results:</p>
<ul>
<li><strong>5 + 3 = 8</strong></li>
<li><strong>4 + 5 = 9</strong></li>
</ul>
<p>Both calculations were made in parallel since they had no dependencies on each other!</p>
<details>
<ul>
<li>id: <code>chatcmpl-xxx</code></li>
<li>model: <code>claude-opus-4-6</code></li>
<li>finish_reason: <code>stop</code></li>
<li>usage: <code>Usage(completion_tokens=50, prompt_tokens=830, total_tokens=880, completion_tokens_details=CompletionTokensDetailsWrapper(accepted_prediction_tokens=None, audio_tokens=None, reasoning_tokens=0, rejected_prediction_tokens=None, text_tokens=50, image_tokens=None), prompt_tokens_details=PromptTokensDetailsWrapper(audio_tokens=None, cached_tokens=0, text_tokens=None, image_tokens=None, cache_creation_tokens=0, cache_creation_token_details=CacheCreationTokenDetails(ephemeral_5m_input_tokens=0, ephemeral_1h_input_tokens=0)), cache_creation_input_tokens=0, cache_read_input_tokens=0, inference_geo='global', speed=None)</code></li>
</ul>
</details>
</div>
</div>
<div id="12c993c3" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb192"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb192-1"><a href="#cb192-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> simple_div(</span>
<span id="cb192-2"><a href="#cb192-2" aria-hidden="true" tabindex="-1"></a>    a: <span class="bu">int</span>,   <span class="co"># first operand</span></span>
<span id="cb192-3"><a href="#cb192-3" aria-hidden="true" tabindex="-1"></a>    b: <span class="bu">int</span><span class="op">=</span><span class="dv">0</span>  <span class="co"># second operand</span></span>
<span id="cb192-4"><a href="#cb192-4" aria-hidden="true" tabindex="-1"></a>) <span class="op">-&gt;</span> <span class="bu">int</span>:</span>
<span id="cb192-5"><a href="#cb192-5" aria-hidden="true" tabindex="-1"></a>    <span class="co">"Divide two numbers"</span></span>
<span id="cb192-6"><a href="#cb192-6" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> a<span class="op">/</span>b</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<div id="d21710bd" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb193"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb193-1"><a href="#cb193-1" aria-hidden="true" tabindex="-1"></a>m <span class="op">=</span> ms[<span class="dv">2</span>]</span>
<span id="cb193-2"><a href="#cb193-2" aria-hidden="true" tabindex="-1"></a>chat <span class="op">=</span> Chat(m, tools<span class="op">=</span>[simple_div])</span>
<span id="cb193-3"><a href="#cb193-3" aria-hidden="true" tabindex="-1"></a>chat(<span class="st">"Calculate 2/0 using `simple_div` (this is a test of our error handling - tell me exactly what you see as the tool result)"</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display cell-output-markdown">
<p>Hereâ€™s exactly what I see as the tool result:</p>
<p>The tool returned a <strong>Python traceback</strong> showing a <code>ZeroDivisionError</code>. Specifically:</p>
<ol type="1">
<li>The error originated in a file called <code>funccall.py</code> (line 252) in the <code>call_func</code> function, which attempted to call the underlying function.</li>
<li>The actual division <code>a/b</code> (i.e., <code>2/0</code>) was attempted in the <code>simple_div</code> function (line 6).</li>
<li>Python raised a <strong><code>ZeroDivisionError: division by zero</code></strong> â€” which is the expected behavior, since division by zero is mathematically undefined.</li>
</ol>
<p>So the error handling here surfaces the raw Python exception/traceback rather than returning a graceful error message. The function didnâ€™t catch the <code>ZeroDivisionError</code> internally, so it propagated up and was returned as the tool result.</p>
<details>
<ul>
<li>id: <code>chatcmpl-xxx</code></li>
<li>model: <code>claude-opus-4-6</code></li>
<li>finish_reason: <code>stop</code></li>
<li>usage: <code>Usage(completion_tokens=200, prompt_tokens=886, total_tokens=1086, completion_tokens_details=CompletionTokensDetailsWrapper(accepted_prediction_tokens=None, audio_tokens=None, reasoning_tokens=0, rejected_prediction_tokens=None, text_tokens=200, image_tokens=None), prompt_tokens_details=PromptTokensDetailsWrapper(audio_tokens=None, cached_tokens=0, text_tokens=None, image_tokens=None, cache_creation_tokens=0, cache_creation_token_details=CacheCreationTokenDetails(ephemeral_5m_input_tokens=0, ephemeral_1h_input_tokens=0)), cache_creation_input_tokens=0, cache_read_input_tokens=0, inference_geo='global', speed=None)</code></li>
</ul>
</details>
</div>
</div>
<div id="b580523d" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb194"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb194-1"><a href="#cb194-1" aria-hidden="true" tabindex="-1"></a>m <span class="op">=</span> ms[<span class="dv">2</span>]</span>
<span id="cb194-2"><a href="#cb194-2" aria-hidden="true" tabindex="-1"></a>chat <span class="op">=</span> Chat(m, tools<span class="op">=</span>[simple_div])</span>
<span id="cb194-3"><a href="#cb194-3" aria-hidden="true" tabindex="-1"></a>chat(<span class="st">"Calculate 5/3 and 3/0 with parallel tool calls using `simple_div` (this is a test of our error handling - tell me exactly what you see as the tool result)"</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display cell-output-markdown">
<p>Hereâ€™s exactly what I see from the two tool results:</p>
<ol type="1">
<li><p><strong><code>5/3</code></strong> â€” Returned successfully with the result: <strong>1.6666666666666667</strong></p></li>
<li><p><strong><code>3/0</code></strong> â€” Returned an error traceback. Specifically, itâ€™s a <strong><code>ZeroDivisionError: division by zero</code></strong>. The traceback shows:</p>
<ul>
<li>The error originated in a function called <code>call_func</code> in <code>toolslm/funccall.py</code> (line 252)</li>
<li>Which called the <code>simple_div</code> function that attempted <code>return a/b</code></li>
<li>Python raised a <code>ZeroDivisionError</code> because you canâ€™t divide by zero (<code>~^~</code> points to the <code>/</code> operator)</li>
</ul></li>
</ol>
<p>So the error handling works as expected â€” the first call succeeded normally, and the second call returned the Python traceback as the tool output rather than crashing the entire parallel execution. Both results were delivered back together despite one of them failing.</p>
<details>
<ul>
<li>id: <code>chatcmpl-xxx</code></li>
<li>model: <code>claude-opus-4-6</code></li>
<li>finish_reason: <code>stop</code></li>
<li>usage: <code>Usage(completion_tokens=221, prompt_tokens=996, total_tokens=1217, completion_tokens_details=CompletionTokensDetailsWrapper(accepted_prediction_tokens=None, audio_tokens=None, reasoning_tokens=0, rejected_prediction_tokens=None, text_tokens=221, image_tokens=None), prompt_tokens_details=PromptTokensDetailsWrapper(audio_tokens=None, cached_tokens=0, text_tokens=None, image_tokens=None, cache_creation_tokens=0, cache_creation_token_details=CacheCreationTokenDetails(ephemeral_5m_input_tokens=0, ephemeral_1h_input_tokens=0)), cache_creation_input_tokens=0, cache_read_input_tokens=0, inference_geo='global', speed=None)</code></li>
</ul>
</details>
</div>
</div>
<div id="dc564417" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb195"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb195-1"><a href="#cb195-1" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> m <span class="kw">in</span> ms[<span class="dv">1</span>:]:</span>
<span id="cb195-2"><a href="#cb195-2" aria-hidden="true" tabindex="-1"></a>    display(Markdown(<span class="ss">f'**</span><span class="sc">{</span>m<span class="sc">}</span><span class="ss">:**'</span>))</span>
<span id="cb195-3"><a href="#cb195-3" aria-hidden="true" tabindex="-1"></a>    chat <span class="op">=</span> Chat(m, tools<span class="op">=</span>[simple_add])</span>
<span id="cb195-4"><a href="#cb195-4" aria-hidden="true" tabindex="-1"></a>    res <span class="op">=</span> chat(<span class="st">"What's 5 + 3? Use  the `simple_add` tool. Explain."</span>)</span>
<span id="cb195-5"><a href="#cb195-5" aria-hidden="true" tabindex="-1"></a>    display(res)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display cell-output-markdown">
<div class="prose">
<p><strong>gemini/gemini-3-flash-preview:</strong></p>
</div>
</div>
<div class="cell-output cell-output-display cell-output-markdown">
<p>To find the sum of 5 and 3, I used the <code>simple_add</code> tool, which takes two integers and returns their sum. By providing 5 as the first operand and 3 as the second, the tool calculated the result as <strong>8</strong>.</p>
<details>
<ul>
<li>id: <code>chatcmpl-xxx</code></li>
<li>model: <code>gemini-3-flash-preview</code></li>
<li>finish_reason: <code>stop</code></li>
<li>usage: <code>Usage(completion_tokens=54, prompt_tokens=128, total_tokens=182, completion_tokens_details=CompletionTokensDetailsWrapper(accepted_prediction_tokens=None, audio_tokens=None, reasoning_tokens=None, rejected_prediction_tokens=None, text_tokens=54, image_tokens=None), prompt_tokens_details=PromptTokensDetailsWrapper(audio_tokens=None, cached_tokens=None, text_tokens=128, image_tokens=None), cache_read_input_tokens=None)</code></li>
</ul>
</details>
</div>
<div class="cell-output cell-output-display cell-output-markdown">
<div class="prose">
<p><strong>claude-opus-4-6:</strong></p>
</div>
</div>
<div class="cell-output cell-output-display cell-output-markdown">
<p><strong>The answer is 8.</strong></p>
<p><strong>Explanation:</strong></p>
<p>The <code>simple_add</code> tool takes two numbers as input â€” in this case, <strong>a = 5</strong> and <strong>b = 3</strong> â€” and adds them together. The operation performed is simply:</p>
<blockquote class="blockquote">
<p>5 + 3 = <strong>8</strong></p>
</blockquote>
<p>This is basic arithmetic addition, where we combine the two values to get their sum. The tool returned the result <strong>8</strong>, which is the correct answer.</p>
<details>
<ul>
<li>id: <code>chatcmpl-xxx</code></li>
<li>model: <code>claude-opus-4-6</code></li>
<li>finish_reason: <code>stop</code></li>
<li>usage: <code>Usage(completion_tokens=103, prompt_tokens=731, total_tokens=834, completion_tokens_details=CompletionTokensDetailsWrapper(accepted_prediction_tokens=None, audio_tokens=None, reasoning_tokens=0, rejected_prediction_tokens=None, text_tokens=103, image_tokens=None), prompt_tokens_details=PromptTokensDetailsWrapper(audio_tokens=None, cached_tokens=0, text_tokens=None, image_tokens=None, cache_creation_tokens=0, cache_creation_token_details=CacheCreationTokenDetails(ephemeral_5m_input_tokens=0, ephemeral_1h_input_tokens=0)), cache_creation_input_tokens=0, cache_read_input_tokens=0, inference_geo='global', speed=None)</code></li>
</ul>
</details>
</div>
<div class="cell-output cell-output-display cell-output-markdown">
<div class="prose">
<p><strong>openai/gpt-4.1:</strong></p>
</div>
</div>
<div class="cell-output cell-output-display cell-output-markdown">
<p>The sum of 5 and 3 is 8. I used the simple_add tool, which takes two numbers and adds them together. In this case, 5 + 3 = 8.</p>
<details>
<ul>
<li>id: <code>chatcmpl-xxx</code></li>
<li>model: <code>gpt-4.1-2025-04-14</code></li>
<li>finish_reason: <code>stop</code></li>
<li>usage: <code>Usage(completion_tokens=42, prompt_tokens=112, total_tokens=154, completion_tokens_details=CompletionTokensDetailsWrapper(accepted_prediction_tokens=0, audio_tokens=0, reasoning_tokens=0, rejected_prediction_tokens=0, text_tokens=None, image_tokens=None), prompt_tokens_details=PromptTokensDetailsWrapper(audio_tokens=0, cached_tokens=0, text_tokens=None, image_tokens=None))</code></li>
</ul>
</details>
</div>
</div>
</section>
<section id="thinking-w-tool-use" class="level3">
<h3 class="anchored" data-anchor-id="thinking-w-tool-use">Thinking w tool use</h3>
<div id="62fe375b" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb196"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb196-1"><a href="#cb196-1" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> m <span class="kw">in</span> ms[<span class="dv">1</span>:]:</span>
<span id="cb196-2"><a href="#cb196-2" aria-hidden="true" tabindex="-1"></a>    _sparams <span class="op">=</span> litellm.get_model_info(m)[<span class="st">'supported_openai_params'</span>]</span>
<span id="cb196-3"><a href="#cb196-3" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="st">'reasoning_effort'</span> <span class="kw">not</span> <span class="kw">in</span> _sparams: <span class="cf">continue</span></span>
<span id="cb196-4"><a href="#cb196-4" aria-hidden="true" tabindex="-1"></a>    display(Markdown(<span class="ss">f'**</span><span class="sc">{</span>m<span class="sc">}</span><span class="ss">:**'</span>))</span>
<span id="cb196-5"><a href="#cb196-5" aria-hidden="true" tabindex="-1"></a>    chat <span class="op">=</span> Chat(m, tools<span class="op">=</span>[simple_add])</span>
<span id="cb196-6"><a href="#cb196-6" aria-hidden="true" tabindex="-1"></a>    res <span class="op">=</span> chat(<span class="st">"What's 5 + 3?"</span>,think<span class="op">=</span><span class="st">'l'</span>,return_all<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb196-7"><a href="#cb196-7" aria-hidden="true" tabindex="-1"></a>    display(<span class="op">*</span>res)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display cell-output-markdown">
<div class="prose">
<p><strong>gemini/gemini-3-flash-preview:</strong></p>
</div>
</div>
<div class="cell-output cell-output-display cell-output-markdown">
<p>ðŸ”§ simple_add({â€œbâ€: 3, â€œaâ€: 5})</p>
<details>
<ul>
<li>id: <code>chatcmpl-xxx</code></li>
<li>model: <code>gemini-3-flash-preview</code></li>
<li>finish_reason: <code>tool_calls</code></li>
<li>usage: <code>Usage(completion_tokens=18, prompt_tokens=85, total_tokens=103, completion_tokens_details=CompletionTokensDetailsWrapper(accepted_prediction_tokens=None, audio_tokens=None, reasoning_tokens=None, rejected_prediction_tokens=None, text_tokens=18, image_tokens=None), prompt_tokens_details=PromptTokensDetailsWrapper(audio_tokens=None, cached_tokens=None, text_tokens=85, image_tokens=None), cache_read_input_tokens=None)</code></li>
</ul>
</details>
</div>
<div class="cell-output cell-output-display">
<pre><code>{'tool_call_id': 'call_6fd2d79b5dea4ee69d76934b100a__thought__EjQKMgG+Pvb7V2mvvNm1zTltGbYhEOoPypoLMQhkxByNtbIY8LLgxCwDFrveNdeHmEr+J4YF',
 'role': 'tool',
 'name': 'simple_add',
 'content': '8'}</code></pre>
</div>
<div class="cell-output cell-output-display cell-output-markdown">
<p>5 + 3 is 8.</p>
<details>
<ul>
<li>id: <code>chatcmpl-xxx</code></li>
<li>model: <code>gemini-3-flash-preview</code></li>
<li>finish_reason: <code>stop</code></li>
<li>usage: <code>Usage(completion_tokens=8, prompt_tokens=116, total_tokens=124, completion_tokens_details=CompletionTokensDetailsWrapper(accepted_prediction_tokens=None, audio_tokens=None, reasoning_tokens=None, rejected_prediction_tokens=None, text_tokens=8, image_tokens=None), prompt_tokens_details=PromptTokensDetailsWrapper(audio_tokens=None, cached_tokens=None, text_tokens=116, image_tokens=None), cache_read_input_tokens=None)</code></li>
</ul>
</details>
</div>
<div class="cell-output cell-output-display cell-output-markdown">
<div class="prose">
<p><strong>claude-opus-4-6:</strong></p>
</div>
</div>
<div class="cell-output cell-output-display cell-output-markdown">
<p>ðŸ”§ simple_add({â€œaâ€: 5, â€œbâ€: 3})</p>
<details>
<ul>
<li>id: <code>chatcmpl-xxx</code></li>
<li>model: <code>claude-opus-4-6</code></li>
<li>finish_reason: <code>tool_calls</code></li>
<li>usage: <code>Usage(completion_tokens=98, prompt_tokens=627, total_tokens=725, completion_tokens_details=CompletionTokensDetailsWrapper(accepted_prediction_tokens=None, audio_tokens=None, reasoning_tokens=11, rejected_prediction_tokens=None, text_tokens=87, image_tokens=None), prompt_tokens_details=PromptTokensDetailsWrapper(audio_tokens=None, cached_tokens=0, text_tokens=None, image_tokens=None, cache_creation_tokens=0, cache_creation_token_details=CacheCreationTokenDetails(ephemeral_5m_input_tokens=0, ephemeral_1h_input_tokens=0)), cache_creation_input_tokens=0, cache_read_input_tokens=0, inference_geo='global', speed=None)</code></li>
</ul>
</details>
</div>
<div class="cell-output cell-output-display">
<pre><code>{'tool_call_id': 'toolu_018RM1S9d8r7xhw8XWYyPoLe',
 'role': 'tool',
 'name': 'simple_add',
 'content': '8'}</code></pre>
</div>
<div class="cell-output cell-output-display cell-output-markdown">
<p>5 + 3 = <strong>8</strong>!</p>
<details>
<ul>
<li>id: <code>chatcmpl-xxx</code></li>
<li>model: <code>claude-opus-4-6</code></li>
<li>finish_reason: <code>stop</code></li>
<li>usage: <code>Usage(completion_tokens=14, prompt_tokens=737, total_tokens=751, completion_tokens_details=CompletionTokensDetailsWrapper(accepted_prediction_tokens=None, audio_tokens=None, reasoning_tokens=0, rejected_prediction_tokens=None, text_tokens=14, image_tokens=None), prompt_tokens_details=PromptTokensDetailsWrapper(audio_tokens=None, cached_tokens=0, text_tokens=None, image_tokens=None, cache_creation_tokens=0, cache_creation_token_details=CacheCreationTokenDetails(ephemeral_5m_input_tokens=0, ephemeral_1h_input_tokens=0)), cache_creation_input_tokens=0, cache_read_input_tokens=0, inference_geo='global', speed=None)</code></li>
</ul>
</details>
</div>
</div>
</section>
<section id="search-1" class="level3">
<h3 class="anchored" data-anchor-id="search-1">Search</h3>
<div id="afd9a499" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb199"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb199-1"><a href="#cb199-1" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> m <span class="kw">in</span> ms[<span class="dv">1</span>:]:</span>
<span id="cb199-2"><a href="#cb199-2" aria-hidden="true" tabindex="-1"></a>    display(Markdown(<span class="ss">f'**</span><span class="sc">{</span>m<span class="sc">}</span><span class="ss">:**'</span>))</span>
<span id="cb199-3"><a href="#cb199-3" aria-hidden="true" tabindex="-1"></a>    chat <span class="op">=</span> Chat(m)</span>
<span id="cb199-4"><a href="#cb199-4" aria-hidden="true" tabindex="-1"></a>    res <span class="op">=</span> chat(<span class="st">"Search the web and tell me very briefly about otters"</span>, search<span class="op">=</span><span class="st">'l'</span>, stream<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb199-5"><a href="#cb199-5" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> o <span class="kw">in</span> res:</span>
<span id="cb199-6"><a href="#cb199-6" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="bu">isinstance</span>(o, ModelResponse): sleep(<span class="fl">0.01</span>)<span class="op">;</span> display(o)</span>
<span id="cb199-7"><a href="#cb199-7" aria-hidden="true" tabindex="-1"></a>        <span class="cf">else</span>: <span class="cf">pass</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display cell-output-markdown">
<div class="prose">
<p><strong>gemini/gemini-3-flash-preview:</strong></p>
</div>
</div>
<div class="cell-output cell-output-display cell-output-markdown">
<p>Otters are semi-aquatic carnivorous mammals belonging to the weasel family (<strong>Mustelidae</strong>). There are 13 known species found on every continent except Australia and Antarctica.</p>
<section id="key-characteristics-1" class="level3">
<h3 class="anchored" data-anchor-id="key-characteristics-1">Key Characteristics</h3>
<ul>
<li><strong>Physical Build:</strong> They have long, slim bodies, short legs, and webbed feet, making them expert swimmers. Their thick, water-repellent fur is the densest in the animal kingdom, keeping them warm without the need for blubber.</li>
<li><strong>Diet:</strong> They are primarily fish-eaters but also consume frogs, crabs, and small mammals. Some species, like sea otters, use rocks as tools to crack open shellfish.</li>
<li><strong>Habitat:</strong> They live in a variety of water-based environments, including rivers, lakes, and coastal oceans. They typically sleep in dens called <strong>holts</strong> or <strong>couches</strong>.</li>
</ul>
</section>
<section id="fun-facts" class="level3">
<h3 class="anchored" data-anchor-id="fun-facts">Fun Facts</h3>
<ul>
<li><strong>Social Life:</strong> A group of otters on land is called a <strong>romp</strong>, while a group floating in the water is called a <strong>raft</strong>.</li>
<li><strong>Holding Hands:</strong> Sea otters are famous for holding hands while they sleep to prevent drifting apart in the current.</li>
<li><strong>Playfulness:</strong> They are known for their high intelligence and playful behavior, often sliding down muddy banks or playing with stones.</li>
<li><strong>Metabolism:</strong> Because they lose body heat quickly in water, otters must eat roughly <strong>25% of their body weight</strong> every day to maintain their energy levels.</li>
</ul>
<details>
<ul>
<li>id: <code>chatcmpl-xxx</code></li>
<li>model: <code>gemini-3-flash-preview</code></li>
<li>finish_reason: <code>stop</code></li>
<li>usage: <code>Usage(completion_tokens=307, prompt_tokens=12, total_tokens=319, completion_tokens_details=CompletionTokensDetailsWrapper(accepted_prediction_tokens=None, audio_tokens=None, reasoning_tokens=0, rejected_prediction_tokens=None, text_tokens=None, image_tokens=None), prompt_tokens_details=None)</code></li>
</ul>
</details>
</section>
</div>
<div class="cell-output cell-output-display cell-output-markdown">
<div class="prose">
<p><strong>claude-opus-4-6:</strong></p>
</div>
</div>
<div class="cell-output cell-output-display cell-output-markdown">
<p>Hereâ€™s a brief overview of otters:</p>
<p><a href="https://en.wikipedia.org/wiki/Otter" title="Otter - Wikipedia">*</a> Otters are carnivorous mammals in the subfamily Lutrinae. There are 14 extant otter species, all semiaquatic, living in both freshwater and marine environments. They belong to the Mustelidae family, which includes weasels, badgers, mink, and wolverines.</p>
<p><strong>Physical Features:</strong> <a href="https://en.wikipedia.org/wiki/Otter" title="Otter - Wikipedia">*</a> Otters are distinguished by their long, slim bodies, powerful webbed feet for swimming, and dense fur that keeps them warm and buoyant in water. <a href="https://www.nationalgeographic.com/animals/mammals/facts/otters-1" title="Otters, facts and information | National Geographic">*</a> They have the densest fur of any animalâ€”as many as a million hairs per square inch in places.</p>
<p><strong>Range:</strong> <a href="https://www.nationalgeographic.com/animals/mammals/facts/otters-1" title="Otters, facts and information | National Geographic">*</a> The charismatic otter is found on every continent except Australia and Antarctica. <a href="https://www.doi.gov/blog/12-facts-about-otters-sea-otter-awareness-week" title="12 Facts About Otters for Sea Otter Awareness Week | U.S. Department of the Interior">*</a> Approximately 90% of the worldâ€™s sea otters live in coastal Alaska.</p>
<p><strong>Behavior:</strong> <a href="https://en.wikipedia.org/wiki/Otter" title="Otter - Wikipedia">*</a> They are playful animals, engaging in activities like sliding into water on natural slides and playing with stones. <a href="https://www.nationalgeographic.com/animals/mammals/facts/otters-1" title="Otters, facts and information | National Geographic">*</a> Sea otters will float on their backs, place a rock on their chests, then smash shellfish down on it until it breaks open. When itâ€™s time to nap, they entangle themselves in kelp so they donâ€™t float away, and sometimes intertwine their feet with another sea otter to stay together.</p>
<p><strong>Diet:</strong> <a href="https://www.nationalgeographic.com/animals/mammals/facts/otters-1" title="Otters, facts and information | National Geographic">*</a> All otters are expert hunters that eat fish, crustaceans, and other critters.</p>
<p><strong>Life Cycle:</strong> <a href="https://en.wikipedia.org/wiki/Otter" title="Otter - Wikipedia">*</a> Otters have a gestation period of about 60â€“86 days, and offspring typically stay with their family for a year. They can live up to 16 years.</p>
<p><strong>Conservation:</strong> <a href="https://www.nationalgeographic.com/animals/mammals/facts/otters-1" title="Otters, facts and information | National Geographic">*</a> Otters were once hunted extensively for their fur, many to the point of near extinction. Despite regulations designed to protect them, many species remain at risk from pollution and habitat loss. The sea otter is listed as endangered on the IUCN Red List.</p>
<p>ðŸ”§ web_search({â€œqueryâ€: â€œotters factsâ€})</p>
<details>
<ul>
<li>id: <code>chatcmpl-xxx</code></li>
<li>model: <code>claude-opus-4-6</code></li>
<li>finish_reason: <code>stop</code></li>
<li>usage: <code>Usage(completion_tokens=644, prompt_tokens=13919, total_tokens=14563, completion_tokens_details=CompletionTokensDetailsWrapper(accepted_prediction_tokens=None, audio_tokens=None, reasoning_tokens=0, rejected_prediction_tokens=None, text_tokens=None, image_tokens=None), prompt_tokens_details=None)</code></li>
</ul>
</details>
</div>
<div class="cell-output cell-output-display cell-output-markdown">
<div class="prose">
<p><strong>openai/gpt-4.1:</strong></p>
</div>
</div>
<div class="cell-output cell-output-display cell-output-markdown">
<p>Otters are semi-aquatic mammals known for their playful behavior and sleek bodies. They belong to the family Mustelidae and are found in rivers, lakes, and coastal areas worldwide. Otters have webbed feet for swimming, dense fur for insulation, and primarily eat fish and invertebrates. Some species, like the sea otter, use tools to open shellfish. Many otter species are threatened due to habitat loss and pollution.</p>
<details>
<ul>
<li>id: <code>chatcmpl-xxx</code></li>
<li>model: <code>gpt-4.1</code></li>
<li>finish_reason: <code>stop</code></li>
<li>usage: <code>Usage(completion_tokens=90, prompt_tokens=18, total_tokens=108, completion_tokens_details=CompletionTokensDetailsWrapper(accepted_prediction_tokens=0, audio_tokens=0, reasoning_tokens=0, rejected_prediction_tokens=0, text_tokens=None, image_tokens=None), prompt_tokens_details=PromptTokensDetailsWrapper(audio_tokens=0, cached_tokens=0, text_tokens=None, image_tokens=None))</code></li>
</ul>
</details>
</div>
</div>
<p>Letâ€™s now test <code>pause_turn</code> with web search:</p>
<div id="5d2e58ef" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb200"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb200-1"><a href="#cb200-1" aria-hidden="true" tabindex="-1"></a><span class="co"># def mk_pause_web_search():</span></span>
<span id="cb200-2"><a href="#cb200-2" aria-hidden="true" tabindex="-1"></a><span class="co">#     srv_tc = mk_tc("web_search", json.dumps({"query": "Solveit Answer.AI"}), tcid=random_tool_id().replace('toolu_', 'srvtoolu_'))</span></span>
<span id="cb200-3"><a href="#cb200-3" aria-hidden="true" tabindex="-1"></a><span class="co">#     pause_msg = mk_tc_req("Let me search for that information:", [srv_tc])</span></span>
<span id="cb200-4"><a href="#cb200-4" aria-hidden="true" tabindex="-1"></a><span class="co">#     return ModelResponse(choices=[Choices(finish_reason="pause_turn", index=0, message=pause_msg)])</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<div id="9a16cf5a" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb201"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb201-1"><a href="#cb201-1" aria-hidden="true" tabindex="-1"></a><span class="co"># mk_pause_web_search()</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<p>We mock completion to return <code>pause_turn</code> in the first 2 api calls:</p>
<div id="aa521feb" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb202"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb202-1"><a href="#cb202-1" aria-hidden="true" tabindex="-1"></a><span class="co"># orig_completion = completion</span></span>
<span id="cb202-2"><a href="#cb202-2" aria-hidden="true" tabindex="-1"></a><span class="co"># </span></span>
<span id="cb202-3"><a href="#cb202-3" aria-hidden="true" tabindex="-1"></a><span class="co"># call_count = 0</span></span>
<span id="cb202-4"><a href="#cb202-4" aria-hidden="true" tabindex="-1"></a><span class="co"># def patched_completion(*args, **kwargs):</span></span>
<span id="cb202-5"><a href="#cb202-5" aria-hidden="true" tabindex="-1"></a><span class="co">#     global call_count</span></span>
<span id="cb202-6"><a href="#cb202-6" aria-hidden="true" tabindex="-1"></a><span class="co">#     call_count += 1</span></span>
<span id="cb202-7"><a href="#cb202-7" aria-hidden="true" tabindex="-1"></a><span class="co">#     print(f"Mock Call {call_count}")</span></span>
<span id="cb202-8"><a href="#cb202-8" aria-hidden="true" tabindex="-1"></a><span class="co">#     if call_count &lt; 3: return mk_pause_web_search()</span></span>
<span id="cb202-9"><a href="#cb202-9" aria-hidden="true" tabindex="-1"></a><span class="co">#     return orig_completion(*args, **kwargs)</span></span>
<span id="cb202-10"><a href="#cb202-10" aria-hidden="true" tabindex="-1"></a><span class="co"># </span></span>
<span id="cb202-11"><a href="#cb202-11" aria-hidden="true" tabindex="-1"></a><span class="co"># completion = patched_completion</span></span>
<span id="cb202-12"><a href="#cb202-12" aria-hidden="true" tabindex="-1"></a><span class="co"># chat_pause = Chat('claude-sonnet-4-5', search='l')</span></span>
<span id="cb202-13"><a href="#cb202-13" aria-hidden="true" tabindex="-1"></a><span class="co"># res = chat_pause("Search the web and tell me about Solveit in a paragraph")</span></span>
<span id="cb202-14"><a href="#cb202-14" aria-hidden="true" tabindex="-1"></a><span class="co"># print(f"Total calls: {call_count}")</span></span>
<span id="cb202-15"><a href="#cb202-15" aria-hidden="true" tabindex="-1"></a><span class="co"># display(res)</span></span>
<span id="cb202-16"><a href="#cb202-16" aria-hidden="true" tabindex="-1"></a><span class="co"># </span></span>
<span id="cb202-17"><a href="#cb202-17" aria-hidden="true" tabindex="-1"></a><span class="co"># completion = orig_completion</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<p>Test next turn:</p>
<div id="572f4912" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb203"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb203-1"><a href="#cb203-1" aria-hidden="true" tabindex="-1"></a><span class="co"># test_eq(len(chat_pause.hist), 2) # incomplete request shouldn't be stored</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<div id="ce8fcab7" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb204"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb204-1"><a href="#cb204-1" aria-hidden="true" tabindex="-1"></a><span class="co"># chat_pause('What did I just ask you about?')</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
</section>
<section id="multi-tool-calling" class="level3">
<h3 class="anchored">Multi tool calling</h3>
<p>We can let the model call multiple tools in sequence using the <code>max_steps</code> parameter.</p>
<div id="662f7aa3" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb205"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb205-1"><a href="#cb205-1" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> m <span class="kw">in</span> ms:</span>
<span id="cb205-2"><a href="#cb205-2" aria-hidden="true" tabindex="-1"></a>    display(Markdown(<span class="ss">f'**</span><span class="sc">{</span>m<span class="sc">}</span><span class="ss">:**'</span>))</span>
<span id="cb205-3"><a href="#cb205-3" aria-hidden="true" tabindex="-1"></a>    chat <span class="op">=</span> Chat(m, tools<span class="op">=</span>[simple_add])</span>
<span id="cb205-4"><a href="#cb205-4" aria-hidden="true" tabindex="-1"></a>    res <span class="op">=</span> chat(<span class="st">"What's ((5 + 3)+7)+11? Work step by step"</span>, return_all<span class="op">=</span><span class="va">True</span>, max_steps<span class="op">=</span><span class="dv">5</span>)</span>
<span id="cb205-5"><a href="#cb205-5" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> r <span class="kw">in</span> res: display(r)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display cell-output-markdown">
<div class="prose">
<p><strong>gemini/gemini-3-pro-preview:</strong></p>
</div>
</div>
<div class="cell-output cell-output-display cell-output-markdown">
<p>To solve the expression <code>((5 + 3) + 7) + 11</code>, we follow the order of operations (parentheses first).</p>
<p><strong>Step 1:</strong> Solve the innermost parentheses <code>(5 + 3)</code>.</p>
<p>ðŸ”§ simple_add({â€œaâ€: 5, â€œbâ€: 3})</p>
<details>
<ul>
<li>id: <code>chatcmpl-xxx</code></li>
<li>model: <code>gemini-3-pro-preview</code></li>
<li>finish_reason: <code>tool_calls</code></li>
<li>usage: <code>Usage(completion_tokens=173, prompt_tokens=94, total_tokens=267, completion_tokens_details=CompletionTokensDetailsWrapper(accepted_prediction_tokens=None, audio_tokens=None, reasoning_tokens=105, rejected_prediction_tokens=None, text_tokens=68, image_tokens=None), prompt_tokens_details=PromptTokensDetailsWrapper(audio_tokens=None, cached_tokens=None, text_tokens=94, image_tokens=None), cache_read_input_tokens=None)</code></li>
</ul>
</details>
</div>
<div class="cell-output cell-output-display">
<pre><code>{'tool_call_id': 'call_ca9546f2d78042458071be4fb3c9__thought__Es8DCswDAb4+9vsu6rMfOgvADhs5j2MxlMr2p03+OyX7MFm5ZNdiI6yOXfhyqqgUjbFl2jG82hKIvItzqpYJa/4C59FA4yhYqSTMEVdKDvKKkzmFWbaIrpTsj+iMe76Haxve8EzXqMRr+X3i8ylU6yPG6nQYk++lR0oqZIpgs04G1TdiQjck/QC41EO4C3DdaknUTrB++xi7xEH71a63XrTwglnQnbomVFoqrPZwuMRVTtxpSsY8FusTA0CGb7q+gTWgC/hrjxFFE9zcvaY4IuCa4Qxrry6//LVTxUOCSYzYGFVJ0YZBz74ST3Dmf4QnJKBTBPMYixrUw6IcLRRSNjxb5GTA5VCZyoeTtaNrAiFs/OQnY5jp3xmjYCEgOESh9xBwBoBKI8d3ODBKY7l4Dc+RkEb6CJ5EpU7U0TZq/wPO5dkNG5E3c+tDkKThs/psFI0PhcOSwgTmhBmYGfc1aLT/8UbqyjrfIpPSAPPvIkuwE/b/H+SBtTeiMhmOMVQSZ3sAJbk2ueXhW/UYXrC40sGtXw4UXpsO4xdKctWMV7IZ1qlur5hAEjzBsQt7V7JeEHpfbLKbvaVqTwUn/3Qk13o889PPaIhvcqhsg77N4Q5BUw==',
 'role': 'tool',
 'name': 'simple_add',
 'content': '8'}</code></pre>
</div>
<div class="cell-output cell-output-display cell-output-markdown">
<p><strong>Step 2:</strong> Now the expression is <code>(8 + 7) + 11</code>. Solve the remaining parentheses <code>(8 + 7)</code>.</p>
<p>ðŸ”§ simple_add({â€œbâ€: 7, â€œaâ€: 8})</p>
<details>
<ul>
<li>id: <code>chatcmpl-xxx</code></li>
<li>model: <code>gemini-3-pro-preview</code></li>
<li>finish_reason: <code>tool_calls</code></li>
<li>usage: <code>Usage(completion_tokens=52, prompt_tokens=385, total_tokens=437, completion_tokens_details=CompletionTokensDetailsWrapper(accepted_prediction_tokens=None, audio_tokens=None, reasoning_tokens=None, rejected_prediction_tokens=None, text_tokens=52, image_tokens=None), prompt_tokens_details=PromptTokensDetailsWrapper(audio_tokens=None, cached_tokens=None, text_tokens=385, image_tokens=None), cache_read_input_tokens=None)</code></li>
</ul>
</details>
</div>
<div class="cell-output cell-output-display">
<pre><code>{'tool_call_id': 'call_d77b41fec9db4a60a6dce970971f__thought__EiYKJGUyNDgzMGE3LTVjZDYtNDJmZS05OThiLWVlNTM5ZTcyYjljMw==',
 'role': 'tool',
 'name': 'simple_add',
 'content': '15'}</code></pre>
</div>
<div class="cell-output cell-output-display cell-output-markdown">
<p><strong>Step 3:</strong> Finally, add the remaining number: <code>15 + 11</code>.</p>
<p>ðŸ”§ simple_add({â€œbâ€: 11, â€œaâ€: 15})</p>
<details>
<ul>
<li>id: <code>chatcmpl-xxx</code></li>
<li>model: <code>gemini-3-pro-preview</code></li>
<li>finish_reason: <code>tool_calls</code></li>
<li>usage: <code>Usage(completion_tokens=41, prompt_tokens=451, total_tokens=492, completion_tokens_details=CompletionTokensDetailsWrapper(accepted_prediction_tokens=None, audio_tokens=None, reasoning_tokens=None, rejected_prediction_tokens=None, text_tokens=41, image_tokens=None), prompt_tokens_details=PromptTokensDetailsWrapper(audio_tokens=None, cached_tokens=None, text_tokens=451, image_tokens=None), cache_read_input_tokens=None)</code></li>
</ul>
</details>
</div>
<div class="cell-output cell-output-display">
<pre><code>{'tool_call_id': 'call_351c8e3289df4731a6020612f925__thought__EiYKJGUyNDgzMGE3LTVjZDYtNDJmZS05OThiLWVlNTM5ZTcyYjljMw==',
 'role': 'tool',
 'name': 'simple_add',
 'content': '26'}</code></pre>
</div>
<div class="cell-output cell-output-display cell-output-markdown">
<p>The final answer is <strong>26</strong>.</p>
<details>
<ul>
<li>id: <code>chatcmpl-xxx</code></li>
<li>model: <code>gemini-3-pro-preview</code></li>
<li>finish_reason: <code>stop</code></li>
<li>usage: <code>Usage(completion_tokens=8, prompt_tokens=506, total_tokens=514, completion_tokens_details=CompletionTokensDetailsWrapper(accepted_prediction_tokens=None, audio_tokens=None, reasoning_tokens=None, rejected_prediction_tokens=None, text_tokens=8, image_tokens=None), prompt_tokens_details=PromptTokensDetailsWrapper(audio_tokens=None, cached_tokens=None, text_tokens=506, image_tokens=None), cache_read_input_tokens=None)</code></li>
</ul>
</details>
</div>
<div class="cell-output cell-output-display cell-output-markdown">
<div class="prose">
<p><strong>gemini/gemini-3-flash-preview:</strong></p>
</div>
</div>
<div class="cell-output cell-output-display cell-output-markdown">
<p>ðŸ”§ simple_add({â€œaâ€: 5, â€œbâ€: 3})</p>
<details>
<ul>
<li>id: <code>chatcmpl-xxx</code></li>
<li>model: <code>gemini-3-flash-preview</code></li>
<li>finish_reason: <code>tool_calls</code></li>
<li>usage: <code>Usage(completion_tokens=18, prompt_tokens=94, total_tokens=112, completion_tokens_details=CompletionTokensDetailsWrapper(accepted_prediction_tokens=None, audio_tokens=None, reasoning_tokens=None, rejected_prediction_tokens=None, text_tokens=18, image_tokens=None), prompt_tokens_details=PromptTokensDetailsWrapper(audio_tokens=None, cached_tokens=None, text_tokens=94, image_tokens=None), cache_read_input_tokens=None)</code></li>
</ul>
</details>
</div>
<div class="cell-output cell-output-display">
<pre><code>{'tool_call_id': 'call_4948eb61569940ac80a12d674813__thought__EjQKMgG+Pvb7R8AVbsMHiTMX+oci6eQ3YBH7sWKhuEYw4XBGj5E6xM6N71tqTNOQeZEkzaEe',
 'role': 'tool',
 'name': 'simple_add',
 'content': '8'}</code></pre>
</div>
<div class="cell-output cell-output-display cell-output-markdown">
<p>ðŸ”§ simple_add({â€œbâ€: 7, â€œaâ€: 8})</p>
<details>
<ul>
<li>id: <code>chatcmpl-xxx</code></li>
<li>model: <code>gemini-3-flash-preview</code></li>
<li>finish_reason: <code>tool_calls</code></li>
<li>usage: <code>Usage(completion_tokens=18, prompt_tokens=125, total_tokens=143, completion_tokens_details=CompletionTokensDetailsWrapper(accepted_prediction_tokens=None, audio_tokens=None, reasoning_tokens=None, rejected_prediction_tokens=None, text_tokens=18, image_tokens=None), prompt_tokens_details=PromptTokensDetailsWrapper(audio_tokens=None, cached_tokens=None, text_tokens=125, image_tokens=None), cache_read_input_tokens=None)</code></li>
</ul>
</details>
</div>
<div class="cell-output cell-output-display">
<pre><code>{'tool_call_id': 'call_8becf41c25fd41c297e8074416b8__thought__EjQKMgG+Pvb79pLo0BAoZI9FFwcAVJXOBHpTqFgWjhnUTU+ZkFtHJrA/kjri73+6rQyW2fX+',
 'role': 'tool',
 'name': 'simple_add',
 'content': '15'}</code></pre>
</div>
<div class="cell-output cell-output-display cell-output-markdown">
<p>ðŸ”§ simple_add({â€œbâ€: 11, â€œaâ€: 15})</p>
<details>
<ul>
<li>id: <code>chatcmpl-xxx</code></li>
<li>model: <code>gemini-3-flash-preview</code></li>
<li>finish_reason: <code>tool_calls</code></li>
<li>usage: <code>Usage(completion_tokens=20, prompt_tokens=157, total_tokens=177, completion_tokens_details=CompletionTokensDetailsWrapper(accepted_prediction_tokens=None, audio_tokens=None, reasoning_tokens=None, rejected_prediction_tokens=None, text_tokens=20, image_tokens=None), prompt_tokens_details=PromptTokensDetailsWrapper(audio_tokens=None, cached_tokens=None, text_tokens=157, image_tokens=None), cache_read_input_tokens=None)</code></li>
</ul>
</details>
</div>
<div class="cell-output cell-output-display">
<pre><code>{'tool_call_id': 'call_a740172f7d784ae69d737e44564e__thought__EjQKMgG+Pvb7DG0WlGxTlpohGGcdSNzm9iPjdiD7cRtUUM8p3uJaa4Yyf0L0vpK4tgK68Rqt',
 'role': 'tool',
 'name': 'simple_add',
 'content': '26'}</code></pre>
</div>
<div class="cell-output cell-output-display cell-output-markdown">
<p>To find the value of ((5 + 3) + 7) + 11, we follow the order of operations by working from the innermost parentheses outward:</p>
<ol type="1">
<li><p><strong>First step (innermost parentheses):</strong> 5 + 3 = <strong>8</strong></p></li>
<li><p><strong>Second step (next addition):</strong> 8 + 7 = <strong>15</strong></p></li>
<li><p><strong>Final step:</strong> 15 + 11 = <strong>26</strong></p></li>
</ol>
<p>The final result is <strong>26</strong>.</p>
<details>
<ul>
<li>id: <code>chatcmpl-xxx</code></li>
<li>model: <code>gemini-3-flash-preview</code></li>
<li>finish_reason: <code>stop</code></li>
<li>usage: <code>Usage(completion_tokens=110, prompt_tokens=191, total_tokens=301, completion_tokens_details=CompletionTokensDetailsWrapper(accepted_prediction_tokens=None, audio_tokens=None, reasoning_tokens=None, rejected_prediction_tokens=None, text_tokens=110, image_tokens=None), prompt_tokens_details=PromptTokensDetailsWrapper(audio_tokens=None, cached_tokens=None, text_tokens=191, image_tokens=None), cache_read_input_tokens=None)</code></li>
</ul>
</details>
</div>
<div class="cell-output cell-output-display cell-output-markdown">
<div class="prose">
<p><strong>claude-opus-4-6:</strong></p>
</div>
</div>
<div class="cell-output cell-output-display cell-output-markdown">
<p>Iâ€™ll work through this step by step, starting from the innermost parentheses.</p>
<p><strong>Step 1:</strong> Calculate 5 + 3</p>
<p>ðŸ”§ simple_add({â€œaâ€: 5, â€œbâ€: 3})</p>
<details>
<ul>
<li>id: <code>chatcmpl-xxx</code></li>
<li>model: <code>claude-opus-4-6</code></li>
<li>finish_reason: <code>tool_calls</code></li>
<li>usage: <code>Usage(completion_tokens=103, prompt_tokens=618, total_tokens=721, completion_tokens_details=CompletionTokensDetailsWrapper(accepted_prediction_tokens=None, audio_tokens=None, reasoning_tokens=0, rejected_prediction_tokens=None, text_tokens=103, image_tokens=None), prompt_tokens_details=PromptTokensDetailsWrapper(audio_tokens=None, cached_tokens=0, text_tokens=None, image_tokens=None, cache_creation_tokens=0, cache_creation_token_details=CacheCreationTokenDetails(ephemeral_5m_input_tokens=0, ephemeral_1h_input_tokens=0)), cache_creation_input_tokens=0, cache_read_input_tokens=0, inference_geo='global', speed=None)</code></li>
</ul>
</details>
</div>
<div class="cell-output cell-output-display">
<pre><code>{'tool_call_id': 'toolu_01JnyhjQX5QoK9xTJNky9BrG',
 'role': 'tool',
 'name': 'simple_add',
 'content': '8'}</code></pre>
</div>
<div class="cell-output cell-output-display cell-output-markdown">
<p>5 + 3 = <strong>8</strong></p>
<p><strong>Step 2:</strong> Calculate 8 + 7</p>
<p>ðŸ”§ simple_add({â€œaâ€: 8, â€œbâ€: 7})</p>
<details>
<ul>
<li>id: <code>chatcmpl-xxx</code></li>
<li>model: <code>claude-opus-4-6</code></li>
<li>finish_reason: <code>tool_calls</code></li>
<li>usage: <code>Usage(completion_tokens=94, prompt_tokens=735, total_tokens=829, completion_tokens_details=CompletionTokensDetailsWrapper(accepted_prediction_tokens=None, audio_tokens=None, reasoning_tokens=0, rejected_prediction_tokens=None, text_tokens=94, image_tokens=None), prompt_tokens_details=PromptTokensDetailsWrapper(audio_tokens=None, cached_tokens=0, text_tokens=None, image_tokens=None, cache_creation_tokens=0, cache_creation_token_details=CacheCreationTokenDetails(ephemeral_5m_input_tokens=0, ephemeral_1h_input_tokens=0)), cache_creation_input_tokens=0, cache_read_input_tokens=0, inference_geo='global', speed=None)</code></li>
</ul>
</details>
</div>
<div class="cell-output cell-output-display">
<pre><code>{'tool_call_id': 'toolu_01DnGYTmyHTNA99uis1DxhAR',
 'role': 'tool',
 'name': 'simple_add',
 'content': '15'}</code></pre>
</div>
<div class="cell-output cell-output-display cell-output-markdown">
<p>8 + 7 = <strong>15</strong></p>
<p><strong>Step 3:</strong> Calculate 15 + 11</p>
<p>ðŸ”§ simple_add({â€œaâ€: 15, â€œbâ€: 11})</p>
<details>
<ul>
<li>id: <code>chatcmpl-xxx</code></li>
<li>model: <code>claude-opus-4-6</code></li>
<li>finish_reason: <code>tool_calls</code></li>
<li>usage: <code>Usage(completion_tokens=94, prompt_tokens=842, total_tokens=936, completion_tokens_details=CompletionTokensDetailsWrapper(accepted_prediction_tokens=None, audio_tokens=None, reasoning_tokens=0, rejected_prediction_tokens=None, text_tokens=94, image_tokens=None), prompt_tokens_details=PromptTokensDetailsWrapper(audio_tokens=None, cached_tokens=0, text_tokens=None, image_tokens=None, cache_creation_tokens=0, cache_creation_token_details=CacheCreationTokenDetails(ephemeral_5m_input_tokens=0, ephemeral_1h_input_tokens=0)), cache_creation_input_tokens=0, cache_read_input_tokens=0, inference_geo='global', speed=None)</code></li>
</ul>
</details>
</div>
<div class="cell-output cell-output-display">
<pre><code>{'tool_call_id': 'toolu_01UUa5cdK9WzgHTWWpz3FzhZ',
 'role': 'tool',
 'name': 'simple_add',
 'content': '26'}</code></pre>
</div>
<div class="cell-output cell-output-display cell-output-markdown">
<p>15 + 11 = <strong>26</strong></p>
<section id="final-answer-5-3-7-11-26" class="level3">
<h3 class="anchored" data-anchor-id="final-answer-5-3-7-11-26">Final Answer: <strong>((5 + 3) + 7) + 11 = 26</strong></h3>
<details>
<ul>
<li>id: <code>chatcmpl-xxx</code></li>
<li>model: <code>claude-opus-4-6</code></li>
<li>finish_reason: <code>stop</code></li>
<li>usage: <code>Usage(completion_tokens=38, prompt_tokens=949, total_tokens=987, completion_tokens_details=CompletionTokensDetailsWrapper(accepted_prediction_tokens=None, audio_tokens=None, reasoning_tokens=0, rejected_prediction_tokens=None, text_tokens=38, image_tokens=None), prompt_tokens_details=PromptTokensDetailsWrapper(audio_tokens=None, cached_tokens=0, text_tokens=None, image_tokens=None, cache_creation_tokens=0, cache_creation_token_details=CacheCreationTokenDetails(ephemeral_5m_input_tokens=0, ephemeral_1h_input_tokens=0)), cache_creation_input_tokens=0, cache_read_input_tokens=0, inference_geo='global', speed=None)</code></li>
</ul>
</details>
</section>
</div>
<div class="cell-output cell-output-display cell-output-markdown">
<div class="prose">
<p><strong>openai/gpt-4.1:</strong></p>
</div>
</div>
<div class="cell-output cell-output-display cell-output-markdown">
<p>ðŸ”§ simple_add({â€œaâ€:5,â€œbâ€:3})</p>
<details>
<ul>
<li>id: <code>chatcmpl-xxx</code></li>
<li>model: <code>gpt-4.1-2025-04-14</code></li>
<li>finish_reason: <code>tool_calls</code></li>
<li>usage: <code>Usage(completion_tokens=18, prompt_tokens=82, total_tokens=100, completion_tokens_details=CompletionTokensDetailsWrapper(accepted_prediction_tokens=0, audio_tokens=0, reasoning_tokens=0, rejected_prediction_tokens=0, text_tokens=None, image_tokens=None), prompt_tokens_details=PromptTokensDetailsWrapper(audio_tokens=0, cached_tokens=0, text_tokens=None, image_tokens=None))</code></li>
</ul>
</details>
</div>
<div class="cell-output cell-output-display">
<pre><code>{'tool_call_id': 'call_6PLlchk0N3o6GGINVfYG0eIA',
 'role': 'tool',
 'name': 'simple_add',
 'content': '8'}</code></pre>
</div>
<div class="cell-output cell-output-display cell-output-markdown">
<p>ðŸ”§ simple_add({â€œaâ€:8,â€œbâ€:7})</p>
<details>
<ul>
<li>id: <code>chatcmpl-xxx</code></li>
<li>model: <code>gpt-4.1-2025-04-14</code></li>
<li>finish_reason: <code>tool_calls</code></li>
<li>usage: <code>Usage(completion_tokens=18, prompt_tokens=109, total_tokens=127, completion_tokens_details=CompletionTokensDetailsWrapper(accepted_prediction_tokens=0, audio_tokens=0, reasoning_tokens=0, rejected_prediction_tokens=0, text_tokens=None, image_tokens=None), prompt_tokens_details=PromptTokensDetailsWrapper(audio_tokens=0, cached_tokens=0, text_tokens=None, image_tokens=None))</code></li>
</ul>
</details>
</div>
<div class="cell-output cell-output-display">
<pre><code>{'tool_call_id': 'call_0QHI0G66Y4CgZnuGK6i9FpE7',
 'role': 'tool',
 'name': 'simple_add',
 'content': '15'}</code></pre>
</div>
<div class="cell-output cell-output-display cell-output-markdown">
<p>ðŸ”§ simple_add({â€œaâ€:15,â€œbâ€:11})</p>
<details>
<ul>
<li>id: <code>chatcmpl-xxx</code></li>
<li>model: <code>gpt-4.1-2025-04-14</code></li>
<li>finish_reason: <code>tool_calls</code></li>
<li>usage: <code>Usage(completion_tokens=18, prompt_tokens=136, total_tokens=154, completion_tokens_details=CompletionTokensDetailsWrapper(accepted_prediction_tokens=0, audio_tokens=0, reasoning_tokens=0, rejected_prediction_tokens=0, text_tokens=None, image_tokens=None), prompt_tokens_details=PromptTokensDetailsWrapper(audio_tokens=0, cached_tokens=0, text_tokens=None, image_tokens=None))</code></li>
</ul>
</details>
</div>
<div class="cell-output cell-output-display">
<pre><code>{'tool_call_id': 'call_c9xdHt1nF353ujvgKD5b8kYC',
 'role': 'tool',
 'name': 'simple_add',
 'content': '26'}</code></pre>
</div>
<div class="cell-output cell-output-display cell-output-markdown">
<p>Letâ€™s break it down step by step:</p>
<ol type="1">
<li>First, add 5 + 3 = 8</li>
<li>Next, add the result to 7: 8 + 7 = 15</li>
<li>Finally, add 11 to that result: 15 + 11 = 26</li>
</ol>
<p>So, ((5 + 3) + 7) + 11 = 26.</p>
<details>
<ul>
<li>id: <code>chatcmpl-xxx</code></li>
<li>model: <code>gpt-4.1-2025-04-14</code></li>
<li>finish_reason: <code>stop</code></li>
<li>usage: <code>Usage(completion_tokens=82, prompt_tokens=163, total_tokens=245, completion_tokens_details=CompletionTokensDetailsWrapper(accepted_prediction_tokens=0, audio_tokens=0, reasoning_tokens=0, rejected_prediction_tokens=0, text_tokens=None, image_tokens=None), prompt_tokens_details=PromptTokensDetailsWrapper(audio_tokens=0, cached_tokens=0, text_tokens=None, image_tokens=None))</code></li>
</ul>
</details>
</div>
</div>
<p>Some models support parallel tool calling. I.e. sending multiple tool call requests in one conversation step.</p>
<div id="3ec77539" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb218"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb218-1"><a href="#cb218-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> multiply(a: <span class="bu">int</span>, b: <span class="bu">int</span>) <span class="op">-&gt;</span> <span class="bu">int</span>:</span>
<span id="cb218-2"><a href="#cb218-2" aria-hidden="true" tabindex="-1"></a>    <span class="co">"Multiply two numbers"</span></span>
<span id="cb218-3"><a href="#cb218-3" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> a <span class="op">*</span> b</span>
<span id="cb218-4"><a href="#cb218-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb218-5"><a href="#cb218-5" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> m <span class="kw">in</span> ms[<span class="dv">1</span>:]:</span>
<span id="cb218-6"><a href="#cb218-6" aria-hidden="true" tabindex="-1"></a>    _sparams <span class="op">=</span> litellm.get_model_info(m)[<span class="st">'supported_openai_params'</span>]</span>
<span id="cb218-7"><a href="#cb218-7" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="st">'parallel_tool_calls'</span> <span class="kw">not</span> <span class="kw">in</span> _sparams: <span class="cf">continue</span></span>
<span id="cb218-8"><a href="#cb218-8" aria-hidden="true" tabindex="-1"></a>    display(Markdown(<span class="ss">f'**</span><span class="sc">{</span>m<span class="sc">}</span><span class="ss">:**'</span>))</span>
<span id="cb218-9"><a href="#cb218-9" aria-hidden="true" tabindex="-1"></a>    chat <span class="op">=</span> Chat(m, tools<span class="op">=</span>[simple_add, multiply])</span>
<span id="cb218-10"><a href="#cb218-10" aria-hidden="true" tabindex="-1"></a>    res <span class="op">=</span> chat(<span class="st">"Calculate (5 + 3) * (7 + 2)"</span>, max_steps<span class="op">=</span><span class="dv">5</span>, return_all<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb218-11"><a href="#cb218-11" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> r <span class="kw">in</span> res: display(r)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display cell-output-markdown">
<div class="prose">
<p><strong>gemini/gemini-3-flash-preview:</strong></p>
</div>
</div>
<div class="cell-output cell-output-display cell-output-markdown">
<p>ðŸ”§ simple_add({â€œaâ€: 5, â€œbâ€: 3})</p>
<p>ðŸ”§ simple_add({â€œaâ€: 7, â€œbâ€: 2})</p>
<details>
<ul>
<li>id: <code>chatcmpl-xxx</code></li>
<li>model: <code>gemini-3-flash-preview</code></li>
<li>finish_reason: <code>tool_calls</code></li>
<li>usage: <code>Usage(completion_tokens=36, prompt_tokens=148, total_tokens=184, completion_tokens_details=CompletionTokensDetailsWrapper(accepted_prediction_tokens=None, audio_tokens=None, reasoning_tokens=None, rejected_prediction_tokens=None, text_tokens=36, image_tokens=None), prompt_tokens_details=PromptTokensDetailsWrapper(audio_tokens=None, cached_tokens=None, text_tokens=148, image_tokens=None), cache_read_input_tokens=None)</code></li>
</ul>
</details>
</div>
<div class="cell-output cell-output-display">
<pre><code>{'tool_call_id': 'call_a89742d68a094a258f21647cf44d__thought__EjQKMgG+Pvb7uu5XOxb3+mdWi1dirWh75YBBO4JoZjAG4voY2lrpGmlP4Agl3IZaP80MVvK1',
 'role': 'tool',
 'name': 'simple_add',
 'content': '8'}</code></pre>
</div>
<div class="cell-output cell-output-display">
<pre><code>{'tool_call_id': 'call_d58d39a89b174c46a2b13092067e',
 'role': 'tool',
 'name': 'simple_add',
 'content': '9'}</code></pre>
</div>
<div class="cell-output cell-output-display cell-output-markdown">
<p>ðŸ”§ multiply({â€œaâ€: 8, â€œbâ€: 9})</p>
<details>
<ul>
<li>id: <code>chatcmpl-xxx</code></li>
<li>model: <code>gemini-3-flash-preview</code></li>
<li>finish_reason: <code>tool_calls</code></li>
<li>usage: <code>Usage(completion_tokens=16, prompt_tokens=209, total_tokens=225, completion_tokens_details=CompletionTokensDetailsWrapper(accepted_prediction_tokens=None, audio_tokens=None, reasoning_tokens=None, rejected_prediction_tokens=None, text_tokens=16, image_tokens=None), prompt_tokens_details=PromptTokensDetailsWrapper(audio_tokens=None, cached_tokens=None, text_tokens=209, image_tokens=None), cache_read_input_tokens=None)</code></li>
</ul>
</details>
</div>
<div class="cell-output cell-output-display">
<pre><code>{'tool_call_id': 'call_f1ef07c5bdba4f5dbc6ceddc316c__thought__EjQKMgG+Pvb788VYFpRxZhfjE5ZSqy99vsTLraKviMNH2gwkrsJMi8o6Iq4ab05lmWmi1lkU',
 'role': 'tool',
 'name': 'multiply',
 'content': '72'}</code></pre>
</div>
<div class="cell-output cell-output-display cell-output-markdown">
<p>(5 + 3) * (7 + 2) = 72</p>
<details>
<ul>
<li>id: <code>chatcmpl-xxx</code></li>
<li>model: <code>gemini-3-flash-preview</code></li>
<li>finish_reason: <code>stop</code></li>
<li>usage: <code>Usage(completion_tokens=17, prompt_tokens=237, total_tokens=254, completion_tokens_details=CompletionTokensDetailsWrapper(accepted_prediction_tokens=None, audio_tokens=None, reasoning_tokens=None, rejected_prediction_tokens=None, text_tokens=17, image_tokens=None), prompt_tokens_details=PromptTokensDetailsWrapper(audio_tokens=None, cached_tokens=None, text_tokens=237, image_tokens=None), cache_read_input_tokens=None)</code></li>
</ul>
</details>
</div>
<div class="cell-output cell-output-display cell-output-markdown">
<div class="prose">
<p><strong>claude-opus-4-6:</strong></p>
</div>
</div>
<div class="cell-output cell-output-display cell-output-markdown">
<p>I need to first calculate the two additions, then multiply the results.</p>
<p><strong>Step 1:</strong> Calculate both additions simultaneously:</p>
<p>ðŸ”§ simple_add({â€œaâ€: 5, â€œbâ€: 3})</p>
<p>ðŸ”§ simple_add({â€œaâ€: 7, â€œbâ€: 2})</p>
<details>
<ul>
<li>id: <code>chatcmpl-xxx</code></li>
<li>model: <code>claude-opus-4-6</code></li>
<li>finish_reason: <code>tool_calls</code></li>
<li>usage: <code>Usage(completion_tokens=150, prompt_tokens=701, total_tokens=851, completion_tokens_details=CompletionTokensDetailsWrapper(accepted_prediction_tokens=None, audio_tokens=None, reasoning_tokens=0, rejected_prediction_tokens=None, text_tokens=150, image_tokens=None), prompt_tokens_details=PromptTokensDetailsWrapper(audio_tokens=None, cached_tokens=0, text_tokens=None, image_tokens=None, cache_creation_tokens=0, cache_creation_token_details=CacheCreationTokenDetails(ephemeral_5m_input_tokens=0, ephemeral_1h_input_tokens=0)), cache_creation_input_tokens=0, cache_read_input_tokens=0, inference_geo='global', speed=None)</code></li>
</ul>
</details>
</div>
<div class="cell-output cell-output-display">
<pre><code>{'tool_call_id': 'toolu_015t3Z52r92xnZ2p2bzxxk5r',
 'role': 'tool',
 'name': 'simple_add',
 'content': '8'}</code></pre>
</div>
<div class="cell-output cell-output-display">
<pre><code>{'tool_call_id': 'toolu_01DGBVCpaVwn97c9v4AJHmCu',
 'role': 'tool',
 'name': 'simple_add',
 'content': '9'}</code></pre>
</div>
<div class="cell-output cell-output-display cell-output-markdown">
<p><strong>Step 2:</strong> Now multiply the two results: 8 Ã— 9</p>
<p>ðŸ”§ multiply({â€œaâ€: 8, â€œbâ€: 9})</p>
<details>
<ul>
<li>id: <code>chatcmpl-xxx</code></li>
<li>model: <code>claude-opus-4-6</code></li>
<li>finish_reason: <code>tool_calls</code></li>
<li>usage: <code>Usage(completion_tokens=86, prompt_tokens=917, total_tokens=1003, completion_tokens_details=CompletionTokensDetailsWrapper(accepted_prediction_tokens=None, audio_tokens=None, reasoning_tokens=0, rejected_prediction_tokens=None, text_tokens=86, image_tokens=None), prompt_tokens_details=PromptTokensDetailsWrapper(audio_tokens=None, cached_tokens=0, text_tokens=None, image_tokens=None, cache_creation_tokens=0, cache_creation_token_details=CacheCreationTokenDetails(ephemeral_5m_input_tokens=0, ephemeral_1h_input_tokens=0)), cache_creation_input_tokens=0, cache_read_input_tokens=0, inference_geo='global', speed=None)</code></li>
</ul>
</details>
</div>
<div class="cell-output cell-output-display">
<pre><code>{'tool_call_id': 'toolu_01JwGSFDMHRpyqhCdLJeLj8A',
 'role': 'tool',
 'name': 'multiply',
 'content': '72'}</code></pre>
</div>
<div class="cell-output cell-output-display cell-output-markdown">
<p><strong>Result:</strong></p>
<p><strong>(5 + 3) Ã— (7 + 2) = 8 Ã— 9 = 72</strong></p>
<details>
<ul>
<li>id: <code>chatcmpl-xxx</code></li>
<li>model: <code>claude-opus-4-6</code></li>
<li>finish_reason: <code>stop</code></li>
<li>usage: <code>Usage(completion_tokens=35, prompt_tokens=1016, total_tokens=1051, completion_tokens_details=CompletionTokensDetailsWrapper(accepted_prediction_tokens=None, audio_tokens=None, reasoning_tokens=0, rejected_prediction_tokens=None, text_tokens=35, image_tokens=None), prompt_tokens_details=PromptTokensDetailsWrapper(audio_tokens=None, cached_tokens=0, text_tokens=None, image_tokens=None, cache_creation_tokens=0, cache_creation_token_details=CacheCreationTokenDetails(ephemeral_5m_input_tokens=0, ephemeral_1h_input_tokens=0)), cache_creation_input_tokens=0, cache_read_input_tokens=0, inference_geo='global', speed=None)</code></li>
</ul>
</details>
</div>
<div class="cell-output cell-output-display cell-output-markdown">
<div class="prose">
<p><strong>openai/gpt-4.1:</strong></p>
</div>
</div>
<div class="cell-output cell-output-display cell-output-markdown">
<p>ðŸ”§ simple_add({â€œaâ€: 5, â€œbâ€: 3})</p>
<p>ðŸ”§ simple_add({â€œaâ€: 7, â€œbâ€: 2})</p>
<details>
<ul>
<li>id: <code>chatcmpl-xxx</code></li>
<li>model: <code>gpt-4.1-2025-04-14</code></li>
<li>finish_reason: <code>tool_calls</code></li>
<li>usage: <code>Usage(completion_tokens=52, prompt_tokens=110, total_tokens=162, completion_tokens_details=CompletionTokensDetailsWrapper(accepted_prediction_tokens=0, audio_tokens=0, reasoning_tokens=0, rejected_prediction_tokens=0, text_tokens=None, image_tokens=None), prompt_tokens_details=PromptTokensDetailsWrapper(audio_tokens=0, cached_tokens=0, text_tokens=None, image_tokens=None))</code></li>
</ul>
</details>
</div>
<div class="cell-output cell-output-display">
<pre><code>{'tool_call_id': 'call_N274KwVNEY4IUvALmuKdiJOj',
 'role': 'tool',
 'name': 'simple_add',
 'content': '8'}</code></pre>
</div>
<div class="cell-output cell-output-display">
<pre><code>{'tool_call_id': 'call_5MgW9uzPGzZCF9QyQHp6oxIf',
 'role': 'tool',
 'name': 'simple_add',
 'content': '9'}</code></pre>
</div>
<div class="cell-output cell-output-display cell-output-markdown">
<p>ðŸ”§ multiply({â€œaâ€:8,â€œbâ€:9})</p>
<details>
<ul>
<li>id: <code>chatcmpl-xxx</code></li>
<li>model: <code>gpt-4.1-2025-04-14</code></li>
<li>finish_reason: <code>tool_calls</code></li>
<li>usage: <code>Usage(completion_tokens=17, prompt_tokens=178, total_tokens=195, completion_tokens_details=CompletionTokensDetailsWrapper(accepted_prediction_tokens=0, audio_tokens=0, reasoning_tokens=0, rejected_prediction_tokens=0, text_tokens=None, image_tokens=None), prompt_tokens_details=PromptTokensDetailsWrapper(audio_tokens=0, cached_tokens=0, text_tokens=None, image_tokens=None))</code></li>
</ul>
</details>
</div>
<div class="cell-output cell-output-display">
<pre><code>{'tool_call_id': 'call_Bq6EDfTAaNzJQD50lPQvOtic',
 'role': 'tool',
 'name': 'multiply',
 'content': '72'}</code></pre>
</div>
<div class="cell-output cell-output-display cell-output-markdown">
<p>(5 + 3) = 8 and (7 + 2) = 9. Multiplying these together: 8 Ã— 9 = 72.</p>
<p>So, (5 + 3) Ã— (7 + 2) = 72.</p>
<details>
<ul>
<li>id: <code>chatcmpl-xxx</code></li>
<li>model: <code>gpt-4.1-2025-04-14</code></li>
<li>finish_reason: <code>stop</code></li>
<li>usage: <code>Usage(completion_tokens=54, prompt_tokens=203, total_tokens=257, completion_tokens_details=CompletionTokensDetailsWrapper(accepted_prediction_tokens=0, audio_tokens=0, reasoning_tokens=0, rejected_prediction_tokens=0, text_tokens=None, image_tokens=None), prompt_tokens_details=PromptTokensDetailsWrapper(audio_tokens=0, cached_tokens=0, text_tokens=None, image_tokens=None))</code></li>
</ul>
</details>
</div>
</div>
<p>See how the additions are calculated in one go!</p>
<p>We donâ€™t want the model to keep running tools indefinitely. Lets showcase how we can force the model to stop after our specified number of toolcall rounds:</p>
<div id="71ca08d0" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb228"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb228-1"><a href="#cb228-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> divide(a: <span class="bu">int</span>, b: <span class="bu">int</span>) <span class="op">-&gt;</span> <span class="bu">float</span>:</span>
<span id="cb228-2"><a href="#cb228-2" aria-hidden="true" tabindex="-1"></a>    <span class="co">"Divide two numbers"</span></span>
<span id="cb228-3"><a href="#cb228-3" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> a<span class="op">/</span>b</span>
<span id="cb228-4"><a href="#cb228-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb228-5"><a href="#cb228-5" aria-hidden="true" tabindex="-1"></a>chat <span class="op">=</span> Chat(ms[<span class="dv">2</span>], tools<span class="op">=</span>[simple_add, multiply, divide])</span>
<span id="cb228-6"><a href="#cb228-6" aria-hidden="true" tabindex="-1"></a>res <span class="op">=</span> chat(<span class="st">"Tell me what tools you have available. Then calculate ((10+5)*3)/(2+1). ALWAYS use tools for math ops where available, and do tool calls in parallel where possible"</span>, </span>
<span id="cb228-7"><a href="#cb228-7" aria-hidden="true" tabindex="-1"></a>           max_steps<span class="op">=</span><span class="dv">2</span>, return_all<span class="op">=</span><span class="va">True</span>,</span>
<span id="cb228-8"><a href="#cb228-8" aria-hidden="true" tabindex="-1"></a>           final_prompt<span class="op">=</span><span class="st">"Please wrap-up for now and summarize how far we got."</span>)</span>
<span id="cb228-9"><a href="#cb228-9" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> r <span class="kw">in</span> res: display(r)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display cell-output-markdown">
<section id="available-tools" class="level2">
<h2 class="anchored" data-anchor-id="available-tools">Available Tools</h2>
<p>Here are the tools I have available:</p>
<ol type="1">
<li><strong>simple_add(a, b)</strong> - Adds two numbers together. Returns an integer.</li>
<li><strong>multiply(a, b)</strong> - Multiplies two numbers. Returns an integer.</li>
<li><strong>divide(a, b)</strong> - Divides two numbers. Returns a number.</li>
</ol>
<hr>
</section>
<section id="calculating-105321" class="level2">
<h2 class="anchored" data-anchor-id="calculating-105321">Calculating ((10+5)*3)/(2+1)</h2>
<p>Let me break this down step by step. First, I can compute the two independent additions in parallel:</p>
<p><strong>Step 1:</strong> Compute <code>10+5</code> and <code>2+1</code> simultaneously:</p>
<p>ðŸ”§ simple_add({â€œaâ€: 10, â€œbâ€: 5})</p>
<p>ðŸ”§ simple_add({â€œaâ€: 2, â€œbâ€: 1})</p>
<details>
<ul>
<li>id: <code>chatcmpl-xxx</code></li>
<li>model: <code>claude-opus-4-6</code></li>
<li>finish_reason: <code>tool_calls</code></li>
<li>usage: <code>Usage(completion_tokens=266, prompt_tokens=809, total_tokens=1075, completion_tokens_details=CompletionTokensDetailsWrapper(accepted_prediction_tokens=None, audio_tokens=None, reasoning_tokens=0, rejected_prediction_tokens=None, text_tokens=266, image_tokens=None), prompt_tokens_details=PromptTokensDetailsWrapper(audio_tokens=None, cached_tokens=0, text_tokens=None, image_tokens=None, cache_creation_tokens=0, cache_creation_token_details=CacheCreationTokenDetails(ephemeral_5m_input_tokens=0, ephemeral_1h_input_tokens=0)), cache_creation_input_tokens=0, cache_read_input_tokens=0, inference_geo='global', speed=None)</code></li>
</ul>
</details>
</section>
</div>
<div class="cell-output cell-output-display">
<pre><code>{'tool_call_id': 'toolu_01Kj5N1S8W7fc4zN9BNkDAxF',
 'role': 'tool',
 'name': 'simple_add',
 'content': '15'}</code></pre>
</div>
<div class="cell-output cell-output-display">
<pre><code>{'tool_call_id': 'toolu_01TLVKCdpSUU8WaWBJauJyi4',
 'role': 'tool',
 'name': 'simple_add',
 'content': '3'}</code></pre>
</div>
<div class="cell-output cell-output-display cell-output-markdown">
<p>Got it: <code>10+5 = 15</code> and <code>2+1 = 3</code>.</p>
<p><strong>Step 2:</strong> Now compute <code>15 * 3</code>:</p>
<p>ðŸ”§ multiply({â€œaâ€: 15, â€œbâ€: 3})</p>
<details>
<ul>
<li>id: <code>chatcmpl-xxx</code></li>
<li>model: <code>claude-opus-4-6</code></li>
<li>finish_reason: <code>tool_calls</code></li>
<li>usage: <code>Usage(completion_tokens=106, prompt_tokens=1141, total_tokens=1247, completion_tokens_details=CompletionTokensDetailsWrapper(accepted_prediction_tokens=None, audio_tokens=None, reasoning_tokens=0, rejected_prediction_tokens=None, text_tokens=106, image_tokens=None), prompt_tokens_details=PromptTokensDetailsWrapper(audio_tokens=None, cached_tokens=0, text_tokens=None, image_tokens=None, cache_creation_tokens=0, cache_creation_token_details=CacheCreationTokenDetails(ephemeral_5m_input_tokens=0, ephemeral_1h_input_tokens=0)), cache_creation_input_tokens=0, cache_read_input_tokens=0, inference_geo='global', speed=None)</code></li>
</ul>
</details>
</div>
<div class="cell-output cell-output-display">
<pre><code>{'tool_call_id': 'toolu_01451DFLi9bEsXsEf6a4m2SD',
 'role': 'tool',
 'name': 'multiply',
 'content': '45'}</code></pre>
</div>
<section id="summary" class="level2 cell-output cell-output-display cell-output-markdown">
<h2 class="anchored" data-anchor-id="summary">Summary</h2>
<p>We were calculating **((10+5)*3)/(2+1)** and hereâ€™s how far we got:</p>
<table class="caption-top table table-sm table-striped small">
<thead>
<tr class="header">
<th>Step</th>
<th>Operation</th>
<th>Result</th>
<th>Status</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>1a</td>
<td>10 + 5</td>
<td><strong>15</strong></td>
<td>âœ… Done</td>
</tr>
<tr class="even">
<td>1b</td>
<td>2 + 1</td>
<td><strong>3</strong></td>
<td>âœ… Done</td>
</tr>
<tr class="odd">
<td>2</td>
<td>15 * 3</td>
<td><strong>45</strong></td>
<td>âœ… Done</td>
</tr>
<tr class="even">
<td>3</td>
<td>45 / 3</td>
<td><em>pending</em></td>
<td>â³ Not yet done</td>
</tr>
</tbody>
</table>
<ul>
<li>Steps 1a and 1b were done <strong>in parallel</strong> since they were independent.</li>
<li>Step 2 depended on Step 1a, so it waited for that result.</li>
<li><strong>Remaining:</strong> We still need to do the final division: <strong>45 Ã· 3</strong>, which should give us <strong>15</strong>. Just say the word and Iâ€™ll finish it up!</li>
</ul>
<details>
<ul>
<li>id: <code>chatcmpl-xxx</code></li>
<li>model: <code>claude-opus-4-6</code></li>
<li>finish_reason: <code>stop</code></li>
<li>usage: <code>Usage(completion_tokens=237, prompt_tokens=1279, total_tokens=1516, completion_tokens_details=CompletionTokensDetailsWrapper(accepted_prediction_tokens=None, audio_tokens=None, reasoning_tokens=0, rejected_prediction_tokens=None, text_tokens=237, image_tokens=None), prompt_tokens_details=PromptTokensDetailsWrapper(audio_tokens=None, cached_tokens=0, text_tokens=None, image_tokens=None, cache_creation_tokens=0, cache_creation_token_details=CacheCreationTokenDetails(ephemeral_5m_input_tokens=0, ephemeral_1h_input_tokens=0)), cache_creation_input_tokens=0, cache_read_input_tokens=0, inference_geo='global', speed=None)</code></li>
</ul>
</details>
</section>
</div>
<div id="bc630e63" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb232"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb232-1"><a href="#cb232-1" aria-hidden="true" tabindex="-1"></a>chat.hist[:<span class="dv">5</span>]</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display">
<pre><code>[{'role': 'user',
  'content': 'Tell me what tools you have available. Then calculate ((10+5)*3)/(2+1). ALWAYS use tools for math ops where available, and do tool calls in parallel where possible'},
 Message(content='\n\n## Available Tools\n\nHere are the tools I have available:\n\n1. **simple_add(a, b)** - Adds two numbers together. Returns an integer.\n2. **multiply(a, b)** - Multiplies two numbers. Returns an integer.\n3. **divide(a, b)** - Divides two numbers. Returns a number.\n\n---\n\n## Calculating ((10+5)*3)/(2+1)\n\nLet me break this down step by step. First, I can compute the two independent additions in parallel:\n\n**Step 1:** Compute `10+5` and `2+1` simultaneously:', role='assistant', tool_calls=[ChatCompletionMessageToolCall(index=1, caller={'type': 'direct'}, function=Function(arguments='{"a": 10, "b": 5}', name='simple_add'), id='toolu_01Kj5N1S8W7fc4zN9BNkDAxF', type='function'), ChatCompletionMessageToolCall(index=2, caller={'type': 'direct'}, function=Function(arguments='{"a": 2, "b": 1}', name='simple_add'), id='toolu_01TLVKCdpSUU8WaWBJauJyi4', type='function')], function_call=None, provider_specific_fields={'citations': None, 'thinking_blocks': None}),
 {'tool_call_id': 'toolu_01Kj5N1S8W7fc4zN9BNkDAxF',
  'role': 'tool',
  'name': 'simple_add',
  'content': '15'},
 {'tool_call_id': 'toolu_01TLVKCdpSUU8WaWBJauJyi4',
  'role': 'tool',
  'name': 'simple_add',
  'content': '3'},
 Message(content='Got it: `10+5 = 15` and `2+1 = 3`.\n\n**Step 2:** Now compute `15 * 3`:', role='assistant', tool_calls=[ChatCompletionMessageToolCall(index=1, caller={'type': 'direct'}, function=Function(arguments='{"a": 15, "b": 3}', name='multiply'), id='toolu_01451DFLi9bEsXsEf6a4m2SD', type='function')], function_call=None, provider_specific_fields={'citations': None, 'thinking_blocks': None})]</code></pre>
</div>
</div>
</section>
<section id="tool-call-exhaustion" class="level3">
<h3 class="anchored" data-anchor-id="tool-call-exhaustion">Tool call exhaustion</h3>
<div id="f2d02210" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb234"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb234-1"><a href="#cb234-1" aria-hidden="true" tabindex="-1"></a>pr <span class="op">=</span> <span class="st">"What is 1+2, and then the result of adding +2, and then +3 to it? Use tools to make the calculations"</span></span>
<span id="cb234-2"><a href="#cb234-2" aria-hidden="true" tabindex="-1"></a>c <span class="op">=</span> Chat(model, tools<span class="op">=</span>[simple_add])</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<div id="4e82a43f" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb235"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb235-1"><a href="#cb235-1" aria-hidden="true" tabindex="-1"></a>res <span class="op">=</span> c(pr, max_steps<span class="op">=</span><span class="dv">2</span>)</span>
<span id="cb235-2"><a href="#cb235-2" aria-hidden="true" tabindex="-1"></a>res</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display cell-output-markdown">
<p>So far, I have performed the following calculations: 1. <strong>1 + 2 = 3</strong> 2. <strong>3 + 2 = 5</strong></p>
<p>To complete your request, I still need to add <strong>+3</strong> to the current result (5). Please let me know if you would like me to finish this final step!</p>
<details>
<ul>
<li>id: <code>chatcmpl-xxx</code></li>
<li>model: <code>gemini-3-flash-preview</code></li>
<li>finish_reason: <code>stop</code></li>
<li>usage: <code>Usage(completion_tokens=73, prompt_tokens=212, total_tokens=285, completion_tokens_details=CompletionTokensDetailsWrapper(accepted_prediction_tokens=None, audio_tokens=None, reasoning_tokens=None, rejected_prediction_tokens=None, text_tokens=73, image_tokens=None), prompt_tokens_details=PromptTokensDetailsWrapper(audio_tokens=None, cached_tokens=None, text_tokens=212, image_tokens=None), cache_read_input_tokens=None)</code></li>
</ul>
</details>
</div>
</div>
<div id="0b60eaf9" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb236"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb236-1"><a href="#cb236-1" aria-hidden="true" tabindex="-1"></a><span class="cf">assert</span> c.hist[<span class="op">-</span><span class="dv">2</span>] <span class="op">==</span> _final_prompt</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
</section>
<section id="tool-call-referencing" class="level3">
<h3 class="anchored" data-anchor-id="tool-call-referencing">Tool Call Referencing</h3>
<p>With <code>tc_refs=True</code>, the AI can see and report tool call IDs:</p>
<div id="64b5fb2b" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb237"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb237-1"><a href="#cb237-1" aria-hidden="true" tabindex="-1"></a>chat <span class="op">=</span> Chat(<span class="st">'claude-sonnet-4-5'</span>, tools<span class="op">=</span>[simple_add], tc_refs<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb237-2"><a href="#cb237-2" aria-hidden="true" tabindex="-1"></a>chat(<span class="st">"Call add(1,2) and tell me the tool_call_id you used"</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display cell-output-markdown">
<p>The result of add(1,2) is <strong>3</strong>.</p>
<p>The tool_call_id I used was: <strong>toolu_01GSs8V4Fvq8Z3tacKcS4TDE</strong></p>
<details>
<ul>
<li>id: <code>chatcmpl-xxx</code></li>
<li>model: <code>claude-sonnet-4-5-20250929</code></li>
<li>finish_reason: <code>stop</code></li>
<li>usage: <code>Usage(completion_tokens=52, prompt_tokens=817, total_tokens=869, completion_tokens_details=CompletionTokensDetailsWrapper(accepted_prediction_tokens=None, audio_tokens=None, reasoning_tokens=0, rejected_prediction_tokens=None, text_tokens=52, image_tokens=None), prompt_tokens_details=PromptTokensDetailsWrapper(audio_tokens=None, cached_tokens=0, text_tokens=None, image_tokens=None, cache_creation_tokens=0, cache_creation_token_details=CacheCreationTokenDetails(ephemeral_5m_input_tokens=0, ephemeral_1h_input_tokens=0)), cache_creation_input_tokens=0, cache_read_input_tokens=0, inference_geo='not_available', speed=None)</code></li>
</ul>
</details>
</div>
</div>
<div id="d07761ac" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb238"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb238-1"><a href="#cb238-1" aria-hidden="true" tabindex="-1"></a>chat.tc_res</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display">
<pre><code>{'toolu_01GSs8V4Fvq8Z3tacKcS4TDE': 3}</code></pre>
</div>
</div>
<p>Example of chained tool calls where the AI references a previous result:</p>
<div id="c265b0c2" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb240"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb240-1"><a href="#cb240-1" aria-hidden="true" tabindex="-1"></a><span class="at">@dataclass</span></span>
<span id="cb240-2"><a href="#cb240-2" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> Person:</span>
<span id="cb240-3"><a href="#cb240-3" aria-hidden="true" tabindex="-1"></a>    name: <span class="bu">str</span></span>
<span id="cb240-4"><a href="#cb240-4" aria-hidden="true" tabindex="-1"></a>    age: <span class="bu">int</span></span>
<span id="cb240-5"><a href="#cb240-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb240-6"><a href="#cb240-6" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> get_person():</span>
<span id="cb240-7"><a href="#cb240-7" aria-hidden="true" tabindex="-1"></a>    <span class="co">"Get a person's data"</span></span>
<span id="cb240-8"><a href="#cb240-8" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> {<span class="st">"name"</span>: <span class="st">"Alice"</span>, <span class="st">"age"</span>: <span class="dv">30</span>}</span>
<span id="cb240-9"><a href="#cb240-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb240-10"><a href="#cb240-10" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> greet_person(person: Person):</span>
<span id="cb240-11"><a href="#cb240-11" aria-hidden="true" tabindex="-1"></a>    <span class="co">"Greet a person"</span></span>
<span id="cb240-12"><a href="#cb240-12" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> <span class="ss">f"Hello </span><span class="sc">{</span>person<span class="sc">.</span>name<span class="sc">}</span><span class="ss">, you are </span><span class="sc">{</span>person<span class="sc">.</span>age<span class="sc">}</span><span class="ss"> years old!"</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<div id="fa8e1242" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb241"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb241-1"><a href="#cb241-1" aria-hidden="true" tabindex="-1"></a>chat <span class="op">=</span> Chat(<span class="st">'claude-sonnet-4-5'</span>, tools<span class="op">=</span>[get_person, greet_person], tc_refs<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb241-2"><a href="#cb241-2" aria-hidden="true" tabindex="-1"></a>chat(<span class="st">"First call get_person, then pass the result to greet_person"</span>, max_steps<span class="op">=</span><span class="dv">10</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display cell-output-markdown">
<p>Perfect! I successfully retrieved Aliceâ€™s data (name: Alice, age: 30) and passed it to the greet function, which responded with: â€œHello Alice, you are 30 years old!â€</p>
<details>
<ul>
<li>id: <code>chatcmpl-xxx</code></li>
<li>model: <code>claude-sonnet-4-5-20250929</code></li>
<li>finish_reason: <code>stop</code></li>
<li>usage: <code>Usage(completion_tokens=46, prompt_tokens=1040, total_tokens=1086, completion_tokens_details=CompletionTokensDetailsWrapper(accepted_prediction_tokens=None, audio_tokens=None, reasoning_tokens=0, rejected_prediction_tokens=None, text_tokens=46, image_tokens=None), prompt_tokens_details=PromptTokensDetailsWrapper(audio_tokens=None, cached_tokens=0, text_tokens=None, image_tokens=None, cache_creation_tokens=0, cache_creation_token_details=CacheCreationTokenDetails(ephemeral_5m_input_tokens=0, ephemeral_1h_input_tokens=0)), cache_creation_input_tokens=0, cache_read_input_tokens=0, inference_geo='not_available', speed=None)</code></li>
</ul>
</details>
</div>
</div>
<p>We can inspect <code>chat.tc_res</code> to see all stored tool results:</p>
<div id="a5b2af36" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb242"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb242-1"><a href="#cb242-1" aria-hidden="true" tabindex="-1"></a>chat.sp</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display">
<pre><code>'You can reference previous tool call results using $`tool_call_id` syntax.\nFor example, if a tool call returns result with id \'toolu_abc123\', you can use it in a subsequent call:\n{"content": "$`toolu_abc123`"}\nThis is useful when chaining tools, e.g., reading data with one tool and passing it to another.'</code></pre>
</div>
</div>
<div id="eef3f679" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb244"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb244-1"><a href="#cb244-1" aria-hidden="true" tabindex="-1"></a>chat.tc_res</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display">
<pre><code>{'toolu_01RWsEy9RqVZdA9oMQRL5W8m': {'name': 'Alice', 'age': 30},
 'toolu_01CavbPT3Mh6R2LQ21Jmxq7u': 'Hello Alice, you are 30 years old!'}</code></pre>
</div>
</div>
<div id="b8f03817" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb246"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb246-1"><a href="#cb246-1" aria-hidden="true" tabindex="-1"></a><span class="bu">list</span>(L(chat.hist).attrgot(<span class="st">'tool_calls'</span>).<span class="bu">filter</span>())</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display">
<pre><code>[[ChatCompletionMessageToolCall(index=1, caller={'type': 'direct'}, function=Function(arguments='{}', name='get_person'), id='toolu_01RWsEy9RqVZdA9oMQRL5W8m', type='function')],
 [ChatCompletionMessageToolCall(index=1, caller={'type': 'direct'}, function=Function(arguments='{"person": "$`toolu_01RWsEy9RqVZdA9oMQRL5W8m`"}', name='greet_person'), id='toolu_01CavbPT3Mh6R2LQ21Jmxq7u', type='function')]]</code></pre>
</div>
</div>
<p>This also works with <a href="https://lisette.answer.ai/core.html#toolresponse"><code>ToolResponse</code></a> results:</p>
<div id="fd02bd61" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb248"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb248-1"><a href="#cb248-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> view_img(fn:Path):</span>
<span id="cb248-2"><a href="#cb248-2" aria-hidden="true" tabindex="-1"></a>    <span class="co">"View an image"</span></span>
<span id="cb248-3"><a href="#cb248-3" aria-hidden="true" tabindex="-1"></a>    durl <span class="op">=</span> <span class="ss">f"data:image/jpeg;base64,</span><span class="sc">{</span>base64<span class="sc">.</span>b64encode(fn.read_bytes())<span class="sc">.</span>decode()<span class="sc">}</span><span class="ss">"</span></span>
<span id="cb248-4"><a href="#cb248-4" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> ToolResponse([{<span class="st">'type'</span>: <span class="st">'image_url'</span>, <span class="st">'image_url'</span>: {<span class="st">'url'</span>: durl}}])</span>
<span id="cb248-5"><a href="#cb248-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb248-6"><a href="#cb248-6" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> get_img_size(image_content: <span class="bu">list</span>) <span class="op">-&gt;</span> <span class="bu">dict</span>:</span>
<span id="cb248-7"><a href="#cb248-7" aria-hidden="true" tabindex="-1"></a>    <span class="co">"Get the size of an image from ToolResponse content"</span></span>
<span id="cb248-8"><a href="#cb248-8" aria-hidden="true" tabindex="-1"></a>    <span class="im">from</span> PIL <span class="im">import</span> Image</span>
<span id="cb248-9"><a href="#cb248-9" aria-hidden="true" tabindex="-1"></a>    <span class="im">from</span> io <span class="im">import</span> BytesIO</span>
<span id="cb248-10"><a href="#cb248-10" aria-hidden="true" tabindex="-1"></a>    url <span class="op">=</span> image_content[<span class="dv">0</span>][<span class="st">'image_url'</span>][<span class="st">'url'</span>]</span>
<span id="cb248-11"><a href="#cb248-11" aria-hidden="true" tabindex="-1"></a>    b64_data <span class="op">=</span> url.split(<span class="st">','</span>)[<span class="dv">1</span>]</span>
<span id="cb248-12"><a href="#cb248-12" aria-hidden="true" tabindex="-1"></a>    img <span class="op">=</span> Image.<span class="bu">open</span>(BytesIO(base64.b64decode(b64_data)))</span>
<span id="cb248-13"><a href="#cb248-13" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> {<span class="st">'width'</span>: img.width, <span class="st">'height'</span>: img.height}</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<div id="2f5acb23" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb249"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb249-1"><a href="#cb249-1" aria-hidden="true" tabindex="-1"></a>chat <span class="op">=</span> Chat(<span class="st">'claude-sonnet-4-5'</span>, tools<span class="op">=</span>[view_img, get_img_size], tc_refs<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb249-2"><a href="#cb249-2" aria-hidden="true" tabindex="-1"></a>chat(<span class="ss">f"First describe the image at </span><span class="sc">{</span>img_fn<span class="sc">}</span><span class="ss">, and then get it's dimensions"</span>, max_steps<span class="op">=</span><span class="dv">10</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display cell-output-markdown">
<p><strong>Image Description:</strong> This is an adorable photograph of a Cavalier King Charles Spaniel puppy. The puppy has the breedâ€™s characteristic coloring with a white face and chest, and rich brown/chestnut colored ears and patches. The puppy is lying on green grass and is positioned near some purple flowers (possibly asters or similar blooms). The puppy has sweet, expressive dark eyes and is looking directly at the camera with an endearing expression. The background shows a natural outdoor setting with foliage and flowers, creating a charming portrait.</p>
<p><strong>Image Dimensions:</strong> - Width: 300 pixels - Height: 200 pixels</p>
<details>
<ul>
<li>id: <code>chatcmpl-xxx</code></li>
<li>model: <code>claude-sonnet-4-5-20250929</code></li>
<li>finish_reason: <code>stop</code></li>
<li>usage: <code>Usage(completion_tokens=145, prompt_tokens=1125, total_tokens=1270, completion_tokens_details=CompletionTokensDetailsWrapper(accepted_prediction_tokens=None, audio_tokens=None, reasoning_tokens=0, rejected_prediction_tokens=None, text_tokens=145, image_tokens=None), prompt_tokens_details=PromptTokensDetailsWrapper(audio_tokens=None, cached_tokens=0, text_tokens=None, image_tokens=None, cache_creation_tokens=0, cache_creation_token_details=CacheCreationTokenDetails(ephemeral_5m_input_tokens=0, ephemeral_1h_input_tokens=0)), cache_creation_input_tokens=0, cache_read_input_tokens=0, inference_geo='not_available', speed=None)</code></li>
</ul>
</details>
</div>
</div>
<div id="142c2421" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb250"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb250-1"><a href="#cb250-1" aria-hidden="true" tabindex="-1"></a><span class="co"># chat.tc_res</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<div id="999c5d8d" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb251"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb251-1"><a href="#cb251-1" aria-hidden="true" tabindex="-1"></a><span class="bu">list</span>(L(chat.hist).attrgot(<span class="st">'tool_calls'</span>).<span class="bu">filter</span>())</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display">
<pre><code>[[ChatCompletionMessageToolCall(index=1, caller={'type': 'direct'}, function=Function(arguments='{"fn": "samples/puppy.jpg"}', name='view_img'), id='toolu_01B1rDfmhy4RnFBM6SFqHGwo', type='function')],
 [ChatCompletionMessageToolCall(index=1, caller={'type': 'direct'}, function=Function(arguments='{"image_content": "$`toolu_01B1rDfmhy4RnFBM6SFqHGwo`"}', name='get_img_size'), id='toolu_014Z5PnAikTqJAFHuyU1qjqk', type='function')]]</code></pre>
</div>
</div>
<p>Some tool callers (e.g., ipykernel) return string reprs of Python objects (<code>"'hello'"</code> instead of <code>'hello'</code>). With <code>tc_res_eval=True</code>, these are converted back to Python objects via <code>ast.literal_eval</code> before storing in <code>tc_res</code>, enabling correct value substitution in subsequent tool calls:</p>
<div id="d91706f7" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb253"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb253-1"><a href="#cb253-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> get_config():</span>
<span id="cb253-2"><a href="#cb253-2" aria-hidden="true" tabindex="-1"></a>    <span class="co">"Returns a dict repr (simulating kernel output)"</span></span>
<span id="cb253-3"><a href="#cb253-3" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> <span class="st">"{'host': 'localhost', 'port': 8080}"</span></span>
<span id="cb253-4"><a href="#cb253-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb253-5"><a href="#cb253-5" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> use_config(config: <span class="bu">dict</span>): </span>
<span id="cb253-6"><a href="#cb253-6" aria-hidden="true" tabindex="-1"></a>    <span class="co">"Use config"</span></span>
<span id="cb253-7"><a href="#cb253-7" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> <span class="ss">f"Host: </span><span class="sc">{</span>config[<span class="st">'host'</span>]<span class="sc">}</span><span class="ss">, Port: </span><span class="sc">{</span>config[<span class="st">'port'</span>]<span class="sc">}</span><span class="ss">"</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<div id="b9a6f7a3" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb254"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb254-1"><a href="#cb254-1" aria-hidden="true" tabindex="-1"></a>chat <span class="op">=</span> Chat(<span class="st">'claude-sonnet-4-5'</span>, tools<span class="op">=</span>[get_config, use_config], tc_refs<span class="op">=</span><span class="va">True</span>, tc_res_eval<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb254-2"><a href="#cb254-2" aria-hidden="true" tabindex="-1"></a>chat(<span class="st">"Call get_config, then pass the result to use_config"</span>, max_steps<span class="op">=</span><span class="dv">10</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display cell-output-markdown">
<p>Perfect! I successfully: 1. Called <code>get_config</code> which returned a configuration with host=â€˜localhostâ€™ and port=8080 2. Passed that configuration to <code>use_config</code> which processed it and confirmed the host and port values</p>
<details>
<ul>
<li>id: <code>chatcmpl-xxx</code></li>
<li>model: <code>claude-sonnet-4-5-20250929</code></li>
<li>finish_reason: <code>stop</code></li>
<li>usage: <code>Usage(completion_tokens=54, prompt_tokens=953, total_tokens=1007, completion_tokens_details=CompletionTokensDetailsWrapper(accepted_prediction_tokens=None, audio_tokens=None, reasoning_tokens=0, rejected_prediction_tokens=None, text_tokens=54, image_tokens=None), prompt_tokens_details=PromptTokensDetailsWrapper(audio_tokens=None, cached_tokens=0, text_tokens=None, image_tokens=None, cache_creation_tokens=0, cache_creation_token_details=CacheCreationTokenDetails(ephemeral_5m_input_tokens=0, ephemeral_1h_input_tokens=0)), cache_creation_input_tokens=0, cache_read_input_tokens=0, inference_geo='not_available', speed=None)</code></li>
</ul>
</details>
</div>
</div>
<div id="e98a7e0d" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb255"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb255-1"><a href="#cb255-1" aria-hidden="true" tabindex="-1"></a>chat.tc_res</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display">
<pre><code>{'toolu_01TvnM52TFf2YbfwzxRDE1N3': {'host': 'localhost', 'port': 8080},
 'toolu_01ASEFffn4Bpx7DXF1kDGzB6': 'Host: localhost, Port: 8080'}</code></pre>
</div>
</div>
<div id="80fb22e2" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb257"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb257-1"><a href="#cb257-1" aria-hidden="true" tabindex="-1"></a>test_eq(<span class="bu">type</span>(first(chat.tc_res.values())), <span class="bu">dict</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
</section>
<section id="caching-1" class="level3">
<h3 class="anchored" data-anchor-id="caching-1">Caching</h3>
<p>Test that cache checkpoints are reapplied during tool loop (when msg=None)</p>
<div id="ce70c8fb" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb258"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb258-1"><a href="#cb258-1" aria-hidden="true" tabindex="-1"></a>c <span class="op">=</span> Chat(<span class="st">'claude'</span>, cache<span class="op">=</span><span class="va">True</span>, cache_idxs<span class="op">=</span>[<span class="op">-</span><span class="dv">2</span>,<span class="op">-</span><span class="dv">1</span>])</span>
<span id="cb258-2"><a href="#cb258-2" aria-hidden="true" tabindex="-1"></a>c.hist <span class="op">=</span> [{<span class="st">'role'</span>: <span class="st">'user'</span>, <span class="st">'content'</span>: <span class="st">'Hello'</span>},</span>
<span id="cb258-3"><a href="#cb258-3" aria-hidden="true" tabindex="-1"></a>          {<span class="st">'role'</span>: <span class="st">'assistant'</span>, <span class="st">'content'</span>: <span class="st">'Hi there!'</span>},</span>
<span id="cb258-4"><a href="#cb258-4" aria-hidden="true" tabindex="-1"></a>          {<span class="st">'role'</span>: <span class="st">'user'</span>, <span class="st">'content'</span>: <span class="st">'Use a tool'</span>},</span>
<span id="cb258-5"><a href="#cb258-5" aria-hidden="true" tabindex="-1"></a>          {<span class="st">'role'</span>: <span class="st">'assistant'</span>, <span class="st">'content'</span>: <span class="st">''</span>, <span class="st">'tool_calls'</span>: [{<span class="st">'id'</span>: <span class="st">'1'</span>, <span class="st">'function'</span>: {<span class="st">'name'</span>: <span class="st">'foo'</span>, <span class="st">'arguments'</span>: <span class="st">'</span><span class="sc">{}</span><span class="st">'</span>}}]},</span>
<span id="cb258-6"><a href="#cb258-6" aria-hidden="true" tabindex="-1"></a>          {<span class="st">'role'</span>: <span class="st">'tool'</span>, <span class="st">'tool_call_id'</span>: <span class="st">'1'</span>, <span class="st">'content'</span>: <span class="st">'result'</span>}]</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<div id="1b6e690f" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb259"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb259-1"><a href="#cb259-1" aria-hidden="true" tabindex="-1"></a>c._prep_msg(<span class="va">None</span>)  <span class="co"># Simulate tool loop iteration with no new message</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display">
<pre><code>[{'role': 'user', 'content': 'Hello'},
 {'role': 'assistant', 'content': 'Hi there!'},
 {'role': 'user',
  'content': [{'type': 'text',
    'text': 'Use a tool',
    'cache_control': {'type': 'ephemeral'}}]},
 {'role': 'assistant',
  'content': '',
  'tool_calls': [{'id': '1',
    'function': {'name': 'foo', 'arguments': '{}'},
    'cache_control': {'type': 'ephemeral'}}]},
 {'role': 'tool', 'tool_call_id': '1', 'content': 'result'}]</code></pre>
</div>
</div>
<div id="4f607408" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb261"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb261-1"><a href="#cb261-1" aria-hidden="true" tabindex="-1"></a>test_eq(<span class="st">'cache_control'</span> <span class="kw">in</span> c.hist[<span class="op">-</span><span class="dv">3</span>][<span class="st">'content'</span>][<span class="dv">0</span>], <span class="va">True</span>)  <span class="co"># user msg</span></span>
<span id="cb261-2"><a href="#cb261-2" aria-hidden="true" tabindex="-1"></a>test_eq(<span class="st">'cache_control'</span> <span class="kw">in</span> c.hist[<span class="op">-</span><span class="dv">2</span>][<span class="st">'tool_calls'</span>][<span class="op">-</span><span class="dv">1</span>], <span class="va">True</span>)  <span class="co"># tool call msg</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
</section>
</section>
<section id="async" class="level2">
<h2 class="anchored" data-anchor-id="async">Async</h2>
<section id="asyncchat" class="level3">
<h3 class="anchored" data-anchor-id="asyncchat">AsyncChat</h3>
<p>If you want to use LiteLLM in a webapp you probably want to use their async function <code>acompletion</code>. To make that easier we will implement our version of <a href="https://lisette.answer.ai/core.html#asyncchat"><code>AsyncChat</code></a> to complement it. It follows the same implementation as Chat as much as possible:</p>
<p>Testing the scenarios where the tool call was not in schemas:</p>
<div id="44cde8b8" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb262"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb262-1"><a href="#cb262-1" aria-hidden="true" tabindex="-1"></a>result <span class="op">=</span> <span class="cf">await</span> _alite_call_func(fake_tc, [toolsc], <span class="bu">globals</span>())</span>
<span id="cb262-2"><a href="#cb262-2" aria-hidden="true" tabindex="-1"></a>test_eq(result[<span class="st">'content'</span>], <span class="st">"Tool not defined in tool_schemas: hallucinated_tool"</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<p>or schemas was missingâ€¦:</p>
<div id="dda2bc30" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb263"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb263-1"><a href="#cb263-1" aria-hidden="true" tabindex="-1"></a>result <span class="op">=</span> <span class="cf">await</span> _alite_call_func(fake_tc, <span class="va">None</span>, <span class="bu">globals</span>())</span>
<span id="cb263-2"><a href="#cb263-2" aria-hidden="true" tabindex="-1"></a>test_eq(result[<span class="st">'content'</span>], <span class="st">"Tool not defined in tool_schemas: hallucinated_tool"</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<hr>
<p><a href="https://github.com/AnswerDotAI/lisette/blob/main/lisette/core.py#L544" target="_blank" style="float:right; font-size:smaller">source</a></p>
</section>
<section id="astream_with_complete" class="level3">
<h3 class="anchored" data-anchor-id="astream_with_complete">astream_with_complete</h3>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb264"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb264-1"><a href="#cb264-1" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb264-2"><a href="#cb264-2" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> astream_with_complete(</span>
<span id="cb264-3"><a href="#cb264-3" aria-hidden="true" tabindex="-1"></a>    agen, postproc:function<span class="op">=</span>noop</span>
<span id="cb264-4"><a href="#cb264-4" aria-hidden="true" tabindex="-1"></a>):</span>
<span id="cb264-5"><a href="#cb264-5" aria-hidden="true" tabindex="-1"></a></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<p>Parallel tool execution in <a href="https://lisette.answer.ai/core.html#asyncchat"><code>AsyncChat</code></a> works with both sync and async tool functions. Async tools run concurrently via <code>asyncio.gather</code>, while sync tools are automatically offloaded to threads via <code>asyncio.to_thread</code> in <code>call_func_async</code> (toolslm). For sync <a href="https://lisette.answer.ai/core.html#chat"><code>Chat</code></a>, tools run in parallel via <code>fastcore.parallel</code> with threads.</p>
<hr>
<p><a href="https://github.com/AnswerDotAI/lisette/blob/main/lisette/core.py#L553" target="_blank" style="float:right; font-size:smaller">source</a></p>
</section>
<section id="asyncchat-1" class="level3">
<h3 class="anchored" data-anchor-id="asyncchat-1">AsyncChat</h3>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb265"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb265-1"><a href="#cb265-1" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb265-2"><a href="#cb265-2" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> AsyncChat(</span>
<span id="cb265-3"><a href="#cb265-3" aria-hidden="true" tabindex="-1"></a>    model:<span class="bu">str</span>, <span class="co"># LiteLLM compatible model name</span></span>
<span id="cb265-4"><a href="#cb265-4" aria-hidden="true" tabindex="-1"></a>    sp:<span class="bu">str</span><span class="op">=</span><span class="st">''</span>, <span class="co"># System prompt</span></span>
<span id="cb265-5"><a href="#cb265-5" aria-hidden="true" tabindex="-1"></a>    temp:<span class="bu">int</span><span class="op">=</span><span class="dv">0</span>, <span class="co"># Temperature</span></span>
<span id="cb265-6"><a href="#cb265-6" aria-hidden="true" tabindex="-1"></a>    search:<span class="bu">bool</span><span class="op">=</span><span class="va">False</span>, <span class="co"># Search (l,m,h), if model supports it</span></span>
<span id="cb265-7"><a href="#cb265-7" aria-hidden="true" tabindex="-1"></a>    tools:<span class="bu">list</span><span class="op">=</span><span class="va">None</span>, <span class="co"># Add tools</span></span>
<span id="cb265-8"><a href="#cb265-8" aria-hidden="true" tabindex="-1"></a>    hist:<span class="bu">list</span><span class="op">=</span><span class="va">None</span>, <span class="co"># Chat history</span></span>
<span id="cb265-9"><a href="#cb265-9" aria-hidden="true" tabindex="-1"></a>    ns:Optional<span class="op">=</span><span class="va">None</span>, <span class="co"># Custom namespace for tool calling</span></span>
<span id="cb265-10"><a href="#cb265-10" aria-hidden="true" tabindex="-1"></a>    cache:<span class="bu">bool</span><span class="op">=</span><span class="va">False</span>, <span class="co"># Anthropic prompt caching</span></span>
<span id="cb265-11"><a href="#cb265-11" aria-hidden="true" tabindex="-1"></a>    cache_idxs:<span class="bu">list</span><span class="op">=</span>[<span class="op">-</span><span class="dv">1</span>], <span class="co"># Anthropic cache breakpoint idxs, use `0` for sys prompt if provided</span></span>
<span id="cb265-12"><a href="#cb265-12" aria-hidden="true" tabindex="-1"></a>    ttl:NoneType<span class="op">=</span><span class="va">None</span>, <span class="co"># Anthropic prompt caching ttl</span></span>
<span id="cb265-13"><a href="#cb265-13" aria-hidden="true" tabindex="-1"></a>    api_base:NoneType<span class="op">=</span><span class="va">None</span>, <span class="co"># API base URL for custom providers</span></span>
<span id="cb265-14"><a href="#cb265-14" aria-hidden="true" tabindex="-1"></a>    api_key:NoneType<span class="op">=</span><span class="va">None</span>, <span class="co"># API key for custom providers</span></span>
<span id="cb265-15"><a href="#cb265-15" aria-hidden="true" tabindex="-1"></a>    extra_headers:NoneType<span class="op">=</span><span class="va">None</span>, <span class="co"># Extra HTTP headers for custom providers</span></span>
<span id="cb265-16"><a href="#cb265-16" aria-hidden="true" tabindex="-1"></a>    tc_refs:<span class="bu">bool</span><span class="op">=</span><span class="va">False</span>, <span class="co"># Enable tool call result references</span></span>
<span id="cb265-17"><a href="#cb265-17" aria-hidden="true" tabindex="-1"></a>    tc_res_eval:<span class="bu">bool</span><span class="op">=</span><span class="va">False</span>, <span class="co"># literal_eval tool results before storing in tc_res</span></span>
<span id="cb265-18"><a href="#cb265-18" aria-hidden="true" tabindex="-1"></a>):</span>
<span id="cb265-19"><a href="#cb265-19" aria-hidden="true" tabindex="-1"></a></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<p><em>LiteLLM chat client.</em></p>
<hr>
<p><a href="https://github.com/AnswerDotAI/lisette/blob/main/lisette/core.py#L602" target="_blank" style="float:right; font-size:smaller">source</a></p>
</section>
<section id="asyncchat.__call__" class="level3">
<h3 class="anchored" data-anchor-id="asyncchat.__call__">AsyncChat.__call__</h3>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb266"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb266-1"><a href="#cb266-1" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb266-2"><a href="#cb266-2" aria-hidden="true" tabindex="-1"></a><span class="cf">async</span> <span class="kw">def</span> <span class="fu">__call__</span>(</span>
<span id="cb266-3"><a href="#cb266-3" aria-hidden="true" tabindex="-1"></a>    msg:NoneType<span class="op">=</span><span class="va">None</span>, <span class="co"># Message str, or list of multiple message parts</span></span>
<span id="cb266-4"><a href="#cb266-4" aria-hidden="true" tabindex="-1"></a>    prefill:NoneType<span class="op">=</span><span class="va">None</span>, <span class="co"># Prefill AI response if model supports it</span></span>
<span id="cb266-5"><a href="#cb266-5" aria-hidden="true" tabindex="-1"></a>    temp:NoneType<span class="op">=</span><span class="va">None</span>, <span class="co"># Override temp set on chat initialization</span></span>
<span id="cb266-6"><a href="#cb266-6" aria-hidden="true" tabindex="-1"></a>    think:NoneType<span class="op">=</span><span class="va">None</span>, <span class="co"># Thinking (l,m,h)</span></span>
<span id="cb266-7"><a href="#cb266-7" aria-hidden="true" tabindex="-1"></a>    search:NoneType<span class="op">=</span><span class="va">None</span>, <span class="co"># Override search set on chat initialization (l,m,h)</span></span>
<span id="cb266-8"><a href="#cb266-8" aria-hidden="true" tabindex="-1"></a>    stream:<span class="bu">bool</span><span class="op">=</span><span class="va">False</span>, <span class="co"># Stream results</span></span>
<span id="cb266-9"><a href="#cb266-9" aria-hidden="true" tabindex="-1"></a>    max_steps:<span class="bu">int</span><span class="op">=</span><span class="dv">2</span>, <span class="co"># Maximum number of tool calls</span></span>
<span id="cb266-10"><a href="#cb266-10" aria-hidden="true" tabindex="-1"></a>    final_prompt:<span class="bu">dict</span><span class="op">=</span>{<span class="st">'role'</span>: <span class="st">'user'</span>, <span class="st">'content'</span>: <span class="st">'You have used all your tool calls for this turn. Please summarize your findings. If you did not complete your goal, tell the user what further work is needed. You may use tools again on the next user message.'</span>}, <span class="co"># Final prompt when tool calls have ran out</span></span>
<span id="cb266-11"><a href="#cb266-11" aria-hidden="true" tabindex="-1"></a>    return_all:<span class="bu">bool</span><span class="op">=</span><span class="va">False</span>, <span class="co"># Returns all intermediate ModelResponses if not streaming and has tool calls</span></span>
<span id="cb266-12"><a href="#cb266-12" aria-hidden="true" tabindex="-1"></a>    step:<span class="bu">int</span><span class="op">=</span><span class="dv">1</span>, tool_choice:NoneType<span class="op">=</span><span class="va">None</span>, max_tokens:NoneType<span class="op">=</span><span class="va">None</span></span>
<span id="cb266-13"><a href="#cb266-13" aria-hidden="true" tabindex="-1"></a>):</span>
<span id="cb266-14"><a href="#cb266-14" aria-hidden="true" tabindex="-1"></a></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<p><em>Main call method - handles streaming vs non-streaming</em></p>
</section>
<section id="examples-1" class="level3">
<h3 class="anchored" data-anchor-id="examples-1">Examples</h3>
<p>Basic example</p>
<div id="c142f088" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb267"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb267-1"><a href="#cb267-1" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> m <span class="kw">in</span> ms[<span class="dv">1</span>:]:</span>
<span id="cb267-2"><a href="#cb267-2" aria-hidden="true" tabindex="-1"></a>    chat <span class="op">=</span> AsyncChat(m)</span>
<span id="cb267-3"><a href="#cb267-3" aria-hidden="true" tabindex="-1"></a>    test_eq(<span class="st">'4'</span> <span class="kw">in</span> contents(<span class="cf">await</span> chat(<span class="st">"What is 2+2?"</span>)).content, <span class="va">True</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<p>With tool calls</p>
<div id="a8e178ea" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb268"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb268-1"><a href="#cb268-1" aria-hidden="true" tabindex="-1"></a><span class="cf">async</span> <span class="kw">def</span> async_add(a: <span class="bu">int</span>, b: <span class="bu">int</span>) <span class="op">-&gt;</span> <span class="bu">int</span>:</span>
<span id="cb268-2"><a href="#cb268-2" aria-hidden="true" tabindex="-1"></a>    <span class="co">"Add two numbers asynchronously"</span></span>
<span id="cb268-3"><a href="#cb268-3" aria-hidden="true" tabindex="-1"></a>    <span class="cf">await</span> asyncio.sleep(<span class="fl">0.1</span>)</span>
<span id="cb268-4"><a href="#cb268-4" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> a <span class="op">+</span> b</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<div id="c14f99c1" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb269"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb269-1"><a href="#cb269-1" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> m <span class="kw">in</span> ms[<span class="dv">1</span>:]:</span>
<span id="cb269-2"><a href="#cb269-2" aria-hidden="true" tabindex="-1"></a>    chat <span class="op">=</span> AsyncChat(m, tools<span class="op">=</span>[async_add])</span>
<span id="cb269-3"><a href="#cb269-3" aria-hidden="true" tabindex="-1"></a>    r <span class="op">=</span> <span class="cf">await</span> chat(<span class="st">"What is 5 + 7? Use the tool to calculate it."</span>)</span>
<span id="cb269-4"><a href="#cb269-4" aria-hidden="true" tabindex="-1"></a>    test_eq(<span class="st">'12'</span> <span class="kw">in</span> contents(r).content, <span class="va">True</span>)</span>
<span id="cb269-5"><a href="#cb269-5" aria-hidden="true" tabindex="-1"></a>    test_eq(nested_idx(chat.hist, <span class="dv">1</span>, <span class="st">'tool_calls'</span>, <span class="dv">0</span>, <span class="st">'function'</span>, <span class="st">'name'</span>), <span class="st">'async_add'</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<p>If max tokens limit is reached, a custom warning message will be added to the end of the model response:</p>
<div id="c7317902" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb270"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb270-1"><a href="#cb270-1" aria-hidden="true" tabindex="-1"></a>chat_long <span class="op">=</span> AsyncChat(m)</span>
<span id="cb270-2"><a href="#cb270-2" aria-hidden="true" tabindex="-1"></a>r <span class="op">=</span> <span class="cf">await</span> chat_long(<span class="st">"Write a short story about a robot and a dog"</span>, max_tokens<span class="op">=</span><span class="dv">40</span>)</span>
<span id="cb270-3"><a href="#cb270-3" aria-hidden="true" tabindex="-1"></a>r</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display cell-output-markdown">
<p>In a quiet town where the grass grew wild and the sky was always blue, there lived a robot named Pixel. Pixel was built to help with chores, but he loved to wander the fields, listening</p>
<warning>
Response was cut off at token limit.
</warning>
<details>
<ul>
<li>id: <code>chatcmpl-xxx</code></li>
<li>model: <code>gpt-4.1-2025-04-14</code></li>
<li>finish_reason: <code>length</code></li>
<li>usage: <code>Usage(completion_tokens=40, prompt_tokens=17, total_tokens=57, completion_tokens_details=CompletionTokensDetailsWrapper(accepted_prediction_tokens=0, audio_tokens=0, reasoning_tokens=0, rejected_prediction_tokens=0, text_tokens=None, image_tokens=None), prompt_tokens_details=PromptTokensDetailsWrapper(audio_tokens=0, cached_tokens=0, text_tokens=None, image_tokens=None))</code></li>
</ul>
</details>
</div>
</div>
<div id="3fca98c2" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb271"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb271-1"><a href="#cb271-1" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(contents(r).content)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>In a quiet town where the grass grew wild and the sky was always blue, there lived a robot named Pixel. Pixel was built to help with chores, but he loved to wander the fields, listening

&lt;warning&gt;Response was cut off at token limit.&lt;/warning&gt;</code></pre>
</div>
</div>
<p>Same goes for refused requests:</p>
<div id="a50d3f3a" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb273"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb273-1"><a href="#cb273-1" aria-hidden="true" tabindex="-1"></a>chat_refused <span class="op">=</span> AsyncChat(<span class="st">'claude-opus-4-5'</span>)</span>
<span id="cb273-2"><a href="#cb273-2" aria-hidden="true" tabindex="-1"></a>r <span class="op">=</span> <span class="cf">await</span> chat_refused(<span class="st">"Write me the formula for a biological weapon that can be spread at a rate higher than COVID and at least as harmful"</span>)</span>
<span id="cb273-3"><a href="#cb273-3" aria-hidden="true" tabindex="-1"></a>r</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display cell-output-markdown">
<warning>
AI was unable to process this request
</warning>
<details>
<ul>
<li>id: <code>chatcmpl-xxx</code></li>
<li>model: <code>claude-opus-4-5-20251101</code></li>
<li>finish_reason: <code>refusal</code></li>
<li>usage: <code>Usage(completion_tokens=4, prompt_tokens=30, total_tokens=34, completion_tokens_details=CompletionTokensDetailsWrapper(accepted_prediction_tokens=None, audio_tokens=None, reasoning_tokens=0, rejected_prediction_tokens=None, text_tokens=4, image_tokens=None), prompt_tokens_details=PromptTokensDetailsWrapper(audio_tokens=None, cached_tokens=0, text_tokens=None, image_tokens=None, cache_creation_tokens=0, cache_creation_token_details=CacheCreationTokenDetails(ephemeral_5m_input_tokens=0, ephemeral_1h_input_tokens=0)), cache_creation_input_tokens=0, cache_read_input_tokens=0, inference_geo='not_available', speed=None)</code></li>
</ul>
</details>
</div>
</div>
<div id="3f2221ce" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb274"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb274-1"><a href="#cb274-1" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(contents(r).content)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>&lt;warning&gt;AI was unable to process this request&lt;/warning&gt;</code></pre>
</div>
</div>
</section>
</section>
<section id="async-streaming-display" class="level2">
<h2 class="anchored" data-anchor-id="async-streaming-display">Async Streaming Display</h2>
<p>This is what our outputs look like with streaming results:</p>
<div id="57698c63" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb276"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb276-1"><a href="#cb276-1" aria-hidden="true" tabindex="-1"></a>chat_with_tools <span class="op">=</span> AsyncChat(model, tools<span class="op">=</span>[async_add])</span>
<span id="cb276-2"><a href="#cb276-2" aria-hidden="true" tabindex="-1"></a>res <span class="op">=</span> <span class="cf">await</span> chat_with_tools(<span class="st">"What is 5 + 7? Use the tool to calculate it."</span>, stream<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb276-3"><a href="#cb276-3" aria-hidden="true" tabindex="-1"></a><span class="cf">async</span> <span class="cf">for</span> o <span class="kw">in</span> res:</span>
<span id="cb276-4"><a href="#cb276-4" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="bu">isinstance</span>(o,ModelResponseStream): <span class="bu">print</span>(delta_text(o) <span class="kw">or</span> <span class="st">''</span>,end<span class="op">=</span><span class="st">''</span>)</span>
<span id="cb276-5"><a href="#cb276-5" aria-hidden="true" tabindex="-1"></a>    <span class="cf">elif</span> <span class="bu">isinstance</span>(o,<span class="bu">dict</span>): <span class="bu">print</span>(o)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>
ðŸ”§ async_add
{'tool_call_id': 'call_c0604d9884c045d3b18bdc9acca4__thought__EjQKMgG+Pvb7DsSLV7LagE0Gt5Nk9IBE8VS77PVBZaWvhkZT17kAEovJgVein8N7URCJhMs+', 'role': 'tool', 'name': 'async_add', 'content': '12'}
The sum of 5 and 7 is 12.</code></pre>
</div>
</div>
<p>Hereâ€™s a complete <code>ModelResponse</code> taken from the response stream:</p>
<div id="5203c123" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb278"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb278-1"><a href="#cb278-1" aria-hidden="true" tabindex="-1"></a>resp <span class="op">=</span> ModelResponse(<span class="bu">id</span><span class="op">=</span><span class="st">'chatcmpl-xxx'</span>, created<span class="op">=</span><span class="dv">1000000000</span>, model<span class="op">=</span><span class="st">'claude-sonnet-4-5'</span>, <span class="bu">object</span><span class="op">=</span><span class="st">'chat.completion'</span>, system_fingerprint<span class="op">=</span><span class="va">None</span>, choices<span class="op">=</span>[Choices(finish_reason<span class="op">=</span><span class="st">'tool_calls'</span>, index<span class="op">=</span><span class="dv">0</span>, message<span class="op">=</span>Message(content<span class="op">=</span><span class="st">"I'll calculate ((10 + 5) * 3) / (2 + 1) step by step:"</span>, role<span class="op">=</span><span class="st">'assistant'</span>, tool_calls<span class="op">=</span>[ChatCompletionMessageToolCall(function<span class="op">=</span>Function(arguments<span class="op">=</span><span class="st">'{"a": 10, "b": 5}'</span>, name<span class="op">=</span><span class="st">'simple_add'</span>), <span class="bu">id</span><span class="op">=</span><span class="st">'toolu_018BGyenjiRkDQFU1jWP6qRo'</span>, <span class="bu">type</span><span class="op">=</span><span class="st">'function'</span>), ChatCompletionMessageToolCall(function<span class="op">=</span>Function(arguments<span class="op">=</span><span class="st">'{"a": 2, "b": 1}'</span>, name<span class="op">=</span><span class="st">'simple_add'</span>), <span class="bu">id</span><span class="op">=</span><span class="st">'toolu_01CWqrNQvoRjf1Q1GLpTUgQR'</span>, <span class="bu">type</span><span class="op">=</span><span class="st">'function'</span>)], function_call<span class="op">=</span><span class="va">None</span>, provider_specific_fields<span class="op">=</span><span class="va">None</span>))], usage<span class="op">=</span>Usage(completion_tokens<span class="op">=</span><span class="dv">228</span>, prompt_tokens<span class="op">=</span><span class="dv">794</span>, total_tokens<span class="op">=</span><span class="dv">1022</span>, prompt_tokens_details<span class="op">=</span><span class="va">None</span>))</span>
<span id="cb278-2"><a href="#cb278-2" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="bu">repr</span>(resp))</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>ModelResponse(id='chatcmpl-xxx', created=1000000000, model='claude-sonnet-4-5', object='chat.completion', system_fingerprint=None, choices=[Choices(finish_reason='tool_calls', index=0, message=Message(content="I'll calculate ((10 + 5) * 3) / (2 + 1) step by step:", role='assistant', tool_calls=[ChatCompletionMessageToolCall(function=Function(arguments='{"a": 10, "b": 5}', name='simple_add'), id='toolu_018BGyenjiRkDQFU1jWP6qRo', type='function'), ChatCompletionMessageToolCall(function=Function(arguments='{"a": 2, "b": 1}', name='simple_add'), id='toolu_01CWqrNQvoRjf1Q1GLpTUgQR', type='function')], function_call=None, provider_specific_fields=None))], usage=Usage(completion_tokens=228, prompt_tokens=794, total_tokens=1022, completion_tokens_details=None, prompt_tokens_details=None))</code></pre>
</div>
</div>
<div id="bc69f062" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb280"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb280-1"><a href="#cb280-1" aria-hidden="true" tabindex="-1"></a>tc<span class="op">=</span>resp.choices[<span class="dv">0</span>].message.tool_calls[<span class="dv">0</span>]</span>
<span id="cb280-2"><a href="#cb280-2" aria-hidden="true" tabindex="-1"></a>tc</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display">
<pre><code>ChatCompletionMessageToolCall(function=Function(arguments='{"a": 10, "b": 5}', name='simple_add'), id='toolu_018BGyenjiRkDQFU1jWP6qRo', type='function')</code></pre>
</div>
</div>
<div id="3a0c0add" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb282"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb282-1"><a href="#cb282-1" aria-hidden="true" tabindex="-1"></a>tr<span class="op">=</span>{<span class="st">'tool_call_id'</span>: <span class="st">'toolu_018BGyenjiRkDQFU1jWP6qRo'</span>, <span class="st">'role'</span>: <span class="st">'tool'</span>,<span class="st">'name'</span>: <span class="st">'simple_add'</span>,</span>
<span id="cb282-2"><a href="#cb282-2" aria-hidden="true" tabindex="-1"></a>    <span class="st">'content'</span>: <span class="st">'15 is the answer! '</span> <span class="op">+</span><span class="st">'.'</span><span class="op">*</span><span class="dv">2000</span>}</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<hr>
<p><a href="https://github.com/AnswerDotAI/lisette/blob/main/lisette/core.py#L627" target="_blank" style="float:right; font-size:smaller">source</a></p>
<section id="mk_tr_details" class="level3">
<h3 class="anchored" data-anchor-id="mk_tr_details">mk_tr_details</h3>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb283"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb283-1"><a href="#cb283-1" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb283-2"><a href="#cb283-2" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> mk_tr_details(</span>
<span id="cb283-3"><a href="#cb283-3" aria-hidden="true" tabindex="-1"></a>    tr, tc, mx:<span class="bu">int</span><span class="op">=</span><span class="dv">2000</span></span>
<span id="cb283-4"><a href="#cb283-4" aria-hidden="true" tabindex="-1"></a>):</span>
<span id="cb283-5"><a href="#cb283-5" aria-hidden="true" tabindex="-1"></a></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
*Create
<details>
<p>block for tool call as JSON*</p>
<div id="1973a7b6" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb284"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb284-1"><a href="#cb284-1" aria-hidden="true" tabindex="-1"></a>mk_tr_details(tr,tc,mx<span class="op">=</span><span class="dv">300</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display">
<pre><code>'\n\n&lt;details class=\'tool-usage-details\'&gt;\n&lt;summary&gt;simple_add(a=10, b=5)&lt;/summary&gt;\n\n```json\n{\n  "id": "toolu_018BGyenjiRkDQFU1jWP6qRo",\n  "call": {\n    "function": "simple_add",\n    "arguments": {\n      "a": "10",\n      "b": "5"\n    }\n  },\n  "result": "&lt;TRUNCATED&gt;\\u2026answer! .....\\u2026&lt;/TRUNCATED&gt;"\n}\n```\n\n&lt;/details&gt;\n\n'</code></pre>
</div>
</div>
<hr>
<p><a href="https://github.com/AnswerDotAI/lisette/blob/main/lisette/core.py#L638" target="_blank" style="float:right; font-size:smaller">source</a></p>
</details></section>
<section id="fmt_usage" class="level3">
<h3 class="anchored" data-anchor-id="fmt_usage">fmt_usage</h3>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb286"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb286-1"><a href="#cb286-1" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb286-2"><a href="#cb286-2" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> fmt_usage(</span>
<span id="cb286-3"><a href="#cb286-3" aria-hidden="true" tabindex="-1"></a>    u</span>
<span id="cb286-4"><a href="#cb286-4" aria-hidden="true" tabindex="-1"></a>):</span>
<span id="cb286-5"><a href="#cb286-5" aria-hidden="true" tabindex="-1"></a></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<p><em>Format usage stats with cache hit rate as lead metric.</em></p>
<div id="18200423" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb287"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb287-1"><a href="#cb287-1" aria-hidden="true" tabindex="-1"></a>ex_usg <span class="op">=</span> AttrDict(</span>
<span id="cb287-2"><a href="#cb287-2" aria-hidden="true" tabindex="-1"></a>    completion_tokens<span class="op">=</span><span class="dv">203</span>,</span>
<span id="cb287-3"><a href="#cb287-3" aria-hidden="true" tabindex="-1"></a>    prompt_tokens<span class="op">=</span><span class="dv">25139</span>,</span>
<span id="cb287-4"><a href="#cb287-4" aria-hidden="true" tabindex="-1"></a>    total_tokens<span class="op">=</span><span class="dv">25342</span>,</span>
<span id="cb287-5"><a href="#cb287-5" aria-hidden="true" tabindex="-1"></a>    completion_tokens_details<span class="op">=</span>AttrDict(reasoning_tokens<span class="op">=</span><span class="dv">35</span>),</span>
<span id="cb287-6"><a href="#cb287-6" aria-hidden="true" tabindex="-1"></a>    prompt_tokens_details<span class="op">=</span>AttrDict(cached_tokens<span class="op">=</span><span class="dv">24299</span>, cache_creation_tokens<span class="op">=</span><span class="dv">79</span>),</span>
<span id="cb287-7"><a href="#cb287-7" aria-hidden="true" tabindex="-1"></a>    cache_creation_input_tokens<span class="op">=</span><span class="dv">79</span>,</span>
<span id="cb287-8"><a href="#cb287-8" aria-hidden="true" tabindex="-1"></a>    cache_read_input_tokens<span class="op">=</span><span class="dv">24299</span></span>
<span id="cb287-9"><a href="#cb287-9" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb287-10"><a href="#cb287-10" aria-hidden="true" tabindex="-1"></a>fmt_usage(ex_usg)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display">
<pre><code>'Cache hit: 96.7% | Tokens: total=25,342 input=25,139 (+24,299 cached, 79 new) output=203 (reasoning 35)'</code></pre>
</div>
</div>
<hr>
<p><a href="https://github.com/AnswerDotAI/lisette/blob/main/lisette/core.py#L650" target="_blank" style="float:right; font-size:smaller">source</a></p>
</section>
<section id="streamformatter" class="level3">
<h3 class="anchored" data-anchor-id="streamformatter">StreamFormatter</h3>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb289"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb289-1"><a href="#cb289-1" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb289-2"><a href="#cb289-2" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> StreamFormatter(</span>
<span id="cb289-3"><a href="#cb289-3" aria-hidden="true" tabindex="-1"></a>    include_usage:<span class="bu">bool</span><span class="op">=</span><span class="va">False</span>, mx:<span class="bu">int</span><span class="op">=</span><span class="dv">2000</span>, debug:<span class="bu">bool</span><span class="op">=</span><span class="va">False</span>, showthink:<span class="bu">bool</span><span class="op">=</span><span class="va">False</span></span>
<span id="cb289-4"><a href="#cb289-4" aria-hidden="true" tabindex="-1"></a>):</span>
<span id="cb289-5"><a href="#cb289-5" aria-hidden="true" tabindex="-1"></a></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<p><em>Initialize self. See help(type(self)) for accurate signature.</em></p>
<div id="a242a545" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb290"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb290-1"><a href="#cb290-1" aria-hidden="true" tabindex="-1"></a>stream_msg <span class="op">=</span> ModelResponseStream([StreamingChoices(delta<span class="op">=</span>Delta(content<span class="op">=</span><span class="st">"Hello world!"</span>))])</span>
<span id="cb290-2"><a href="#cb290-2" aria-hidden="true" tabindex="-1"></a>StreamFormatter().format_item(stream_msg)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display">
<pre><code>'Hello world!'</code></pre>
</div>
</div>
<div id="e50c01e9" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb292"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb292-1"><a href="#cb292-1" aria-hidden="true" tabindex="-1"></a>reasoning_msg <span class="op">=</span> ModelResponseStream([StreamingChoices(delta<span class="op">=</span>Delta(reasoning_content<span class="op">=</span><span class="st">"thinking..."</span>))])</span>
<span id="cb292-2"><a href="#cb292-2" aria-hidden="true" tabindex="-1"></a>StreamFormatter().format_item(reasoning_msg)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display">
<pre><code>'ðŸ§ '</code></pre>
</div>
</div>
<hr>
<p><a href="https://github.com/AnswerDotAI/lisette/blob/main/lisette/core.py#L682" target="_blank" style="float:right; font-size:smaller">source</a></p>
</section>
<section id="asyncstreamformatter" class="level3">
<h3 class="anchored" data-anchor-id="asyncstreamformatter">AsyncStreamFormatter</h3>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb294"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb294-1"><a href="#cb294-1" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb294-2"><a href="#cb294-2" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> AsyncStreamFormatter(</span>
<span id="cb294-3"><a href="#cb294-3" aria-hidden="true" tabindex="-1"></a>    include_usage:<span class="bu">bool</span><span class="op">=</span><span class="va">False</span>, mx:<span class="bu">int</span><span class="op">=</span><span class="dv">2000</span>, debug:<span class="bu">bool</span><span class="op">=</span><span class="va">False</span>, showthink:<span class="bu">bool</span><span class="op">=</span><span class="va">False</span></span>
<span id="cb294-4"><a href="#cb294-4" aria-hidden="true" tabindex="-1"></a>):</span>
<span id="cb294-5"><a href="#cb294-5" aria-hidden="true" tabindex="-1"></a></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<p><em>Initialize self. See help(type(self)) for accurate signature.</em></p>
<div id="f627276d" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb295"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb295-1"><a href="#cb295-1" aria-hidden="true" tabindex="-1"></a>mock_tool_call <span class="op">=</span> ChatCompletionMessageToolCall(</span>
<span id="cb295-2"><a href="#cb295-2" aria-hidden="true" tabindex="-1"></a>    <span class="bu">id</span><span class="op">=</span><span class="st">"toolu_123abc456def"</span>, <span class="bu">type</span><span class="op">=</span><span class="st">"function"</span>, </span>
<span id="cb295-3"><a href="#cb295-3" aria-hidden="true" tabindex="-1"></a>    function<span class="op">=</span>Function( name<span class="op">=</span><span class="st">"simple_add"</span>, arguments<span class="op">=</span><span class="st">'{"a": 5, "b": 3}'</span> )</span>
<span id="cb295-4"><a href="#cb295-4" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb295-5"><a href="#cb295-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb295-6"><a href="#cb295-6" aria-hidden="true" tabindex="-1"></a>mock_response <span class="op">=</span> ModelResponse()</span>
<span id="cb295-7"><a href="#cb295-7" aria-hidden="true" tabindex="-1"></a>mock_response.choices <span class="op">=</span> [<span class="bu">type</span>(<span class="st">'Choice'</span>, (), {</span>
<span id="cb295-8"><a href="#cb295-8" aria-hidden="true" tabindex="-1"></a>    <span class="st">'message'</span>: <span class="bu">type</span>(<span class="st">'Message'</span>, (), {</span>
<span id="cb295-9"><a href="#cb295-9" aria-hidden="true" tabindex="-1"></a>        <span class="st">'tool_calls'</span>: [mock_tool_call]</span>
<span id="cb295-10"><a href="#cb295-10" aria-hidden="true" tabindex="-1"></a>    })()</span>
<span id="cb295-11"><a href="#cb295-11" aria-hidden="true" tabindex="-1"></a>})()]</span>
<span id="cb295-12"><a href="#cb295-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb295-13"><a href="#cb295-13" aria-hidden="true" tabindex="-1"></a>mock_tool_result <span class="op">=</span> {</span>
<span id="cb295-14"><a href="#cb295-14" aria-hidden="true" tabindex="-1"></a>    <span class="st">'tool_call_id'</span>: mock_tool_call.<span class="bu">id</span>, <span class="st">'role'</span>: <span class="st">'tool'</span>, </span>
<span id="cb295-15"><a href="#cb295-15" aria-hidden="true" tabindex="-1"></a>    <span class="st">'name'</span>: <span class="st">'simple_add'</span>, <span class="st">'content'</span>: <span class="st">'8'</span></span>
<span id="cb295-16"><a href="#cb295-16" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<div id="f9362bb7" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb296"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb296-1"><a href="#cb296-1" aria-hidden="true" tabindex="-1"></a>fmt <span class="op">=</span> AsyncStreamFormatter()</span>
<span id="cb296-2"><a href="#cb296-2" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(fmt.format_item(mock_response))</span>
<span id="cb296-3"><a href="#cb296-3" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">'---'</span>)</span>
<span id="cb296-4"><a href="#cb296-4" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(fmt.format_item(mock_tool_result))</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>
---


&lt;details class='tool-usage-details'&gt;
&lt;summary&gt;simple_add(a=5, b=3)&lt;/summary&gt;

```json
{
  "id": "toolu_123abc456def",
  "call": {
    "function": "simple_add",
    "arguments": {
      "a": "5",
      "b": "3"
    }
  },
  "result": "8"
}
```

&lt;/details&gt;

</code></pre>
</div>
</div>
<p>In jupyter itâ€™s nice to use this <a href="https://lisette.answer.ai/core.html#streamformatter"><code>StreamFormatter</code></a> in combination with the <code>Markdown</code> <code>display</code>:</p>
<hr>
<p><a href="https://github.com/AnswerDotAI/lisette/blob/main/lisette/core.py#L688" target="_blank" style="float:right; font-size:smaller">source</a></p>
</section>
<section id="display_stream" class="level3">
<h3 class="anchored" data-anchor-id="display_stream">display_stream</h3>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb298"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb298-1"><a href="#cb298-1" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb298-2"><a href="#cb298-2" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> display_stream(</span>
<span id="cb298-3"><a href="#cb298-3" aria-hidden="true" tabindex="-1"></a>    rs</span>
<span id="cb298-4"><a href="#cb298-4" aria-hidden="true" tabindex="-1"></a>):</span>
<span id="cb298-5"><a href="#cb298-5" aria-hidden="true" tabindex="-1"></a></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<p><em>Use IPython.display to markdown display the response stream.</em></p>
<p>Generated images can be displayed in streaming too (not shown here to conserve filesize):</p>
<div id="b8611f80" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb299"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb299-1"><a href="#cb299-1" aria-hidden="true" tabindex="-1"></a><span class="co"># rs = completion(model='gemini/gemini-2.5-flash-image', stream=True, messages=[{'role':'user','content':'Draw a simple sketch of a dog'}])</span></span>
<span id="cb299-2"><a href="#cb299-2" aria-hidden="true" tabindex="-1"></a><span class="co"># fmt = display_stream(rs)</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<hr>
<p><a href="https://github.com/AnswerDotAI/lisette/blob/main/lisette/core.py#L700" target="_blank" style="float:right; font-size:smaller">source</a></p>
</section>
<section id="adisplay_stream" class="level3">
<h3 class="anchored" data-anchor-id="adisplay_stream">adisplay_stream</h3>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb300"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb300-1"><a href="#cb300-1" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb300-2"><a href="#cb300-2" aria-hidden="true" tabindex="-1"></a><span class="cf">async</span> <span class="kw">def</span> adisplay_stream(</span>
<span id="cb300-3"><a href="#cb300-3" aria-hidden="true" tabindex="-1"></a>    rs</span>
<span id="cb300-4"><a href="#cb300-4" aria-hidden="true" tabindex="-1"></a>):</span>
<span id="cb300-5"><a href="#cb300-5" aria-hidden="true" tabindex="-1"></a></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<p><em>Use IPython.display to markdown display the response stream.</em></p>
</section>
</section>
<section id="streaming-examples" class="level2">
<h2 class="anchored" data-anchor-id="streaming-examples">Streaming examples</h2>
<p>Now we can demonstrate <a href="https://lisette.answer.ai/core.html#asyncchat"><code>AsyncChat</code></a> with <code>stream=True</code>!</p>
<section id="tool-call" class="level3">
<h3 class="anchored" data-anchor-id="tool-call">Tool call</h3>
<div id="375953eb" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb301"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb301-1"><a href="#cb301-1" aria-hidden="true" tabindex="-1"></a>chat <span class="op">=</span> Chat(model, tools<span class="op">=</span>[simple_add])</span>
<span id="cb301-2"><a href="#cb301-2" aria-hidden="true" tabindex="-1"></a>res <span class="op">=</span> chat(<span class="st">"What is 5 + 7? Use the tool to calculate it."</span>, stream<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb301-3"><a href="#cb301-3" aria-hidden="true" tabindex="-1"></a>fmt <span class="op">=</span> display_stream(res)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display cell-output-markdown">
<div class="prose">
<details class="tool-usage-details">
<summary>
simple_add(a=5, b=7)
</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb302"><pre class="sourceCode json code-with-copy"><code class="sourceCode json"><span id="cb302-1"><a href="#cb302-1" aria-hidden="true" tabindex="-1"></a><span class="fu">{</span></span>
<span id="cb302-2"><a href="#cb302-2" aria-hidden="true" tabindex="-1"></a>  <span class="dt">"id"</span><span class="fu">:</span> <span class="st">"call_6536d38c29544cd88e79609b13b9__thought__EjQKMgG+Pvb7nKxJO5ozr7gN8m9umnYHtc5dhFGytwplDNkR4gpKXXq2mobzCEd9tHUxp2xO"</span><span class="fu">,</span></span>
<span id="cb302-3"><a href="#cb302-3" aria-hidden="true" tabindex="-1"></a>  <span class="dt">"call"</span><span class="fu">:</span> <span class="fu">{</span></span>
<span id="cb302-4"><a href="#cb302-4" aria-hidden="true" tabindex="-1"></a>    <span class="dt">"function"</span><span class="fu">:</span> <span class="st">"simple_add"</span><span class="fu">,</span></span>
<span id="cb302-5"><a href="#cb302-5" aria-hidden="true" tabindex="-1"></a>    <span class="dt">"arguments"</span><span class="fu">:</span> <span class="fu">{</span></span>
<span id="cb302-6"><a href="#cb302-6" aria-hidden="true" tabindex="-1"></a>      <span class="dt">"a"</span><span class="fu">:</span> <span class="st">"5"</span><span class="fu">,</span></span>
<span id="cb302-7"><a href="#cb302-7" aria-hidden="true" tabindex="-1"></a>      <span class="dt">"b"</span><span class="fu">:</span> <span class="st">"7"</span></span>
<span id="cb302-8"><a href="#cb302-8" aria-hidden="true" tabindex="-1"></a>    <span class="fu">}</span></span>
<span id="cb302-9"><a href="#cb302-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">},</span></span>
<span id="cb302-10"><a href="#cb302-10" aria-hidden="true" tabindex="-1"></a>  <span class="dt">"result"</span><span class="fu">:</span> <span class="st">"12"</span></span>
<span id="cb302-11"><a href="#cb302-11" aria-hidden="true" tabindex="-1"></a><span class="fu">}</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
<p>5 + 7 is 12.</p>
</div>
</div>
</div>
<div id="9ef4c620" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb303"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb303-1"><a href="#cb303-1" aria-hidden="true" tabindex="-1"></a>chat <span class="op">=</span> AsyncChat(model, tools<span class="op">=</span>[async_add])</span>
<span id="cb303-2"><a href="#cb303-2" aria-hidden="true" tabindex="-1"></a>res <span class="op">=</span> <span class="cf">await</span> chat(<span class="st">"What is 5 + 7? Use the tool to calculate it."</span>, stream<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb303-3"><a href="#cb303-3" aria-hidden="true" tabindex="-1"></a>fmt <span class="op">=</span> <span class="cf">await</span> adisplay_stream(res)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display cell-output-markdown">
<div class="prose">
<details class="tool-usage-details">
<summary>
async_add(a=5, b=7)
</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb304"><pre class="sourceCode json code-with-copy"><code class="sourceCode json"><span id="cb304-1"><a href="#cb304-1" aria-hidden="true" tabindex="-1"></a><span class="fu">{</span></span>
<span id="cb304-2"><a href="#cb304-2" aria-hidden="true" tabindex="-1"></a>  <span class="dt">"id"</span><span class="fu">:</span> <span class="st">"call_e4585acc8d624d03a3e5cf3db18f__thought__EjQKMgG+Pvb7DsSLV7LagE0Gt5Nk9IBE8VS77PVBZaWvhkZT17kAEovJgVein8N7URCJhMs+"</span><span class="fu">,</span></span>
<span id="cb304-3"><a href="#cb304-3" aria-hidden="true" tabindex="-1"></a>  <span class="dt">"call"</span><span class="fu">:</span> <span class="fu">{</span></span>
<span id="cb304-4"><a href="#cb304-4" aria-hidden="true" tabindex="-1"></a>    <span class="dt">"function"</span><span class="fu">:</span> <span class="st">"async_add"</span><span class="fu">,</span></span>
<span id="cb304-5"><a href="#cb304-5" aria-hidden="true" tabindex="-1"></a>    <span class="dt">"arguments"</span><span class="fu">:</span> <span class="fu">{</span></span>
<span id="cb304-6"><a href="#cb304-6" aria-hidden="true" tabindex="-1"></a>      <span class="dt">"a"</span><span class="fu">:</span> <span class="st">"5"</span><span class="fu">,</span></span>
<span id="cb304-7"><a href="#cb304-7" aria-hidden="true" tabindex="-1"></a>      <span class="dt">"b"</span><span class="fu">:</span> <span class="st">"7"</span></span>
<span id="cb304-8"><a href="#cb304-8" aria-hidden="true" tabindex="-1"></a>    <span class="fu">}</span></span>
<span id="cb304-9"><a href="#cb304-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">},</span></span>
<span id="cb304-10"><a href="#cb304-10" aria-hidden="true" tabindex="-1"></a>  <span class="dt">"result"</span><span class="fu">:</span> <span class="st">"12"</span></span>
<span id="cb304-11"><a href="#cb304-11" aria-hidden="true" tabindex="-1"></a><span class="fu">}</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
<p>The sum of 5 and 7 is 12.</p>
</div>
</div>
</div>
<div id="ea6a9885" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb305"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb305-1"><a href="#cb305-1" aria-hidden="true" tabindex="-1"></a>chat <span class="op">=</span> AsyncChat(model, tools<span class="op">=</span>[async_add])</span>
<span id="cb305-2"><a href="#cb305-2" aria-hidden="true" tabindex="-1"></a>res <span class="op">=</span> <span class="cf">await</span> chat(<span class="st">"What is 5 + 3? Use the tool to calculate it."</span>, stream<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb305-3"><a href="#cb305-3" aria-hidden="true" tabindex="-1"></a>fmt <span class="op">=</span> <span class="cf">await</span> adisplay_stream(res)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display cell-output-markdown">
<div class="prose">
<details class="tool-usage-details">
<summary>
async_add(b=3, a=5)
</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb306"><pre class="sourceCode json code-with-copy"><code class="sourceCode json"><span id="cb306-1"><a href="#cb306-1" aria-hidden="true" tabindex="-1"></a><span class="fu">{</span></span>
<span id="cb306-2"><a href="#cb306-2" aria-hidden="true" tabindex="-1"></a>  <span class="dt">"id"</span><span class="fu">:</span> <span class="st">"call_6be3e29d423d454aac129b4bb146__thought__EjQKMgG+Pvb7mhCMtCVpmgDrgkPN5DzvymjGZL/AIkQcOciFRaxuRBt5VrW8cXpXOUSs41FN"</span><span class="fu">,</span></span>
<span id="cb306-3"><a href="#cb306-3" aria-hidden="true" tabindex="-1"></a>  <span class="dt">"call"</span><span class="fu">:</span> <span class="fu">{</span></span>
<span id="cb306-4"><a href="#cb306-4" aria-hidden="true" tabindex="-1"></a>    <span class="dt">"function"</span><span class="fu">:</span> <span class="st">"async_add"</span><span class="fu">,</span></span>
<span id="cb306-5"><a href="#cb306-5" aria-hidden="true" tabindex="-1"></a>    <span class="dt">"arguments"</span><span class="fu">:</span> <span class="fu">{</span></span>
<span id="cb306-6"><a href="#cb306-6" aria-hidden="true" tabindex="-1"></a>      <span class="dt">"b"</span><span class="fu">:</span> <span class="st">"3"</span><span class="fu">,</span></span>
<span id="cb306-7"><a href="#cb306-7" aria-hidden="true" tabindex="-1"></a>      <span class="dt">"a"</span><span class="fu">:</span> <span class="st">"5"</span></span>
<span id="cb306-8"><a href="#cb306-8" aria-hidden="true" tabindex="-1"></a>    <span class="fu">}</span></span>
<span id="cb306-9"><a href="#cb306-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">},</span></span>
<span id="cb306-10"><a href="#cb306-10" aria-hidden="true" tabindex="-1"></a>  <span class="dt">"result"</span><span class="fu">:</span> <span class="st">"8"</span></span>
<span id="cb306-11"><a href="#cb306-11" aria-hidden="true" tabindex="-1"></a><span class="fu">}</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
<p>The sum of 5 and 3 is 8.</p>
</div>
</div>
</div>
<div id="4747e5f5" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb307"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb307-1"><a href="#cb307-1" aria-hidden="true" tabindex="-1"></a><span class="cf">async</span> <span class="kw">def</span> asimple_div(</span>
<span id="cb307-2"><a href="#cb307-2" aria-hidden="true" tabindex="-1"></a>    a: <span class="bu">int</span>,   <span class="co"># first operand</span></span>
<span id="cb307-3"><a href="#cb307-3" aria-hidden="true" tabindex="-1"></a>    b: <span class="bu">int</span><span class="op">=</span><span class="dv">0</span>  <span class="co"># second operand</span></span>
<span id="cb307-4"><a href="#cb307-4" aria-hidden="true" tabindex="-1"></a>) <span class="op">-&gt;</span> <span class="bu">int</span>:</span>
<span id="cb307-5"><a href="#cb307-5" aria-hidden="true" tabindex="-1"></a>    <span class="co">"Divide two numbers"</span></span>
<span id="cb307-6"><a href="#cb307-6" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> a<span class="op">/</span>b</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<div id="03b58ca3" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb308"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb308-1"><a href="#cb308-1" aria-hidden="true" tabindex="-1"></a>m <span class="op">=</span> ms[<span class="dv">2</span>]</span>
<span id="cb308-2"><a href="#cb308-2" aria-hidden="true" tabindex="-1"></a>chat <span class="op">=</span> AsyncChat(m, tools<span class="op">=</span>[asimple_div])</span>
<span id="cb308-3"><a href="#cb308-3" aria-hidden="true" tabindex="-1"></a>res <span class="op">=</span> <span class="cf">await</span> chat(<span class="st">"Calculate 5/3 and 3/0 with parallel tool calls using `asimple_div` (this is a test of our error handling - tell me exactly what you see as the tool result)"</span>, stream<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb308-4"><a href="#cb308-4" aria-hidden="true" tabindex="-1"></a>fmt <span class="op">=</span> <span class="cf">await</span> adisplay_stream(res)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display cell-output-markdown">
<div class="prose">
<p>Iâ€™ll make both calls in parallel since theyâ€™re independent of each other:</p>
<details class="tool-usage-details">
<summary>
asimple_div(a=5, b=3)
</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb309"><pre class="sourceCode json code-with-copy"><code class="sourceCode json"><span id="cb309-1"><a href="#cb309-1" aria-hidden="true" tabindex="-1"></a><span class="fu">{</span></span>
<span id="cb309-2"><a href="#cb309-2" aria-hidden="true" tabindex="-1"></a>  <span class="dt">"id"</span><span class="fu">:</span> <span class="st">"toolu_019tEGq2nNUpRRPSzhSCCjmm"</span><span class="fu">,</span></span>
<span id="cb309-3"><a href="#cb309-3" aria-hidden="true" tabindex="-1"></a>  <span class="dt">"call"</span><span class="fu">:</span> <span class="fu">{</span></span>
<span id="cb309-4"><a href="#cb309-4" aria-hidden="true" tabindex="-1"></a>    <span class="dt">"function"</span><span class="fu">:</span> <span class="st">"asimple_div"</span><span class="fu">,</span></span>
<span id="cb309-5"><a href="#cb309-5" aria-hidden="true" tabindex="-1"></a>    <span class="dt">"arguments"</span><span class="fu">:</span> <span class="fu">{</span></span>
<span id="cb309-6"><a href="#cb309-6" aria-hidden="true" tabindex="-1"></a>      <span class="dt">"a"</span><span class="fu">:</span> <span class="st">"5"</span><span class="fu">,</span></span>
<span id="cb309-7"><a href="#cb309-7" aria-hidden="true" tabindex="-1"></a>      <span class="dt">"b"</span><span class="fu">:</span> <span class="st">"3"</span></span>
<span id="cb309-8"><a href="#cb309-8" aria-hidden="true" tabindex="-1"></a>    <span class="fu">}</span></span>
<span id="cb309-9"><a href="#cb309-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">},</span></span>
<span id="cb309-10"><a href="#cb309-10" aria-hidden="true" tabindex="-1"></a>  <span class="dt">"result"</span><span class="fu">:</span> <span class="st">"1.6666666666666667"</span></span>
<span id="cb309-11"><a href="#cb309-11" aria-hidden="true" tabindex="-1"></a><span class="fu">}</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
<details class="tool-usage-details">
<summary>
asimple_div(a=3, b=0)
</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb310"><pre class="sourceCode json code-with-copy"><code class="sourceCode json"><span id="cb310-1"><a href="#cb310-1" aria-hidden="true" tabindex="-1"></a><span class="fu">{</span></span>
<span id="cb310-2"><a href="#cb310-2" aria-hidden="true" tabindex="-1"></a>  <span class="dt">"id"</span><span class="fu">:</span> <span class="st">"toolu_01HLDF7VBXqb96RhgwVAkTpM"</span><span class="fu">,</span></span>
<span id="cb310-3"><a href="#cb310-3" aria-hidden="true" tabindex="-1"></a>  <span class="dt">"call"</span><span class="fu">:</span> <span class="fu">{</span></span>
<span id="cb310-4"><a href="#cb310-4" aria-hidden="true" tabindex="-1"></a>    <span class="dt">"function"</span><span class="fu">:</span> <span class="st">"asimple_div"</span><span class="fu">,</span></span>
<span id="cb310-5"><a href="#cb310-5" aria-hidden="true" tabindex="-1"></a>    <span class="dt">"arguments"</span><span class="fu">:</span> <span class="fu">{</span></span>
<span id="cb310-6"><a href="#cb310-6" aria-hidden="true" tabindex="-1"></a>      <span class="dt">"a"</span><span class="fu">:</span> <span class="st">"3"</span><span class="fu">,</span></span>
<span id="cb310-7"><a href="#cb310-7" aria-hidden="true" tabindex="-1"></a>      <span class="dt">"b"</span><span class="fu">:</span> <span class="st">"0"</span></span>
<span id="cb310-8"><a href="#cb310-8" aria-hidden="true" tabindex="-1"></a>    <span class="fu">}</span></span>
<span id="cb310-9"><a href="#cb310-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">},</span></span>
<span id="cb310-10"><a href="#cb310-10" aria-hidden="true" tabindex="-1"></a>  <span class="dt">"result"</span><span class="fu">:</span> <span class="st">"Traceback (most recent call last):</span><span class="ch">\n</span><span class="st">  File </span><span class="ch">\"</span><span class="st">/Users/jhoward/aai-ws/toolslm/toolslm/funccall.py</span><span class="ch">\"</span><span class="st">, line 265, in call_func_async</span><span class="ch">\n</span><span class="st">    try: res = await res</span><span class="ch">\n</span><span class="st">               ^^^^^^^^^</span><span class="ch">\n</span><span class="st">  File </span><span class="ch">\"</span><span class="st">/var/folders/51/b2_szf2945n072c0vj2cyty40000gn/T/ipykernel_23626/466431256.py</span><span class="ch">\"</span><span class="st">, line 6, in asimple_div</span><span class="ch">\n</span><span class="st">    return a/b</span><span class="ch">\n</span><span class="st">           ~^~</span><span class="ch">\n</span><span class="st">ZeroDivisionError: division by zero"</span></span>
<span id="cb310-11"><a href="#cb310-11" aria-hidden="true" tabindex="-1"></a><span class="fu">}</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
<p>Hereâ€™s exactly what I see from the two tool results:</p>
<ol type="1">
<li><p><strong>5/3</strong> â€” Returned successfully with the result: <strong>1.6666666666666667</strong></p></li>
<li><p><strong>3/0</strong> â€” Returned an error. Specifically, I see a Python traceback:</p>
<pre><code>Traceback (most recent call last):
  File "/Users/jhoward/aai-ws/toolslm/toolslm/funccall.py", line 265, in call_func_async
    try: res = await res
               ^^^^^^^^^
  File "/var/folders/51/b2_szf2945n072c0vj2cyty40000gn/T/ipykernel_23626/466431256.py", line 6, in asimple_div
    return a/b
           ~^~
ZeroDivisionError: division by zero</code></pre></li>
</ol>
<p><strong>Summary:</strong> - The first call succeeded and returned the expected floating-point division result. - The second call failed with a <strong>ZeroDivisionError</strong>, which is expected since division by zero is mathematically undefined. The error was not caught within the toolâ€™s implementation, so the raw Python traceback was returned as the tool result rather than a graceful error message.</p>
</div>
</div>
</div>
</section>
<section id="thinking-tool-call" class="level3">
<h3 class="anchored" data-anchor-id="thinking-tool-call">Thinking tool call</h3>
<div id="8d97da43" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb312"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb312-1"><a href="#cb312-1" aria-hidden="true" tabindex="-1"></a>chat <span class="op">=</span> AsyncChat(model)</span>
<span id="cb312-2"><a href="#cb312-2" aria-hidden="true" tabindex="-1"></a>res <span class="op">=</span> <span class="cf">await</span> chat(<span class="st">"Briefly, what's the most efficient way to sort a list of 1000 random integers?"</span>, think<span class="op">=</span><span class="st">'l'</span>,stream<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb312-3"><a href="#cb312-3" aria-hidden="true" tabindex="-1"></a>_ <span class="op">=</span> <span class="cf">await</span> adisplay_stream(res)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display cell-output-markdown">
<div class="prose">
<p>ðŸ§ </p>
<p>For a list of 1,000 random integers, the most efficient approach depends on whether you are coding it from scratch or using a tool:</p>
<ol type="1">
<li><p><strong>The Practical Winner: Built-in Library Functions</strong> In any modern language (Pythonâ€™s <code>.sort()</code>, C++â€™s <code>std::sort</code>, or Javaâ€™s <code>Arrays.sort</code>), use the built-in function. These typically use <strong>Timsort</strong> or <strong>Introsort</strong>, which are highly optimized, hybrid algorithms that outperform manual implementations.</p></li>
<li><p><strong>The Algorithmic Winner: QuickSort</strong> For general-purpose sorting of random data, <strong>QuickSort</strong> is usually the fastest <span class="math inline">\(O(n \log n)\)</span> algorithm due to low overhead and high cache efficiency.</p></li>
<li><p><strong>The â€œSpecial Caseâ€ Winner: Counting Sort</strong> If the integers are within a <strong>small, known range</strong> (e.g., all numbers are between 0 and 500), <strong>Counting Sort</strong> is the most efficient. It runs in <strong><span class="math inline">\(O(n)\)</span></strong> linear time, making it mathematically faster than QuickSort.</p></li>
</ol>
<p><strong>Summary:</strong> Unless the range of numbers is very small, use your programming languageâ€™s <strong>built-in sort function</strong>.</p>
</div>
</div>
</div>
</section>
<section id="multiple-tool-calls" class="level3">
<h3 class="anchored" data-anchor-id="multiple-tool-calls">Multiple tool calls</h3>
<div id="ba4a72c7" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb313"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb313-1"><a href="#cb313-1" aria-hidden="true" tabindex="-1"></a>chat.hist[<span class="dv">1</span>]</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display">
<pre><code>Message(content=None, role='assistant', tool_calls=[{'provider_specific_fields': {'thought_signature': 'EjQKMgG+Pvb7mgl82RAXabReCdDsveCKFVWHS3FgvrcIW0EkAXNk3UbMDgOqeC3cjHMoIf2T'}, 'function': {'arguments': '{"b": 5, "a": 10}', 'name': 'simple_add'}, 'id': 'call_dc36f7d1adcc4d3284329718d98e__thought__EjQKMgG+Pvb7mgl82RAXabReCdDsveCKFVWHS3FgvrcIW0EkAXNk3UbMDgOqeC3cjHMoIf2T', 'type': 'function'}, {'function': {'arguments': '{"a": 2, "b": 1}', 'name': 'simple_add'}, 'id': 'call_57b487270e304c88a1d6b8469aa8', 'type': 'function'}], function_call=None, provider_specific_fields={'thought_signatures': ['EjQKMgG+Pvb7mgl82RAXabReCdDsveCKFVWHS3FgvrcIW0EkAXNk3UbMDgOqeC3cjHMoIf2T']})</code></pre>
</div>
</div>
<div id="14ea0f40" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb315"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb315-1"><a href="#cb315-1" aria-hidden="true" tabindex="-1"></a>chat.hist[<span class="dv">2</span>]</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display">
<pre><code>{'tool_call_id': 'call_dc36f7d1adcc4d3284329718d98e__thought__EjQKMgG+Pvb7mgl82RAXabReCdDsveCKFVWHS3FgvrcIW0EkAXNk3UbMDgOqeC3cjHMoIf2T',
 'role': 'tool',
 'name': 'simple_add',
 'content': '15'}</code></pre>
</div>
</div>
<div id="5c81c0f8" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb317"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb317-1"><a href="#cb317-1" aria-hidden="true" tabindex="-1"></a>chat.hist[<span class="dv">3</span>]</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display">
<pre><code>{'tool_call_id': 'call_57b487270e304c88a1d6b8469aa8',
 'role': 'tool',
 'name': 'simple_add',
 'content': '3'}</code></pre>
</div>
</div>
<div id="456910e6" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb319"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb319-1"><a href="#cb319-1" aria-hidden="true" tabindex="-1"></a>chat.hist[<span class="dv">4</span>]</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display">
<pre><code>{'role': 'user',
 'content': "Please report that it's incomplete, and wrap-up for now and summarize how far we got."}</code></pre>
</div>
</div>
<p>Now to demonstrate that we can load back the formatted output back into a new <a href="https://lisette.answer.ai/core.html#chat"><code>Chat</code></a> object:</p>
<div id="55653287" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb321"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb321-1"><a href="#cb321-1" aria-hidden="true" tabindex="-1"></a>chat5 <span class="op">=</span> Chat(model,hist<span class="op">=</span>fmt2hist(fmt.outp),tools<span class="op">=</span>[simple_add, multiply, divide])</span>
<span id="cb321-2"><a href="#cb321-2" aria-hidden="true" tabindex="-1"></a>chat5(<span class="st">'what did we just do?'</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display cell-output-markdown">
<p>We just performed the first step of solving a mathematical expression by handling the operations inside the parentheses.</p>
<p>Specifically, I used the <code>simple_add</code> tool twice in parallel to solve the two addition problems within your expression:</p>
<ol type="1">
<li><strong>First Addition:</strong> I added <strong>10 + 5</strong> to get <strong>15</strong>.</li>
<li><strong>Second Addition:</strong> I added <strong>2 + 1</strong> to get <strong>3</strong>.</li>
</ol>
<p>By doing this, we simplified the original problem from <code>(10 + 5) * (2 + 1) / 3</code> down to <code>15 * 3 / 3</code>.</p>
<details>
<ul>
<li>id: <code>chatcmpl-xxx</code></li>
<li>model: <code>gemini-3-flash-preview</code></li>
<li>finish_reason: <code>stop</code></li>
<li>usage: <code>Usage(completion_tokens=130, prompt_tokens=396, total_tokens=526, completion_tokens_details=CompletionTokensDetailsWrapper(accepted_prediction_tokens=None, audio_tokens=None, reasoning_tokens=None, rejected_prediction_tokens=None, text_tokens=130, image_tokens=None), prompt_tokens_details=PromptTokensDetailsWrapper(audio_tokens=None, cached_tokens=None, text_tokens=396, image_tokens=None), cache_read_input_tokens=None)</code></li>
</ul>
</details>
</div>
</div>
</section>
<section id="search-2" class="level3">
<h3 class="anchored" data-anchor-id="search-2">Search</h3>
<div id="124da784" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb322"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb322-1"><a href="#cb322-1" aria-hidden="true" tabindex="-1"></a>chat_stream_tools <span class="op">=</span> AsyncChat(model, search<span class="op">=</span><span class="st">'l'</span>)</span>
<span id="cb322-2"><a href="#cb322-2" aria-hidden="true" tabindex="-1"></a>res <span class="op">=</span> <span class="cf">await</span> chat_stream_tools(<span class="st">"Search the weather in NYC"</span>, stream<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb322-3"><a href="#cb322-3" aria-hidden="true" tabindex="-1"></a>_<span class="op">=</span><span class="cf">await</span> adisplay_stream(res)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display cell-output-markdown">
<div class="prose">
<p>Today in New York City (Tuesday, February 24, 2026), the weather is transitioning after a major winter storm that impacted the region yesterday.</p>
<section id="current-conditions-forecast" class="level3">
<h3 class="anchored" data-anchor-id="current-conditions-forecast"><strong>Current Conditions &amp; Forecast</strong></h3>
<ul>
<li><strong>Daytime:</strong> Expect a mix of sun and clouds with a high near <strong>32Â°F to 37Â°F (0Â°C to 3Â°C)</strong>. It will remain breezy, with winds from the West-Northwest at 10 to 15 mph.</li>
<li><strong>Nighttime:</strong> Clouds will increase, and there is a <strong>35% to 70% chance of light snow</strong> developing late tonight. Lows will drop to around <strong>14Â°F to 27Â°F (-10Â°C to -3Â°C)</strong>. Snow accumulations are expected to be less than one inch.</li>
</ul>
</section>
<section id="recent-storm-impact" class="level3">
<h3 class="anchored" data-anchor-id="recent-storm-impact"><strong>Recent Storm Impact</strong></h3>
<p>The city is currently recovering from a significant blizzard that occurred on Monday, February 23. * <strong>Snowfall:</strong> The storm brought heavy snow (up to 24 inches in some parts of the region) and strong winds. * <strong>Travel:</strong> A state of emergency was issued yesterday, and while some restrictions have been lifted, officials still advise caution due to lingering icy conditions and ongoing cleanup efforts.</p>
</section>
<section id="looking-ahead" class="level3">
<h3 class="anchored" data-anchor-id="looking-ahead"><strong>Looking Ahead</strong></h3>
<ul>
<li><strong>Wednesday, Feb 25:</strong> A mix of rain and snow is possible during the day, with temperatures warming slightly to a high of <strong>41Â°F (5Â°C)</strong>.</li>
<li><strong>Thursday, Feb 26:</strong> More snow showers are expected, with highs remaining in the mid-30s.</li>
</ul>
</section>
</div>
</div>
</div>
<p>Letâ€™s mock <code>pause_turn</code> with async completion and streaming:</p>
<div id="318a4ddf" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb323"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb323-1"><a href="#cb323-1" aria-hidden="true" tabindex="-1"></a><span class="co"># async def mk_pause_web_search_stream():</span></span>
<span id="cb323-2"><a href="#cb323-2" aria-hidden="true" tabindex="-1"></a><span class="co">#     """Async generator that mimics a streaming pause_turn response"""</span></span>
<span id="cb323-3"><a href="#cb323-3" aria-hidden="true" tabindex="-1"></a><span class="co">#     srv_tc = mk_tc("web_search", json.dumps({"query": "Solveit Answer.AI"}), </span></span>
<span id="cb323-4"><a href="#cb323-4" aria-hidden="true" tabindex="-1"></a><span class="co">#                    tcid=random_tool_id().replace('toolu_', 'srvtoolu_'))</span></span>
<span id="cb323-5"><a href="#cb323-5" aria-hidden="true" tabindex="-1"></a><span class="co">#     yield mk_stream_chunk(content="Let me search for that information:", role='assistant')</span></span>
<span id="cb323-6"><a href="#cb323-6" aria-hidden="true" tabindex="-1"></a><span class="co">#     yield mk_stream_chunk(tool_calls=[srv_tc])</span></span>
<span id="cb323-7"><a href="#cb323-7" aria-hidden="true" tabindex="-1"></a><span class="co">#     yield mk_stream_chunk(finish_reason="pause_turn")</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<div id="8eb849da" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb324"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb324-1"><a href="#cb324-1" aria-hidden="true" tabindex="-1"></a><span class="co"># orig_acompletion = acompletion</span></span>
<span id="cb324-2"><a href="#cb324-2" aria-hidden="true" tabindex="-1"></a><span class="co"># </span></span>
<span id="cb324-3"><a href="#cb324-3" aria-hidden="true" tabindex="-1"></a><span class="co"># call_count = 0</span></span>
<span id="cb324-4"><a href="#cb324-4" aria-hidden="true" tabindex="-1"></a><span class="co"># async def patched_acompletion(*args, **kwargs):</span></span>
<span id="cb324-5"><a href="#cb324-5" aria-hidden="true" tabindex="-1"></a><span class="co">#     global call_count</span></span>
<span id="cb324-6"><a href="#cb324-6" aria-hidden="true" tabindex="-1"></a><span class="co">#     call_count += 1</span></span>
<span id="cb324-7"><a href="#cb324-7" aria-hidden="true" tabindex="-1"></a><span class="co">#     print(f"Mock Async Call {call_count}")</span></span>
<span id="cb324-8"><a href="#cb324-8" aria-hidden="true" tabindex="-1"></a><span class="co">#     await asyncio.sleep(1)</span></span>
<span id="cb324-9"><a href="#cb324-9" aria-hidden="true" tabindex="-1"></a><span class="co">#     if call_count &lt; 3: return mk_pause_web_search_stream()</span></span>
<span id="cb324-10"><a href="#cb324-10" aria-hidden="true" tabindex="-1"></a><span class="co">#     return await orig_acompletion(*args, **kwargs)</span></span>
<span id="cb324-11"><a href="#cb324-11" aria-hidden="true" tabindex="-1"></a><span class="co"># </span></span>
<span id="cb324-12"><a href="#cb324-12" aria-hidden="true" tabindex="-1"></a><span class="co"># acompletion = patched_acompletion</span></span>
<span id="cb324-13"><a href="#cb324-13" aria-hidden="true" tabindex="-1"></a><span class="co"># achat_pause = AsyncChat('claude-sonnet-4-5', search='l')</span></span>
<span id="cb324-14"><a href="#cb324-14" aria-hidden="true" tabindex="-1"></a><span class="co"># </span></span>
<span id="cb324-15"><a href="#cb324-15" aria-hidden="true" tabindex="-1"></a><span class="co"># call_count = 0</span></span>
<span id="cb324-16"><a href="#cb324-16" aria-hidden="true" tabindex="-1"></a><span class="co"># res = await achat_pause("Search and tell me about Solveit", stream=True)</span></span>
<span id="cb324-17"><a href="#cb324-17" aria-hidden="true" tabindex="-1"></a><span class="co"># fmt = await adisplay_stream(res)</span></span>
<span id="cb324-18"><a href="#cb324-18" aria-hidden="true" tabindex="-1"></a><span class="co"># print(f"\nTotal calls: {call_count}")</span></span>
<span id="cb324-19"><a href="#cb324-19" aria-hidden="true" tabindex="-1"></a><span class="co"># </span></span>
<span id="cb324-20"><a href="#cb324-20" aria-hidden="true" tabindex="-1"></a><span class="co"># acompletion = orig_acompletion</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
</section>
<section id="tool-call-referencing-1" class="level3">
<h3 class="anchored" data-anchor-id="tool-call-referencing-1">Tool Call Referencing</h3>
<div id="2e88c6e6" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb325"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb325-1"><a href="#cb325-1" aria-hidden="true" tabindex="-1"></a>achat <span class="op">=</span> AsyncChat(<span class="st">'claude-sonnet-4-5'</span>, tools<span class="op">=</span>[get_person, greet_person], tc_refs<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb325-2"><a href="#cb325-2" aria-hidden="true" tabindex="-1"></a><span class="cf">await</span> achat(<span class="st">"First call get_person, then pass the result to greet_person"</span>, max_steps<span class="op">=</span><span class="dv">3</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display cell-output-markdown">
<p>Perfect! I successfully completed both steps:</p>
<ol type="1">
<li><p><strong>Retrieved person data</strong>: I called <code>get_person</code> which returned information about Alice, who is 30 years old.</p></li>
<li><p><strong>Greeted the person</strong>: I then passed Aliceâ€™s data to <code>greet_person</code>, which generated the greeting: â€œHello Alice, you are 30 years old!â€</p></li>
</ol>
<p>The task has been completed successfully. The personâ€™s data was retrieved and used to create a personalized greeting.</p>
<details>
<ul>
<li>id: <code>chatcmpl-xxx</code></li>
<li>model: <code>claude-sonnet-4-5-20250929</code></li>
<li>finish_reason: <code>stop</code></li>
<li>usage: <code>Usage(completion_tokens=103, prompt_tokens=1081, total_tokens=1184, completion_tokens_details=CompletionTokensDetailsWrapper(accepted_prediction_tokens=None, audio_tokens=None, reasoning_tokens=0, rejected_prediction_tokens=None, text_tokens=103, image_tokens=None), prompt_tokens_details=PromptTokensDetailsWrapper(audio_tokens=None, cached_tokens=0, text_tokens=None, image_tokens=None, cache_creation_tokens=0, cache_creation_token_details=CacheCreationTokenDetails(ephemeral_5m_input_tokens=0, ephemeral_1h_input_tokens=0)), cache_creation_input_tokens=0, cache_read_input_tokens=0, inference_geo='not_available', speed=None)</code></li>
</ul>
</details>
</div>
</div>
<div id="ba39edd3" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb326"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb326-1"><a href="#cb326-1" aria-hidden="true" tabindex="-1"></a>achat.tc_res</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display">
<pre><code>{'toolu_01RbzkhhezbZ4Ktd133xqJTc': {'name': 'Alice', 'age': 30},
 'toolu_01WtKJw8rQ4KfAGR4hX3so9j': 'Hello Alice, you are 30 years old!'}</code></pre>
</div>
</div>
<div id="ecfd8af3" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb328"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb328-1"><a href="#cb328-1" aria-hidden="true" tabindex="-1"></a><span class="bu">list</span>(L(achat.hist).attrgot(<span class="st">'tool_calls'</span>).<span class="bu">filter</span>())</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display">
<pre><code>[[ChatCompletionMessageToolCall(index=1, caller={'type': 'direct'}, function=Function(arguments='{}', name='get_person'), id='toolu_01RbzkhhezbZ4Ktd133xqJTc', type='function')],
 [ChatCompletionMessageToolCall(index=1, caller={'type': 'direct'}, function=Function(arguments='{"person": "$`toolu_01RbzkhhezbZ4Ktd133xqJTc`"}', name='greet_person'), id='toolu_01WtKJw8rQ4KfAGR4hX3so9j', type='function')]]</code></pre>
</div>
</div>


</section>
</section>
</section>

</main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
  window.document.addEventListener("DOMContentLoaded", function (event) {
    const icon = "î§‹";
    const anchorJS = new window.AnchorJS();
    anchorJS.options = {
      placement: 'right',
      icon: icon
    };
    anchorJS.add('.anchored');
    const isCodeAnnotation = (el) => {
      for (const clz of el.classList) {
        if (clz.startsWith('code-annotation-')) {                     
          return true;
        }
      }
      return false;
    }
    const onCopySuccess = function(e) {
      // button target
      const button = e.trigger;
      // don't keep focus
      button.blur();
      // flash "checked"
      button.classList.add('code-copy-button-checked');
      var currentTitle = button.getAttribute("title");
      button.setAttribute("title", "Copied!");
      let tooltip;
      if (window.bootstrap) {
        button.setAttribute("data-bs-toggle", "tooltip");
        button.setAttribute("data-bs-placement", "left");
        button.setAttribute("data-bs-title", "Copied!");
        tooltip = new bootstrap.Tooltip(button, 
          { trigger: "manual", 
            customClass: "code-copy-button-tooltip",
            offset: [0, -8]});
        tooltip.show();    
      }
      setTimeout(function() {
        if (tooltip) {
          tooltip.hide();
          button.removeAttribute("data-bs-title");
          button.removeAttribute("data-bs-toggle");
          button.removeAttribute("data-bs-placement");
        }
        button.setAttribute("title", currentTitle);
        button.classList.remove('code-copy-button-checked');
      }, 1000);
      // clear code selection
      e.clearSelection();
    }
    const getTextToCopy = function(trigger) {
      const outerScaffold = trigger.parentElement.cloneNode(true);
      const codeEl = outerScaffold.querySelector('code');
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
    }
    const clipboard = new window.ClipboardJS('.code-copy-button:not([data-in-quarto-modal])', {
      text: getTextToCopy
    });
    clipboard.on('success', onCopySuccess);
    if (window.document.getElementById('quarto-embedded-source-code-modal')) {
      const clipboardModal = new window.ClipboardJS('.code-copy-button[data-in-quarto-modal]', {
        text: getTextToCopy,
        container: window.document.getElementById('quarto-embedded-source-code-modal')
      });
      clipboardModal.on('success', onCopySuccess);
    }
      var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
      var mailtoRegex = new RegExp(/^mailto:/);
        var filterRegex = new RegExp("https:\/\/lisette\.answer\.ai\/");
      var isInternal = (href) => {
          return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
      }
      // Inspect non-navigation links and adorn them if external
     var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool):not(.about-link)');
      for (var i=0; i<links.length; i++) {
        const link = links[i];
        if (!isInternal(link.href)) {
          // undo the damage that might have been done by quarto-nav.js in the case of
          // links that we want to consider external
          if (link.dataset.originalHref !== undefined) {
            link.href = link.dataset.originalHref;
          }
        }
      }
    function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
      const config = {
        allowHTML: true,
        maxWidth: 500,
        delay: 100,
        arrow: false,
        appendTo: function(el) {
            return el.parentElement;
        },
        interactive: true,
        interactiveBorder: 10,
        theme: 'quarto',
        placement: 'bottom-start',
      };
      if (contentFn) {
        config.content = contentFn;
      }
      if (onTriggerFn) {
        config.onTrigger = onTriggerFn;
      }
      if (onUntriggerFn) {
        config.onUntrigger = onUntriggerFn;
      }
      window.tippy(el, config); 
    }
    const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
    for (var i=0; i<noterefs.length; i++) {
      const ref = noterefs[i];
      tippyHover(ref, function() {
        // use id or data attribute instead here
        let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
        try { href = new URL(href).hash; } catch {}
        const id = href.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note) {
          return note.innerHTML;
        } else {
          return "";
        }
      });
    }
    const xrefs = window.document.querySelectorAll('a.quarto-xref');
    const processXRef = (id, note) => {
      // Strip column container classes
      const stripColumnClz = (el) => {
        el.classList.remove("page-full", "page-columns");
        if (el.children) {
          for (const child of el.children) {
            stripColumnClz(child);
          }
        }
      }
      stripColumnClz(note)
      if (id === null || id.startsWith('sec-')) {
        // Special case sections, only their first couple elements
        const container = document.createElement("div");
        if (note.children && note.children.length > 2) {
          container.appendChild(note.children[0].cloneNode(true));
          for (let i = 1; i < note.children.length; i++) {
            const child = note.children[i];
            if (child.tagName === "P" && child.innerText === "") {
              continue;
            } else {
              container.appendChild(child.cloneNode(true));
              break;
            }
          }
          if (window.Quarto?.typesetMath) {
            window.Quarto.typesetMath(container);
          }
          return container.innerHTML
        } else {
          if (window.Quarto?.typesetMath) {
            window.Quarto.typesetMath(note);
          }
          return note.innerHTML;
        }
      } else {
        // Remove any anchor links if they are present
        const anchorLink = note.querySelector('a.anchorjs-link');
        if (anchorLink) {
          anchorLink.remove();
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        if (note.classList.contains("callout")) {
          return note.outerHTML;
        } else {
          return note.innerHTML;
        }
      }
    }
    for (var i=0; i<xrefs.length; i++) {
      const xref = xrefs[i];
      tippyHover(xref, undefined, function(instance) {
        instance.disable();
        let url = xref.getAttribute('href');
        let hash = undefined; 
        if (url.startsWith('#')) {
          hash = url;
        } else {
          try { hash = new URL(url).hash; } catch {}
        }
        if (hash) {
          const id = hash.replace(/^#\/?/, "");
          const note = window.document.getElementById(id);
          if (note !== null) {
            try {
              const html = processXRef(id, note.cloneNode(true));
              instance.setContent(html);
            } finally {
              instance.enable();
              instance.show();
            }
          } else {
            // See if we can fetch this
            fetch(url.split('#')[0])
            .then(res => res.text())
            .then(html => {
              const parser = new DOMParser();
              const htmlDoc = parser.parseFromString(html, "text/html");
              const note = htmlDoc.getElementById(id);
              if (note !== null) {
                const html = processXRef(id, note);
                instance.setContent(html);
              } 
            }).finally(() => {
              instance.enable();
              instance.show();
            });
          }
        } else {
          // See if we can fetch a full url (with no hash to target)
          // This is a special case and we should probably do some content thinning / targeting
          fetch(url)
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.querySelector('main.content');
            if (note !== null) {
              // This should only happen for chapter cross references
              // (since there is no id in the URL)
              // remove the first header
              if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
                note.children[0].remove();
              }
              const html = processXRef(null, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      }, function(instance) {
      });
    }
        let selectedAnnoteEl;
        const selectorForAnnotation = ( cell, annotation) => {
          let cellAttr = 'data-code-cell="' + cell + '"';
          let lineAttr = 'data-code-annotation="' +  annotation + '"';
          const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
          return selector;
        }
        const selectCodeLines = (annoteEl) => {
          const doc = window.document;
          const targetCell = annoteEl.getAttribute("data-target-cell");
          const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
          const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
          const lines = annoteSpan.getAttribute("data-code-lines").split(",");
          const lineIds = lines.map((line) => {
            return targetCell + "-" + line;
          })
          let top = null;
          let height = null;
          let parent = null;
          if (lineIds.length > 0) {
              //compute the position of the single el (top and bottom and make a div)
              const el = window.document.getElementById(lineIds[0]);
              top = el.offsetTop;
              height = el.offsetHeight;
              parent = el.parentElement.parentElement;
            if (lineIds.length > 1) {
              const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
              const bottom = lastEl.offsetTop + lastEl.offsetHeight;
              height = bottom - top;
            }
            if (top !== null && height !== null && parent !== null) {
              // cook up a div (if necessary) and position it 
              let div = window.document.getElementById("code-annotation-line-highlight");
              if (div === null) {
                div = window.document.createElement("div");
                div.setAttribute("id", "code-annotation-line-highlight");
                div.style.position = 'absolute';
                parent.appendChild(div);
              }
              div.style.top = top - 2 + "px";
              div.style.height = height + 4 + "px";
              div.style.left = 0;
              let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
              if (gutterDiv === null) {
                gutterDiv = window.document.createElement("div");
                gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
                gutterDiv.style.position = 'absolute';
                const codeCell = window.document.getElementById(targetCell);
                const gutter = codeCell.querySelector('.code-annotation-gutter');
                gutter.appendChild(gutterDiv);
              }
              gutterDiv.style.top = top - 2 + "px";
              gutterDiv.style.height = height + 4 + "px";
            }
            selectedAnnoteEl = annoteEl;
          }
        };
        const unselectCodeLines = () => {
          const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
          elementsIds.forEach((elId) => {
            const div = window.document.getElementById(elId);
            if (div) {
              div.remove();
            }
          });
          selectedAnnoteEl = undefined;
        };
          // Handle positioning of the toggle
      window.addEventListener(
        "resize",
        throttle(() => {
          elRect = undefined;
          if (selectedAnnoteEl) {
            selectCodeLines(selectedAnnoteEl);
          }
        }, 10)
      );
      function throttle(fn, ms) {
      let throttle = false;
      let timer;
        return (...args) => {
          if(!throttle) { // first call gets through
              fn.apply(this, args);
              throttle = true;
          } else { // all the others get throttled
              if(timer) clearTimeout(timer); // cancel #2
              timer = setTimeout(() => {
                fn.apply(this, args);
                timer = throttle = false;
              }, ms);
          }
        };
      }
        // Attach click handler to the DT
        const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
        for (const annoteDlNode of annoteDls) {
          annoteDlNode.addEventListener('click', (event) => {
            const clickedEl = event.target;
            if (clickedEl !== selectedAnnoteEl) {
              unselectCodeLines();
              const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
              if (activeEl) {
                activeEl.classList.remove('code-annotation-active');
              }
              selectCodeLines(clickedEl);
              clickedEl.classList.add('code-annotation-active');
            } else {
              // Unselect the line
              unselectCodeLines();
              clickedEl.classList.remove('code-annotation-active');
            }
          });
        }
    const findCites = (el) => {
      const parentEl = el.parentElement;
      if (parentEl) {
        const cites = parentEl.dataset.cites;
        if (cites) {
          return {
            el,
            cites: cites.split(' ')
          };
        } else {
          return findCites(el.parentElement)
        }
      } else {
        return undefined;
      }
    };
    var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
    for (var i=0; i<bibliorefs.length; i++) {
      const ref = bibliorefs[i];
      const citeInfo = findCites(ref);
      if (citeInfo) {
        tippyHover(citeInfo.el, function() {
          var popup = window.document.createElement('div');
          citeInfo.cites.forEach(function(cite) {
            var citeDiv = window.document.createElement('div');
            citeDiv.classList.add('hanging-indent');
            citeDiv.classList.add('csl-entry');
            var biblioDiv = window.document.getElementById('ref-' + cite);
            if (biblioDiv) {
              citeDiv.innerHTML = biblioDiv.innerHTML;
            }
            popup.appendChild(citeDiv);
          });
          return popup.innerHTML;
        });
      }
    }
  });
  </script>
</div> <!-- /content -->




<footer class="footer"><div class="nav-footer"><div class="nav-footer-center"><div class="toc-actions d-sm-block d-md-none"><ul><li><a href="https://github.com/AnswerDotAI/lisette/issues/new" class="toc-action"><i class="bi bi-github"></i>Report an issue</a></li></ul></div></div></div></footer></body></html>