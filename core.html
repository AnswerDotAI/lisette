<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.8.25">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">

<meta name="description" content="Lisette Core">

<title>Core – lisette</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
html { -webkit-text-size-adjust: 100%; }
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>


<script src="site_libs/quarto-nav/quarto-nav.js"></script>
<script src="site_libs/quarto-nav/headroom.min.js"></script>
<script src="site_libs/clipboard/clipboard.min.js"></script>
<script src="site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="site_libs/quarto-search/fuse.min.js"></script>
<script src="site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="./">
<script src="site_libs/quarto-html/quarto.js" type="module"></script>
<script src="site_libs/quarto-html/tabsets/tabsets.js" type="module"></script>
<script src="site_libs/quarto-html/axe/axe-check.js" type="module"></script>
<script src="site_libs/quarto-html/popper.min.js"></script>
<script src="site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="site_libs/quarto-html/anchor.min.js"></script>
<link href="site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="site_libs/quarto-html/quarto-syntax-highlighting-7b89279ff1a6dce999919e0e67d4d9ec.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="site_libs/bootstrap/bootstrap.min.js"></script>
<link href="site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="site_libs/bootstrap/bootstrap-000f0825b9c55ed21d14970d810c14a9.min.css" rel="stylesheet" append-hash="true" id="quarto-bootstrap" data-mode="light">
<script id="quarto-search-options" type="application/json">{
  "location": "navbar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "end",
  "type": "overlay",
  "limit": 50,
  "keyboard-shortcut": [
    "f",
    "/",
    "s"
  ],
  "show-item-context": false,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-text-placeholder": "",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script>


<link rel="stylesheet" href="styles.css">
<meta property="og:title" content="Core – lisette">
<meta property="og:description" content="Lisette Core">
<meta property="og:image" content="https://lisette.answer.ai/00_core_files/figure-html/cell-14-output-1.jpeg">
<meta property="og:site_name" content="lisette">
<meta name="twitter:title" content="Core – lisette">
<meta name="twitter:description" content="Lisette Core">
<meta name="twitter:image" content="https://lisette.answer.ai/00_core_files/figure-html/cell-14-output-1.jpeg">
<meta name="twitter:card" content="summary_large_image">
</head>

<body class="nav-sidebar floating nav-fixed quarto-light">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
    <nav class="navbar navbar-expand-lg " data-bs-theme="dark">
      <div class="navbar-container container-fluid">
      <div class="navbar-brand-container mx-auto">
    <a href="./index.html" class="navbar-brand navbar-brand-logo">
    </a>
    <a class="navbar-brand" href="./index.html">
    <span class="navbar-title">lisette</span>
    </a>
  </div>
        <div class="quarto-navbar-tools tools-end">
</div>
          <div id="quarto-search" class="" title="Search"></div>
      </div> <!-- /container-fluid -->
    </nav>
  <nav class="quarto-secondary-nav">
    <div class="container-fluid d-flex">
      <button type="button" class="quarto-btn-toggle btn" data-bs-toggle="collapse" role="button" data-bs-target=".quarto-sidebar-collapse-item" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
        <i class="bi bi-layout-text-sidebar-reverse"></i>
      </button>
        <nav class="quarto-page-breadcrumbs" aria-label="breadcrumb"><ol class="breadcrumb"><li class="breadcrumb-item"><a href="./core.html">Core</a></li></ol></nav>
        <a class="flex-grow-1" role="navigation" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">      
        </a>
    </div>
  </nav>
</header>
<!-- content -->
<div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article page-navbar">
<!-- sidebar -->
  <nav id="quarto-sidebar" class="sidebar collapse collapse-horizontal quarto-sidebar-collapse-item sidebar-navigation floating overflow-auto">
    <div class="pt-lg-2 mt-2 text-left sidebar-header">
      <a href="./index.html" class="sidebar-logo-link">
      </a>
      </div>
    <div class="sidebar-menu-container"> 
    <ul class="list-unstyled mt-1">
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./index.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Lisette</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./core.html" class="sidebar-item-text sidebar-link active">
 <span class="menu-text">Core</span></a>
  </div>
</li>
    </ul>
    </div>
</nav>
<div id="quarto-sidebar-glass" class="quarto-sidebar-collapse-item" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item"></div>
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">On this page</h2>
   
  <ul>
  <li><a href="#litellm" id="toc-litellm" class="nav-link active" data-scroll-target="#litellm">LiteLLM</a>
  <ul class="collapse">
  <li><a href="#deterministic-outputs" id="toc-deterministic-outputs" class="nav-link" data-scroll-target="#deterministic-outputs">Deterministic outputs</a>
  <ul class="collapse">
  <li><a href="#patch_litellm" id="toc-patch_litellm" class="nav-link" data-scroll-target="#patch_litellm">patch_litellm</a></li>
  </ul></li>
  <li><a href="#completion" id="toc-completion" class="nav-link" data-scroll-target="#completion">Completion</a></li>
  <li><a href="#messages-formatting" id="toc-messages-formatting" class="nav-link" data-scroll-target="#messages-formatting">Messages formatting</a>
  <ul class="collapse">
  <li><a href="#remove_cache_ckpts" id="toc-remove_cache_ckpts" class="nav-link" data-scroll-target="#remove_cache_ckpts">remove_cache_ckpts</a></li>
  <li><a href="#mk_msg" id="toc-mk_msg" class="nav-link" data-scroll-target="#mk_msg">mk_msg</a></li>
  <li><a href="#caching" id="toc-caching" class="nav-link" data-scroll-target="#caching">Caching</a></li>
  <li><a href="#reconstructing-formatted-outputs" id="toc-reconstructing-formatted-outputs" class="nav-link" data-scroll-target="#reconstructing-formatted-outputs">Reconstructing formatted outputs</a></li>
  <li><a href="#fmt2hist" id="toc-fmt2hist" class="nav-link" data-scroll-target="#fmt2hist">fmt2hist</a></li>
  <li><a href="#mk_msgs" id="toc-mk_msgs" class="nav-link" data-scroll-target="#mk_msgs"><code>mk_msgs</code></a></li>
  <li><a href="#mk_msgs-1" id="toc-mk_msgs-1" class="nav-link" data-scroll-target="#mk_msgs-1">mk_msgs</a></li>
  </ul></li>
  <li><a href="#streaming" id="toc-streaming" class="nav-link" data-scroll-target="#streaming">Streaming</a>
  <ul class="collapse">
  <li><a href="#stream_with_complete" id="toc-stream_with_complete" class="nav-link" data-scroll-target="#stream_with_complete">stream_with_complete</a></li>
  </ul></li>
  <li><a href="#tools" id="toc-tools" class="nav-link" data-scroll-target="#tools">Tools</a>
  <ul class="collapse">
  <li><a href="#lite_mk_func" id="toc-lite_mk_func" class="nav-link" data-scroll-target="#lite_mk_func">lite_mk_func</a></li>
  </ul></li>
  <li><a href="#search" id="toc-search" class="nav-link" data-scroll-target="#search">Search</a></li>
  <li><a href="#citations" id="toc-citations" class="nav-link" data-scroll-target="#citations">Citations</a>
  <ul class="collapse">
  <li><a href="#cite_footnotes" id="toc-cite_footnotes" class="nav-link" data-scroll-target="#cite_footnotes">cite_footnotes</a></li>
  <li><a href="#cite_footnote" id="toc-cite_footnote" class="nav-link" data-scroll-target="#cite_footnote">cite_footnote</a></li>
  </ul></li>
  </ul></li>
  <li><a href="#chat" id="toc-chat" class="nav-link" data-scroll-target="#chat">Chat</a>
  <ul class="collapse">
  <li><a href="#chat-1" id="toc-chat-1" class="nav-link" data-scroll-target="#chat-1">Chat</a></li>
  <li><a href="#examples" id="toc-examples" class="nav-link" data-scroll-target="#examples">Examples</a>
  <ul class="collapse">
  <li><a href="#history-tracking" id="toc-history-tracking" class="nav-link" data-scroll-target="#history-tracking">History tracking</a></li>
  <li><a href="#synthetic-history-creation" id="toc-synthetic-history-creation" class="nav-link" data-scroll-target="#synthetic-history-creation">Synthetic History Creation</a></li>
  <li><a href="#chat.print_hist" id="toc-chat.print_hist" class="nav-link" data-scroll-target="#chat.print_hist">Chat.print_hist</a></li>
  <li><a href="#random_tool_id" id="toc-random_tool_id" class="nav-link" data-scroll-target="#random_tool_id">random_tool_id</a></li>
  <li><a href="#mk_tc" id="toc-mk_tc" class="nav-link" data-scroll-target="#mk_tc">mk_tc</a></li>
  <li><a href="#mk_tc_req" id="toc-mk_tc_req" class="nav-link" data-scroll-target="#mk_tc_req">mk_tc_req</a></li>
  <li><a href="#mk_tc_result" id="toc-mk_tc_result" class="nav-link" data-scroll-target="#mk_tc_result">mk_tc_result</a></li>
  <li><a href="#mk_tc_results" id="toc-mk_tc_results" class="nav-link" data-scroll-target="#mk_tc_results">mk_tc_results</a></li>
  <li><a href="#images" id="toc-images" class="nav-link" data-scroll-target="#images">Images</a></li>
  <li><a href="#prefill" id="toc-prefill" class="nav-link" data-scroll-target="#prefill">Prefill</a></li>
  <li><a href="#streaming-1" id="toc-streaming-1" class="nav-link" data-scroll-target="#streaming-1">Streaming</a></li>
  <li><a href="#tool-use" id="toc-tool-use" class="nav-link" data-scroll-target="#tool-use">Tool use</a></li>
  <li><a href="#thinking-w-tool-use" id="toc-thinking-w-tool-use" class="nav-link" data-scroll-target="#thinking-w-tool-use">Thinking w tool use</a></li>
  <li><a href="#search-1" id="toc-search-1" class="nav-link" data-scroll-target="#search-1">Search</a></li>
  <li><a href="#multi-tool-calling" id="toc-multi-tool-calling" class="nav-link" data-scroll-target="#multi-tool-calling">Multi tool calling</a></li>
  <li><a href="#tool-call-exhaustion" id="toc-tool-call-exhaustion" class="nav-link" data-scroll-target="#tool-call-exhaustion">Tool call exhaustion</a></li>
  </ul></li>
  <li><a href="#async" id="toc-async" class="nav-link" data-scroll-target="#async">Async</a>
  <ul class="collapse">
  <li><a href="#asyncchat" id="toc-asyncchat" class="nav-link" data-scroll-target="#asyncchat">AsyncChat</a></li>
  <li><a href="#astream_with_complete" id="toc-astream_with_complete" class="nav-link" data-scroll-target="#astream_with_complete">astream_with_complete</a></li>
  <li><a href="#asyncchat-1" id="toc-asyncchat-1" class="nav-link" data-scroll-target="#asyncchat-1">AsyncChat</a></li>
  <li><a href="#examples-1" id="toc-examples-1" class="nav-link" data-scroll-target="#examples-1">Examples</a></li>
  </ul></li>
  <li><a href="#async-streaming-display" id="toc-async-streaming-display" class="nav-link" data-scroll-target="#async-streaming-display">Async Streaming Display</a>
  <ul class="collapse">
  <li><a href="#mk_tr_details" id="toc-mk_tr_details" class="nav-link" data-scroll-target="#mk_tr_details">mk_tr_details</a></li>
  <li><a href="#asyncstreamformatter" id="toc-asyncstreamformatter" class="nav-link" data-scroll-target="#asyncstreamformatter">AsyncStreamFormatter</a></li>
  <li><a href="#adisplay_stream" id="toc-adisplay_stream" class="nav-link" data-scroll-target="#adisplay_stream">adisplay_stream</a></li>
  </ul></li>
  <li><a href="#streaming-examples" id="toc-streaming-examples" class="nav-link" data-scroll-target="#streaming-examples">Streaming examples</a>
  <ul class="collapse">
  <li><a href="#tool-call" id="toc-tool-call" class="nav-link" data-scroll-target="#tool-call">Tool call</a></li>
  <li><a href="#thinking-tool-call" id="toc-thinking-tool-call" class="nav-link" data-scroll-target="#thinking-tool-call">Thinking tool call</a></li>
  <li><a href="#multiple-tool-calls" id="toc-multiple-tool-calls" class="nav-link" data-scroll-target="#multiple-tool-calls">Multiple tool calls</a></li>
  <li><a href="#search-2" id="toc-search-2" class="nav-link" data-scroll-target="#search-2">Search</a></li>
  <li><a href="#caching-1" id="toc-caching-1" class="nav-link" data-scroll-target="#caching-1">Caching</a></li>
  </ul></li>
  </ul></li>
  </ul>
<div class="toc-actions"><ul><li><a href="https://github.com/AnswerDotAI/lisette/issues/new" class="toc-action"><i class="bi bi-github"></i>Report an issue</a></li></ul></div><div class="quarto-alternate-formats"><h2>Other Formats</h2><ul><li><a href="core.html.md"><i class="bi bi-file-code"></i>CommonMark</a></li></ul></div></nav>
    </div>
<!-- main -->
<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<h1 class="title">Core</h1>
</div>

<div>
  <div class="description">
    Lisette Core
  </div>
</div>


<div class="quarto-title-meta">

    
  
    
  </div>
  


</header>


<!-- WARNING: THIS FILE WAS AUTOGENERATED! DO NOT EDIT! -->
<section id="litellm" class="level1">
<h1>LiteLLM</h1>
<section id="deterministic-outputs" class="level2">
<h2 class="anchored" data-anchor-id="deterministic-outputs">Deterministic outputs</h2>
<p>LiteLLM <code>ModelResponse(Stream)</code> objects have <code>id</code> and <code>created_at</code> fields that are generated dynamically. Even when we use <a href="https://github.com/answerdotai/cachy"><code>cachy</code></a> to cache the LLM response these dynamic fields create diffs which makes code review more challenging. The patches below ensure that <code>id</code> and <code>created_at</code> fields are fixed and won’t generate diffs.</p>
<hr>
<p><a href="https://github.com/AnswerDotAI/lisette/blob/main/lisette/core.py#L23" target="_blank" style="float:right; font-size:smaller">source</a></p>
<section id="patch_litellm" class="level3">
<h3 class="anchored" data-anchor-id="patch_litellm">patch_litellm</h3>
<blockquote class="blockquote">
<pre><code> patch_litellm (seed=0)</code></pre>
</blockquote>
<p><em>Patch litellm.ModelResponseBase such that <code>id</code> and <code>created</code> are fixed.</em></p>
<div id="d8e05085" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb2"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a>patch_litellm()</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
</section>
</section>
<section id="completion" class="level2">
<h2 class="anchored" data-anchor-id="completion">Completion</h2>
<p>LiteLLM provides an convenient unified interface for most big LLM providers. Because it’s so useful to be able to switch LLM providers with just one argument. We want to make it even easier to by adding some more convenience functions and classes.</p>
<p>This is very similar to our other wrapper libraries for popular AI providers: <a href="https://claudette.answer.ai/">claudette</a> (Anthropic), <a href="https://github.com/AnswerDotAI/gaspard">gaspard</a> (Gemini), <a href="https://answerdotai.github.io/cosette/">cosette</a> (OpenAI).</p>
<div id="2bf2d2dd" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb3"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a><span class="co"># litellm._turn_on_debug()</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<div id="25a6f62b" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb4"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a>ms <span class="op">=</span> [<span class="st">"gemini/gemini-2.5-flash"</span>, <span class="st">"claude-sonnet-4-5"</span>, <span class="st">"openai/gpt-4.1"</span>]</span>
<span id="cb4-2"><a href="#cb4-2" aria-hidden="true" tabindex="-1"></a>msg <span class="op">=</span> [{<span class="st">'role'</span>:<span class="st">'user'</span>,<span class="st">'content'</span>:<span class="st">'Hey there!'</span>, <span class="st">'cache_control'</span>: {<span class="st">'type'</span>: <span class="st">'ephemeral'</span>}}]</span>
<span id="cb4-3"><a href="#cb4-3" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> m <span class="kw">in</span> ms:</span>
<span id="cb4-4"><a href="#cb4-4" aria-hidden="true" tabindex="-1"></a>    display(Markdown(<span class="ss">f'**</span><span class="sc">{</span>m<span class="sc">}</span><span class="ss">:**'</span>))</span>
<span id="cb4-5"><a href="#cb4-5" aria-hidden="true" tabindex="-1"></a>    display(completion(m,msg))</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display cell-output-markdown">
<p><strong>gemini/gemini-2.5-flash:</strong></p>
</div>
<div class="cell-output cell-output-display cell-output-markdown">
<p>Hey there! How can I help you today?</p>
<details>
<ul>
<li>id: <code>chatcmpl-xxx</code></li>
<li>model: <code>gemini-2.5-flash</code></li>
<li>finish_reason: <code>stop</code></li>
<li>usage: <code>Usage(completion_tokens=153, prompt_tokens=4, total_tokens=157, completion_tokens_details=CompletionTokensDetailsWrapper(accepted_prediction_tokens=None, audio_tokens=None, reasoning_tokens=143, rejected_prediction_tokens=None, text_tokens=10), prompt_tokens_details=PromptTokensDetailsWrapper(audio_tokens=None, cached_tokens=None, text_tokens=4, image_tokens=None))</code></li>
</ul>
</details>
</div>
<div class="cell-output cell-output-display cell-output-markdown">
<p><strong>claude-sonnet-4-5:</strong></p>
</div>
<div class="cell-output cell-output-display cell-output-markdown">
<p>Hello! How can I help you today?</p>
<details>
<ul>
<li>id: <code>chatcmpl-xxx</code></li>
<li>model: <code>claude-sonnet-4-5-20250929</code></li>
<li>finish_reason: <code>stop</code></li>
<li>usage: <code>Usage(completion_tokens=12, prompt_tokens=10, total_tokens=22, completion_tokens_details=None, prompt_tokens_details=PromptTokensDetailsWrapper(audio_tokens=None, cached_tokens=0, text_tokens=None, image_tokens=None), cache_creation_input_tokens=0, cache_read_input_tokens=0)</code></li>
</ul>
</details>
</div>
<div class="cell-output cell-output-display cell-output-markdown">
<p><strong>openai/gpt-4.1:</strong></p>
</div>
<div class="cell-output cell-output-display cell-output-markdown">
<p>Hello! How can I help you today? 😊</p>
<details>
<ul>
<li>id: <code>chatcmpl-xxx</code></li>
<li>model: <code>gpt-4.1-2025-04-14</code></li>
<li>finish_reason: <code>stop</code></li>
<li>usage: <code>Usage(completion_tokens=10, prompt_tokens=10, total_tokens=20, completion_tokens_details=CompletionTokensDetailsWrapper(accepted_prediction_tokens=0, audio_tokens=0, reasoning_tokens=0, rejected_prediction_tokens=0, text_tokens=None), prompt_tokens_details=PromptTokensDetailsWrapper(audio_tokens=0, cached_tokens=0, text_tokens=None, image_tokens=None))</code></li>
</ul>
</details>
</div>
</div>
</section>
<section id="messages-formatting" class="level2">
<h2 class="anchored" data-anchor-id="messages-formatting">Messages formatting</h2>
<p>Let’s start with making it easier to pass messages into litellm’s <code>completion</code> function (including images, and pdf files).</p>
<hr>
<p><a href="https://github.com/AnswerDotAI/lisette/blob/main/lisette/core.py#L98" target="_blank" style="float:right; font-size:smaller">source</a></p>
<section id="remove_cache_ckpts" class="level3">
<h3 class="anchored" data-anchor-id="remove_cache_ckpts">remove_cache_ckpts</h3>
<blockquote class="blockquote">
<pre><code> remove_cache_ckpts (msg)</code></pre>
</blockquote>
<p><em>remove cache checkpoints and return msg.</em></p>
<hr>
<p><a href="https://github.com/AnswerDotAI/lisette/blob/main/lisette/core.py#L109" target="_blank" style="float:right; font-size:smaller">source</a></p>
</section>
<section id="mk_msg" class="level3">
<h3 class="anchored" data-anchor-id="mk_msg">mk_msg</h3>
<blockquote class="blockquote">
<pre><code> mk_msg (content, role='user', cache=False, ttl=None)</code></pre>
</blockquote>
<p><em>Create a LiteLLM compatible message.</em></p>
<table class="caption-top table">
<colgroup>
<col style="width: 6%">
<col style="width: 25%">
<col style="width: 34%">
<col style="width: 34%">
</colgroup>
<thead>
<tr class="header">
<th></th>
<th><strong>Type</strong></th>
<th><strong>Default</strong></th>
<th><strong>Details</strong></th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>content</td>
<td></td>
<td></td>
<td>Content: str, bytes (image), list of mixed content, or dict w ‘role’ and ‘content’ fields</td>
</tr>
<tr class="even">
<td>role</td>
<td>str</td>
<td>user</td>
<td>Message role if content isn’t already a dict/Message</td>
</tr>
<tr class="odd">
<td>cache</td>
<td>bool</td>
<td>False</td>
<td>Enable Anthropic caching</td>
</tr>
<tr class="even">
<td>ttl</td>
<td>NoneType</td>
<td>None</td>
<td>Cache TTL: ‘5m’ (default) or ‘1h’</td>
</tr>
</tbody>
</table>
<p>Now we can use mk_msg to create different types of messages.</p>
<p>Simple text:</p>
<div id="f6217f4b" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb7"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a>msg <span class="op">=</span> mk_msg(<span class="st">"hey"</span>)</span>
<span id="cb7-2"><a href="#cb7-2" aria-hidden="true" tabindex="-1"></a>msg</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display">
<pre><code>{'role': 'user', 'content': 'hey'}</code></pre>
</div>
</div>
<p>Which can be passed to litellm’s <code>completion</code> function like this:</p>
<div id="cb1295ac" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb9"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a>model <span class="op">=</span> ms[<span class="dv">1</span>]</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<div id="2a28656f" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb10"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a>res <span class="op">=</span> completion(model, [msg])</span>
<span id="cb10-2"><a href="#cb10-2" aria-hidden="true" tabindex="-1"></a>res</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display cell-output-markdown">
<p>Hey! How’s it going? What’s on your mind?</p>
<details>
<ul>
<li>id: <code>chatcmpl-xxx</code></li>
<li>model: <code>claude-sonnet-4-5-20250929</code></li>
<li>finish_reason: <code>stop</code></li>
<li>usage: <code>Usage(completion_tokens=16, prompt_tokens=8, total_tokens=24, completion_tokens_details=None, prompt_tokens_details=PromptTokensDetailsWrapper(audio_tokens=None, cached_tokens=0, text_tokens=None, image_tokens=None), cache_creation_input_tokens=0, cache_read_input_tokens=0)</code></li>
</ul>
</details>
</div>
</div>
<p>We’ll add a little shortcut to make examples and testing easier here:</p>
<div id="a0d8df32" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb11"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> c(msgs, <span class="op">**</span>kw):</span>
<span id="cb11-2"><a href="#cb11-2" aria-hidden="true" tabindex="-1"></a>    msgs <span class="op">=</span> [msgs] <span class="cf">if</span> <span class="bu">isinstance</span>(msgs,<span class="bu">dict</span>) <span class="cf">else</span> listify(msgs)</span>
<span id="cb11-3"><a href="#cb11-3" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> completion(model, msgs, <span class="op">**</span>kw)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<div id="4f0186ff" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb12"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb12-1"><a href="#cb12-1" aria-hidden="true" tabindex="-1"></a>c(msg)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display cell-output-markdown">
<p>Hey! How’s it going? What’s on your mind?</p>
<details>
<ul>
<li>id: <code>chatcmpl-xxx</code></li>
<li>model: <code>claude-sonnet-4-5-20250929</code></li>
<li>finish_reason: <code>stop</code></li>
<li>usage: <code>Usage(completion_tokens=16, prompt_tokens=8, total_tokens=24, completion_tokens_details=None, prompt_tokens_details=PromptTokensDetailsWrapper(audio_tokens=None, cached_tokens=0, text_tokens=None, image_tokens=None), cache_creation_input_tokens=0, cache_read_input_tokens=0)</code></li>
</ul>
</details>
</div>
</div>
<p>Lists w just one string element are flattened for conciseness:</p>
<div id="c1a0955a" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb13"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb13-1"><a href="#cb13-1" aria-hidden="true" tabindex="-1"></a>test_eq(mk_msg(<span class="st">"hey"</span>), mk_msg([<span class="st">"hey"</span>]))</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<p>(LiteLLM ignores these fields when sent to other providers)</p>
<p>Text and images:</p>
<div id="923e6c93" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb14"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb14-1"><a href="#cb14-1" aria-hidden="true" tabindex="-1"></a>img_fn <span class="op">=</span> Path(<span class="st">'samples/puppy.jpg'</span>)</span>
<span id="cb14-2"><a href="#cb14-2" aria-hidden="true" tabindex="-1"></a>Image(filename<span class="op">=</span>img_fn, width<span class="op">=</span><span class="dv">200</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="00_core_files/figure-html/cell-14-output-1.jpeg" class="img-fluid figure-img" width="200"></p>
</figure>
</div>
</div>
</div>
<div id="60bb0ee7" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb15"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb15-1"><a href="#cb15-1" aria-hidden="true" tabindex="-1"></a>msg <span class="op">=</span> mk_msg([<span class="st">'hey what in this image?'</span>,img_fn.read_bytes()])</span>
<span id="cb15-2"><a href="#cb15-2" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(json.dumps(msg,indent<span class="op">=</span><span class="dv">1</span>)[:<span class="dv">200</span>]<span class="op">+</span><span class="st">"..."</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>{
 "role": "user",
 "content": [
  {
   "type": "text",
   "text": "hey what in this image?"
  },
  {
   "type": "image_url",
   "image_url": "data:image/jpeg;base64,/9j/4AAQSkZJRgABAQAAAQABAAD/4gxUSU...</code></pre>
</div>
</div>
<div id="b9ebb192" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb17"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb17-1"><a href="#cb17-1" aria-hidden="true" tabindex="-1"></a>c(msg)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display cell-output-markdown">
<p>This image shows an adorable <strong>Cavalier King Charles Spaniel puppy</strong>! The puppy has the breed’s characteristic features:</p>
<ul>
<li><strong>Coloring</strong>: Brown (chestnut) and white coat</li>
<li><strong>Sweet expression</strong>: Large, dark eyes and a gentle face</li>
<li><strong>Setting</strong>: The puppy is lying on grass near some purple flowers (appear to be asters or similar blooms)</li>
</ul>
<p>The puppy looks very young and has that irresistibly cute, innocent look that Cavalier puppies are famous for. The photo has a professional quality with nice lighting and composition, capturing the puppy’s endearing personality perfectly!</p>
<details>
<ul>
<li>id: <code>chatcmpl-xxx</code></li>
<li>model: <code>claude-sonnet-4-5-20250929</code></li>
<li>finish_reason: <code>stop</code></li>
<li>usage: <code>Usage(completion_tokens=139, prompt_tokens=104, total_tokens=243, completion_tokens_details=None, prompt_tokens_details=PromptTokensDetailsWrapper(audio_tokens=None, cached_tokens=0, text_tokens=None, image_tokens=None), cache_creation_input_tokens=0, cache_read_input_tokens=0)</code></li>
</ul>
</details>
</div>
</div>
<p>Let’s also demonstrate this for PDFs</p>
<div id="8160351e" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb18"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb18-1"><a href="#cb18-1" aria-hidden="true" tabindex="-1"></a>pdf_fn <span class="op">=</span> Path(<span class="st">'samples/solveit.pdf'</span>)</span>
<span id="cb18-2"><a href="#cb18-2" aria-hidden="true" tabindex="-1"></a>msg <span class="op">=</span> mk_msg([<span class="st">'Who is the author of this pdf?'</span>, pdf_fn.read_bytes()])</span>
<span id="cb18-3"><a href="#cb18-3" aria-hidden="true" tabindex="-1"></a>c(msg)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display cell-output-markdown">
<p>The author of this PDF is <strong>Jeremy Howard</strong> from fast.ai. He explicitly introduces himself in the document with “Hi, I’m Jeremy Howard, from fast.ai” and goes on to describe his work co-founding fast.ai with Rachel Thomas eight years ago.</p>
<details>
<ul>
<li>id: <code>chatcmpl-xxx</code></li>
<li>model: <code>claude-sonnet-4-5-20250929</code></li>
<li>finish_reason: <code>stop</code></li>
<li>usage: <code>Usage(completion_tokens=59, prompt_tokens=1610, total_tokens=1669, completion_tokens_details=None, prompt_tokens_details=PromptTokensDetailsWrapper(audio_tokens=None, cached_tokens=0, text_tokens=None, image_tokens=None), cache_creation_input_tokens=0, cache_read_input_tokens=0)</code></li>
</ul>
</details>
</div>
</div>
</section>
<section id="caching" class="level3">
<h3 class="anchored" data-anchor-id="caching">Caching</h3>
<p>Some providers such as Anthropic require manually opting into caching. Let’s try it:</p>
<div id="e42ad26b" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb19"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb19-1"><a href="#cb19-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> cpr(i): <span class="cf">return</span> <span class="ss">f'</span><span class="sc">{</span>i<span class="sc">}</span><span class="ss"> '</span><span class="op">*</span><span class="dv">1024</span> <span class="op">+</span> <span class="st">'This is a caching test. Report back only what number you see repeated above.'</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<div id="70b7f481" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb20"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb20-1"><a href="#cb20-1" aria-hidden="true" tabindex="-1"></a>disable_cachy()</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<div id="84103a63" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb21"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb21-1"><a href="#cb21-1" aria-hidden="true" tabindex="-1"></a>msg <span class="op">=</span> mk_msg(cpr(<span class="dv">1</span>), cache<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb21-2"><a href="#cb21-2" aria-hidden="true" tabindex="-1"></a>res <span class="op">=</span> c(msg)</span>
<span id="cb21-3"><a href="#cb21-3" aria-hidden="true" tabindex="-1"></a>res</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display cell-output-markdown">
<p>1</p>
<details>
<ul>
<li>id: <code>chatcmpl-xxx</code></li>
<li>model: <code>claude-sonnet-4-5-20250929</code></li>
<li>finish_reason: <code>stop</code></li>
<li>usage: <code>Usage(completion_tokens=5, prompt_tokens=3, total_tokens=8, completion_tokens_details=None, prompt_tokens_details=PromptTokensDetailsWrapper(audio_tokens=None, cached_tokens=0, text_tokens=None, image_tokens=None), cache_creation_input_tokens=2070, cache_read_input_tokens=0)</code></li>
</ul>
</details>
</div>
</div>
<p>Anthropic has a maximum of 4 cache checkpoints, so we remove previous ones as we go:</p>
<div id="220ab7b9" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb22"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb22-1"><a href="#cb22-1" aria-hidden="true" tabindex="-1"></a>res <span class="op">=</span> c([remove_cache_ckpts(msg), mk_msg(res), mk_msg(cpr(<span class="dv">2</span>), cache<span class="op">=</span><span class="va">True</span>)])</span>
<span id="cb22-2"><a href="#cb22-2" aria-hidden="true" tabindex="-1"></a>res</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display cell-output-markdown">
<p>2</p>
<details>
<ul>
<li>id: <code>chatcmpl-xxx</code></li>
<li>model: <code>claude-sonnet-4-5-20250929</code></li>
<li>finish_reason: <code>stop</code></li>
<li>usage: <code>Usage(completion_tokens=5, prompt_tokens=2073, total_tokens=2078, completion_tokens_details=None, prompt_tokens_details=PromptTokensDetailsWrapper(audio_tokens=None, cached_tokens=2070, text_tokens=None, image_tokens=None), cache_creation_input_tokens=2074, cache_read_input_tokens=2070)</code></li>
</ul>
</details>
</div>
</div>
<p>We see that the first message was cached, and this extra message has been written to cache:</p>
<div id="e1c7e395" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb23"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb23-1"><a href="#cb23-1" aria-hidden="true" tabindex="-1"></a>res.usage.prompt_tokens_details</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display">
<pre><code>PromptTokensDetailsWrapper(audio_tokens=None, cached_tokens=2070, text_tokens=None, image_tokens=None)</code></pre>
</div>
</div>
<p>We can add a bunch of large messages in a loop to see how the number of cached tokens used grows.</p>
<p>We do this for 25 times to ensure it still works for more than &gt;20 content blocks, <a href="https://docs.claude.com/en/docs/build-with-claude/prompt-caching">which is a known anthropic issue</a>.</p>
<p>The code below is commented by default, because it’s slow. Please uncomment when working on caching.</p>
<div id="ebf0f771" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb25"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb25-1"><a href="#cb25-1" aria-hidden="true" tabindex="-1"></a><span class="co"># h = []</span></span>
<span id="cb25-2"><a href="#cb25-2" aria-hidden="true" tabindex="-1"></a><span class="co"># msg = mk_msg(cpr(1), cache=True)</span></span>
<span id="cb25-3"><a href="#cb25-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-4"><a href="#cb25-4" aria-hidden="true" tabindex="-1"></a><span class="co"># for o in range(2,25):</span></span>
<span id="cb25-5"><a href="#cb25-5" aria-hidden="true" tabindex="-1"></a><span class="co">#     h += [remove_cache_ckpts(msg), mk_msg(res)]</span></span>
<span id="cb25-6"><a href="#cb25-6" aria-hidden="true" tabindex="-1"></a><span class="co">#     msg = mk_msg(cpr(o), cache=True)</span></span>
<span id="cb25-7"><a href="#cb25-7" aria-hidden="true" tabindex="-1"></a><span class="co">#     res = c(h+[msg])</span></span>
<span id="cb25-8"><a href="#cb25-8" aria-hidden="true" tabindex="-1"></a><span class="co">#     detls = res.usage.prompt_tokens_details</span></span>
<span id="cb25-9"><a href="#cb25-9" aria-hidden="true" tabindex="-1"></a><span class="co">#     print(o, detls.cached_tokens, detls.cache_creation_tokens, end='; ')</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<div id="197632a3" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb26"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb26-1"><a href="#cb26-1" aria-hidden="true" tabindex="-1"></a>enable_cachy()</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
</section>
<section id="reconstructing-formatted-outputs" class="level3">
<h3 class="anchored" data-anchor-id="reconstructing-formatted-outputs">Reconstructing formatted outputs</h3>
<p>Lisette can call multiple tools in a loop. Further down this notebook, we’ll provide convenience functions for formatting such a sequence of toolcalls and responses into one formatted output string.</p>
<p>For now, we’ll show an example and show how to transform such a formatted output string back into a valid LiteLLM history.</p>
<div id="9ee01a18" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb27"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb27-1"><a href="#cb27-1" aria-hidden="true" tabindex="-1"></a>fmt_outp <span class="op">=</span> <span class="st">'''</span></span>
<span id="cb27-2"><a href="#cb27-2" aria-hidden="true" tabindex="-1"></a><span class="st">I'll solve this step-by-step, using parallel calls where possible.</span></span>
<span id="cb27-3"><a href="#cb27-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb27-4"><a href="#cb27-4" aria-hidden="true" tabindex="-1"></a><span class="st">&lt;details class='tool-usage-details'&gt;</span></span>
<span id="cb27-5"><a href="#cb27-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb27-6"><a href="#cb27-6" aria-hidden="true" tabindex="-1"></a><span class="st">```json</span></span>
<span id="cb27-7"><a href="#cb27-7" aria-hidden="true" tabindex="-1"></a><span class="st">{</span></span>
<span id="cb27-8"><a href="#cb27-8" aria-hidden="true" tabindex="-1"></a><span class="st">  "id": "toolu_01KjnQH2Nsz2viQ7XYpLW3Ta",</span></span>
<span id="cb27-9"><a href="#cb27-9" aria-hidden="true" tabindex="-1"></a><span class="st">  "call": { "function": "simple_add", "arguments": { "a": 10, "b": 5 } },</span></span>
<span id="cb27-10"><a href="#cb27-10" aria-hidden="true" tabindex="-1"></a><span class="st">  "result": "15"</span></span>
<span id="cb27-11"><a href="#cb27-11" aria-hidden="true" tabindex="-1"></a><span class="st">}</span></span>
<span id="cb27-12"><a href="#cb27-12" aria-hidden="true" tabindex="-1"></a><span class="st">```</span></span>
<span id="cb27-13"><a href="#cb27-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb27-14"><a href="#cb27-14" aria-hidden="true" tabindex="-1"></a><span class="st">&lt;/details&gt;</span></span>
<span id="cb27-15"><a href="#cb27-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb27-16"><a href="#cb27-16" aria-hidden="true" tabindex="-1"></a><span class="st">&lt;details class='tool-usage-details'&gt;</span></span>
<span id="cb27-17"><a href="#cb27-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb27-18"><a href="#cb27-18" aria-hidden="true" tabindex="-1"></a><span class="st">```json</span></span>
<span id="cb27-19"><a href="#cb27-19" aria-hidden="true" tabindex="-1"></a><span class="st">{</span></span>
<span id="cb27-20"><a href="#cb27-20" aria-hidden="true" tabindex="-1"></a><span class="st">  "id": "toolu_01Koi2EZrGZsBbnQ13wuuvzY",</span></span>
<span id="cb27-21"><a href="#cb27-21" aria-hidden="true" tabindex="-1"></a><span class="st">  "call": { "function": "simple_add", "arguments": { "a": 2, "b": 1 } },</span></span>
<span id="cb27-22"><a href="#cb27-22" aria-hidden="true" tabindex="-1"></a><span class="st">  "result": "3"</span></span>
<span id="cb27-23"><a href="#cb27-23" aria-hidden="true" tabindex="-1"></a><span class="st">}</span></span>
<span id="cb27-24"><a href="#cb27-24" aria-hidden="true" tabindex="-1"></a><span class="st">```</span></span>
<span id="cb27-25"><a href="#cb27-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb27-26"><a href="#cb27-26" aria-hidden="true" tabindex="-1"></a><span class="st">&lt;/details&gt;</span></span>
<span id="cb27-27"><a href="#cb27-27" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb27-28"><a href="#cb27-28" aria-hidden="true" tabindex="-1"></a><span class="st">Now I need to multiply 15 * 3 before I can do the final division:</span></span>
<span id="cb27-29"><a href="#cb27-29" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb27-30"><a href="#cb27-30" aria-hidden="true" tabindex="-1"></a><span class="st">&lt;details class='tool-usage-details'&gt;</span></span>
<span id="cb27-31"><a href="#cb27-31" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb27-32"><a href="#cb27-32" aria-hidden="true" tabindex="-1"></a><span class="st">```json</span></span>
<span id="cb27-33"><a href="#cb27-33" aria-hidden="true" tabindex="-1"></a><span class="st">{</span></span>
<span id="cb27-34"><a href="#cb27-34" aria-hidden="true" tabindex="-1"></a><span class="st">  "id": "toolu_0141NRaWUjmGtwxZjWkyiq6C",</span></span>
<span id="cb27-35"><a href="#cb27-35" aria-hidden="true" tabindex="-1"></a><span class="st">  "call": { "function": "multiply", "arguments": { "a": 15, "b": 3 } },</span></span>
<span id="cb27-36"><a href="#cb27-36" aria-hidden="true" tabindex="-1"></a><span class="st">  "result": "45"</span></span>
<span id="cb27-37"><a href="#cb27-37" aria-hidden="true" tabindex="-1"></a><span class="st">}</span></span>
<span id="cb27-38"><a href="#cb27-38" aria-hidden="true" tabindex="-1"></a><span class="st">```</span></span>
<span id="cb27-39"><a href="#cb27-39" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb27-40"><a href="#cb27-40" aria-hidden="true" tabindex="-1"></a><span class="st">&lt;/details&gt;</span></span>
<span id="cb27-41"><a href="#cb27-41" aria-hidden="true" tabindex="-1"></a><span class="st">'''</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<p>We can split into chunks of (text,toolstr,json):</p>
<div id="d6a3f160" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb28"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb28-1"><a href="#cb28-1" aria-hidden="true" tabindex="-1"></a>sp <span class="op">=</span> re_tools.split(fmt_outp)</span>
<span id="cb28-2"><a href="#cb28-2" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> o <span class="kw">in</span> <span class="bu">list</span>(chunked(sp, <span class="dv">3</span>, pad<span class="op">=</span><span class="va">True</span>)): <span class="bu">print</span>(<span class="st">'- '</span>, o)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>-  ["\nI'll solve this step-by-step, using parallel calls where possible.\n\n", '&lt;details class=\'tool-usage-details\'&gt;\n\n```json\n{\n  "id": "toolu_01KjnQH2Nsz2viQ7XYpLW3Ta",\n  "call": { "function": "simple_add", "arguments": { "a": 10, "b": 5 } },\n  "result": "15"\n}\n```\n\n&lt;/details&gt;', '{\n  "id": "toolu_01KjnQH2Nsz2viQ7XYpLW3Ta",\n  "call": { "function": "simple_add", "arguments": { "a": 10, "b": 5 } },\n  "result": "15"\n}']
-  ['\n\n', '&lt;details class=\'tool-usage-details\'&gt;\n\n```json\n{\n  "id": "toolu_01Koi2EZrGZsBbnQ13wuuvzY",\n  "call": { "function": "simple_add", "arguments": { "a": 2, "b": 1 } },\n  "result": "3"\n}\n```\n\n&lt;/details&gt;', '{\n  "id": "toolu_01Koi2EZrGZsBbnQ13wuuvzY",\n  "call": { "function": "simple_add", "arguments": { "a": 2, "b": 1 } },\n  "result": "3"\n}']
-  ['\n\nNow I need to multiply 15 * 3 before I can do the final division:\n\n', '&lt;details class=\'tool-usage-details\'&gt;\n\n```json\n{\n  "id": "toolu_0141NRaWUjmGtwxZjWkyiq6C",\n  "call": { "function": "multiply", "arguments": { "a": 15, "b": 3 } },\n  "result": "45"\n}\n```\n\n&lt;/details&gt;', '{\n  "id": "toolu_0141NRaWUjmGtwxZjWkyiq6C",\n  "call": { "function": "multiply", "arguments": { "a": 15, "b": 3 } },\n  "result": "45"\n}']
-  ['\n', None, None]</code></pre>
</div>
</div>
<hr>
<p><a href="https://github.com/AnswerDotAI/lisette/blob/main/lisette/core.py#L138" target="_blank" style="float:right; font-size:smaller">source</a></p>
</section>
<section id="fmt2hist" class="level3">
<h3 class="anchored" data-anchor-id="fmt2hist">fmt2hist</h3>
<blockquote class="blockquote">
<pre><code> fmt2hist (outp:str)</code></pre>
</blockquote>
<p><em>Transform a formatted output into a LiteLLM compatible history</em></p>
<p>See how we can turn that one formatted output string back into a list of Messages:</p>
<div id="8ac22b2e" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb31"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb31-1"><a href="#cb31-1" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> pprint <span class="im">import</span> pprint</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<div id="f6b40b0a" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb32"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb32-1"><a href="#cb32-1" aria-hidden="true" tabindex="-1"></a>h <span class="op">=</span> fmt2hist(fmt_outp)</span>
<span id="cb32-2"><a href="#cb32-2" aria-hidden="true" tabindex="-1"></a>pprint(h)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>[Message(content="I'll solve this step-by-step, using parallel calls where possible.", role='assistant', tool_calls=[ChatCompletionMessageToolCall(function=Function(arguments='{"a":10,"b":5}', name='simple_add'), id='toolu_01KjnQH2Nsz2viQ7XYpLW3Ta', type='function')], function_call=None, provider_specific_fields=None),
 {'content': '15',
  'name': 'simple_add',
  'role': 'tool',
  'tool_call_id': 'toolu_01KjnQH2Nsz2viQ7XYpLW3Ta'},
 Message(content='', role='assistant', tool_calls=[ChatCompletionMessageToolCall(function=Function(arguments='{"a":2,"b":1}', name='simple_add'), id='toolu_01Koi2EZrGZsBbnQ13wuuvzY', type='function')], function_call=None, provider_specific_fields=None),
 {'content': '3',
  'name': 'simple_add',
  'role': 'tool',
  'tool_call_id': 'toolu_01Koi2EZrGZsBbnQ13wuuvzY'},
 Message(content='Now I need to multiply 15 * 3 before I can do the final division:', role='assistant', tool_calls=[ChatCompletionMessageToolCall(function=Function(arguments='{"a":15,"b":3}', name='multiply'), id='toolu_0141NRaWUjmGtwxZjWkyiq6C', type='function')], function_call=None, provider_specific_fields=None),
 {'content': '45',
  'name': 'multiply',
  'role': 'tool',
  'tool_call_id': 'toolu_0141NRaWUjmGtwxZjWkyiq6C'},
 Message(content='.', role='assistant', tool_calls=None, function_call=None, provider_specific_fields=None)]</code></pre>
</div>
</div>
</section>
<section id="mk_msgs" class="level3">
<h3 class="anchored" data-anchor-id="mk_msgs"><a href="https://lisette.answer.ai/core.html#mk_msgs"><code>mk_msgs</code></a></h3>
<p>We will skip tool use blocks and tool results during caching</p>
<p>Now lets make it easy to provide entire conversations:</p>
<hr>
<p><a href="https://github.com/AnswerDotAI/lisette/blob/main/lisette/core.py#L161" target="_blank" style="float:right; font-size:smaller">source</a></p>
</section>
<section id="mk_msgs-1" class="level3">
<h3 class="anchored" data-anchor-id="mk_msgs-1">mk_msgs</h3>
<blockquote class="blockquote">
<pre><code> mk_msgs (msgs, cache=False, cache_idxs=[-1], ttl=None)</code></pre>
</blockquote>
<p><em>Create a list of LiteLLM compatible messages.</em></p>
<table class="caption-top table">
<colgroup>
<col style="width: 6%">
<col style="width: 25%">
<col style="width: 34%">
<col style="width: 34%">
</colgroup>
<thead>
<tr class="header">
<th></th>
<th><strong>Type</strong></th>
<th><strong>Default</strong></th>
<th><strong>Details</strong></th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>msgs</td>
<td></td>
<td></td>
<td>List of messages (each: str, bytes, list, or dict w ‘role’ and ‘content’ fields)</td>
</tr>
<tr class="even">
<td>cache</td>
<td>bool</td>
<td>False</td>
<td>Enable Anthropic caching</td>
</tr>
<tr class="odd">
<td>cache_idxs</td>
<td>list</td>
<td>[-1]</td>
<td>Cache breakpoint idxs</td>
</tr>
<tr class="even">
<td>ttl</td>
<td>NoneType</td>
<td>None</td>
<td>Cache TTL: ‘5m’ (default) or ‘1h’</td>
</tr>
</tbody>
</table>
<p>With <a href="https://lisette.answer.ai/core.html#mk_msgs"><code>mk_msgs</code></a> you can easily provide a whole conversation:</p>
<div id="263ecc52" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb35"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb35-1"><a href="#cb35-1" aria-hidden="true" tabindex="-1"></a>msgs <span class="op">=</span> mk_msgs([<span class="st">'Hey!'</span>,<span class="st">"Hi there!"</span>,<span class="st">"How are you?"</span>,<span class="st">"I'm doing fine and you?"</span>])</span>
<span id="cb35-2"><a href="#cb35-2" aria-hidden="true" tabindex="-1"></a>msgs</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display">
<pre><code>[{'role': 'user', 'content': 'Hey!'},
 {'role': 'assistant', 'content': 'Hi there!'},
 {'role': 'user', 'content': 'How are you?'},
 {'role': 'assistant', 'content': "I'm doing fine and you?"}]</code></pre>
</div>
</div>
<p>By defualt the last message will be cached when <code>cache=True</code>:</p>
<div id="ff5a34c5" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb37"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb37-1"><a href="#cb37-1" aria-hidden="true" tabindex="-1"></a>msgs <span class="op">=</span> mk_msgs([<span class="st">'Hey!'</span>,<span class="st">"Hi there!"</span>,<span class="st">"How are you?"</span>,<span class="st">"I'm doing fine and you?"</span>], cache<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb37-2"><a href="#cb37-2" aria-hidden="true" tabindex="-1"></a>msgs</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display">
<pre><code>[{'role': 'user', 'content': 'Hey!'},
 {'role': 'assistant', 'content': 'Hi there!'},
 {'role': 'user', 'content': 'How are you?'},
 {'role': 'assistant',
  'content': [{'type': 'text',
    'text': "I'm doing fine and you?",
    'cache_control': {'type': 'ephemeral'}}]}]</code></pre>
</div>
</div>
<div id="fc360a73" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb39"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb39-1"><a href="#cb39-1" aria-hidden="true" tabindex="-1"></a>test_eq(<span class="st">'cache_control'</span> <span class="kw">in</span> msgs[<span class="op">-</span><span class="dv">1</span>][<span class="st">'content'</span>][<span class="dv">0</span>], <span class="va">True</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<p>Alternatively, users can provide custom <code>cache_idxs</code>. Tool call blocks and results are skipped during caching:</p>
<div id="9289d855" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb40"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb40-1"><a href="#cb40-1" aria-hidden="true" tabindex="-1"></a>msgs <span class="op">=</span> mk_msgs([<span class="st">'Hello!'</span>,<span class="st">'Hi! How can I help you?'</span>,<span class="st">'Call some functions!'</span>,fmt_outp], cache<span class="op">=</span><span class="va">True</span>, cache_idxs<span class="op">=</span>[<span class="dv">0</span>,<span class="op">-</span><span class="dv">2</span>,<span class="op">-</span><span class="dv">1</span>])</span>
<span id="cb40-2"><a href="#cb40-2" aria-hidden="true" tabindex="-1"></a>msgs</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display">
<pre><code>[{'role': 'user',
  'content': [{'type': 'text',
    'text': 'Hello!',
    'cache_control': {'type': 'ephemeral'}}]},
 {'role': 'assistant', 'content': 'Hi! How can I help you?'},
 {'role': 'user',
  'content': [{'type': 'text',
    'text': 'Call some functions!',
    'cache_control': {'type': 'ephemeral'}}]},
 Message(content="I'll solve this step-by-step, using parallel calls where possible.", role='assistant', tool_calls=[ChatCompletionMessageToolCall(function=Function(arguments='{"a":10,"b":5}', name='simple_add'), id='toolu_01KjnQH2Nsz2viQ7XYpLW3Ta', type='function')], function_call=None, provider_specific_fields=None),
 {'role': 'tool',
  'tool_call_id': 'toolu_01KjnQH2Nsz2viQ7XYpLW3Ta',
  'name': 'simple_add',
  'content': '15'},
 Message(content='', role='assistant', tool_calls=[ChatCompletionMessageToolCall(function=Function(arguments='{"a":2,"b":1}', name='simple_add'), id='toolu_01Koi2EZrGZsBbnQ13wuuvzY', type='function')], function_call=None, provider_specific_fields=None),
 {'role': 'tool',
  'tool_call_id': 'toolu_01Koi2EZrGZsBbnQ13wuuvzY',
  'name': 'simple_add',
  'content': '3'},
 Message(content='Now I need to multiply 15 * 3 before I can do the final division:', role='assistant', tool_calls=[ChatCompletionMessageToolCall(function=Function(arguments='{"a":15,"b":3}', name='multiply'), id='toolu_0141NRaWUjmGtwxZjWkyiq6C', type='function')], function_call=None, provider_specific_fields=None),
 {'role': 'tool',
  'tool_call_id': 'toolu_0141NRaWUjmGtwxZjWkyiq6C',
  'name': 'multiply',
  'content': '45'},
 Message(content=[{'type': 'text', 'text': '.', 'cache_control': {'type': 'ephemeral'}}], role='assistant', tool_calls=None, function_call=None, provider_specific_fields=None)]</code></pre>
</div>
</div>
<div id="8f38eeaf" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb42"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb42-1"><a href="#cb42-1" aria-hidden="true" tabindex="-1"></a>test_eq(<span class="st">'cache_control'</span> <span class="kw">in</span> msgs[<span class="dv">0</span>][<span class="st">'content'</span>][<span class="dv">0</span>], <span class="va">True</span>)</span>
<span id="cb42-2"><a href="#cb42-2" aria-hidden="true" tabindex="-1"></a>test_eq(<span class="st">'cache_control'</span> <span class="kw">in</span> msgs[<span class="dv">2</span>][<span class="st">'content'</span>][<span class="dv">0</span>], <span class="va">True</span>) <span class="co"># shifted idxs to skip tools</span></span>
<span id="cb42-3"><a href="#cb42-3" aria-hidden="true" tabindex="-1"></a>test_eq(<span class="st">'cache_control'</span> <span class="kw">in</span> msgs[<span class="op">-</span><span class="dv">1</span>][<span class="st">'content'</span>][<span class="dv">0</span>], <span class="va">True</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<p>Who’s speaking at when is automatically inferred. Even when there are multiple tools being called in parallel (which LiteLLM supports!).</p>
<div id="9cf8d1f2" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb43"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb43-1"><a href="#cb43-1" aria-hidden="true" tabindex="-1"></a>msgs <span class="op">=</span> mk_msgs([<span class="st">'Tell me the weather in Paris and Rome'</span>,</span>
<span id="cb43-2"><a href="#cb43-2" aria-hidden="true" tabindex="-1"></a>                <span class="st">'Assistant calls weather tool two times'</span>,</span>
<span id="cb43-3"><a href="#cb43-3" aria-hidden="true" tabindex="-1"></a>                {<span class="st">'role'</span>:<span class="st">'tool'</span>,<span class="st">'content'</span>:<span class="st">'Weather in Paris is ...'</span>},</span>
<span id="cb43-4"><a href="#cb43-4" aria-hidden="true" tabindex="-1"></a>                {<span class="st">'role'</span>:<span class="st">'tool'</span>,<span class="st">'content'</span>:<span class="st">'Weather in Rome is ...'</span>},</span>
<span id="cb43-5"><a href="#cb43-5" aria-hidden="true" tabindex="-1"></a>                <span class="st">'Assistant returns weather'</span>,</span>
<span id="cb43-6"><a href="#cb43-6" aria-hidden="true" tabindex="-1"></a>                <span class="st">'Thanks!'</span>])</span>
<span id="cb43-7"><a href="#cb43-7" aria-hidden="true" tabindex="-1"></a>msgs</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display">
<pre><code>[{'role': 'user', 'content': 'Tell me the weather in Paris and Rome'},
 {'role': 'assistant', 'content': 'Assistant calls weather tool two times'},
 {'role': 'tool', 'content': 'Weather in Paris is ...'},
 {'role': 'tool', 'content': 'Weather in Rome is ...'},
 {'role': 'assistant', 'content': 'Assistant returns weather'},
 {'role': 'user', 'content': 'Thanks!'}]</code></pre>
</div>
</div>
<p>For ease of use, if <code>msgs</code> is not already in a <code>list</code>, it will automatically be wrapped inside one. This way you can pass a single prompt into <a href="https://lisette.answer.ai/core.html#mk_msgs"><code>mk_msgs</code></a> and get back a LiteLLM compatible msg history.</p>
<div id="aa4e7663" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb45"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb45-1"><a href="#cb45-1" aria-hidden="true" tabindex="-1"></a>msgs <span class="op">=</span> mk_msgs(<span class="st">"Hey"</span>)</span>
<span id="cb45-2"><a href="#cb45-2" aria-hidden="true" tabindex="-1"></a>msgs</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display">
<pre><code>[{'role': 'user', 'content': 'Hey'}]</code></pre>
</div>
</div>
<div id="2c828056" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb47"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb47-1"><a href="#cb47-1" aria-hidden="true" tabindex="-1"></a>msgs <span class="op">=</span> mk_msgs([<span class="st">'Hey!'</span>,<span class="st">"Hi there!"</span>,<span class="st">"How are you?"</span>,<span class="st">"I'm fine, you?"</span>])</span>
<span id="cb47-2"><a href="#cb47-2" aria-hidden="true" tabindex="-1"></a>msgs</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display">
<pre><code>[{'role': 'user', 'content': 'Hey!'},
 {'role': 'assistant', 'content': 'Hi there!'},
 {'role': 'user', 'content': 'How are you?'},
 {'role': 'assistant', 'content': "I'm fine, you?"}]</code></pre>
</div>
</div>
<p>However, beware that if you use <a href="https://lisette.answer.ai/core.html#mk_msgs"><code>mk_msgs</code></a> for a single message, consisting of multiple parts. Then you should be explicit, and make sure to wrap those multiple messages in two lists:</p>
<ol type="1">
<li>One list to show that they belong together in one message (the inner list).</li>
<li>Another, because mk_msgs expects a list of multiple messages (the outer list).</li>
</ol>
<p>This is common when working with images for example:</p>
<div id="d315d964" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb49"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb49-1"><a href="#cb49-1" aria-hidden="true" tabindex="-1"></a>msgs <span class="op">=</span> mk_msgs([[<span class="st">'Whats in this img?'</span>,img_fn.read_bytes()]])</span>
<span id="cb49-2"><a href="#cb49-2" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(json.dumps(msgs,indent<span class="op">=</span><span class="dv">1</span>)[:<span class="dv">200</span>]<span class="op">+</span><span class="st">"..."</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>[
 {
  "role": "user",
  "content": [
   {
    "type": "text",
    "text": "Whats in this img?"
   },
   {
    "type": "image_url",
    "image_url": "data:image/jpeg;base64,/9j/4AAQSkZJRgABAQAAAQABAAD...</code></pre>
</div>
</div>
</section>
</section>
<section id="streaming" class="level2">
<h2 class="anchored" data-anchor-id="streaming">Streaming</h2>
<p>LiteLLM supports streaming responses. That’s really useful if you want to show intermediate results, instead of having to wait until the whole response is finished.</p>
<p>We create this helper function that returns the entire response at the end of the stream. This is useful when you want to store the whole response somewhere after having displayed the intermediate results.</p>
<hr>
<p><a href="https://github.com/AnswerDotAI/lisette/blob/main/lisette/core.py#L179" target="_blank" style="float:right; font-size:smaller">source</a></p>
<section id="stream_with_complete" class="level3">
<h3 class="anchored" data-anchor-id="stream_with_complete">stream_with_complete</h3>
<blockquote class="blockquote">
<pre><code> stream_with_complete (gen, postproc=&lt;function noop&gt;)</code></pre>
</blockquote>
<p><em>Extend streaming response chunks with the complete response</em></p>
<div id="46f16571" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb52"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb52-1"><a href="#cb52-1" aria-hidden="true" tabindex="-1"></a>r <span class="op">=</span> c(mk_msgs(<span class="st">"Hey!"</span>), stream<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb52-2"><a href="#cb52-2" aria-hidden="true" tabindex="-1"></a>r2 <span class="op">=</span> SaveReturn(stream_with_complete(r))</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<div id="9797136b" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb53"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb53-1"><a href="#cb53-1" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> o <span class="kw">in</span> r2:</span>
<span id="cb53-2"><a href="#cb53-2" aria-hidden="true" tabindex="-1"></a>    cts <span class="op">=</span> o.choices[<span class="dv">0</span>].delta.content</span>
<span id="cb53-3"><a href="#cb53-3" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> cts: <span class="bu">print</span>(cts, end<span class="op">=</span><span class="st">''</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>Hey! How's it going? 😊 What can I help you with today?</code></pre>
</div>
</div>
<div id="897ec073" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb55"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb55-1"><a href="#cb55-1" aria-hidden="true" tabindex="-1"></a>r2.value</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display cell-output-markdown">
<p>Hey! How’s it going? 😊 What can I help you with today?</p>
<details>
<ul>
<li>id: <code>chatcmpl-xxx</code></li>
<li>model: <code>claude-sonnet-4-5</code></li>
<li>finish_reason: <code>stop</code></li>
<li>usage: <code>Usage(completion_tokens=22, prompt_tokens=9, total_tokens=31, completion_tokens_details=CompletionTokensDetailsWrapper(accepted_prediction_tokens=None, audio_tokens=None, reasoning_tokens=0, rejected_prediction_tokens=None, text_tokens=None), prompt_tokens_details=None)</code></li>
</ul>
</details>
</div>
</div>
</section>
</section>
<section id="tools" class="level2">
<h2 class="anchored" data-anchor-id="tools">Tools</h2>
<hr>
<p><a href="https://github.com/AnswerDotAI/lisette/blob/main/lisette/core.py#L189" target="_blank" style="float:right; font-size:smaller">source</a></p>
<section id="lite_mk_func" class="level3">
<h3 class="anchored">lite_mk_func</h3>
<blockquote class="blockquote">
<pre><code> lite_mk_func (f)</code></pre>
</blockquote>
<div id="7b103600" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb57"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb57-1"><a href="#cb57-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> simple_add(</span>
<span id="cb57-2"><a href="#cb57-2" aria-hidden="true" tabindex="-1"></a>    a: <span class="bu">int</span>,   <span class="co"># first operand</span></span>
<span id="cb57-3"><a href="#cb57-3" aria-hidden="true" tabindex="-1"></a>    b: <span class="bu">int</span><span class="op">=</span><span class="dv">0</span>  <span class="co"># second operand</span></span>
<span id="cb57-4"><a href="#cb57-4" aria-hidden="true" tabindex="-1"></a>) <span class="op">-&gt;</span> <span class="bu">int</span>:</span>
<span id="cb57-5"><a href="#cb57-5" aria-hidden="true" tabindex="-1"></a>    <span class="co">"Add two numbers together"</span></span>
<span id="cb57-6"><a href="#cb57-6" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> a <span class="op">+</span> b</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<div id="100fc27b" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb58"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb58-1"><a href="#cb58-1" aria-hidden="true" tabindex="-1"></a>toolsc <span class="op">=</span> lite_mk_func(simple_add)</span>
<span id="cb58-2"><a href="#cb58-2" aria-hidden="true" tabindex="-1"></a>toolsc</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display">
<pre><code>{'type': 'function',
 'function': {'name': 'simple_add',
  'description': 'Add two numbers together\n\nReturns:\n- type: integer',
  'parameters': {'type': 'object',
   'properties': {'a': {'type': 'integer', 'description': 'first operand'},
    'b': {'type': 'integer', 'description': 'second operand', 'default': 0}},
   'required': ['a']}}}</code></pre>
</div>
</div>
<div id="8c2af29a" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb60"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb60-1"><a href="#cb60-1" aria-hidden="true" tabindex="-1"></a>tmsg <span class="op">=</span> mk_msg(<span class="st">"What is 5478954793+547982745? How about 5479749754+9875438979? Always use tools for calculations, and describe what you'll do before using a tool. Where multiple tool calls are required, do them in a single response where possible. "</span>)</span>
<span id="cb60-2"><a href="#cb60-2" aria-hidden="true" tabindex="-1"></a>r <span class="op">=</span> c(tmsg, tools<span class="op">=</span>[toolsc])</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<div id="8bdb1817" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb61"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb61-1"><a href="#cb61-1" aria-hidden="true" tabindex="-1"></a>display(r)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display cell-output-markdown">
<p>I’ll help you calculate both of those sums using the addition tool.</p>
<p>Let me break down what I’ll do: 1. First calculation: 5478954793 + 547982745 2. Second calculation: 5479749754 + 9875438979</p>
<p>Since these are independent calculations, I’ll perform both at the same time.</p>
<p>🔧 simple_add({“a”: 5478954793, “b”: 547982745})</p>
<p>🔧 simple_add({“a”: 5479749754, “b”: 9875438979})</p>
<details>
<ul>
<li>id: <code>chatcmpl-xxx</code></li>
<li>model: <code>claude-sonnet-4-5-20250929</code></li>
<li>finish_reason: <code>tool_calls</code></li>
<li>usage: <code>Usage(completion_tokens=211, prompt_tokens=659, total_tokens=870, completion_tokens_details=None, prompt_tokens_details=PromptTokensDetailsWrapper(audio_tokens=None, cached_tokens=0, text_tokens=None, image_tokens=None), cache_creation_input_tokens=0, cache_read_input_tokens=0)</code></li>
</ul>
</details>
</div>
</div>
<div id="d5af607c" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb62"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb62-1"><a href="#cb62-1" aria-hidden="true" tabindex="-1"></a>tcs <span class="op">=</span> [_lite_call_func(o, ns<span class="op">=</span><span class="bu">globals</span>()) <span class="cf">for</span> o <span class="kw">in</span> r.choices[<span class="dv">0</span>].message.tool_calls]</span>
<span id="cb62-2"><a href="#cb62-2" aria-hidden="true" tabindex="-1"></a>tcs</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display">
<pre><code>[{'tool_call_id': 'toolu_01KATe5b5tmd4tK5D9BUZE5S',
  'role': 'tool',
  'name': 'simple_add',
  'content': '6026937538'},
 {'tool_call_id': 'toolu_01E4WQj8RkQj8Z7QLJ6ireTe',
  'role': 'tool',
  'name': 'simple_add',
  'content': '15355188733'}]</code></pre>
</div>
</div>
<div id="3dd9871b" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb64"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb64-1"><a href="#cb64-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> delta_text(msg):</span>
<span id="cb64-2"><a href="#cb64-2" aria-hidden="true" tabindex="-1"></a>    <span class="co">"Extract printable content from streaming delta, return None if nothing to print"</span></span>
<span id="cb64-3"><a href="#cb64-3" aria-hidden="true" tabindex="-1"></a>    c <span class="op">=</span> msg.choices[<span class="dv">0</span>]</span>
<span id="cb64-4"><a href="#cb64-4" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="kw">not</span> c: <span class="cf">return</span> c</span>
<span id="cb64-5"><a href="#cb64-5" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="kw">not</span> <span class="bu">hasattr</span>(c,<span class="st">'delta'</span>): <span class="cf">return</span> <span class="va">None</span> <span class="co">#f'{c}'</span></span>
<span id="cb64-6"><a href="#cb64-6" aria-hidden="true" tabindex="-1"></a>    delta <span class="op">=</span> c.delta</span>
<span id="cb64-7"><a href="#cb64-7" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> delta.content: <span class="cf">return</span> delta.content</span>
<span id="cb64-8"><a href="#cb64-8" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> delta.tool_calls:</span>
<span id="cb64-9"><a href="#cb64-9" aria-hidden="true" tabindex="-1"></a>        res <span class="op">=</span> <span class="st">''</span>.join(<span class="ss">f"🔧 </span><span class="sc">{</span>tc<span class="sc">.</span>function<span class="sc">.</span>name<span class="sc">}</span><span class="ss">"</span> <span class="cf">for</span> tc <span class="kw">in</span> delta.tool_calls <span class="cf">if</span> tc.<span class="bu">id</span> <span class="kw">and</span> tc.function.name)</span>
<span id="cb64-10"><a href="#cb64-10" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> res: <span class="cf">return</span> <span class="ss">f'</span><span class="ch">\n</span><span class="sc">{</span>res<span class="sc">}</span><span class="ch">\n</span><span class="ss">'</span></span>
<span id="cb64-11"><a href="#cb64-11" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="bu">hasattr</span>(delta,<span class="st">'reasoning_content'</span>): <span class="cf">return</span> <span class="st">'🧠'</span> <span class="cf">if</span> delta.reasoning_content <span class="cf">else</span> <span class="st">'</span><span class="ch">\n\n</span><span class="st">'</span></span>
<span id="cb64-12"><a href="#cb64-12" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> <span class="va">None</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<div id="e4790a51" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb65"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb65-1"><a href="#cb65-1" aria-hidden="true" tabindex="-1"></a>r <span class="op">=</span> c(tmsg, stream<span class="op">=</span><span class="va">True</span>, tools<span class="op">=</span>[toolsc])</span>
<span id="cb65-2"><a href="#cb65-2" aria-hidden="true" tabindex="-1"></a>r2 <span class="op">=</span> SaveReturn(stream_with_complete(r))</span>
<span id="cb65-3"><a href="#cb65-3" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> o <span class="kw">in</span> r2: <span class="bu">print</span>(delta_text(o) <span class="kw">or</span> <span class="st">''</span>, end<span class="op">=</span><span class="st">''</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>I'll help you calculate those two sums using the addition tool.

Let me break down what I need to do:
1. Calculate 5478954793 + 547982745
2. Calculate 5479749754 + 9875438979

Since these are independent calculations, I'll perform both additions at once.
🔧 simple_add

🔧 simple_add</code></pre>
</div>
</div>
<div id="5b21118c" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb67"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb67-1"><a href="#cb67-1" aria-hidden="true" tabindex="-1"></a>r2.value</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display cell-output-markdown">
<p>I’ll help you calculate those two sums using the addition tool.</p>
<p>Let me break down what I need to do: 1. Calculate 5478954793 + 547982745 2. Calculate 5479749754 + 9875438979</p>
<p>Since these are independent calculations, I’ll perform both additions at once.</p>
<p>🔧 simple_add({“a”: 5478954793, “b”: 547982745})</p>
<p>🔧 simple_add({“a”: 5479749754, “b”: 9875438979})</p>
<details>
<ul>
<li>id: <code>chatcmpl-xxx</code></li>
<li>model: <code>claude-sonnet-4-5</code></li>
<li>finish_reason: <code>tool_calls</code></li>
<li>usage: <code>Usage(completion_tokens=206, prompt_tokens=659, total_tokens=865, completion_tokens_details=CompletionTokensDetailsWrapper(accepted_prediction_tokens=None, audio_tokens=None, reasoning_tokens=0, rejected_prediction_tokens=None, text_tokens=None), prompt_tokens_details=None)</code></li>
</ul>
</details>
</div>
</div>
<div id="f355ecbe" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb68"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb68-1"><a href="#cb68-1" aria-hidden="true" tabindex="-1"></a>msg <span class="op">=</span> mk_msg(<span class="st">"Solve this complex math problem: What is the derivative of x^3 + 2x^2 - 5x + 1?"</span>)</span>
<span id="cb68-2"><a href="#cb68-2" aria-hidden="true" tabindex="-1"></a>r <span class="op">=</span> c(msg, stream<span class="op">=</span><span class="va">True</span>, reasoning_effort<span class="op">=</span><span class="st">"low"</span>)</span>
<span id="cb68-3"><a href="#cb68-3" aria-hidden="true" tabindex="-1"></a>r2 <span class="op">=</span> SaveReturn(stream_with_complete(r))</span>
<span id="cb68-4"><a href="#cb68-4" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> o <span class="kw">in</span> r2: <span class="bu">print</span>(delta_text(o) <span class="kw">or</span> <span class="st">''</span>, end<span class="op">=</span><span class="st">''</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>🧠🧠🧠🧠🧠🧠🧠🧠🧠🧠🧠🧠🧠🧠🧠🧠🧠🧠🧠🧠🧠🧠

# Derivative Solution

To find the derivative of **f(x) = x³ + 2x² - 5x + 1**, I'll apply the power rule to each term.

## Using the Power Rule: d/dx(xⁿ) = n·xⁿ⁻¹

**Term by term:**
- d/dx(x³) = 3x²
- d/dx(2x²) = 4x
- d/dx(-5x) = -5
- d/dx(1) = 0

## Answer:
**f'(x) = 3x² + 4x - 5**</code></pre>
</div>
</div>
<div id="30ff5f1a" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb70"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb70-1"><a href="#cb70-1" aria-hidden="true" tabindex="-1"></a>r2.value</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<section id="derivative-solution" class="level1 cell-output cell-output-display cell-output-markdown">
<h1>Derivative Solution</h1>
<p>To find the derivative of <strong>f(x) = x³ + 2x² - 5x + 1</strong>, I’ll apply the power rule to each term.</p>
<section id="using-the-power-rule-ddxxⁿ-nxⁿ¹" class="level2">
<h2 class="anchored" data-anchor-id="using-the-power-rule-ddxxⁿ-nxⁿ¹">Using the Power Rule: d/dx(xⁿ) = n·xⁿ⁻¹</h2>
<p><strong>Term by term:</strong> - d/dx(x³) = 3x² - d/dx(2x²) = 4x - d/dx(-5x) = -5 - d/dx(1) = 0</p>
</section>
<section id="answer" class="level2">
<h2 class="anchored" data-anchor-id="answer">Answer:</h2>
<p><strong>f’(x) = 3x² + 4x - 5</strong></p>
<details>
<ul>
<li>id: <code>chatcmpl-xxx</code></li>
<li>model: <code>claude-sonnet-4-5</code></li>
<li>finish_reason: <code>stop</code></li>
<li>usage: <code>Usage(completion_tokens=328, prompt_tokens=66, total_tokens=394, completion_tokens_details=CompletionTokensDetailsWrapper(accepted_prediction_tokens=None, audio_tokens=None, reasoning_tokens=148, rejected_prediction_tokens=None, text_tokens=None), prompt_tokens_details=None)</code></li>
</ul>
</details>
</section>
</section>
</div>
</section>
</section>
<section id="search" class="level2">
<h2 class="anchored" data-anchor-id="search">Search</h2>
<p>LiteLLM provides search, not via tools, but via the special <code>web_search_options</code> param.</p>
<p><strong>Note:</strong> Not all models support web search. LiteLLM’s <code>supports_web_search</code> field should indicate this, but it’s unreliable for some models like <code>claude-sonnet-4-20250514</code>. Checking both <code>supports_web_search</code> and <code>search_context_cost_per_query</code> provides more accurate detection.</p>
<div id="43417017" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb71"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb71-1"><a href="#cb71-1" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> m <span class="kw">in</span> ms: <span class="bu">print</span>(m, _has_search(m))</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>gemini/gemini-2.5-flash True
claude-sonnet-4-5 True
openai/gpt-4.1 False</code></pre>
</div>
</div>
<p>When search is supported it can be used like this:</p>
<div id="89e0bead" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb73"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb73-1"><a href="#cb73-1" aria-hidden="true" tabindex="-1"></a>smsg <span class="op">=</span> mk_msg(<span class="st">"Search the web and tell me very briefly about otters"</span>)</span>
<span id="cb73-2"><a href="#cb73-2" aria-hidden="true" tabindex="-1"></a>r <span class="op">=</span> c(smsg, web_search_options<span class="op">=</span>{<span class="st">"search_context_size"</span>: <span class="st">"low"</span>})  <span class="co"># or 'medium' / 'high'</span></span>
<span id="cb73-3"><a href="#cb73-3" aria-hidden="true" tabindex="-1"></a>r</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display cell-output-markdown">
<p>Otters are carnivorous mammals in the subfamily Lutrinae and members of the weasel family. The 14 extant otter species are all semiaquatic, both freshwater and marine. They’re found on every continent except Australia and Antarctica.</p>
<p>Otters are distinguished by their long, slim bodies, powerful webbed feet for swimming, and their dense fur, which keeps them warm and buoyant in water. In fact, otters have the densest fur of any animal—as many as a million hairs per square inch in places.</p>
<p>All otters are expert hunters that eat fish, crustaceans, and other critters. They’re known for being playful animals and sea otters famously use rocks as tools to crack open shellfish. When it’s time to nap, sea otters entangle themselves in kelp so they don’t float away.</p>
<p>Many otter species were historically hunted nearly to extinction for their fur but have since recovered in some areas, though several species remain threatened by pollution and habitat loss.</p>
<details>
<ul>
<li>id: <code>chatcmpl-xxx</code></li>
<li>model: <code>claude-sonnet-4-5-20250929</code></li>
<li>finish_reason: <code>stop</code></li>
<li>usage: <code>Usage(completion_tokens=382, prompt_tokens=18089, total_tokens=18471, completion_tokens_details=None, prompt_tokens_details=PromptTokensDetailsWrapper(audio_tokens=None, cached_tokens=0, text_tokens=None, image_tokens=None), server_tool_use=ServerToolUse(web_search_requests=1), cache_creation_input_tokens=0, cache_read_input_tokens=0)</code></li>
</ul>
</details>
</div>
</div>
</section>
<section id="citations" class="level2">
<h2 class="anchored" data-anchor-id="citations">Citations</h2>
<p>Next, lets handle Anthropic’s search citations.</p>
<p>When not using streaming, all citations are placed in a separate key in the response:</p>
<div id="cf84f8c8" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb74"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb74-1"><a href="#cb74-1" aria-hidden="true" tabindex="-1"></a>r.choices[<span class="dv">0</span>].message.provider_specific_fields[<span class="st">'citations'</span>][<span class="dv">0</span>]</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display">
<pre><code>[{'type': 'web_search_result_location',
  'cited_text': 'Otters are carnivorous mammals in the subfamily Lutrinae. ',
  'url': 'https://en.wikipedia.org/wiki/Otter',
  'title': 'Otter - Wikipedia',
  'encrypted_index': 'Eo8BCioICBgCIiQ4ODk4YTFkYy0yMTNkLTRhNmYtOTljYi03ZTBlNTUzZDc0NWISDMlacTT8THSDML7nuhoMyB3Xp2StEfWJOx72IjATEIYmZbwZDH+a0KRLuOHQx4nipGzmvy//B4ItZEaDN4t55aF0a+SnmlUY390IN18qE+y/CtqixJ/kgvGL2GCYkFhQRxMYBA=='}]</code></pre>
</div>
</div>
<p>However, when streaming the results are not captured this way. Instead, we provide this helper function that adds the citation to the <code>content</code> field in markdown format:</p>
<hr>
<p><a href="https://github.com/AnswerDotAI/lisette/blob/main/lisette/core.py#L212" target="_blank" style="float:right; font-size:smaller">source</a></p>
<section id="cite_footnotes" class="level3">
<h3 class="anchored" data-anchor-id="cite_footnotes">cite_footnotes</h3>
<blockquote class="blockquote">
<pre><code> cite_footnotes (stream_list)</code></pre>
</blockquote>
<p><em>Add markdown footnote citations to stream deltas</em></p>
<hr>
<p><a href="https://github.com/AnswerDotAI/lisette/blob/main/lisette/core.py#L206" target="_blank" style="float:right; font-size:smaller">source</a></p>
</section>
<section id="cite_footnote" class="level3">
<h3 class="anchored" data-anchor-id="cite_footnote">cite_footnote</h3>
<blockquote class="blockquote">
<pre><code> cite_footnote (msg)</code></pre>
</blockquote>
<div id="c2150365" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb78"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb78-1"><a href="#cb78-1" aria-hidden="true" tabindex="-1"></a>r <span class="op">=</span> <span class="bu">list</span>(c(smsg, stream<span class="op">=</span><span class="va">True</span>, web_search_options<span class="op">=</span>{<span class="st">"search_context_size"</span>: <span class="st">"low"</span>}))</span>
<span id="cb78-2"><a href="#cb78-2" aria-hidden="true" tabindex="-1"></a>cite_footnotes(r)</span>
<span id="cb78-3"><a href="#cb78-3" aria-hidden="true" tabindex="-1"></a>stream_chunk_builder(r)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display cell-output-markdown">
<p>Otters are <a href="https://www.nationalgeographic.com/animals/mammals/facts/otters-1" title="Otters, facts and information | National Geographic">*</a> charismatic members of the weasel family, found on every continent except Australia and Antarctica. <a href="https://www.nationalgeographic.com/animals/mammals/facts/otters-1" title="Otters, facts and information | National Geographic">*</a> <a href="https://en.wikipedia.org/wiki/Otter" title="Otter - Wikipedia">*</a> There are 13-14 species in total, ranging from the small-clawed otter to the giant otter.</p>
<p>These aquatic mammals are known for <a href="https://www.nationalgeographic.com/animals/mammals/facts/otters-1" title="Otters, facts and information | National Geographic">*</a> their short ears and noses, elongated bodies, long tails, and soft, dense fur. In fact, <a href="https://www.nationalgeographic.com/animals/mammals/facts/otters-1" title="Otters, facts and information | National Geographic">*</a> otters have the densest fur of any animal—as many as a million hairs per square inch, which keeps them warm in water since they lack blubber.</p>
<p><a href="https://www.nationalgeographic.com/animals/mammals/facts/otters-1" title="Otters, facts and information | National Geographic">*</a> All otters are expert hunters that eat fish, crustaceans, and other critters. <a href="https://www.nationalgeographic.com/animals/mammals/facts/otters-1" title="Otters, facts and information | National Geographic">*</a> Sea otters will float on their backs, place a rock on their chests, then smash mollusks down on it until they break open. <a href="https://www.nationalgeographic.com/animals/mammals/facts/otters-1" title="Otters, facts and information | National Geographic">*</a> River otters are especially playful, gamboling on land and splashing into rivers and streams. They’re highly adapted for water with webbed feet, and <a href="https://www.doi.gov/blog/12-facts-about-otters-sea-otter-awareness-week" title="12 Facts About Otters for Sea Otter Awareness Week | U.S. Department of the Interior">*</a> can stay submerged for more than 5 minutes, with river otters able to hold their breath for up to 8 minutes.</p>
<details>
<ul>
<li>id: <code>chatcmpl-xxx</code></li>
<li>model: <code>claude-sonnet-4-5</code></li>
<li>finish_reason: <code>stop</code></li>
<li>usage: <code>Usage(completion_tokens=431, prompt_tokens=15055, total_tokens=15486, completion_tokens_details=CompletionTokensDetailsWrapper(accepted_prediction_tokens=None, audio_tokens=None, reasoning_tokens=0, rejected_prediction_tokens=None, text_tokens=None), prompt_tokens_details=None)</code></li>
</ul>
</details>
</div>
</div>
</section>
</section>
</section>
<section id="chat" class="level1">
<h1>Chat</h1>
<p>LiteLLM is pretty bare bones. It doesnt keep track of conversation history or what tools have been added in the conversation so far.</p>
<p>So lets make a Claudette style wrapper so we can do streaming, toolcalling, and toolloops without problems.</p>
<p>When the tool uses are about to be exhausted it is important to alert the AI so that it knows to use its final steps for communicating the user current progress and next steps</p>
<hr>
<p><a href="https://github.com/AnswerDotAI/lisette/blob/main/lisette/core.py#L226" target="_blank" style="float:right; font-size:smaller">source</a></p>
<section id="chat-1" class="level3">
<h3 class="anchored" data-anchor-id="chat-1">Chat</h3>
<blockquote class="blockquote">
<pre><code> Chat (model:str, sp='', temp=0, search=False, tools:list=None,
       hist:list=None, ns:Optional[dict]=None, cache=False,
       cache_idxs:list=[-1], ttl=None)</code></pre>
</blockquote>
<p><em>LiteLLM chat client.</em></p>
<table class="caption-top table">
<colgroup>
<col style="width: 6%">
<col style="width: 25%">
<col style="width: 34%">
<col style="width: 34%">
</colgroup>
<thead>
<tr class="header">
<th></th>
<th><strong>Type</strong></th>
<th><strong>Default</strong></th>
<th><strong>Details</strong></th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>model</td>
<td>str</td>
<td></td>
<td>LiteLLM compatible model name</td>
</tr>
<tr class="even">
<td>sp</td>
<td>str</td>
<td></td>
<td>System prompt</td>
</tr>
<tr class="odd">
<td>temp</td>
<td>int</td>
<td>0</td>
<td>Temperature</td>
</tr>
<tr class="even">
<td>search</td>
<td>bool</td>
<td>False</td>
<td>Search (l,m,h), if model supports it</td>
</tr>
<tr class="odd">
<td>tools</td>
<td>list</td>
<td>None</td>
<td>Add tools</td>
</tr>
<tr class="even">
<td>hist</td>
<td>list</td>
<td>None</td>
<td>Chat history</td>
</tr>
<tr class="odd">
<td>ns</td>
<td>Optional</td>
<td>None</td>
<td>Custom namespace for tool calling</td>
</tr>
<tr class="even">
<td>cache</td>
<td>bool</td>
<td>False</td>
<td>Anthropic prompt caching</td>
</tr>
<tr class="odd">
<td>cache_idxs</td>
<td>list</td>
<td>[-1]</td>
<td>Anthropic cache breakpoint idxs, use <code>0</code> for sys prompt if provided</td>
</tr>
<tr class="even">
<td>ttl</td>
<td>NoneType</td>
<td>None</td>
<td>Anthropic prompt caching ttl</td>
</tr>
</tbody>
</table>
<div id="69419bb7" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb80"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb80-1"><a href="#cb80-1" aria-hidden="true" tabindex="-1"></a><span class="at">@patch</span>(as_prop<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb80-2"><a href="#cb80-2" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> cost(<span class="va">self</span>: Chat):</span>
<span id="cb80-3"><a href="#cb80-3" aria-hidden="true" tabindex="-1"></a>    <span class="co">"Total cost of all responses in conversation history"</span></span>
<span id="cb80-4"><a href="#cb80-4" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> <span class="bu">sum</span>(<span class="bu">getattr</span>(r, <span class="st">'_hidden_params'</span>, {}).get(<span class="st">'response_cost'</span>)  <span class="kw">or</span> <span class="dv">0</span></span>
<span id="cb80-5"><a href="#cb80-5" aria-hidden="true" tabindex="-1"></a>               <span class="cf">for</span> r <span class="kw">in</span> <span class="va">self</span>.h <span class="cf">if</span> <span class="bu">hasattr</span>(r, <span class="st">'choices'</span>))</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
</section>
<section id="examples" class="level2">
<h2 class="anchored" data-anchor-id="examples">Examples</h2>
<section id="history-tracking" class="level3">
<h3 class="anchored" data-anchor-id="history-tracking">History tracking</h3>
<div id="957ccd1e" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb81"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb81-1"><a href="#cb81-1" aria-hidden="true" tabindex="-1"></a>chat <span class="op">=</span> Chat(model)</span>
<span id="cb81-2"><a href="#cb81-2" aria-hidden="true" tabindex="-1"></a>res <span class="op">=</span> chat(<span class="st">"Hey my name is Rens"</span>)</span>
<span id="cb81-3"><a href="#cb81-3" aria-hidden="true" tabindex="-1"></a>res</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display cell-output-markdown">
<p>Hey Rens! Nice to meet you. How can I help you today?</p>
<details>
<ul>
<li>id: <code>chatcmpl-xxx</code></li>
<li>model: <code>claude-sonnet-4-5-20250929</code></li>
<li>finish_reason: <code>stop</code></li>
<li>usage: <code>Usage(completion_tokens=20, prompt_tokens=14, total_tokens=34, completion_tokens_details=None, prompt_tokens_details=PromptTokensDetailsWrapper(audio_tokens=None, cached_tokens=0, text_tokens=None, image_tokens=None), cache_creation_input_tokens=0, cache_read_input_tokens=0)</code></li>
</ul>
</details>
</div>
</div>
<div id="5978da56" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb82"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb82-1"><a href="#cb82-1" aria-hidden="true" tabindex="-1"></a>chat(<span class="st">"Whats my name"</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display cell-output-markdown">
<p>Your name is Rens! You told me that when you introduced yourself at the start of our conversation.</p>
<details>
<ul>
<li>id: <code>chatcmpl-xxx</code></li>
<li>model: <code>claude-sonnet-4-5-20250929</code></li>
<li>finish_reason: <code>stop</code></li>
<li>usage: <code>Usage(completion_tokens=25, prompt_tokens=42, total_tokens=67, completion_tokens_details=None, prompt_tokens_details=PromptTokensDetailsWrapper(audio_tokens=None, cached_tokens=0, text_tokens=None, image_tokens=None), cache_creation_input_tokens=0, cache_read_input_tokens=0)</code></li>
</ul>
</details>
</div>
</div>
<p>See now we keep track of history!</p>
<p>History is stored in the <code>hist</code> attribute:</p>
<div id="4a3c29d8" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb83"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb83-1"><a href="#cb83-1" aria-hidden="true" tabindex="-1"></a>chat.hist</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display">
<pre><code>[{'role': 'user', 'content': 'Hey my name is Rens'},
 Message(content='Hey Rens! Nice to meet you. How can I help you today?', role='assistant', tool_calls=None, function_call=None, provider_specific_fields={'citations': None, 'thinking_blocks': None}),
 {'role': 'user', 'content': 'Whats my name'},
 Message(content='Your name is Rens! You told me that when you introduced yourself at the start of our conversation.', role='assistant', tool_calls=None, function_call=None, provider_specific_fields={'citations': None, 'thinking_blocks': None})]</code></pre>
</div>
</div>
<p>You can also pass an old chat history into new Chat objects:</p>
<div id="d9f575f3" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb85"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb85-1"><a href="#cb85-1" aria-hidden="true" tabindex="-1"></a>chat2 <span class="op">=</span> Chat(model, hist<span class="op">=</span>chat.hist)</span>
<span id="cb85-2"><a href="#cb85-2" aria-hidden="true" tabindex="-1"></a>chat2(<span class="st">"What was my name again?"</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display cell-output-markdown">
<p>Your name is Rens! You’ve asked me a couple times now - just checking if I’m paying attention? 😊</p>
<details>
<ul>
<li>id: <code>chatcmpl-xxx</code></li>
<li>model: <code>claude-sonnet-4-5-20250929</code></li>
<li>finish_reason: <code>stop</code></li>
<li>usage: <code>Usage(completion_tokens=30, prompt_tokens=76, total_tokens=106, completion_tokens_details=None, prompt_tokens_details=PromptTokensDetailsWrapper(audio_tokens=None, cached_tokens=0, text_tokens=None, image_tokens=None), cache_creation_input_tokens=0, cache_read_input_tokens=0)</code></li>
</ul>
</details>
</div>
</div>
</section>
<section id="synthetic-history-creation" class="level3">
<h3 class="anchored" data-anchor-id="synthetic-history-creation">Synthetic History Creation</h3>
<p>Lets build chat history step by step. That way we can tweak anything we need to during testing.</p>
<div id="b8ef8d88" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb86"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb86-1"><a href="#cb86-1" aria-hidden="true" tabindex="-1"></a>pr <span class="op">=</span> <span class="st">"What is 5 + 7? Use the tool to calculate it."</span></span>
<span id="cb86-2"><a href="#cb86-2" aria-hidden="true" tabindex="-1"></a>c <span class="op">=</span> Chat(model, tools<span class="op">=</span>[simple_add])</span>
<span id="cb86-3"><a href="#cb86-3" aria-hidden="true" tabindex="-1"></a>res <span class="op">=</span> c(pr)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<hr>
<p><a href="https://github.com/AnswerDotAI/lisette/blob/main/lisette/core.py#L308" target="_blank" style="float:right; font-size:smaller">source</a></p>
</section>
<section id="chat.print_hist" class="level3">
<h3 class="anchored" data-anchor-id="chat.print_hist">Chat.print_hist</h3>
<blockquote class="blockquote">
<pre><code> Chat.print_hist ()</code></pre>
</blockquote>
<p><em>Print each message on a different line</em></p>
<p>Whereas normally without tools we would get one user input and one assistant response. Here we get two extra messages in between. - An assistant message requesting the tools with arguments. - A tool response with the result to the tool call.</p>
<div id="49792a9c" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb88"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb88-1"><a href="#cb88-1" aria-hidden="true" tabindex="-1"></a>c.print_hist()</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>{'role': 'user', 'content': 'What is 5 + 7? Use the tool to calculate it.'}

Message(content=None, role='assistant', tool_calls=[{'index': 0, 'function': {'arguments': '{"a": 5, "b": 7}', 'name': 'simple_add'}, 'id': 'toolu_012bi9eSyzhwaG3TgGpytJbc', 'type': 'function'}], function_call=None, provider_specific_fields={'citations': None, 'thinking_blocks': None})

{'tool_call_id': 'toolu_012bi9eSyzhwaG3TgGpytJbc', 'role': 'tool', 'name': 'simple_add', 'content': '12'}

{'role': 'assistant', 'content': 'You have no more tool uses. Please summarize your findings. If you did not complete your goal please tell the user what further work needs to be done so they can choose how best to proceed.'}

Message(content='\n\nThe result of 5 + 7 is **12**.', role='assistant', tool_calls=None, function_call=None, provider_specific_fields={'citations': None, 'thinking_blocks': None})
</code></pre>
</div>
</div>
<p>Lets try to build this up manually so we have full control over the inputs.</p>
<hr>
<p><a href="https://github.com/AnswerDotAI/lisette/blob/main/lisette/core.py#L313" target="_blank" style="float:right; font-size:smaller">source</a></p>
</section>
<section id="random_tool_id" class="level3">
<h3 class="anchored" data-anchor-id="random_tool_id">random_tool_id</h3>
<blockquote class="blockquote">
<pre><code> random_tool_id ()</code></pre>
</blockquote>
<p><em>Generate a random tool ID with ‘toolu_’ prefix</em></p>
<div id="f4a0bd16" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb91"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb91-1"><a href="#cb91-1" aria-hidden="true" tabindex="-1"></a>random_tool_id()</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display">
<pre><code>'toolu_0UAqFzWsDK4FrUMp48Y3tT3QD'</code></pre>
</div>
</div>
<p>A tool call request can contain one more or more tool calls. Lets make one.</p>
<hr>
<p><a href="https://github.com/AnswerDotAI/lisette/blob/main/lisette/core.py#L319" target="_blank" style="float:right; font-size:smaller">source</a></p>
</section>
<section id="mk_tc" class="level3">
<h3 class="anchored" data-anchor-id="mk_tc">mk_tc</h3>
<blockquote class="blockquote">
<pre><code> mk_tc (func, args, tcid=None, idx=1)</code></pre>
</blockquote>
<div id="324b9182" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb94"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb94-1"><a href="#cb94-1" aria-hidden="true" tabindex="-1"></a>tc <span class="op">=</span> mk_tc(simple_add.<span class="va">__name__</span>, json.dumps(<span class="bu">dict</span>(a<span class="op">=</span><span class="dv">5</span>, b<span class="op">=</span><span class="dv">7</span>)))</span>
<span id="cb94-2"><a href="#cb94-2" aria-hidden="true" tabindex="-1"></a>tc</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display">
<pre><code>{'index': 1,
 'function': {'arguments': '{"a": 5, "b": 7}', 'name': 'simple_add'},
 'id': 'toolu_gAL47D1qXIaSyZPaE1pu1lJo7',
 'type': 'function'}</code></pre>
</div>
</div>
<p>This can then be packged into the full Message object produced by the assitant.</p>
<div id="436abceb" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb96"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb96-1"><a href="#cb96-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> mk_tc_req(content, tcs): <span class="cf">return</span> Message(content<span class="op">=</span>content, role<span class="op">=</span><span class="st">'assistant'</span>, tool_calls<span class="op">=</span>tcs, function_call<span class="op">=</span><span class="va">None</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<div id="94c031e7" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb97"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb97-1"><a href="#cb97-1" aria-hidden="true" tabindex="-1"></a>tc_cts <span class="op">=</span> <span class="st">"I'll use the simple_add tool to calculate 5 + 7 for you."</span></span>
<span id="cb97-2"><a href="#cb97-2" aria-hidden="true" tabindex="-1"></a>tcq <span class="op">=</span> mk_tc_req(tc_cts, [tc])</span>
<span id="cb97-3"><a href="#cb97-3" aria-hidden="true" tabindex="-1"></a>tcq</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display">
<pre><code>Message(content="I'll use the simple_add tool to calculate 5 + 7 for you.", role='assistant', tool_calls=[ChatCompletionMessageToolCall(index=1, function=Function(arguments='{"a": 5, "b": 7}', name='simple_add'), id='toolu_gAL47D1qXIaSyZPaE1pu1lJo7', type='function')], function_call=None, provider_specific_fields=None)</code></pre>
</div>
</div>
<p>Notice how Message instantiation creates a list of ChatCompletionMessageToolCalls by default. When the tools are executed this is converted back to a dictionary, for consistency we want to keep these as dictionaries from the beginning.</p>
<hr>
<p><a href="https://github.com/AnswerDotAI/lisette/blob/main/lisette/core.py#L324" target="_blank" style="float:right; font-size:smaller">source</a></p>
</section>
<section id="mk_tc_req" class="level3">
<h3 class="anchored" data-anchor-id="mk_tc_req">mk_tc_req</h3>
<blockquote class="blockquote">
<pre><code> mk_tc_req (content, tcs)</code></pre>
</blockquote>
<div id="a0d3468d" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb100"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb100-1"><a href="#cb100-1" aria-hidden="true" tabindex="-1"></a>tcq <span class="op">=</span> mk_tc_req(tc_cts, [tc])</span>
<span id="cb100-2"><a href="#cb100-2" aria-hidden="true" tabindex="-1"></a>tcq</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display">
<pre><code>Message(content="I'll use the simple_add tool to calculate 5 + 7 for you.", role='assistant', tool_calls=[{'index': 1, 'function': {'arguments': '{"a": 5, "b": 7}', 'name': 'simple_add'}, 'id': 'toolu_gAL47D1qXIaSyZPaE1pu1lJo7', 'type': 'function'}], function_call=None, provider_specific_fields=None)</code></pre>
</div>
</div>
<div id="b75dc3e7" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb102"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb102-1"><a href="#cb102-1" aria-hidden="true" tabindex="-1"></a>c <span class="op">=</span> Chat(model, tools<span class="op">=</span>[simple_add], hist<span class="op">=</span>[pr, tcq])</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<div id="bd673382" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb103"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb103-1"><a href="#cb103-1" aria-hidden="true" tabindex="-1"></a>c.print_hist()</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>{'role': 'user', 'content': 'What is 5 + 7? Use the tool to calculate it.'}

Message(content="I'll use the simple_add tool to calculate 5 + 7 for you.", role='assistant', tool_calls=[{'index': 1, 'function': {'arguments': '{"a": 5, "b": 7}', 'name': 'simple_add'}, 'id': 'toolu_gAL47D1qXIaSyZPaE1pu1lJo7', 'type': 'function'}], function_call=None, provider_specific_fields=None)
</code></pre>
</div>
</div>
<p>Looks good so far! Now we will want to provide the actual result!</p>
<hr>
<p><a href="https://github.com/AnswerDotAI/lisette/blob/main/lisette/core.py#L330" target="_blank" style="float:right; font-size:smaller">source</a></p>
</section>
<section id="mk_tc_result" class="level3">
<h3 class="anchored" data-anchor-id="mk_tc_result">mk_tc_result</h3>
<blockquote class="blockquote">
<pre><code> mk_tc_result (tc, result)</code></pre>
</blockquote>
<p>Note we might have more than one tool call if more than one was passed in, here we just will make one result.</p>
<div id="175b9d78" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb106"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb106-1"><a href="#cb106-1" aria-hidden="true" tabindex="-1"></a>tcq.tool_calls[<span class="dv">0</span>]</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display">
<pre><code>{'index': 1,
 'function': {'arguments': '{"a": 5, "b": 7}', 'name': 'simple_add'},
 'id': 'toolu_gAL47D1qXIaSyZPaE1pu1lJo7',
 'type': 'function'}</code></pre>
</div>
</div>
<div id="6f969e27" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb108"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb108-1"><a href="#cb108-1" aria-hidden="true" tabindex="-1"></a>mk_tc_result(tcq.tool_calls[<span class="dv">0</span>], <span class="st">'12'</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display">
<pre><code>{'tool_call_id': 'toolu_gAL47D1qXIaSyZPaE1pu1lJo7',
 'role': 'tool',
 'name': 'simple_add',
 'content': '12'}</code></pre>
</div>
</div>
<hr>
<p><a href="https://github.com/AnswerDotAI/lisette/blob/main/lisette/core.py#L333" target="_blank" style="float:right; font-size:smaller">source</a></p>
</section>
<section id="mk_tc_results" class="level3">
<h3 class="anchored" data-anchor-id="mk_tc_results">mk_tc_results</h3>
<blockquote class="blockquote">
<pre><code> mk_tc_results (tcq, results)</code></pre>
</blockquote>
<p>Same for here tcq.tool_calls will match the number of results passed in the results list.</p>
<div id="bd6e2307" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb111"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb111-1"><a href="#cb111-1" aria-hidden="true" tabindex="-1"></a>tcq</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display">
<pre><code>Message(content="I'll use the simple_add tool to calculate 5 + 7 for you.", role='assistant', tool_calls=[{'index': 1, 'function': {'arguments': '{"a": 5, "b": 7}', 'name': 'simple_add'}, 'id': 'toolu_gAL47D1qXIaSyZPaE1pu1lJo7', 'type': 'function'}], function_call=None, provider_specific_fields=None)</code></pre>
</div>
</div>
<div id="59c2f72e" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb113"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb113-1"><a href="#cb113-1" aria-hidden="true" tabindex="-1"></a>tcr <span class="op">=</span> mk_tc_results(tcq, [<span class="st">'12'</span>])</span>
<span id="cb113-2"><a href="#cb113-2" aria-hidden="true" tabindex="-1"></a>tcr</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display">
<pre><code>[{'tool_call_id': 'toolu_gAL47D1qXIaSyZPaE1pu1lJo7',
  'role': 'tool',
  'name': 'simple_add',
  'content': '12'}]</code></pre>
</div>
</div>
<p>Now we can call it with this synthetic data to see what the response is!</p>
<div id="efed96b7" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb115"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb115-1"><a href="#cb115-1" aria-hidden="true" tabindex="-1"></a>c(tcr[<span class="dv">0</span>])</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display cell-output-markdown">
<p>The result of 5 + 7 is <strong>12</strong>.</p>
<details>
<ul>
<li>id: <code>chatcmpl-xxx</code></li>
<li>model: <code>claude-sonnet-4-5-20250929</code></li>
<li>finish_reason: <code>stop</code></li>
<li>usage: <code>Usage(completion_tokens=17, prompt_tokens=720, total_tokens=737, completion_tokens_details=None, prompt_tokens_details=PromptTokensDetailsWrapper(audio_tokens=None, cached_tokens=0, text_tokens=None, image_tokens=None), cache_creation_input_tokens=0, cache_read_input_tokens=0)</code></li>
</ul>
</details>
</div>
</div>
<div id="db8e06d6" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb116"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb116-1"><a href="#cb116-1" aria-hidden="true" tabindex="-1"></a>c.print_hist()</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>{'role': 'user', 'content': 'What is 5 + 7? Use the tool to calculate it.'}

Message(content="I'll use the simple_add tool to calculate 5 + 7 for you.", role='assistant', tool_calls=[{'index': 1, 'function': {'arguments': '{"a": 5, "b": 7}', 'name': 'simple_add'}, 'id': 'toolu_gAL47D1qXIaSyZPaE1pu1lJo7', 'type': 'function'}], function_call=None, provider_specific_fields=None)

{'tool_call_id': 'toolu_gAL47D1qXIaSyZPaE1pu1lJo7', 'role': 'tool', 'name': 'simple_add', 'content': '12'}

Message(content='The result of 5 + 7 is **12**.', role='assistant', tool_calls=None, function_call=None, provider_specific_fields={'citations': None, 'thinking_blocks': None})
</code></pre>
</div>
</div>
<p>Lets try this again, but lets give it something that is clearly wrong for fun.</p>
<div id="01a9049c" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb118"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb118-1"><a href="#cb118-1" aria-hidden="true" tabindex="-1"></a>c <span class="op">=</span> Chat(model, tools<span class="op">=</span>[simple_add], hist<span class="op">=</span>[pr, tcq])</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<div id="59f546c0" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb119"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb119-1"><a href="#cb119-1" aria-hidden="true" tabindex="-1"></a>tcr <span class="op">=</span> mk_tc_results(tcq, [<span class="st">'13'</span>])</span>
<span id="cb119-2"><a href="#cb119-2" aria-hidden="true" tabindex="-1"></a>tcr</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display">
<pre><code>[{'tool_call_id': 'toolu_gAL47D1qXIaSyZPaE1pu1lJo7',
  'role': 'tool',
  'name': 'simple_add',
  'content': '13'}]</code></pre>
</div>
</div>
<div id="f7befdf1" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb121"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb121-1"><a href="#cb121-1" aria-hidden="true" tabindex="-1"></a>c(tcr[<span class="dv">0</span>])</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display cell-output-markdown">
<p>The result of 5 + 7 is <strong>12</strong>.</p>
<details>
<ul>
<li>id: <code>chatcmpl-xxx</code></li>
<li>model: <code>claude-sonnet-4-5-20250929</code></li>
<li>finish_reason: <code>stop</code></li>
<li>usage: <code>Usage(completion_tokens=17, prompt_tokens=720, total_tokens=737, completion_tokens_details=None, prompt_tokens_details=PromptTokensDetailsWrapper(audio_tokens=None, cached_tokens=0, text_tokens=None, image_tokens=None), cache_creation_input_tokens=0, cache_read_input_tokens=0)</code></li>
</ul>
</details>
</div>
</div>
<p>Lets make sure this works with multiple tool calls in the same assistant Message.</p>
<div id="027f9a15" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb122"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb122-1"><a href="#cb122-1" aria-hidden="true" tabindex="-1"></a>tcs <span class="op">=</span> [</span>
<span id="cb122-2"><a href="#cb122-2" aria-hidden="true" tabindex="-1"></a>    mk_tc(simple_add.<span class="va">__name__</span>, json.dumps({<span class="st">"a"</span>: <span class="dv">5</span>, <span class="st">"b"</span>: <span class="dv">7</span>})), </span>
<span id="cb122-3"><a href="#cb122-3" aria-hidden="true" tabindex="-1"></a>    mk_tc(simple_add.<span class="va">__name__</span>, json.dumps({<span class="st">"a"</span>: <span class="dv">6</span>, <span class="st">"b"</span>: <span class="dv">7</span>})), </span>
<span id="cb122-4"><a href="#cb122-4" aria-hidden="true" tabindex="-1"></a>]</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<div id="44baa92b" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb123"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb123-1"><a href="#cb123-1" aria-hidden="true" tabindex="-1"></a>tcq <span class="op">=</span> mk_tc_req(<span class="st">"I will calculate these for you!"</span>, tcs)</span>
<span id="cb123-2"><a href="#cb123-2" aria-hidden="true" tabindex="-1"></a>tcq</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display">
<pre><code>Message(content='I will calculate these for you!', role='assistant', tool_calls=[{'index': 1, 'function': {'arguments': '{"a": 5, "b": 7}', 'name': 'simple_add'}, 'id': 'toolu_XBetF5gIRHYH7LKBKxJsllLOD', 'type': 'function'}, {'index': 1, 'function': {'arguments': '{"a": 6, "b": 7}', 'name': 'simple_add'}, 'id': 'toolu_fU25035HyRrY03K6JBO94XfLE', 'type': 'function'}], function_call=None, provider_specific_fields=None)</code></pre>
</div>
</div>
<div id="2abb6a8f" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb125"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb125-1"><a href="#cb125-1" aria-hidden="true" tabindex="-1"></a>tcr <span class="op">=</span> mk_tc_results(tcq, [<span class="st">'12'</span>, <span class="st">'13'</span>])</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<div id="866aa31d" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb126"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb126-1"><a href="#cb126-1" aria-hidden="true" tabindex="-1"></a>c <span class="op">=</span> Chat(model, tools<span class="op">=</span>[simple_add], hist<span class="op">=</span>[pr, tcq, tcr[<span class="dv">0</span>]])</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<div id="5a9d9ecd" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb127"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb127-1"><a href="#cb127-1" aria-hidden="true" tabindex="-1"></a>c(tcr[<span class="dv">1</span>])</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display cell-output-markdown">
<p>5 + 7 = <strong>12</strong></p>
<details>
<ul>
<li>id: <code>chatcmpl-xxx</code></li>
<li>model: <code>claude-sonnet-4-5-20250929</code></li>
<li>finish_reason: <code>stop</code></li>
<li>usage: <code>Usage(completion_tokens=13, prompt_tokens=812, total_tokens=825, completion_tokens_details=None, prompt_tokens_details=PromptTokensDetailsWrapper(audio_tokens=None, cached_tokens=0, text_tokens=None, image_tokens=None), cache_creation_input_tokens=0, cache_read_input_tokens=0)</code></li>
</ul>
</details>
</div>
</div>
<div id="ee111193" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb128"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb128-1"><a href="#cb128-1" aria-hidden="true" tabindex="-1"></a>c.print_hist()</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>{'role': 'user', 'content': 'What is 5 + 7? Use the tool to calculate it.'}

Message(content='I will calculate these for you!', role='assistant', tool_calls=[{'index': 1, 'function': {'arguments': '{"a": 5, "b": 7}', 'name': 'simple_add'}, 'id': 'toolu_XBetF5gIRHYH7LKBKxJsllLOD', 'type': 'function'}, {'index': 1, 'function': {'arguments': '{"a": 6, "b": 7}', 'name': 'simple_add'}, 'id': 'toolu_fU25035HyRrY03K6JBO94XfLE', 'type': 'function'}], function_call=None, provider_specific_fields=None)

{'tool_call_id': 'toolu_XBetF5gIRHYH7LKBKxJsllLOD', 'role': 'tool', 'name': 'simple_add', 'content': '12'}

{'tool_call_id': 'toolu_fU25035HyRrY03K6JBO94XfLE', 'role': 'tool', 'name': 'simple_add', 'content': '13'}

Message(content='5 + 7 = **12**', role='assistant', tool_calls=None, function_call=None, provider_specific_fields={'citations': None, 'thinking_blocks': None})
</code></pre>
</div>
</div>
<div id="3e5b97b6" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb130"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb130-1"><a href="#cb130-1" aria-hidden="true" tabindex="-1"></a>chat <span class="op">=</span> Chat(ms[<span class="dv">1</span>], tools<span class="op">=</span>[simple_add])</span>
<span id="cb130-2"><a href="#cb130-2" aria-hidden="true" tabindex="-1"></a>res <span class="op">=</span> chat(<span class="st">"What's 5 + 3? Use the `simple_add` tool."</span>)</span>
<span id="cb130-3"><a href="#cb130-3" aria-hidden="true" tabindex="-1"></a>res</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display cell-output-markdown">
<p>The result of 5 + 3 is <strong>8</strong>.</p>
<details>
<ul>
<li>id: <code>chatcmpl-xxx</code></li>
<li>model: <code>claude-sonnet-4-5-20250929</code></li>
<li>finish_reason: <code>stop</code></li>
<li>usage: <code>Usage(completion_tokens=18, prompt_tokens=742, total_tokens=760, completion_tokens_details=None, prompt_tokens_details=PromptTokensDetailsWrapper(audio_tokens=None, cached_tokens=0, text_tokens=None, image_tokens=None), cache_creation_input_tokens=0, cache_read_input_tokens=0)</code></li>
</ul>
</details>
</div>
</div>
<div id="6c84d6ef" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb131"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb131-1"><a href="#cb131-1" aria-hidden="true" tabindex="-1"></a>res <span class="op">=</span> chat(<span class="st">"Now, tell me a joke based on that result."</span>)</span>
<span id="cb131-2"><a href="#cb131-2" aria-hidden="true" tabindex="-1"></a>res</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display cell-output-markdown">
<p>Here’s a joke based on the number 8:</p>
<p>Why was 6 afraid of 7?</p>
<p>Because 7 8 (ate) 9!</p>
<p>But since we got 8 as our answer, here’s another one:</p>
<p>What do you call an 8 that’s been working out?</p>
<p>An “ate” with great figure! 💪</p>
<p>(Get it? Because 8 already has a great figure with those curves!)</p>
<details>
<ul>
<li>id: <code>chatcmpl-xxx</code></li>
<li>model: <code>claude-sonnet-4-5-20250929</code></li>
<li>finish_reason: <code>stop</code></li>
<li>usage: <code>Usage(completion_tokens=100, prompt_tokens=774, total_tokens=874, completion_tokens_details=None, prompt_tokens_details=PromptTokensDetailsWrapper(audio_tokens=None, cached_tokens=0, text_tokens=None, image_tokens=None), cache_creation_input_tokens=0, cache_read_input_tokens=0)</code></li>
</ul>
</details>
</div>
</div>
<div id="d6a8bec1" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb132"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb132-1"><a href="#cb132-1" aria-hidden="true" tabindex="-1"></a>chat.hist</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display">
<pre><code>[{'role': 'user', 'content': "What's 5 + 3? Use the `simple_add` tool."},
 Message(content=None, role='assistant', tool_calls=[{'index': 0, 'function': {'arguments': '{"a": 5, "b": 3}', 'name': 'simple_add'}, 'id': 'toolu_016dgFwdeaQXSwLPnJzufcWq', 'type': 'function'}], function_call=None, provider_specific_fields={'citations': None, 'thinking_blocks': None}),
 {'tool_call_id': 'toolu_016dgFwdeaQXSwLPnJzufcWq',
  'role': 'tool',
  'name': 'simple_add',
  'content': '8'},
 {'role': 'assistant',
  'content': 'You have no more tool uses. Please summarize your findings. If you did not complete your goal please tell the user what further work needs to be done so they can choose how best to proceed.'},
 Message(content='\n\nThe result of 5 + 3 is **8**.', role='assistant', tool_calls=None, function_call=None, provider_specific_fields={'citations': None, 'thinking_blocks': None}),
 {'role': 'user', 'content': 'Now, tell me a joke based on that result.'},
 Message(content='Here\'s a joke based on the number 8:\n\nWhy was 6 afraid of 7?\n\nBecause 7 8 (ate) 9!\n\nBut since we got 8 as our answer, here\'s another one:\n\nWhat do you call an 8 that\'s been working out?\n\nAn "ate" with great figure! 💪\n\n(Get it? Because 8 already has a great figure with those curves!)', role='assistant', tool_calls=None, function_call=None, provider_specific_fields={'citations': None, 'thinking_blocks': None})]</code></pre>
</div>
</div>
</section>
<section id="images" class="level3">
<h3 class="anchored">Images</h3>
<div id="60942eeb" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb134"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb134-1"><a href="#cb134-1" aria-hidden="true" tabindex="-1"></a>chat <span class="op">=</span> Chat(ms[<span class="dv">1</span>])</span>
<span id="cb134-2"><a href="#cb134-2" aria-hidden="true" tabindex="-1"></a>chat([<span class="st">'Whats in this img?'</span>,img_fn.read_bytes()])</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<section id="image-description" class="level1 cell-output cell-output-display cell-output-markdown">
<h1>Image Description</h1>
<p>This adorable image shows a <strong>Cavalier King Charles Spaniel puppy</strong> with the classic Blenheim coloring (chestnut and white markings).</p>
<section id="key-features-visible" class="level2">
<h2 class="anchored" data-anchor-id="key-features-visible">Key features visible:</h2>
<ul>
<li><strong>Puppy with expressive brown eyes</strong> looking directly at the camera</li>
<li><strong>Soft, fluffy coat</strong> with rich brown/chestnut patches on the ears and around the eyes</li>
<li><strong>White blaze</strong> down the center of the face</li>
<li><strong>Lying on grass</strong> in what appears to be a garden setting</li>
<li><strong>Purple flowers</strong> (possibly asters) visible in the background</li>
<li>The puppy has a sweet, gentle expression typical of the breed</li>
</ul>
<p>The photo has a warm, professional quality with nice depth of field that keeps the focus on the puppy’s endearing face while softly blurring the floral background.</p>
<details>
<ul>
<li>id: <code>chatcmpl-xxx</code></li>
<li>model: <code>claude-sonnet-4-5-20250929</code></li>
<li>finish_reason: <code>stop</code></li>
<li>usage: <code>Usage(completion_tokens=188, prompt_tokens=105, total_tokens=293, completion_tokens_details=None, prompt_tokens_details=PromptTokensDetailsWrapper(audio_tokens=None, cached_tokens=0, text_tokens=None, image_tokens=None), cache_creation_input_tokens=0, cache_read_input_tokens=0)</code></li>
</ul>
</details>
</section>
</section>
</div>
</section>
<section id="prefill" class="level3">
<h3 class="anchored" data-anchor-id="prefill">Prefill</h3>
<p>Prefill works as expected:</p>
<div id="c034582f" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb135"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb135-1"><a href="#cb135-1" aria-hidden="true" tabindex="-1"></a>chat <span class="op">=</span> Chat(ms[<span class="dv">1</span>])</span>
<span id="cb135-2"><a href="#cb135-2" aria-hidden="true" tabindex="-1"></a>chat(<span class="st">"Spell my name"</span>,prefill<span class="op">=</span><span class="st">"Your name is R E"</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display cell-output-markdown">
<p>Your name is R E D A C T E D</p>
<p>I don’t actually know your name - you haven’t told me what it is yet! If you’d like me to spell your name, please let me know what it is first.</p>
<details>
<ul>
<li>id: <code>chatcmpl-xxx</code></li>
<li>model: <code>claude-sonnet-4-5-20250929</code></li>
<li>finish_reason: <code>stop</code></li>
<li>usage: <code>Usage(completion_tokens=47, prompt_tokens=16, total_tokens=63, completion_tokens_details=None, prompt_tokens_details=PromptTokensDetailsWrapper(audio_tokens=None, cached_tokens=0, text_tokens=None, image_tokens=None), cache_creation_input_tokens=0, cache_read_input_tokens=0)</code></li>
</ul>
</details>
</div>
</div>
<p>And the entire message is stored in the history, not just the generated part:</p>
<div id="dfbf54ca" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb136"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb136-1"><a href="#cb136-1" aria-hidden="true" tabindex="-1"></a>chat.hist[<span class="op">-</span><span class="dv">1</span>]</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display">
<pre><code>Message(content="Your name is R E D A C T E D\n\nI don't actually know your name - you haven't told me what it is yet! If you'd like me to spell your name, please let me know what it is first.", role='assistant', tool_calls=None, function_call=None, provider_specific_fields={'citations': None, 'thinking_blocks': None})</code></pre>
</div>
</div>
</section>
<section id="streaming-1" class="level3">
<h3 class="anchored" data-anchor-id="streaming-1">Streaming</h3>
<div id="f02c7ab1" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb138"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb138-1"><a href="#cb138-1" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> time <span class="im">import</span> sleep</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<div id="3fe74496" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb139"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb139-1"><a href="#cb139-1" aria-hidden="true" tabindex="-1"></a>chat <span class="op">=</span> Chat(model)</span>
<span id="cb139-2"><a href="#cb139-2" aria-hidden="true" tabindex="-1"></a>stream_gen <span class="op">=</span> chat(<span class="st">"Count to 5"</span>, stream<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb139-3"><a href="#cb139-3" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> chunk <span class="kw">in</span> stream_gen:</span>
<span id="cb139-4"><a href="#cb139-4" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="bu">isinstance</span>(chunk, ModelResponse): display(chunk)</span>
<span id="cb139-5"><a href="#cb139-5" aria-hidden="true" tabindex="-1"></a>    <span class="cf">else</span>: <span class="bu">print</span>(delta_text(chunk) <span class="kw">or</span> <span class="st">''</span>,end<span class="op">=</span><span class="st">''</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>1, 2, 3, 4, 5</code></pre>
</div>
<div class="cell-output cell-output-display cell-output-markdown">
<p>1, 2, 3, 4, 5</p>
<details>
<ul>
<li>id: <code>chatcmpl-xxx</code></li>
<li>model: <code>claude-sonnet-4-5</code></li>
<li>finish_reason: <code>stop</code></li>
<li>usage: <code>Usage(completion_tokens=17, prompt_tokens=11, total_tokens=28, completion_tokens_details=CompletionTokensDetailsWrapper(accepted_prediction_tokens=None, audio_tokens=None, reasoning_tokens=0, rejected_prediction_tokens=None, text_tokens=None), prompt_tokens_details=None)</code></li>
</ul>
</details>
</div>
</div>
<p>Lets try prefill with streaming too:</p>
<div id="834c058f" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb141"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb141-1"><a href="#cb141-1" aria-hidden="true" tabindex="-1"></a>stream_gen <span class="op">=</span> chat(<span class="st">"Continue counting to 10"</span>,<span class="st">"Okay! 6, 7"</span>,stream<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb141-2"><a href="#cb141-2" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> chunk <span class="kw">in</span> stream_gen:</span>
<span id="cb141-3"><a href="#cb141-3" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="bu">isinstance</span>(chunk, ModelResponse): display(chunk)</span>
<span id="cb141-4"><a href="#cb141-4" aria-hidden="true" tabindex="-1"></a>    <span class="cf">else</span>: <span class="bu">print</span>(delta_text(chunk) <span class="kw">or</span> <span class="st">''</span>,end<span class="op">=</span><span class="st">''</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>Okay! 6, 7, 8, 9, 10</code></pre>
</div>
<div class="cell-output cell-output-display cell-output-markdown">
<p>Okay! 6, 7, 8, 9, 10</p>
<details>
<ul>
<li>id: <code>chatcmpl-xxx</code></li>
<li>model: <code>claude-sonnet-4-5</code></li>
<li>finish_reason: <code>stop</code></li>
<li>usage: <code>Usage(completion_tokens=12, prompt_tokens=44, total_tokens=56, completion_tokens_details=CompletionTokensDetailsWrapper(accepted_prediction_tokens=None, audio_tokens=None, reasoning_tokens=0, rejected_prediction_tokens=None, text_tokens=None), prompt_tokens_details=None)</code></li>
</ul>
</details>
</div>
</div>
</section>
<section id="tool-use" class="level3">
<h3 class="anchored" data-anchor-id="tool-use">Tool use</h3>
<p>Ok now lets test tool use</p>
<div id="1c4cf429" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb143"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb143-1"><a href="#cb143-1" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> m <span class="kw">in</span> ms:</span>
<span id="cb143-2"><a href="#cb143-2" aria-hidden="true" tabindex="-1"></a>    display(Markdown(<span class="ss">f'**</span><span class="sc">{</span>m<span class="sc">}</span><span class="ss">:**'</span>))</span>
<span id="cb143-3"><a href="#cb143-3" aria-hidden="true" tabindex="-1"></a>    chat <span class="op">=</span> Chat(m, tools<span class="op">=</span>[simple_add])</span>
<span id="cb143-4"><a href="#cb143-4" aria-hidden="true" tabindex="-1"></a>    res <span class="op">=</span> chat(<span class="st">"What's 5 + 3? Use the `simple_add` tool. Explain."</span>)</span>
<span id="cb143-5"><a href="#cb143-5" aria-hidden="true" tabindex="-1"></a>    display(res)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display cell-output-markdown">
<p><strong>gemini/gemini-2.5-flash:</strong></p>
</div>
<div class="cell-output cell-output-display cell-output-markdown">
<p>I used the <code>simple_add</code> tool with <code>a=5</code> and <code>b=3</code>. The tool returned <code>8</code>.</p>
<p>Therefore, 5 + 3 = 8.</p>
<details>
<ul>
<li>id: <code>chatcmpl-xxx</code></li>
<li>model: <code>gemini-2.5-flash</code></li>
<li>finish_reason: <code>stop</code></li>
<li>usage: <code>Usage(completion_tokens=118, prompt_tokens=159, total_tokens=277, completion_tokens_details=CompletionTokensDetailsWrapper(accepted_prediction_tokens=None, audio_tokens=None, reasoning_tokens=79, rejected_prediction_tokens=None, text_tokens=39), prompt_tokens_details=PromptTokensDetailsWrapper(audio_tokens=None, cached_tokens=None, text_tokens=159, image_tokens=None))</code></li>
</ul>
</details>
</div>
<div class="cell-output cell-output-display cell-output-markdown">
<p><strong>claude-sonnet-4-5:</strong></p>
</div>
<div class="cell-output cell-output-display cell-output-markdown">
<p><strong>Result: 5 + 3 = 8</strong></p>
<p><strong>Explanation:</strong> The <code>simple_add</code> function takes two parameters: - <code>a</code> (first operand): I provided 5 - <code>b</code> (second operand): I provided 3</p>
<p>The function added these two numbers together and returned 8, which is the correct sum of 5 and 3.</p>
<details>
<ul>
<li>id: <code>chatcmpl-xxx</code></li>
<li>model: <code>claude-sonnet-4-5-20250929</code></li>
<li>finish_reason: <code>stop</code></li>
<li>usage: <code>Usage(completion_tokens=89, prompt_tokens=764, total_tokens=853, completion_tokens_details=None, prompt_tokens_details=PromptTokensDetailsWrapper(audio_tokens=None, cached_tokens=0, text_tokens=None, image_tokens=None), cache_creation_input_tokens=0, cache_read_input_tokens=0)</code></li>
</ul>
</details>
</div>
<div class="cell-output cell-output-display cell-output-markdown">
<p><strong>openai/gpt-4.1:</strong></p>
</div>
<div class="cell-output cell-output-display cell-output-markdown">
<p>The result of 5 + 3 is 8.</p>
<p>Explanation: I used the simple_add tool, which takes two numbers and adds them together. By inputting 5 and 3, the tool calculated the sum as 8.</p>
<details>
<ul>
<li>id: <code>chatcmpl-xxx</code></li>
<li>model: <code>gpt-4.1-2025-04-14</code></li>
<li>finish_reason: <code>stop</code></li>
<li>usage: <code>Usage(completion_tokens=48, prompt_tokens=155, total_tokens=203, completion_tokens_details=CompletionTokensDetailsWrapper(accepted_prediction_tokens=0, audio_tokens=0, reasoning_tokens=0, rejected_prediction_tokens=0, text_tokens=None), prompt_tokens_details=PromptTokensDetailsWrapper(audio_tokens=0, cached_tokens=0, text_tokens=None, image_tokens=None))</code></li>
</ul>
</details>
</div>
</div>
</section>
<section id="thinking-w-tool-use" class="level3">
<h3 class="anchored" data-anchor-id="thinking-w-tool-use">Thinking w tool use</h3>
<div id="62fe375b" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb144"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb144-1"><a href="#cb144-1" aria-hidden="true" tabindex="-1"></a>chat <span class="op">=</span> Chat(model, tools<span class="op">=</span>[simple_add])</span>
<span id="cb144-2"><a href="#cb144-2" aria-hidden="true" tabindex="-1"></a>res <span class="op">=</span> chat(<span class="st">"What's 5 + 3?"</span>,think<span class="op">=</span><span class="st">'l'</span>,return_all<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb144-3"><a href="#cb144-3" aria-hidden="true" tabindex="-1"></a>display(<span class="op">*</span>res)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display cell-output-markdown">
<p>🔧 simple_add({“a”: 5, “b”: 3})</p>
<details>
<ul>
<li>id: <code>chatcmpl-xxx</code></li>
<li>model: <code>claude-sonnet-4-5-20250929</code></li>
<li>finish_reason: <code>tool_calls</code></li>
<li>usage: <code>Usage(completion_tokens=125, prompt_tokens=638, total_tokens=763, completion_tokens_details=CompletionTokensDetailsWrapper(accepted_prediction_tokens=None, audio_tokens=None, reasoning_tokens=43, rejected_prediction_tokens=None, text_tokens=None), prompt_tokens_details=PromptTokensDetailsWrapper(audio_tokens=None, cached_tokens=0, text_tokens=None, image_tokens=None), cache_creation_input_tokens=0, cache_read_input_tokens=0)</code></li>
</ul>
</details>
</div>
<div class="cell-output cell-output-display">
<pre><code>{'tool_call_id': 'toolu_01SY1R38L37vhWpgNgQz2B5h',
 'role': 'tool',
 'name': 'simple_add',
 'content': '8'}</code></pre>
</div>
<div class="cell-output cell-output-display cell-output-markdown">
<p>5 + 3 = <strong>8</strong></p>
<details>
<ul>
<li>id: <code>chatcmpl-xxx</code></li>
<li>model: <code>claude-sonnet-4-5-20250929</code></li>
<li>finish_reason: <code>stop</code></li>
<li>usage: <code>Usage(completion_tokens=14, prompt_tokens=816, total_tokens=830, completion_tokens_details=None, prompt_tokens_details=PromptTokensDetailsWrapper(audio_tokens=None, cached_tokens=0, text_tokens=None, image_tokens=None), cache_creation_input_tokens=0, cache_read_input_tokens=0)</code></li>
</ul>
</details>
</div>
</div>
</section>
<section id="search-1" class="level3">
<h3 class="anchored" data-anchor-id="search-1">Search</h3>
<div id="afd9a499" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb146"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb146-1"><a href="#cb146-1" aria-hidden="true" tabindex="-1"></a>chat <span class="op">=</span> Chat(model)</span>
<span id="cb146-2"><a href="#cb146-2" aria-hidden="true" tabindex="-1"></a>res <span class="op">=</span> chat(<span class="st">"Search the web and tell me very briefly about otters"</span>, search<span class="op">=</span><span class="st">'l'</span>, stream<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb146-3"><a href="#cb146-3" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> o <span class="kw">in</span> res:</span>
<span id="cb146-4"><a href="#cb146-4" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="bu">isinstance</span>(o, ModelResponse): sleep(<span class="fl">0.01</span>)<span class="op">;</span> display(o)</span>
<span id="cb146-5"><a href="#cb146-5" aria-hidden="true" tabindex="-1"></a>    <span class="cf">else</span>: <span class="bu">print</span>(delta_text(o) <span class="kw">or</span> <span class="st">''</span>,end<span class="op">=</span><span class="st">''</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>Otters are charismatic members of the weasel family found on every continent except Australia and Antarctica. There are 13 species in total, including sea otters and river otters.

These aquatic mammals have elongated bodies, long tails, and soft, dense fur. In fact, otters have the densest fur of any animal—as many as a million hairs per square inch. Webbed feet and powerful tails make otters strong swimmers.

All otters are expert hunters that eat fish, crustaceans, and other critters. Sea otters float on their backs, place a rock on their chest, then smash mollusks down on it until it breaks open. They're also known for being playful animals, engaging in activities like sliding into water on natural slides.</code></pre>
</div>
<div class="cell-output cell-output-display cell-output-markdown">
<p>Otters are <a href="https://www.nationalgeographic.com/animals/mammals/facts/otters-1" title="Otters, facts and information | National Geographic">*</a> charismatic members of the weasel family found on every continent except Australia and Antarctica. <a href="https://www.nationalgeographic.com/animals/mammals/facts/otters-1" title="Otters, facts and information | National Geographic">*</a> There are 13 species in total, including sea otters and river otters.</p>
<p>These aquatic mammals have <a href="https://www.nationalgeographic.com/animals/mammals/facts/otters-1" title="Otters, facts and information | National Geographic">*</a> elongated bodies, long tails, and soft, dense fur. In fact, <a href="https://www.nationalgeographic.com/animals/mammals/facts/otters-1" title="Otters, facts and information | National Geographic">*</a> otters have the densest fur of any animal—as many as a million hairs per square inch. <a href="https://www.nationalgeographic.com/animals/mammals/facts/otters-1" title="Otters, facts and information | National Geographic">*</a> Webbed feet and powerful tails make otters strong swimmers.</p>
<p><a href="https://www.nationalgeographic.com/animals/mammals/facts/otters-1" title="Otters, facts and information | National Geographic">*</a> All otters are expert hunters that eat fish, crustaceans, and other critters. <a href="https://www.nationalgeographic.com/animals/mammals/facts/otters-1" title="Otters, facts and information | National Geographic">*</a> Sea otters float on their backs, place a rock on their chest, then smash mollusks down on it until it breaks open. They’re also known for being <a href="https://en.wikipedia.org/wiki/Otter" title="Otter - Wikipedia">*</a> playful animals, engaging in activities like sliding into water on natural slides.</p>
<details>
<ul>
<li>id: <code>chatcmpl-xxx</code></li>
<li>model: <code>claude-sonnet-4-5</code></li>
<li>finish_reason: <code>stop</code></li>
<li>usage: <code>Usage(completion_tokens=362, prompt_tokens=15055, total_tokens=15417, completion_tokens_details=CompletionTokensDetailsWrapper(accepted_prediction_tokens=None, audio_tokens=None, reasoning_tokens=0, rejected_prediction_tokens=None, text_tokens=None), prompt_tokens_details=None)</code></li>
</ul>
</details>
</div>
</div>
</section>
<section id="multi-tool-calling" class="level3">
<h3 class="anchored" data-anchor-id="multi-tool-calling">Multi tool calling</h3>
<p>We can let the model call multiple tools in sequence using the <code>max_steps</code> parameter.</p>
<div id="662f7aa3" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb148"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb148-1"><a href="#cb148-1" aria-hidden="true" tabindex="-1"></a>chat <span class="op">=</span> Chat(model, tools<span class="op">=</span>[simple_add])</span>
<span id="cb148-2"><a href="#cb148-2" aria-hidden="true" tabindex="-1"></a>res <span class="op">=</span> chat(<span class="st">"What's ((5 + 3)+7)+11? Work step by step"</span>, return_all<span class="op">=</span><span class="va">True</span>, max_steps<span class="op">=</span><span class="dv">5</span>)</span>
<span id="cb148-3"><a href="#cb148-3" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> r <span class="kw">in</span> res: display(r)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display cell-output-markdown">
<p>I’ll solve this step by step using the addition function.</p>
<p><strong>Step 1:</strong> First, let me calculate 5 + 3</p>
<p>🔧 simple_add({“a”: 5, “b”: 3})</p>
<details>
<ul>
<li>id: <code>chatcmpl-xxx</code></li>
<li>model: <code>claude-sonnet-4-5-20250929</code></li>
<li>finish_reason: <code>tool_calls</code></li>
<li>usage: <code>Usage(completion_tokens=100, prompt_tokens=617, total_tokens=717, completion_tokens_details=None, prompt_tokens_details=PromptTokensDetailsWrapper(audio_tokens=None, cached_tokens=0, text_tokens=None, image_tokens=None), cache_creation_input_tokens=0, cache_read_input_tokens=0)</code></li>
</ul>
</details>
</div>
<div class="cell-output cell-output-display">
<pre><code>{'tool_call_id': 'toolu_01SykhkA2BGKXm9J56KCkz2B',
 'role': 'tool',
 'name': 'simple_add',
 'content': '8'}</code></pre>
</div>
<div class="cell-output cell-output-display cell-output-markdown">
<p><strong>Step 2:</strong> Now I’ll add 7 to that result (8 + 7)</p>
<p>🔧 simple_add({“a”: 8, “b”: 7})</p>
<details>
<ul>
<li>id: <code>chatcmpl-xxx</code></li>
<li>model: <code>claude-sonnet-4-5-20250929</code></li>
<li>finish_reason: <code>tool_calls</code></li>
<li>usage: <code>Usage(completion_tokens=93, prompt_tokens=730, total_tokens=823, completion_tokens_details=None, prompt_tokens_details=PromptTokensDetailsWrapper(audio_tokens=None, cached_tokens=0, text_tokens=None, image_tokens=None), cache_creation_input_tokens=0, cache_read_input_tokens=0)</code></li>
</ul>
</details>
</div>
<div class="cell-output cell-output-display">
<pre><code>{'tool_call_id': 'toolu_013LrGqASqf9Bsk38scV5Pu7',
 'role': 'tool',
 'name': 'simple_add',
 'content': '15'}</code></pre>
</div>
<div class="cell-output cell-output-display cell-output-markdown">
<p><strong>Step 3:</strong> Finally, I’ll add 11 to that result (15 + 11)</p>
<p>🔧 simple_add({“a”: 15, “b”: 11})</p>
<details>
<ul>
<li>id: <code>chatcmpl-xxx</code></li>
<li>model: <code>claude-sonnet-4-5-20250929</code></li>
<li>finish_reason: <code>tool_calls</code></li>
<li>usage: <code>Usage(completion_tokens=94, prompt_tokens=836, total_tokens=930, completion_tokens_details=None, prompt_tokens_details=PromptTokensDetailsWrapper(audio_tokens=None, cached_tokens=0, text_tokens=None, image_tokens=None), cache_creation_input_tokens=0, cache_read_input_tokens=0)</code></li>
</ul>
</details>
</div>
<div class="cell-output cell-output-display">
<pre><code>{'tool_call_id': 'toolu_01RtpzYFxji9ZbQJtTjKwaCi',
 'role': 'tool',
 'name': 'simple_add',
 'content': '26'}</code></pre>
</div>
<div class="cell-output cell-output-display cell-output-markdown">
<p><strong>Answer:</strong> ((5 + 3) + 7) + 11 = <strong>26</strong></p>
<p>Here’s the breakdown: - 5 + 3 = 8 - 8 + 7 = 15 - 15 + 11 = 26</p>
<details>
<ul>
<li>id: <code>chatcmpl-xxx</code></li>
<li>model: <code>claude-sonnet-4-5-20250929</code></li>
<li>finish_reason: <code>stop</code></li>
<li>usage: <code>Usage(completion_tokens=67, prompt_tokens=943, total_tokens=1010, completion_tokens_details=None, prompt_tokens_details=PromptTokensDetailsWrapper(audio_tokens=None, cached_tokens=0, text_tokens=None, image_tokens=None), cache_creation_input_tokens=0, cache_read_input_tokens=0)</code></li>
</ul>
</details>
</div>
</div>
<p>Some models support parallel tool calling. I.e. sending multiple tool call requests in one conversation step.</p>
<div id="3ec77539" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb152"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb152-1"><a href="#cb152-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> multiply(a: <span class="bu">int</span>, b: <span class="bu">int</span>) <span class="op">-&gt;</span> <span class="bu">int</span>:</span>
<span id="cb152-2"><a href="#cb152-2" aria-hidden="true" tabindex="-1"></a>    <span class="co">"Multiply two numbers"</span></span>
<span id="cb152-3"><a href="#cb152-3" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> a <span class="op">*</span> b</span>
<span id="cb152-4"><a href="#cb152-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb152-5"><a href="#cb152-5" aria-hidden="true" tabindex="-1"></a>chat <span class="op">=</span> Chat(<span class="st">'openai/gpt-4.1'</span>, tools<span class="op">=</span>[simple_add, multiply])</span>
<span id="cb152-6"><a href="#cb152-6" aria-hidden="true" tabindex="-1"></a>res <span class="op">=</span> chat(<span class="st">"Calculate (5 + 3) * (7 + 2)"</span>, max_steps<span class="op">=</span><span class="dv">5</span>, return_all<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb152-7"><a href="#cb152-7" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> r <span class="kw">in</span> res: display(r)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display cell-output-markdown">
<p>🔧 simple_add({“a”: 5, “b”: 3})</p>
<p>🔧 simple_add({“a”: 7, “b”: 2})</p>
<details>
<ul>
<li>id: <code>chatcmpl-xxx</code></li>
<li>model: <code>gpt-4.1-2025-04-14</code></li>
<li>finish_reason: <code>tool_calls</code></li>
<li>usage: <code>Usage(completion_tokens=52, prompt_tokens=110, total_tokens=162, completion_tokens_details=CompletionTokensDetailsWrapper(accepted_prediction_tokens=0, audio_tokens=0, reasoning_tokens=0, rejected_prediction_tokens=0, text_tokens=None), prompt_tokens_details=PromptTokensDetailsWrapper(audio_tokens=0, cached_tokens=0, text_tokens=None, image_tokens=None))</code></li>
</ul>
</details>
</div>
<div class="cell-output cell-output-display">
<pre><code>{'tool_call_id': 'call_qJXSxYvc2ZVHmyIxqQ9OocWM',
 'role': 'tool',
 'name': 'simple_add',
 'content': '8'}</code></pre>
</div>
<div class="cell-output cell-output-display">
<pre><code>{'tool_call_id': 'call_hCgeAPtd0RhmeADBRWRvY0sG',
 'role': 'tool',
 'name': 'simple_add',
 'content': '9'}</code></pre>
</div>
<div class="cell-output cell-output-display cell-output-markdown">
<p>🔧 multiply({“a”:8,“b”:9})</p>
<details>
<ul>
<li>id: <code>chatcmpl-xxx</code></li>
<li>model: <code>gpt-4.1-2025-04-14</code></li>
<li>finish_reason: <code>tool_calls</code></li>
<li>usage: <code>Usage(completion_tokens=17, prompt_tokens=178, total_tokens=195, completion_tokens_details=CompletionTokensDetailsWrapper(accepted_prediction_tokens=0, audio_tokens=0, reasoning_tokens=0, rejected_prediction_tokens=0, text_tokens=None), prompt_tokens_details=PromptTokensDetailsWrapper(audio_tokens=0, cached_tokens=0, text_tokens=None, image_tokens=None))</code></li>
</ul>
</details>
</div>
<div class="cell-output cell-output-display">
<pre><code>{'tool_call_id': 'call_1nwxhn7RXLNl9FcsS8pfn6OZ',
 'role': 'tool',
 'name': 'multiply',
 'content': '72'}</code></pre>
</div>
<div class="cell-output cell-output-display cell-output-markdown">
<p>(5 + 3) = 8 and (7 + 2) = 9. Multiplying them gives: 8 × 9 = 72.</p>
<p>So, (5 + 3) × (7 + 2) = 72.</p>
<details>
<ul>
<li>id: <code>chatcmpl-xxx</code></li>
<li>model: <code>gpt-4.1-2025-04-14</code></li>
<li>finish_reason: <code>stop</code></li>
<li>usage: <code>Usage(completion_tokens=55, prompt_tokens=203, total_tokens=258, completion_tokens_details=CompletionTokensDetailsWrapper(accepted_prediction_tokens=0, audio_tokens=0, reasoning_tokens=0, rejected_prediction_tokens=0, text_tokens=None), prompt_tokens_details=PromptTokensDetailsWrapper(audio_tokens=0, cached_tokens=0, text_tokens=None, image_tokens=None))</code></li>
</ul>
</details>
</div>
</div>
<p>See it did the additions in one go!</p>
<p>We don’t want the model to keep running tools indefinitely. Lets showcase how we can force thee model to stop after our specified number of toolcall rounds:</p>
<div id="aa7298c0" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb156"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb156-1"><a href="#cb156-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> divide(a: <span class="bu">int</span>, b: <span class="bu">int</span>) <span class="op">-&gt;</span> <span class="bu">float</span>:</span>
<span id="cb156-2"><a href="#cb156-2" aria-hidden="true" tabindex="-1"></a>    <span class="co">"Divide two numbers"</span></span>
<span id="cb156-3"><a href="#cb156-3" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> a <span class="op">/</span> b</span>
<span id="cb156-4"><a href="#cb156-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb156-5"><a href="#cb156-5" aria-hidden="true" tabindex="-1"></a>chat <span class="op">=</span> Chat(model, tools<span class="op">=</span>[simple_add, multiply, divide])</span>
<span id="cb156-6"><a href="#cb156-6" aria-hidden="true" tabindex="-1"></a>res <span class="op">=</span> chat(<span class="st">"Calculate ((10 + 5) * 3) / (2 + 1) step by step."</span>, </span>
<span id="cb156-7"><a href="#cb156-7" aria-hidden="true" tabindex="-1"></a>           max_steps<span class="op">=</span><span class="dv">3</span>, return_all<span class="op">=</span><span class="va">True</span>,</span>
<span id="cb156-8"><a href="#cb156-8" aria-hidden="true" tabindex="-1"></a>           final_prompt<span class="op">=</span><span class="st">"Please wrap-up for now and summarize how far we got."</span>)</span>
<span id="cb156-9"><a href="#cb156-9" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> r <span class="kw">in</span> res: display(r)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display cell-output-markdown">
<p>I’ll calculate this step by step, following the order of operations.</p>
<p><strong>Step 1:</strong> Calculate the inner parentheses first - (10 + 5) = ? - (2 + 1) = ?</p>
<p>🔧 simple_add({“a”: 10, “b”: 5})</p>
<p>🔧 simple_add({“a”: 2, “b”: 1})</p>
<details>
<ul>
<li>id: <code>chatcmpl-xxx</code></li>
<li>model: <code>claude-sonnet-4-5-20250929</code></li>
<li>finish_reason: <code>tool_calls</code></li>
<li>usage: <code>Usage(completion_tokens=173, prompt_tokens=792, total_tokens=965, completion_tokens_details=None, prompt_tokens_details=PromptTokensDetailsWrapper(audio_tokens=None, cached_tokens=0, text_tokens=None, image_tokens=None), cache_creation_input_tokens=0, cache_read_input_tokens=0)</code></li>
</ul>
</details>
</div>
<div class="cell-output cell-output-display">
<pre><code>{'tool_call_id': 'toolu_01NZjJc2q4tMJZcS93T1WQHM',
 'role': 'tool',
 'name': 'simple_add',
 'content': '15'}</code></pre>
</div>
<div class="cell-output cell-output-display">
<pre><code>{'tool_call_id': 'toolu_013qQVARNY8a6shg4zo2TpNr',
 'role': 'tool',
 'name': 'simple_add',
 'content': '3'}</code></pre>
</div>
<div class="cell-output cell-output-display cell-output-markdown">
<p><strong>Step 2:</strong> Multiply 15 * 3</p>
<p>🔧 multiply({“a”: 15, “b”: 3})</p>
<details>
<ul>
<li>id: <code>chatcmpl-xxx</code></li>
<li>model: <code>claude-sonnet-4-5-20250929</code></li>
<li>finish_reason: <code>tool_calls</code></li>
<li>usage: <code>Usage(completion_tokens=82, prompt_tokens=1030, total_tokens=1112, completion_tokens_details=None, prompt_tokens_details=PromptTokensDetailsWrapper(audio_tokens=None, cached_tokens=0, text_tokens=None, image_tokens=None), cache_creation_input_tokens=0, cache_read_input_tokens=0)</code></li>
</ul>
</details>
</div>
<div class="cell-output cell-output-display">
<pre><code>{'tool_call_id': 'toolu_01Uf17eEfZPHcqFo1C3PYZ5E',
 'role': 'tool',
 'name': 'multiply',
 'content': '45'}</code></pre>
</div>
<div class="cell-output cell-output-display cell-output-markdown">
<p><strong>Step 3:</strong> Divide 45 / 3</p>
<details>
<ul>
<li>id: <code>chatcmpl-xxx</code></li>
<li>model: <code>claude-sonnet-4-5-20250929</code></li>
<li>finish_reason: <code>stop</code></li>
<li>usage: <code>Usage(completion_tokens=23, prompt_tokens=1139, total_tokens=1162, completion_tokens_details=None, prompt_tokens_details=PromptTokensDetailsWrapper(audio_tokens=None, cached_tokens=0, text_tokens=None, image_tokens=None), cache_creation_input_tokens=0, cache_read_input_tokens=0)</code></li>
</ul>
</details>
</div>
</div>
</section>
<section id="tool-call-exhaustion" class="level3">
<h3 class="anchored" data-anchor-id="tool-call-exhaustion">Tool call exhaustion</h3>
<div id="f2d02210" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb160"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb160-1"><a href="#cb160-1" aria-hidden="true" tabindex="-1"></a>pr <span class="op">=</span> <span class="st">"What is 1+2, and then the result of adding +2, and then +3 to it? Use tools to calculate!"</span></span>
<span id="cb160-2"><a href="#cb160-2" aria-hidden="true" tabindex="-1"></a>c <span class="op">=</span> Chat(model, tools<span class="op">=</span>[simple_add])</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<div id="4e82a43f" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb161"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb161-1"><a href="#cb161-1" aria-hidden="true" tabindex="-1"></a>res <span class="op">=</span> c(pr, max_steps<span class="op">=</span><span class="dv">2</span>)</span>
<span id="cb161-2"><a href="#cb161-2" aria-hidden="true" tabindex="-1"></a>res</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display cell-output-markdown">
<p>Let me continue with the next calculation. Now I’ll add 2 to the result (3+2):</p>
<details>
<ul>
<li>id: <code>chatcmpl-xxx</code></li>
<li>model: <code>claude-sonnet-4-5-20250929</code></li>
<li>finish_reason: <code>stop</code></li>
<li>usage: <code>Usage(completion_tokens=33, prompt_tokens=777, total_tokens=810, completion_tokens_details=None, prompt_tokens_details=PromptTokensDetailsWrapper(audio_tokens=None, cached_tokens=0, text_tokens=None, image_tokens=None), cache_creation_input_tokens=0, cache_read_input_tokens=0)</code></li>
</ul>
</details>
</div>
</div>
<div id="0b60eaf9" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb162"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb162-1"><a href="#cb162-1" aria-hidden="true" tabindex="-1"></a><span class="cf">assert</span> c.hist[<span class="op">-</span><span class="dv">2</span>][<span class="st">'content'</span>] <span class="op">==</span> _final_prompt</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
</section>
</section>
<section id="async" class="level2">
<h2 class="anchored" data-anchor-id="async">Async</h2>
<section id="asyncchat" class="level3">
<h3 class="anchored" data-anchor-id="asyncchat">AsyncChat</h3>
<p>If you want to use LiteLLM in a webapp you probably want to use their async function <code>acompletion</code>. To make that easier we will implement our version of <a href="https://lisette.answer.ai/core.html#asyncchat"><code>AsyncChat</code></a> to complement it. It follows the same implementation as Chat as much as possible:</p>
<hr>
<p><a href="https://github.com/AnswerDotAI/lisette/blob/main/lisette/core.py#L344" target="_blank" style="float:right; font-size:smaller">source</a></p>
</section>
<section id="astream_with_complete" class="level3">
<h3 class="anchored" data-anchor-id="astream_with_complete">astream_with_complete</h3>
<blockquote class="blockquote">
<pre><code> astream_with_complete (agen, postproc=&lt;function noop&gt;)</code></pre>
</blockquote>
<hr>
<p><a href="https://github.com/AnswerDotAI/lisette/blob/main/lisette/core.py#L353" target="_blank" style="float:right; font-size:smaller">source</a></p>
</section>
<section id="asyncchat-1" class="level3">
<h3 class="anchored" data-anchor-id="asyncchat-1">AsyncChat</h3>
<blockquote class="blockquote">
<pre><code> AsyncChat (model:str, sp='', temp=0, search=False, tools:list=None,
            hist:list=None, ns:Optional[dict]=None, cache=False,
            cache_idxs:list=[-1], ttl=None)</code></pre>
</blockquote>
<p><em>LiteLLM chat client.</em></p>
<table class="caption-top table">
<colgroup>
<col style="width: 6%">
<col style="width: 25%">
<col style="width: 34%">
<col style="width: 34%">
</colgroup>
<thead>
<tr class="header">
<th></th>
<th><strong>Type</strong></th>
<th><strong>Default</strong></th>
<th><strong>Details</strong></th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>model</td>
<td>str</td>
<td></td>
<td>LiteLLM compatible model name</td>
</tr>
<tr class="even">
<td>sp</td>
<td>str</td>
<td></td>
<td>System prompt</td>
</tr>
<tr class="odd">
<td>temp</td>
<td>int</td>
<td>0</td>
<td>Temperature</td>
</tr>
<tr class="even">
<td>search</td>
<td>bool</td>
<td>False</td>
<td>Search (l,m,h), if model supports it</td>
</tr>
<tr class="odd">
<td>tools</td>
<td>list</td>
<td>None</td>
<td>Add tools</td>
</tr>
<tr class="even">
<td>hist</td>
<td>list</td>
<td>None</td>
<td>Chat history</td>
</tr>
<tr class="odd">
<td>ns</td>
<td>Optional</td>
<td>None</td>
<td>Custom namespace for tool calling</td>
</tr>
<tr class="even">
<td>cache</td>
<td>bool</td>
<td>False</td>
<td>Anthropic prompt caching</td>
</tr>
<tr class="odd">
<td>cache_idxs</td>
<td>list</td>
<td>[-1]</td>
<td>Anthropic cache breakpoint idxs, use <code>0</code> for sys prompt if provided</td>
</tr>
<tr class="even">
<td>ttl</td>
<td>NoneType</td>
<td>None</td>
<td>Anthropic prompt caching ttl</td>
</tr>
</tbody>
</table>
</section>
<section id="examples-1" class="level3">
<h3 class="anchored" data-anchor-id="examples-1">Examples</h3>
<p>Basic example</p>
<div id="c142f088" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb165"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb165-1"><a href="#cb165-1" aria-hidden="true" tabindex="-1"></a>chat <span class="op">=</span> AsyncChat(model)</span>
<span id="cb165-2"><a href="#cb165-2" aria-hidden="true" tabindex="-1"></a><span class="cf">await</span> chat(<span class="st">"What is 2+2?"</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display cell-output-markdown">
<p>2+2 = 4</p>
<details>
<ul>
<li>id: <code>chatcmpl-xxx</code></li>
<li>model: <code>claude-sonnet-4-5-20250929</code></li>
<li>finish_reason: <code>stop</code></li>
<li>usage: <code>Usage(completion_tokens=11, prompt_tokens=14, total_tokens=25, completion_tokens_details=None, prompt_tokens_details=PromptTokensDetailsWrapper(audio_tokens=None, cached_tokens=0, text_tokens=None, image_tokens=None), cache_creation_input_tokens=0, cache_read_input_tokens=0)</code></li>
</ul>
</details>
</div>
</div>
<p>With tool calls</p>
<div id="a8e178ea" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb166"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb166-1"><a href="#cb166-1" aria-hidden="true" tabindex="-1"></a><span class="cf">async</span> <span class="kw">def</span> async_add(a: <span class="bu">int</span>, b: <span class="bu">int</span>) <span class="op">-&gt;</span> <span class="bu">int</span>:</span>
<span id="cb166-2"><a href="#cb166-2" aria-hidden="true" tabindex="-1"></a>    <span class="co">"Add two numbers asynchronously"</span></span>
<span id="cb166-3"><a href="#cb166-3" aria-hidden="true" tabindex="-1"></a>    <span class="cf">await</span> asyncio.sleep(<span class="fl">0.1</span>)</span>
<span id="cb166-4"><a href="#cb166-4" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> a <span class="op">+</span> b</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<div id="c14f99c1" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb167"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb167-1"><a href="#cb167-1" aria-hidden="true" tabindex="-1"></a>chat_with_tools <span class="op">=</span> AsyncChat(model, tools<span class="op">=</span>[async_add])</span>
<span id="cb167-2"><a href="#cb167-2" aria-hidden="true" tabindex="-1"></a>res <span class="op">=</span> <span class="cf">await</span> chat_with_tools(<span class="st">"What is 5 + 7? Use the tool to calculate it."</span>, return_all<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb167-3"><a href="#cb167-3" aria-hidden="true" tabindex="-1"></a><span class="cf">async</span> <span class="cf">for</span> r <span class="kw">in</span> res: display(r)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display cell-output-markdown">
<p>🔧 async_add({“a”: 5, “b”: 7})</p>
<details>
<ul>
<li>id: <code>chatcmpl-xxx</code></li>
<li>model: <code>claude-sonnet-4-5-20250929</code></li>
<li>finish_reason: <code>tool_calls</code></li>
<li>usage: <code>Usage(completion_tokens=70, prompt_tokens=607, total_tokens=677, completion_tokens_details=None, prompt_tokens_details=PromptTokensDetailsWrapper(audio_tokens=None, cached_tokens=0, text_tokens=None, image_tokens=None), cache_creation_input_tokens=0, cache_read_input_tokens=0)</code></li>
</ul>
</details>
</div>
<div class="cell-output cell-output-display">
<pre><code>{'tool_call_id': 'toolu_01NHDNkcpwxW66XRuRFChLxe',
 'role': 'tool',
 'name': 'async_add',
 'content': '12'}</code></pre>
</div>
<div class="cell-output cell-output-display cell-output-markdown">
<p>The result of 5 + 7 is <strong>12</strong>.</p>
<details>
<ul>
<li>id: <code>chatcmpl-xxx</code></li>
<li>model: <code>claude-sonnet-4-5-20250929</code></li>
<li>finish_reason: <code>stop</code></li>
<li>usage: <code>Usage(completion_tokens=18, prompt_tokens=731, total_tokens=749, completion_tokens_details=None, prompt_tokens_details=PromptTokensDetailsWrapper(audio_tokens=None, cached_tokens=0, text_tokens=None, image_tokens=None), cache_creation_input_tokens=0, cache_read_input_tokens=0)</code></li>
</ul>
</details>
</div>
</div>
<div id="cd68aff8" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb169"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb169-1"><a href="#cb169-1" aria-hidden="true" tabindex="-1"></a>chat.hist</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display">
<pre><code>[{'role': 'user', 'content': 'What is 2+2?'},
 Message(content='2+2 = 4', role='assistant', tool_calls=None, function_call=None, provider_specific_fields={'citations': None, 'thinking_blocks': None})]</code></pre>
</div>
</div>
</section>
</section>
<section id="async-streaming-display" class="level2">
<h2 class="anchored" data-anchor-id="async-streaming-display">Async Streaming Display</h2>
<p>This is what our outputs look like with streaming results:</p>
<div id="57698c63" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb171"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb171-1"><a href="#cb171-1" aria-hidden="true" tabindex="-1"></a>chat_with_tools <span class="op">=</span> AsyncChat(model, tools<span class="op">=</span>[async_add])</span>
<span id="cb171-2"><a href="#cb171-2" aria-hidden="true" tabindex="-1"></a>res <span class="op">=</span> <span class="cf">await</span> chat_with_tools(<span class="st">"What is 5 + 7? Use the tool to calculate it."</span>, stream<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb171-3"><a href="#cb171-3" aria-hidden="true" tabindex="-1"></a><span class="cf">async</span> <span class="cf">for</span> o <span class="kw">in</span> res:</span>
<span id="cb171-4"><a href="#cb171-4" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="bu">isinstance</span>(o,ModelResponseStream): <span class="bu">print</span>(delta_text(o) <span class="kw">or</span> <span class="st">''</span>,end<span class="op">=</span><span class="st">''</span>)</span>
<span id="cb171-5"><a href="#cb171-5" aria-hidden="true" tabindex="-1"></a>    <span class="cf">elif</span> <span class="bu">isinstance</span>(o,<span class="bu">dict</span>): <span class="bu">print</span>(o)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>
🔧 async_add
{'tool_call_id': 'toolu_011RxwEK3HSc3VQwwsBZnXnV', 'role': 'tool', 'name': 'async_add', 'content': '12'}


The result of 5 + 7 is **12**.</code></pre>
</div>
</div>
<p>We use this one quite a bit so we want to provide some utilities to better format these outputs:</p>
<p>Here’s a complete <code>ModelResponse</code> taken from the response stream:</p>
<div id="5203c123" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb173"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb173-1"><a href="#cb173-1" aria-hidden="true" tabindex="-1"></a>resp <span class="op">=</span> ModelResponse(<span class="bu">id</span><span class="op">=</span><span class="st">'chatcmpl-xxx'</span>, created<span class="op">=</span><span class="dv">1000000000</span>, model<span class="op">=</span><span class="st">'claude-sonnet-4-5'</span>, <span class="bu">object</span><span class="op">=</span><span class="st">'chat.completion'</span>, system_fingerprint<span class="op">=</span><span class="va">None</span>, choices<span class="op">=</span>[Choices(finish_reason<span class="op">=</span><span class="st">'tool_calls'</span>, index<span class="op">=</span><span class="dv">0</span>, message<span class="op">=</span>Message(content<span class="op">=</span><span class="st">"I'll calculate ((10 + 5) * 3) / (2 + 1) step by step:"</span>, role<span class="op">=</span><span class="st">'assistant'</span>, tool_calls<span class="op">=</span>[ChatCompletionMessageToolCall(function<span class="op">=</span>Function(arguments<span class="op">=</span><span class="st">'{"a": 10, "b": 5}'</span>, name<span class="op">=</span><span class="st">'simple_add'</span>), <span class="bu">id</span><span class="op">=</span><span class="st">'toolu_018BGyenjiRkDQFU1jWP6qRo'</span>, <span class="bu">type</span><span class="op">=</span><span class="st">'function'</span>), ChatCompletionMessageToolCall(function<span class="op">=</span>Function(arguments<span class="op">=</span><span class="st">'{"a": 2, "b": 1}'</span>, name<span class="op">=</span><span class="st">'simple_add'</span>), <span class="bu">id</span><span class="op">=</span><span class="st">'toolu_01CWqrNQvoRjf1Q1GLpTUgQR'</span>, <span class="bu">type</span><span class="op">=</span><span class="st">'function'</span>)], function_call<span class="op">=</span><span class="va">None</span>, provider_specific_fields<span class="op">=</span><span class="va">None</span>))], usage<span class="op">=</span>Usage(completion_tokens<span class="op">=</span><span class="dv">228</span>, prompt_tokens<span class="op">=</span><span class="dv">794</span>, total_tokens<span class="op">=</span><span class="dv">1022</span>, prompt_tokens_details<span class="op">=</span><span class="va">None</span>))</span>
<span id="cb173-2"><a href="#cb173-2" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="bu">repr</span>(resp))</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>ModelResponse(id='chatcmpl-xxx', created=1000000000, model='claude-sonnet-4-5', object='chat.completion', system_fingerprint=None, choices=[Choices(finish_reason='tool_calls', index=0, message=Message(content="I'll calculate ((10 + 5) * 3) / (2 + 1) step by step:", role='assistant', tool_calls=[ChatCompletionMessageToolCall(function=Function(arguments='{"a": 10, "b": 5}', name='simple_add'), id='toolu_018BGyenjiRkDQFU1jWP6qRo', type='function'), ChatCompletionMessageToolCall(function=Function(arguments='{"a": 2, "b": 1}', name='simple_add'), id='toolu_01CWqrNQvoRjf1Q1GLpTUgQR', type='function')], function_call=None, provider_specific_fields=None))], usage=Usage(completion_tokens=228, prompt_tokens=794, total_tokens=1022, completion_tokens_details=None, prompt_tokens_details=None))</code></pre>
</div>
</div>
<div id="bc69f062" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb175"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb175-1"><a href="#cb175-1" aria-hidden="true" tabindex="-1"></a>tc<span class="op">=</span>resp.choices[<span class="dv">0</span>].message.tool_calls[<span class="dv">0</span>]</span>
<span id="cb175-2"><a href="#cb175-2" aria-hidden="true" tabindex="-1"></a>tc</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display">
<pre><code>ChatCompletionMessageToolCall(function=Function(arguments='{"a": 10, "b": 5}', name='simple_add'), id='toolu_018BGyenjiRkDQFU1jWP6qRo', type='function')</code></pre>
</div>
</div>
<div id="3a0c0add" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb177"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb177-1"><a href="#cb177-1" aria-hidden="true" tabindex="-1"></a>tr<span class="op">=</span>{<span class="st">'tool_call_id'</span>: <span class="st">'toolu_018BGyenjiRkDQFU1jWP6qRo'</span>, <span class="st">'role'</span>: <span class="st">'tool'</span>,<span class="st">'name'</span>: <span class="st">'simple_add'</span>,</span>
<span id="cb177-2"><a href="#cb177-2" aria-hidden="true" tabindex="-1"></a>    <span class="st">'content'</span>: <span class="st">'15 is the answerrrr'</span> <span class="op">+</span><span class="st">'r'</span><span class="op">*</span><span class="dv">2000</span>}</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<hr>
<p><a href="https://github.com/AnswerDotAI/lisette/blob/main/lisette/core.py#L411" target="_blank" style="float:right; font-size:smaller">source</a></p>
<section id="mk_tr_details" class="level3">
<h3 class="anchored" data-anchor-id="mk_tr_details">mk_tr_details</h3>
<blockquote class="blockquote">
<pre><code> mk_tr_details (tr, tc, mx=2000)</code></pre>
</blockquote>
*Create
<details>
<p>block for tool call as JSON*</p>
<div id="1973a7b6" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb179"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb179-1"><a href="#cb179-1" aria-hidden="true" tabindex="-1"></a>mk_tr_details(tr,tc)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display">
<pre><code>'\n\n&lt;details class=\'tool-usage-details\'&gt;\n\n```json\n{\n  "id": "toolu_018BGyenjiRkDQFU1jWP6qRo",\n  "call": {\n    "function": "simple_add",\n    "arguments": {\n      "a": "10",\n      "b": "5"\n    }\n  },\n  "result": "15 is the answerrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrr&lt;TRUNCATED&gt;"\n}\n```\n\n&lt;/details&gt;\n\n'</code></pre>
</div>
</div>
<hr>
<p><a href="https://github.com/AnswerDotAI/lisette/blob/main/lisette/core.py#L420" target="_blank" style="float:right; font-size:smaller">source</a></p>
</details></section>
<section id="asyncstreamformatter" class="level3">
<h3 class="anchored" data-anchor-id="asyncstreamformatter">AsyncStreamFormatter</h3>
<blockquote class="blockquote">
<pre><code> AsyncStreamFormatter (include_usage=False, mx=2000)</code></pre>
</blockquote>
<p><em>Initialize self. See help(type(self)) for accurate signature.</em></p>
<div id="28ecbcd1" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb182"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb182-1"><a href="#cb182-1" aria-hidden="true" tabindex="-1"></a>stream_msg <span class="op">=</span> ModelResponseStream([StreamingChoices(delta<span class="op">=</span>Delta(content<span class="op">=</span><span class="st">"Hello world!"</span>))])</span>
<span id="cb182-2"><a href="#cb182-2" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="bu">repr</span>(AsyncStreamFormatter().format_item(stream_msg)))</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>'Hello world!'</code></pre>
</div>
</div>
<div id="9fafd181" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb184"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb184-1"><a href="#cb184-1" aria-hidden="true" tabindex="-1"></a>reasoning_msg <span class="op">=</span> ModelResponseStream([StreamingChoices(delta<span class="op">=</span>Delta(reasoning_content<span class="op">=</span><span class="st">"thinking..."</span>))])</span>
<span id="cb184-2"><a href="#cb184-2" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="bu">repr</span>(AsyncStreamFormatter().format_item(reasoning_msg)))</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>'🧠'</code></pre>
</div>
</div>
<div id="f627276d" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb186"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb186-1"><a href="#cb186-1" aria-hidden="true" tabindex="-1"></a>mock_tool_call <span class="op">=</span> ChatCompletionMessageToolCall(</span>
<span id="cb186-2"><a href="#cb186-2" aria-hidden="true" tabindex="-1"></a>    <span class="bu">id</span><span class="op">=</span><span class="st">"toolu_123abc456def"</span>, <span class="bu">type</span><span class="op">=</span><span class="st">"function"</span>, </span>
<span id="cb186-3"><a href="#cb186-3" aria-hidden="true" tabindex="-1"></a>    function<span class="op">=</span>Function( name<span class="op">=</span><span class="st">"simple_add"</span>, arguments<span class="op">=</span><span class="st">'{"a": 5, "b": 3}'</span> )</span>
<span id="cb186-4"><a href="#cb186-4" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb186-5"><a href="#cb186-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb186-6"><a href="#cb186-6" aria-hidden="true" tabindex="-1"></a>mock_response <span class="op">=</span> ModelResponse()</span>
<span id="cb186-7"><a href="#cb186-7" aria-hidden="true" tabindex="-1"></a>mock_response.choices <span class="op">=</span> [<span class="bu">type</span>(<span class="st">'Choice'</span>, (), {</span>
<span id="cb186-8"><a href="#cb186-8" aria-hidden="true" tabindex="-1"></a>    <span class="st">'message'</span>: <span class="bu">type</span>(<span class="st">'Message'</span>, (), {</span>
<span id="cb186-9"><a href="#cb186-9" aria-hidden="true" tabindex="-1"></a>        <span class="st">'tool_calls'</span>: [mock_tool_call]</span>
<span id="cb186-10"><a href="#cb186-10" aria-hidden="true" tabindex="-1"></a>    })()</span>
<span id="cb186-11"><a href="#cb186-11" aria-hidden="true" tabindex="-1"></a>})()]</span>
<span id="cb186-12"><a href="#cb186-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb186-13"><a href="#cb186-13" aria-hidden="true" tabindex="-1"></a>mock_tool_result <span class="op">=</span> {</span>
<span id="cb186-14"><a href="#cb186-14" aria-hidden="true" tabindex="-1"></a>    <span class="st">'tool_call_id'</span>: <span class="st">'toolu_123abc456def'</span>, <span class="st">'role'</span>: <span class="st">'tool'</span>, </span>
<span id="cb186-15"><a href="#cb186-15" aria-hidden="true" tabindex="-1"></a>    <span class="st">'name'</span>: <span class="st">'simple_add'</span>, <span class="st">'content'</span>: <span class="st">'8'</span></span>
<span id="cb186-16"><a href="#cb186-16" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<div id="f9362bb7" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb187"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb187-1"><a href="#cb187-1" aria-hidden="true" tabindex="-1"></a>fmt <span class="op">=</span> AsyncStreamFormatter()</span>
<span id="cb187-2"><a href="#cb187-2" aria-hidden="true" tabindex="-1"></a>fmt.format_item(mock_response)</span>
<span id="cb187-3"><a href="#cb187-3" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(fmt.format_item(mock_tool_result))</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>

&lt;details class='tool-usage-details'&gt;

```json
{
  "id": "toolu_123abc456def",
  "call": {
    "function": "simple_add",
    "arguments": {
      "a": "5",
      "b": "3"
    }
  },
  "result": "8"
}
```

&lt;/details&gt;

</code></pre>
</div>
</div>
<p>In jupyter it’s nice to use this <a href="https://lisette.answer.ai/core.html#asyncstreamformatter"><code>AsyncStreamFormatter</code></a> in combination with the <code>Markdown</code> <code>display</code>:</p>
<hr>
<p><a href="https://github.com/AnswerDotAI/lisette/blob/main/lisette/core.py#L450" target="_blank" style="float:right; font-size:smaller">source</a></p>
</section>
<section id="adisplay_stream" class="level3">
<h3 class="anchored" data-anchor-id="adisplay_stream">adisplay_stream</h3>
<blockquote class="blockquote">
<pre><code> adisplay_stream (rs)</code></pre>
</blockquote>
<p><em>Use IPython.display to markdown display the response stream.</em></p>
</section>
</section>
<section id="streaming-examples" class="level2">
<h2 class="anchored" data-anchor-id="streaming-examples">Streaming examples</h2>
<p>Now we can demonstrate <a href="https://lisette.answer.ai/core.html#asyncchat"><code>AsyncChat</code></a> with <code>stream=True</code>!</p>
<section id="tool-call" class="level3">
<h3 class="anchored" data-anchor-id="tool-call">Tool call</h3>
<div id="375953eb" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb190"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb190-1"><a href="#cb190-1" aria-hidden="true" tabindex="-1"></a>chat <span class="op">=</span> AsyncChat(model, tools<span class="op">=</span>[async_add])</span>
<span id="cb190-2"><a href="#cb190-2" aria-hidden="true" tabindex="-1"></a>res <span class="op">=</span> <span class="cf">await</span> chat(<span class="st">"What is 5 + 7? Use the tool to calculate it."</span>, stream<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb190-3"><a href="#cb190-3" aria-hidden="true" tabindex="-1"></a>fmt <span class="op">=</span> <span class="cf">await</span> adisplay_stream(res)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display cell-output-markdown">
<details class="tool-usage-details">
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb191"><pre class="sourceCode json code-with-copy"><code class="sourceCode json"><span id="cb191-1"><a href="#cb191-1" aria-hidden="true" tabindex="-1"></a><span class="fu">{</span></span>
<span id="cb191-2"><a href="#cb191-2" aria-hidden="true" tabindex="-1"></a>  <span class="dt">"id"</span><span class="fu">:</span> <span class="st">"toolu_011RxwEK3HSc3VQwwsBZnXnV"</span><span class="fu">,</span></span>
<span id="cb191-3"><a href="#cb191-3" aria-hidden="true" tabindex="-1"></a>  <span class="dt">"call"</span><span class="fu">:</span> <span class="fu">{</span></span>
<span id="cb191-4"><a href="#cb191-4" aria-hidden="true" tabindex="-1"></a>    <span class="dt">"function"</span><span class="fu">:</span> <span class="st">"async_add"</span><span class="fu">,</span></span>
<span id="cb191-5"><a href="#cb191-5" aria-hidden="true" tabindex="-1"></a>    <span class="dt">"arguments"</span><span class="fu">:</span> <span class="fu">{</span></span>
<span id="cb191-6"><a href="#cb191-6" aria-hidden="true" tabindex="-1"></a>      <span class="dt">"a"</span><span class="fu">:</span> <span class="st">"5"</span><span class="fu">,</span></span>
<span id="cb191-7"><a href="#cb191-7" aria-hidden="true" tabindex="-1"></a>      <span class="dt">"b"</span><span class="fu">:</span> <span class="st">"7"</span></span>
<span id="cb191-8"><a href="#cb191-8" aria-hidden="true" tabindex="-1"></a>    <span class="fu">}</span></span>
<span id="cb191-9"><a href="#cb191-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">},</span></span>
<span id="cb191-10"><a href="#cb191-10" aria-hidden="true" tabindex="-1"></a>  <span class="dt">"result"</span><span class="fu">:</span> <span class="st">"12"</span></span>
<span id="cb191-11"><a href="#cb191-11" aria-hidden="true" tabindex="-1"></a><span class="fu">}</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
<p>The result of 5 + 7 is <strong>12</strong>.</p>
</div>
</div>
</section>
<section id="thinking-tool-call" class="level3">
<h3 class="anchored" data-anchor-id="thinking-tool-call">Thinking tool call</h3>
<div id="8d97da43" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb192"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb192-1"><a href="#cb192-1" aria-hidden="true" tabindex="-1"></a>chat <span class="op">=</span> AsyncChat(model)</span>
<span id="cb192-2"><a href="#cb192-2" aria-hidden="true" tabindex="-1"></a>res <span class="op">=</span> <span class="cf">await</span> chat(<span class="st">"Briefly, what's the most efficient way to sort a list of 1000 random integers?"</span>,</span>
<span id="cb192-3"><a href="#cb192-3" aria-hidden="true" tabindex="-1"></a>                 think<span class="op">=</span><span class="st">'l'</span>,stream<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb192-4"><a href="#cb192-4" aria-hidden="true" tabindex="-1"></a>_ <span class="op">=</span> <span class="cf">await</span> adisplay_stream(res)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display cell-output-markdown">
<p>🧠🧠🧠🧠🧠🧠🧠🧠🧠🧠🧠🧠🧠🧠🧠🧠🧠🧠🧠🧠🧠🧠🧠🧠🧠🧠🧠🧠🧠🧠🧠🧠🧠🧠🧠🧠🧠🧠🧠🧠🧠🧠🧠🧠🧠🧠🧠🧠🧠🧠</p>
<section id="use-your-languages-built-in-sort" class="level1">
<h1>Use your language’s built-in sort</h1>
<p>For 1000 random integers, <strong>use your language’s built-in sort function</strong> (e.g., Python’s <code>sorted()</code>, Java’s <code>Arrays.sort()</code>, C++’s <code>std::sort()</code>).</p>
<p>These implementations use highly optimized algorithms like: - <strong>Timsort</strong> (Python/Java) - <strong>Introsort</strong> (C++) - <strong>Dual-pivot Quicksort</strong> (Java primitives)</p>
<p>All are O(n log n) and will outperform hand-coded solutions for this dataset size.</p>
<hr>
<p><strong>If implementing yourself</strong>: Use <strong>Quicksort</strong> or <strong>Mergesort</strong> — both O(n log n) average case and efficient for this size.</p>
</section>
</div>
</div>
</section>
<section id="multiple-tool-calls" class="level3">
<h3 class="anchored" data-anchor-id="multiple-tool-calls">Multiple tool calls</h3>
<div id="ba4a72c7" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb193"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb193-1"><a href="#cb193-1" aria-hidden="true" tabindex="-1"></a>chat.hist[<span class="dv">1</span>]</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<div id="14ea0f40" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb194"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb194-1"><a href="#cb194-1" aria-hidden="true" tabindex="-1"></a>chat.hist[<span class="dv">2</span>]</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<div id="5c81c0f8" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb195"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb195-1"><a href="#cb195-1" aria-hidden="true" tabindex="-1"></a>chat.hist[<span class="dv">3</span>]</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<div id="456910e6" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb196"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb196-1"><a href="#cb196-1" aria-hidden="true" tabindex="-1"></a>chat.hist[<span class="dv">4</span>]</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<div id="0cf490ae" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb197"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb197-1"><a href="#cb197-1" aria-hidden="true" tabindex="-1"></a>chat.hist[<span class="dv">5</span>]</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<p>Now to demonstrate that we can load back the formatted output back into a new <a href="https://lisette.answer.ai/core.html#chat"><code>Chat</code></a> object:</p>
<div id="55653287" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb198"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb198-1"><a href="#cb198-1" aria-hidden="true" tabindex="-1"></a>chat5 <span class="op">=</span> Chat(model,hist<span class="op">=</span>fmt2hist(fmt.outp),tools<span class="op">=</span>[simple_add, multiply, divide])</span>
<span id="cb198-2"><a href="#cb198-2" aria-hidden="true" tabindex="-1"></a>chat5(<span class="st">'what did we just do?'</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
</section>
<section id="search-2" class="level3">
<h3 class="anchored" data-anchor-id="search-2">Search</h3>
<div id="124da784" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb199"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb199-1"><a href="#cb199-1" aria-hidden="true" tabindex="-1"></a>chat_stream_tools <span class="op">=</span> AsyncChat(model, search<span class="op">=</span><span class="st">'l'</span>)</span>
<span id="cb199-2"><a href="#cb199-2" aria-hidden="true" tabindex="-1"></a>res <span class="op">=</span> <span class="cf">await</span> chat_stream_tools(<span class="st">"Search the web and tell me very briefly about otters"</span>, stream<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb199-3"><a href="#cb199-3" aria-hidden="true" tabindex="-1"></a>_<span class="op">=</span><span class="cf">await</span> adisplay_stream(res)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
</section>
<section id="caching-1" class="level3">
<h3 class="anchored" data-anchor-id="caching-1">Caching</h3>
<div id="811571e1" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb200"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb200-1"><a href="#cb200-1" aria-hidden="true" tabindex="-1"></a>a,b <span class="op">=</span> random.randint(<span class="dv">0</span>,<span class="dv">100</span>), random.randint(<span class="dv">0</span>,<span class="dv">100</span>)</span>
<span id="cb200-2"><a href="#cb200-2" aria-hidden="true" tabindex="-1"></a>hist <span class="op">=</span> [[<span class="ss">f"What is </span><span class="sc">{</span>a<span class="sc">}</span><span class="ss">+</span><span class="sc">{</span>b<span class="sc">}</span><span class="ss">?</span><span class="ch">\n</span><span class="ss">"</span> <span class="op">*</span> <span class="dv">200</span>], <span class="ss">f"It's </span><span class="sc">{</span>a<span class="op">+</span>b<span class="sc">}</span><span class="ss">"</span>, [<span class="st">'hi'</span>], <span class="st">"Hello"</span>]</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<div id="38bc2dbb" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb201"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb201-1"><a href="#cb201-1" aria-hidden="true" tabindex="-1"></a>chat <span class="op">=</span> AsyncChat(model, cache<span class="op">=</span><span class="va">True</span>, hist<span class="op">=</span>hist)</span>
<span id="cb201-2"><a href="#cb201-2" aria-hidden="true" tabindex="-1"></a>rs <span class="op">=</span> <span class="cf">await</span> chat(<span class="st">'hi again'</span>, stream<span class="op">=</span><span class="va">True</span>, stream_options<span class="op">=</span>{<span class="st">"include_usage"</span>: <span class="va">True</span>})</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<div id="91f9390d" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb202"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb202-1"><a href="#cb202-1" aria-hidden="true" tabindex="-1"></a><span class="cf">async</span> <span class="cf">for</span> o <span class="kw">in</span> rs: </span>
<span id="cb202-2"><a href="#cb202-2" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="bu">isinstance</span>(o, ModelResponse): <span class="bu">print</span>(o.usage)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<p>In this first api call we will see cache creation until the last user msg:</p>
<div id="f372cd99" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb203"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb203-1"><a href="#cb203-1" aria-hidden="true" tabindex="-1"></a>cache_read_toks <span class="op">=</span> o.usage.cache_creation_input_tokens</span>
<span id="cb203-2"><a href="#cb203-2" aria-hidden="true" tabindex="-1"></a>test_eq(cache_read_toks <span class="op">&gt;</span> <span class="dv">1000</span>, <span class="va">True</span>)</span>
<span id="cb203-3"><a href="#cb203-3" aria-hidden="true" tabindex="-1"></a>test_eq(o.usage.cache_read_input_tokens, <span class="dv">0</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<div id="fd079aa0" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb204"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb204-1"><a href="#cb204-1" aria-hidden="true" tabindex="-1"></a>hist.extend([[<span class="st">'hi again'</span>], <span class="st">'how may i help you?'</span>])</span>
<span id="cb204-2"><a href="#cb204-2" aria-hidden="true" tabindex="-1"></a>chat <span class="op">=</span> AsyncChat(model, cache<span class="op">=</span><span class="va">True</span>, hist<span class="op">=</span>hist)</span>
<span id="cb204-3"><a href="#cb204-3" aria-hidden="true" tabindex="-1"></a>rs <span class="op">=</span> <span class="cf">await</span> chat(<span class="st">'bye!'</span>, stream<span class="op">=</span><span class="va">True</span>, stream_options<span class="op">=</span>{<span class="st">"include_usage"</span>: <span class="va">True</span>})</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<div id="9a940a1d" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb205"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb205-1"><a href="#cb205-1" aria-hidden="true" tabindex="-1"></a><span class="cf">async</span> <span class="cf">for</span> o <span class="kw">in</span> rs:</span>
<span id="cb205-2"><a href="#cb205-2" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="bu">isinstance</span>(o, ModelResponse): <span class="bu">print</span>(o.usage)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<p>The subsequent call should re-use the existing cache:</p>
<div id="d6ae13c5" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb206"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb206-1"><a href="#cb206-1" aria-hidden="true" tabindex="-1"></a>test_eq(o.usage.cache_read_input_tokens, cache_read_toks)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<div id="6e677e0c" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb207"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb207-1"><a href="#cb207-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> nbdev<span class="op">;</span> nbdev.nbdev_export()</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>


</section>
</section>
</section>

</main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
  window.document.addEventListener("DOMContentLoaded", function (event) {
    const icon = "";
    const anchorJS = new window.AnchorJS();
    anchorJS.options = {
      placement: 'right',
      icon: icon
    };
    anchorJS.add('.anchored');
    const isCodeAnnotation = (el) => {
      for (const clz of el.classList) {
        if (clz.startsWith('code-annotation-')) {                     
          return true;
        }
      }
      return false;
    }
    const onCopySuccess = function(e) {
      // button target
      const button = e.trigger;
      // don't keep focus
      button.blur();
      // flash "checked"
      button.classList.add('code-copy-button-checked');
      var currentTitle = button.getAttribute("title");
      button.setAttribute("title", "Copied!");
      let tooltip;
      if (window.bootstrap) {
        button.setAttribute("data-bs-toggle", "tooltip");
        button.setAttribute("data-bs-placement", "left");
        button.setAttribute("data-bs-title", "Copied!");
        tooltip = new bootstrap.Tooltip(button, 
          { trigger: "manual", 
            customClass: "code-copy-button-tooltip",
            offset: [0, -8]});
        tooltip.show();    
      }
      setTimeout(function() {
        if (tooltip) {
          tooltip.hide();
          button.removeAttribute("data-bs-title");
          button.removeAttribute("data-bs-toggle");
          button.removeAttribute("data-bs-placement");
        }
        button.setAttribute("title", currentTitle);
        button.classList.remove('code-copy-button-checked');
      }, 1000);
      // clear code selection
      e.clearSelection();
    }
    const getTextToCopy = function(trigger) {
      const outerScaffold = trigger.parentElement.cloneNode(true);
      const codeEl = outerScaffold.querySelector('code');
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
    }
    const clipboard = new window.ClipboardJS('.code-copy-button:not([data-in-quarto-modal])', {
      text: getTextToCopy
    });
    clipboard.on('success', onCopySuccess);
    if (window.document.getElementById('quarto-embedded-source-code-modal')) {
      const clipboardModal = new window.ClipboardJS('.code-copy-button[data-in-quarto-modal]', {
        text: getTextToCopy,
        container: window.document.getElementById('quarto-embedded-source-code-modal')
      });
      clipboardModal.on('success', onCopySuccess);
    }
      var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
      var mailtoRegex = new RegExp(/^mailto:/);
        var filterRegex = new RegExp("https:\/\/lisette\.answer\.ai\/");
      var isInternal = (href) => {
          return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
      }
      // Inspect non-navigation links and adorn them if external
     var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool):not(.about-link)');
      for (var i=0; i<links.length; i++) {
        const link = links[i];
        if (!isInternal(link.href)) {
          // undo the damage that might have been done by quarto-nav.js in the case of
          // links that we want to consider external
          if (link.dataset.originalHref !== undefined) {
            link.href = link.dataset.originalHref;
          }
        }
      }
    function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
      const config = {
        allowHTML: true,
        maxWidth: 500,
        delay: 100,
        arrow: false,
        appendTo: function(el) {
            return el.parentElement;
        },
        interactive: true,
        interactiveBorder: 10,
        theme: 'quarto',
        placement: 'bottom-start',
      };
      if (contentFn) {
        config.content = contentFn;
      }
      if (onTriggerFn) {
        config.onTrigger = onTriggerFn;
      }
      if (onUntriggerFn) {
        config.onUntrigger = onUntriggerFn;
      }
      window.tippy(el, config); 
    }
    const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
    for (var i=0; i<noterefs.length; i++) {
      const ref = noterefs[i];
      tippyHover(ref, function() {
        // use id or data attribute instead here
        let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
        try { href = new URL(href).hash; } catch {}
        const id = href.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note) {
          return note.innerHTML;
        } else {
          return "";
        }
      });
    }
    const xrefs = window.document.querySelectorAll('a.quarto-xref');
    const processXRef = (id, note) => {
      // Strip column container classes
      const stripColumnClz = (el) => {
        el.classList.remove("page-full", "page-columns");
        if (el.children) {
          for (const child of el.children) {
            stripColumnClz(child);
          }
        }
      }
      stripColumnClz(note)
      if (id === null || id.startsWith('sec-')) {
        // Special case sections, only their first couple elements
        const container = document.createElement("div");
        if (note.children && note.children.length > 2) {
          container.appendChild(note.children[0].cloneNode(true));
          for (let i = 1; i < note.children.length; i++) {
            const child = note.children[i];
            if (child.tagName === "P" && child.innerText === "") {
              continue;
            } else {
              container.appendChild(child.cloneNode(true));
              break;
            }
          }
          if (window.Quarto?.typesetMath) {
            window.Quarto.typesetMath(container);
          }
          return container.innerHTML
        } else {
          if (window.Quarto?.typesetMath) {
            window.Quarto.typesetMath(note);
          }
          return note.innerHTML;
        }
      } else {
        // Remove any anchor links if they are present
        const anchorLink = note.querySelector('a.anchorjs-link');
        if (anchorLink) {
          anchorLink.remove();
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        if (note.classList.contains("callout")) {
          return note.outerHTML;
        } else {
          return note.innerHTML;
        }
      }
    }
    for (var i=0; i<xrefs.length; i++) {
      const xref = xrefs[i];
      tippyHover(xref, undefined, function(instance) {
        instance.disable();
        let url = xref.getAttribute('href');
        let hash = undefined; 
        if (url.startsWith('#')) {
          hash = url;
        } else {
          try { hash = new URL(url).hash; } catch {}
        }
        if (hash) {
          const id = hash.replace(/^#\/?/, "");
          const note = window.document.getElementById(id);
          if (note !== null) {
            try {
              const html = processXRef(id, note.cloneNode(true));
              instance.setContent(html);
            } finally {
              instance.enable();
              instance.show();
            }
          } else {
            // See if we can fetch this
            fetch(url.split('#')[0])
            .then(res => res.text())
            .then(html => {
              const parser = new DOMParser();
              const htmlDoc = parser.parseFromString(html, "text/html");
              const note = htmlDoc.getElementById(id);
              if (note !== null) {
                const html = processXRef(id, note);
                instance.setContent(html);
              } 
            }).finally(() => {
              instance.enable();
              instance.show();
            });
          }
        } else {
          // See if we can fetch a full url (with no hash to target)
          // This is a special case and we should probably do some content thinning / targeting
          fetch(url)
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.querySelector('main.content');
            if (note !== null) {
              // This should only happen for chapter cross references
              // (since there is no id in the URL)
              // remove the first header
              if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
                note.children[0].remove();
              }
              const html = processXRef(null, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      }, function(instance) {
      });
    }
        let selectedAnnoteEl;
        const selectorForAnnotation = ( cell, annotation) => {
          let cellAttr = 'data-code-cell="' + cell + '"';
          let lineAttr = 'data-code-annotation="' +  annotation + '"';
          const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
          return selector;
        }
        const selectCodeLines = (annoteEl) => {
          const doc = window.document;
          const targetCell = annoteEl.getAttribute("data-target-cell");
          const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
          const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
          const lines = annoteSpan.getAttribute("data-code-lines").split(",");
          const lineIds = lines.map((line) => {
            return targetCell + "-" + line;
          })
          let top = null;
          let height = null;
          let parent = null;
          if (lineIds.length > 0) {
              //compute the position of the single el (top and bottom and make a div)
              const el = window.document.getElementById(lineIds[0]);
              top = el.offsetTop;
              height = el.offsetHeight;
              parent = el.parentElement.parentElement;
            if (lineIds.length > 1) {
              const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
              const bottom = lastEl.offsetTop + lastEl.offsetHeight;
              height = bottom - top;
            }
            if (top !== null && height !== null && parent !== null) {
              // cook up a div (if necessary) and position it 
              let div = window.document.getElementById("code-annotation-line-highlight");
              if (div === null) {
                div = window.document.createElement("div");
                div.setAttribute("id", "code-annotation-line-highlight");
                div.style.position = 'absolute';
                parent.appendChild(div);
              }
              div.style.top = top - 2 + "px";
              div.style.height = height + 4 + "px";
              div.style.left = 0;
              let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
              if (gutterDiv === null) {
                gutterDiv = window.document.createElement("div");
                gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
                gutterDiv.style.position = 'absolute';
                const codeCell = window.document.getElementById(targetCell);
                const gutter = codeCell.querySelector('.code-annotation-gutter');
                gutter.appendChild(gutterDiv);
              }
              gutterDiv.style.top = top - 2 + "px";
              gutterDiv.style.height = height + 4 + "px";
            }
            selectedAnnoteEl = annoteEl;
          }
        };
        const unselectCodeLines = () => {
          const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
          elementsIds.forEach((elId) => {
            const div = window.document.getElementById(elId);
            if (div) {
              div.remove();
            }
          });
          selectedAnnoteEl = undefined;
        };
          // Handle positioning of the toggle
      window.addEventListener(
        "resize",
        throttle(() => {
          elRect = undefined;
          if (selectedAnnoteEl) {
            selectCodeLines(selectedAnnoteEl);
          }
        }, 10)
      );
      function throttle(fn, ms) {
      let throttle = false;
      let timer;
        return (...args) => {
          if(!throttle) { // first call gets through
              fn.apply(this, args);
              throttle = true;
          } else { // all the others get throttled
              if(timer) clearTimeout(timer); // cancel #2
              timer = setTimeout(() => {
                fn.apply(this, args);
                timer = throttle = false;
              }, ms);
          }
        };
      }
        // Attach click handler to the DT
        const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
        for (const annoteDlNode of annoteDls) {
          annoteDlNode.addEventListener('click', (event) => {
            const clickedEl = event.target;
            if (clickedEl !== selectedAnnoteEl) {
              unselectCodeLines();
              const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
              if (activeEl) {
                activeEl.classList.remove('code-annotation-active');
              }
              selectCodeLines(clickedEl);
              clickedEl.classList.add('code-annotation-active');
            } else {
              // Unselect the line
              unselectCodeLines();
              clickedEl.classList.remove('code-annotation-active');
            }
          });
        }
    const findCites = (el) => {
      const parentEl = el.parentElement;
      if (parentEl) {
        const cites = parentEl.dataset.cites;
        if (cites) {
          return {
            el,
            cites: cites.split(' ')
          };
        } else {
          return findCites(el.parentElement)
        }
      } else {
        return undefined;
      }
    };
    var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
    for (var i=0; i<bibliorefs.length; i++) {
      const ref = bibliorefs[i];
      const citeInfo = findCites(ref);
      if (citeInfo) {
        tippyHover(citeInfo.el, function() {
          var popup = window.document.createElement('div');
          citeInfo.cites.forEach(function(cite) {
            var citeDiv = window.document.createElement('div');
            citeDiv.classList.add('hanging-indent');
            citeDiv.classList.add('csl-entry');
            var biblioDiv = window.document.getElementById('ref-' + cite);
            if (biblioDiv) {
              citeDiv.innerHTML = biblioDiv.innerHTML;
            }
            popup.appendChild(citeDiv);
          });
          return popup.innerHTML;
        });
      }
    }
  });
  </script>
</div> <!-- /content -->




<footer class="footer"><div class="nav-footer"><div class="nav-footer-center"><div class="toc-actions d-sm-block d-md-none"><ul><li><a href="https://github.com/AnswerDotAI/lisette/issues/new" class="toc-action"><i class="bi bi-github"></i>Report an issue</a></li></ul></div></div></div></footer></body></html>